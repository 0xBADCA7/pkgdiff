<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: keys.c - keys.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;keys.c&nbsp;</th><th> </th><th>&nbsp;keys.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 31</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 31</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MA 02111-1307, USA.</td><td> </td><td class="right"> * MA 02111-1307, USA.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdlib.h&gt;</td><td> </td><td class="right">#include &lt;stdlib.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;string.h&gt;</td><td> </td><td class="right">#include &lt;string.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/dsa.h&gt;</td><td> </td><td class="right">#include &lt;openssl/dsa.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/rsa.h&gt;</td><td> </td><td class="right">#include &lt;openssl/rsa.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/ssh2.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/server.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/agent.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/keys.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/dh.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/messages.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \addtogroup ssh_auth</td><td> </td><td class="right">/** \addtogroup ssh_auth</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @{</td><td> </td><td class="right"> * @{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Public key decoding functions */</td><td> </td><td class="right">/* Public key decoding functions */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">const char *ssh_type_to_char(int type) {</td><td> </td><td class="right">const char *ssh_type_to_char(int type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch (type) {</td><td> </td><td class="right">  switch (type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_DSS:</td><td> </td><td class="right">    case TYPE_DSS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return "ssh-dss";</td><td> </td><td class="right">      return "ssh-dss";</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 68</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 76</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return TYPE_RSA1;</td><td> </td><td class="right">    return TYPE_RSA1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (strcmp(name, "ssh-rsa") == 0) {</td><td> </td><td class="right">  } else if (strcmp(name, "ssh-rsa") == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return TYPE_RSA;</td><td> </td><td class="right">    return TYPE_RSA;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (strcmp(name, "ssh-dss") == 0) {</td><td> </td><td class="right">  } else if (strcmp(name, "ssh-dss") == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return TYPE_DSS;</td><td> </td><td class="right">    return TYPE_DSS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PUBLIC_KEY *publickey_make_dss(SSH_SESSION *session, BUFFER *buffer)</span> {</td><td> </td><td class="rblock"><span class="insert">ssh_public_key publickey_make_dss(ssh_session session, ssh_buffer buffer)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *p</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string p</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *q</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string q</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *g</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string g</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pubkey</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string pubkey</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PUBLIC_KEY *key</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_public_key key</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  key = malloc(sizeof(<span class="delete">PUBLIC_KEY</span>));</td><td> </td><td class="rblock">  key = malloc(sizeof(<span class="insert">struct ssh_public_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key == NULL) {</td><td> </td><td class="right">  if (key == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;type = TYPE_DSS;</td><td> </td><td class="right">  key-&gt;type = TYPE_DSS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;type_c = ssh_type_to_char(key-&gt;type);</td><td> </td><td class="right">  key-&gt;type_c = ssh_type_to_char(key-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  p = buffer_get_ssh_string(buffer);</td><td> </td><td class="right">  p = buffer_get_ssh_string(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  q = buffer_get_ssh_string(buffer);</td><td> </td><td class="right">  q = buffer_get_ssh_string(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 99</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 107</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer); /* we don't need it anymore */</td><td> </td><td class="right">  buffer_free(buffer); /* we don't need it anymore */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (p == NULL || q == NULL || g == NULL || pubkey == NULL) {</td><td> </td><td class="right">  if (p == NULL || q == NULL || g == NULL || pubkey == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Invalid DSA public key");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Invalid DSA public key");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_build(&amp;key-&gt;dsa_pub, NULL,</td><td> </td><td class="right">  gcry_sexp_build(&amp;key-&gt;dsa_pub, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "(public-key(dsa(p %b)(q %b)(g %b)(y %b)))",</td><td> </td><td class="right">      "(public-key(dsa(p %b)(q %b)(g %b)(y %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_len(p), <span class="delete">p-&gt;string,</span></td><td> </td><td class="rblock">      string_len(p), <span class="insert">string_data(p),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_len(q), <span class="delete">q-&gt;string,</span></td><td> </td><td class="rblock">      string_len(q), <span class="insert">string_data(q),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_len(g), <span class="delete">g-&gt;string,</span></td><td> </td><td class="rblock">      string_len(g), <span class="insert">string_data(g),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_len(pubkey), <span class="delete">pubkey-&gt;string);</span></td><td> </td><td class="rblock">      string_len(pubkey), <span class="insert">string_data(pubkey));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key-&gt;dsa_pub == NULL) {</td><td> </td><td class="right">  if (key-&gt;dsa_pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;dsa_pub = DSA_new();</td><td> </td><td class="right">  key-&gt;dsa_pub = DSA_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key-&gt;dsa_pub == NULL) {</td><td> </td><td class="right">  if (key-&gt;dsa_pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;dsa_pub-&gt;p = make_string_bn(p);</td><td> </td><td class="right">  key-&gt;dsa_pub-&gt;p = make_string_bn(p);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 154</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 162</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(q);</td><td> </td><td class="right">  string_free(q);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(g);</td><td> </td><td class="right">  string_burn(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(g);</td><td> </td><td class="right">  string_free(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(pubkey);</td><td> </td><td class="right">  string_burn(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(pubkey);</td><td> </td><td class="right">  string_free(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  publickey_free(key);</td><td> </td><td class="right">  publickey_free(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PUBLIC_KEY *publickey_make_rsa(SSH_SESSION *session, BUFFER *</span>buffer,</td><td> </td><td class="rblock"><span class="insert">ssh_public_key publickey_make_rsa(ssh_session session, ssh_buffer </span>buffer,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int type) {</td><td> </td><td class="right">    int type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *e</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string e</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *n</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string n</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PUBLIC_KEY *key</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_public_key key</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  key = malloc(sizeof(<span class="delete">PUBLIC_KEY</span>));</td><td> </td><td class="rblock">  key = malloc(sizeof(<span class="insert">struct ssh_public_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key == NULL) {</td><td> </td><td class="right">  if (key == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;type = type;</td><td> </td><td class="right">  key-&gt;type = type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;type_c = ssh_type_to_char(key-&gt;type);</td><td> </td><td class="right">  key-&gt;type_c = ssh_type_to_char(key-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  e = buffer_get_ssh_string(buffer);</td><td> </td><td class="right">  e = buffer_get_ssh_string(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  n = buffer_get_ssh_string(buffer);</td><td> </td><td class="right">  n = buffer_get_ssh_string(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer); /* we don't need it anymore */</td><td> </td><td class="right">  buffer_free(buffer); /* we don't need it anymore */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(e == NULL || n == NULL) {</td><td> </td><td class="right">  if(e == NULL || n == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Invalid RSA public key");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Invalid RSA public key");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_build(&amp;key-&gt;rsa_pub, NULL,</td><td> </td><td class="right">  gcry_sexp_build(&amp;key-&gt;rsa_pub, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "(public-key(rsa(n %b)(e %b)))",</td><td> </td><td class="right">      "(public-key(rsa(n %b)(e %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_len(n), <span class="delete">n-&gt;string,</span></td><td> </td><td class="rblock">      string_len(n), <span class="insert">string_data(n),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      string_len(e),e-&gt;string);</span></td><td> </td><td class="rblock"><span class="insert">      string_len(e),string_data(e));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key-&gt;rsa_pub == NULL) {</td><td> </td><td class="right">  if (key-&gt;rsa_pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;rsa_pub = RSA_new();</td><td> </td><td class="right">  key-&gt;rsa_pub = RSA_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key-&gt;rsa_pub == NULL) {</td><td> </td><td class="right">  if (key-&gt;rsa_pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;rsa_pub-&gt;e = make_string_bn(e);</td><td> </td><td class="right">  key-&gt;rsa_pub-&gt;e = make_string_bn(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 221</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 229</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(e);</td><td> </td><td class="right">  string_burn(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(e);</td><td> </td><td class="right">  string_free(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(n);</td><td> </td><td class="right">  string_burn(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(n);</td><td> </td><td class="right">  string_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  publickey_free(key);</td><td> </td><td class="right">  publickey_free(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void publickey_free(<span class="delete">PUBLIC_KEY *</span>key) {</td><td> </td><td class="rblock">void publickey_free(<span class="insert">ssh_public_key </span>key) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key == NULL) {</td><td> </td><td class="right">  if (key == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(key-&gt;type) {</td><td> </td><td class="right">  switch(key-&gt;type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_DSS:</td><td> </td><td class="right">    case TYPE_DSS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      gcry_sexp_release(key-&gt;dsa_pub);</td><td> </td><td class="right">      gcry_sexp_release(key-&gt;dsa_pub);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      DSA_free(key-&gt;dsa_pub);</td><td> </td><td class="right">      DSA_free(key-&gt;dsa_pub);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 248</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 256</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      RSA_free(key-&gt;rsa_pub);</td><td> </td><td class="right">      RSA_free(key-&gt;rsa_pub);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(key);</td><td> </td><td class="right">  SAFE_FREE(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PUBLIC_KEY *publickey_from_string(SSH_SESSION *session, STRING *pubkey_s)</span> {</td><td> </td><td class="rblock"><span class="insert">ssh_public_key publickey_from_string(ssh_session session, ssh_string pubkey</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *tmpbuf</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">_s)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *type_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer tmpbuf</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">ssh_string type_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *type_c = NULL;</td><td> </td><td class="right">  char *type_c = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int type;</td><td> </td><td class="right">  int type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  tmpbuf = buffer_new();</td><td> </td><td class="right">  tmpbuf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (tmpbuf == NULL) {</td><td> </td><td class="right">  if (tmpbuf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_add_data(tmpbuf, <span class="delete">pubkey_s-&gt;string, string_len(pubkey_s)) &lt; 0) 
</span>{</td><td> </td><td class="rblock">  if (buffer_add_data(tmpbuf, <span class="insert">string_data(pubkey_s), string_len(pubkey_s)) 
&lt; 0) </span>{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  type_s = buffer_get_ssh_string(tmpbuf);</td><td> </td><td class="right">  type_s = buffer_get_ssh_string(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (type_s == NULL) {</td><td> </td><td class="right">  if (type_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session,SSH_FATAL,"Invalid public key format");</td><td> </td><td class="right">    ssh_set_error(session,SSH_FATAL,"Invalid public key format");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  type_c = string_to_char(type_s);</td><td> </td><td class="right">  type_c = string_to_char(type_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 299</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 307</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(tmpbuf);</td><td> </td><td class="right">  buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief Makes a PUBLIC_KEY object out of a PRIVATE_KEY object</td><td> </td><td class="right">/** \brief Makes a PUBLIC_KEY object out of a PRIVATE_KEY object</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param prv the Private key</td><td> </td><td class="right"> * \param prv the Private key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns the public key</td><td> </td><td class="right"> * \returns the public key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see publickey_to_string()</td><td> </td><td class="right"> * \see publickey_to_string()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PUBLIC_KEY *publickey_from_privatekey(PRIVATE_KEY *prv)</span> {</td><td> </td><td class="rblock"><span class="insert">ssh_public_key publickey_from_privatekey(ssh_private_key prv)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PUBLIC_KEY *key</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_public_key key</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t sexp;</td><td> </td><td class="right">  gcry_sexp_t sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *tmp = NULL;</td><td> </td><td class="right">  const char *tmp = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t size;</td><td> </td><td class="right">  size_t size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *p</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string p</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *q</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string q</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *g</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string g</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *y</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string y</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *e</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string e</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *n</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string n</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_LIBGCRYPT */</td><td> </td><td class="right">#endif /* HAVE_LIBGCRYPT */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  key = malloc(sizeof(<span class="delete">PUBLIC_KEY</span>));</td><td> </td><td class="rblock">  key = malloc(sizeof(<span class="insert">struct ssh_public_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (key == NULL) {</td><td> </td><td class="right">  if (key == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  key-&gt;type = prv-&gt;type;</td><td> </td><td class="right">  key-&gt;type = prv-&gt;type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(key-&gt;type) {</td><td> </td><td class="right">  switch(key-&gt;type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_DSS:</td><td> </td><td class="right">    case TYPE_DSS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sexp = gcry_sexp_find_token(prv-&gt;dsa_priv, "p", 0);</td><td> </td><td class="right">      sexp = gcry_sexp_find_token(prv-&gt;dsa_priv, "p", 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (sexp == NULL) {</td><td> </td><td class="right">      if (sexp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 372</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 380</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      tmp = gcry_sexp_nth_data(sexp,1,&amp;size);</td><td> </td><td class="right">      tmp = gcry_sexp_nth_data(sexp,1,&amp;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      y = string_new(size);</td><td> </td><td class="right">      y = string_new(size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (y == NULL) {</td><td> </td><td class="right">      if (y == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_fill(y,(char *) tmp,size);</td><td> </td><td class="right">      string_fill(y,(char *) tmp,size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      gcry_sexp_release(sexp);</td><td> </td><td class="right">      gcry_sexp_release(sexp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      gcry_sexp_build(&amp;key-&gt;dsa_pub, NULL,</td><td> </td><td class="right">      gcry_sexp_build(&amp;key-&gt;dsa_pub, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "(public-key(dsa(p %b)(q %b)(g %b)(y %b)))",</td><td> </td><td class="right">          "(public-key(dsa(p %b)(q %b)(g %b)(y %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(p), <span class="delete">p-&gt;string,</span></td><td> </td><td class="rblock">          string_len(p), <span class="insert">string_data(p),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(q), <span class="delete">q-&gt;string,</span></td><td> </td><td class="rblock">          string_len(q), <span class="insert">string_data(q),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(g), <span class="delete">g-&gt;string,</span></td><td> </td><td class="rblock">          string_len(g), <span class="insert">string_data(g),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(y), <span class="delete">y-&gt;string);</span></td><td> </td><td class="rblock">          string_len(y), <span class="insert">string_data(y));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(p);</td><td> </td><td class="right">      string_burn(p);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(p);</td><td> </td><td class="right">      string_free(p);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(q);</td><td> </td><td class="right">      string_burn(q);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(q);</td><td> </td><td class="right">      string_free(q);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(g);</td><td> </td><td class="right">      string_burn(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(g);</td><td> </td><td class="right">      string_free(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(y);</td><td> </td><td class="right">      string_burn(y);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(y);</td><td> </td><td class="right">      string_free(y);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 431</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 439</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      tmp = gcry_sexp_nth_data(sexp, 1, &amp;size);</td><td> </td><td class="right">      tmp = gcry_sexp_nth_data(sexp, 1, &amp;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      e = string_new(size);</td><td> </td><td class="right">      e = string_new(size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (e == NULL) {</td><td> </td><td class="right">      if (e == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_fill(e, (char *) tmp, size);</td><td> </td><td class="right">      string_fill(e, (char *) tmp, size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      gcry_sexp_release(sexp);</td><td> </td><td class="right">      gcry_sexp_release(sexp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      gcry_sexp_build(&amp;key-&gt;rsa_pub, NULL,</td><td> </td><td class="right">      gcry_sexp_build(&amp;key-&gt;rsa_pub, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "(public-key(rsa(n %b)(e %b)))",</td><td> </td><td class="right">          "(public-key(rsa(n %b)(e %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(n), <span class="delete">n-&gt;string,</span></td><td> </td><td class="rblock">          string_len(n), <span class="insert">string_data(n),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(e), <span class="delete">e-&gt;string);</span></td><td> </td><td class="rblock">          string_len(e), <span class="insert">string_data(e));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (key-&gt;rsa_pub == NULL) {</td><td> </td><td class="right">      if (key-&gt;rsa_pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(e);</td><td> </td><td class="right">      string_burn(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(e);</td><td> </td><td class="right">      string_free(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_burn(n);</td><td> </td><td class="right">      string_burn(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(n);</td><td> </td><td class="right">      string_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      key-&gt;rsa_pub = RSA_new();</td><td> </td><td class="right">      key-&gt;rsa_pub = RSA_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l10" /><small>skipping to change at</small><em> line 481</em></th><th> </th><th><a name="part-r10" /><small>skipping to change at</small><em> line 489</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(e);</td><td> </td><td class="right">  string_free(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(n);</td><td> </td><td class="right">  string_burn(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(n);</td><td> </td><td class="right">  string_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  publickey_free(key);</td><td> </td><td class="right">  publickey_free(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int dsa_public_to_string(gcry_sexp_t key, <span class="delete">BUFFER *</span>buffer) {</td><td> </td><td class="rblock">static int dsa_public_to_string(gcry_sexp_t key, <span class="insert">ssh_buffer </span>buffer) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int dsa_public_to_string(DSA *key, <span class="delete">BUFFER *</span>buffer) {</td><td> </td><td class="rblock">static int dsa_public_to_string(DSA *key, <span class="insert">ssh_buffer </span>buffer) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *p</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string p</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *q</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string q</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *g</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string g</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *n</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string n</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = -1;</td><td> </td><td class="right">  int rc = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *tmp = NULL;</td><td> </td><td class="right">  const char *tmp = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t size;</td><td> </td><td class="right">  size_t size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t sexp;</td><td> </td><td class="right">  gcry_sexp_t sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sexp = gcry_sexp_find_token(key, "p", 0);</td><td> </td><td class="right">  sexp = gcry_sexp_find_token(key, "p", 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sexp == NULL) {</td><td> </td><td class="right">  if (sexp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l11" /><small>skipping to change at</small><em> line 585</em></th><th> </th><th><a name="part-r11" /><small>skipping to change at</small><em> line 593</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(q);</td><td> </td><td class="right">  string_free(q);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(g);</td><td> </td><td class="right">  string_burn(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(g);</td><td> </td><td class="right">  string_free(g);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_burn(n);</td><td> </td><td class="right">  string_burn(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(n);</td><td> </td><td class="right">  string_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int rsa_public_to_string(gcry_sexp_t key, <span class="delete">BUFFER *</span>buffer) {</td><td> </td><td class="rblock">static int rsa_public_to_string(gcry_sexp_t key, <span class="insert">ssh_buffer </span>buffer) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int rsa_public_to_string(RSA *key, <span class="delete">BUFFER *</span>buffer) {</td><td> </td><td class="rblock">static int rsa_public_to_string(RSA *key, <span class="insert">ssh_buffer </span>buffer) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *e</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string e</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *n</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string n</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = -1;</td><td> </td><td class="right">  int rc = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *tmp;</td><td> </td><td class="right">  const char *tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t size;</td><td> </td><td class="right">  size_t size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t sexp;</td><td> </td><td class="right">  gcry_sexp_t sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sexp = gcry_sexp_find_token(key, "n", 0);</td><td> </td><td class="right">  sexp = gcry_sexp_find_token(key, "n", 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sexp == NULL) {</td><td> </td><td class="right">  if (sexp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l12" /><small>skipping to change at</small><em> line 657</em></th><th> </th><th><a name="part-r12" /><small>skipping to change at</small><em> line 665</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(n);</td><td> </td><td class="right">  string_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief makes a SSH String out of a PUBLIC_KEY object</td><td> </td><td class="right">/** \brief makes a SSH String out of a PUBLIC_KEY object</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param key the public key</td><td> </td><td class="right"> * \param key the public key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns a SSH String containing the public key</td><td> </td><td class="right"> * \returns a SSH String containing the public key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see string_free()</td><td> </td><td class="right"> * \see string_free()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *publickey_to_string(PUBLIC_KEY *key)</span> {</td><td> </td><td class="rblock"><span class="insert">ssh_string publickey_to_string(ssh_public_key key)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *type</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string type</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *ret</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string ret</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buf</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buf</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buf = buffer_new();</td><td> </td><td class="right">  buf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buf == NULL) {</td><td> </td><td class="right">  if (buf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  type = string_from_char(key-&gt;type_c);</td><td> </td><td class="right">  type = string_from_char(key-&gt;type_c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (type == NULL) {</td><td> </td><td class="right">  if (type == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l13" /><small>skipping to change at</small><em> line 704</em></th><th> </th><th><a name="part-r13" /><small>skipping to change at</small><em> line 712</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_fill(ret, buffer_get(buf), buffer_get_len(buf));</td><td> </td><td class="right">  string_fill(ret, buffer_get(buf), buffer_get_len(buf));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buf);</td><td> </td><td class="right">  buffer_free(buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(type);</td><td> </td><td class="right">  string_free(type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ret;</td><td> </td><td class="right">  return ret;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Signature decoding functions */</td><td> </td><td class="right">/* Signature decoding functions */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">STRING *</span>signature_to_string(SIGNATURE *sign) {</td><td> </td><td class="rblock">static <span class="insert">ssh_string </span>signature_to_string(SIGNATURE *sign) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char buffer[40] = {0};</td><td> </td><td class="right">  unsigned char buffer[40] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *tmpbuf</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer tmpbuf</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *str</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string str</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *tmp</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string tmp</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *rs</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string rs</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = -1;</td><td> </td><td class="right">  int rc = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *r = NULL;</td><td> </td><td class="right">  const char *r = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *s = NULL;</td><td> </td><td class="right">  const char *s = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t sexp;</td><td> </td><td class="right">  gcry_sexp_t sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t size = 0;</td><td> </td><td class="right">  size_t size = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *r</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string r</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  tmpbuf = buffer_new();</td><td> </td><td class="right">  tmpbuf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (tmpbuf == NULL) {</td><td> </td><td class="right">  if (tmpbuf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  tmp = string_from_char(ssh_type_to_char(sign-&gt;type));</td><td> </td><td class="right">  tmp = string_from_char(ssh_type_to_char(sign-&gt;type));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (tmp == NULL) {</td><td> </td><td class="right">  if (tmp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(tmpbuf);</td><td> </td><td class="right">    buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l14" /><small>skipping to change at</small><em> line 779</em></th><th> </th><th><a name="part-r14" /><small>skipping to change at</small><em> line 787</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_free(tmpbuf);</td><td> </td><td class="right">        buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      s = make_bignum_string(sign-&gt;dsa_sign-&gt;s);</td><td> </td><td class="right">      s = make_bignum_string(sign-&gt;dsa_sign-&gt;s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (s == NULL) {</td><td> </td><td class="right">      if (s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_free(tmpbuf);</td><td> </td><td class="right">        buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(r);</td><td> </td><td class="right">        string_free(r);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      memcpy(buffer, <span class="delete">r-&gt;string</span> + string_len(r) - 20, 20);</td><td> </td><td class="rblock">      memcpy(buffer, <span class="insert">(char *)string_data(r)</span> + string_len(r) - 20, 20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      memcpy(buffer + 20, <span class="delete">s-&gt;string</span> + string_len(s) - 20, 20);</td><td> </td><td class="rblock">      memcpy(buffer + 20, <span class="insert">(char *)string_data(s)</span> + string_len(s) - 20, 20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(r);</td><td> </td><td class="right">      string_free(r);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(s);</td><td> </td><td class="right">      string_free(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_LIBCRYPTO */</td><td> </td><td class="right">#endif /* HAVE_LIBCRYPTO */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      rs = string_new(40);</td><td> </td><td class="right">      rs = string_new(40);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (rs == NULL) {</td><td> </td><td class="right">      if (rs == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_free(tmpbuf);</td><td> </td><td class="right">        buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l15" /><small>skipping to change at</small><em> line 848</em></th><th> </th><th><a name="part-r15" /><small>skipping to change at</small><em> line 856</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(tmpbuf);</td><td> </td><td class="right">    buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_fill(str, buffer_get(tmpbuf), buffer_get_len(tmpbuf));</td><td> </td><td class="right">  string_fill(str, buffer_get(tmpbuf), buffer_get_len(tmpbuf));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(tmpbuf);</td><td> </td><td class="right">  buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return str;</td><td> </td><td class="right">  return str;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* TODO : split this function in two so it becomes smaller */</td><td> </td><td class="right">/* TODO : split this function in two so it becomes smaller */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">SIGNATURE <span class="delete">*signature_from_string(SSH_SESSION *session, STRING *signature,</span></td><td> </td><td class="rblock">SIGNATURE <span class="insert">*signature_from_string(ssh_session session, ssh_string signature,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    PUBLIC_KEY *pubkey,</span> int needed_type) {</td><td> </td><td class="rblock"><span class="insert">    ssh_public_key pubkey,</span> int needed_type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SIGNATURE *sign = NULL;</td><td> </td><td class="right">  SIGNATURE *sign = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *tmpbuf</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer tmpbuf</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *rs</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string rs</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *type_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string type_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *e</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string e</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *type_c = NULL;</td><td> </td><td class="right">  char *type_c = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int type;</td><td> </td><td class="right">  int type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int len;</td><td> </td><td class="right">  int len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rsalen;</td><td> </td><td class="right">  int rsalen;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t sig;</td><td> </td><td class="right">  gcry_sexp_t sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  DSA_SIG *sig = NULL;</td><td> </td><td class="right">  DSA_SIG *sig = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *r</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string r</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sign = malloc(sizeof(SIGNATURE));</td><td> </td><td class="right">  sign = malloc(sizeof(SIGNATURE));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sign == NULL) {</td><td> </td><td class="right">  if (sign == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  tmpbuf = buffer_new();</td><td> </td><td class="right">  tmpbuf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (tmpbuf == NULL) {</td><td> </td><td class="right">  if (tmpbuf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    signature_free(sign);</td><td> </td><td class="right">    signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_add_data(tmpbuf, s<span class="delete">ignature-&gt;string, string_len(signature)) &lt; 0
</span>) {</td><td> </td><td class="rblock">  if (buffer_add_data(tmpbuf, s<span class="insert">tring_data(signature), string_len(signature)
) &lt; 0</span>) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    signature_free(sign);</td><td> </td><td class="right">    signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(tmpbuf);</td><td> </td><td class="right">    buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  type_s = buffer_get_ssh_string(tmpbuf);</td><td> </td><td class="right">  type_s = buffer_get_ssh_string(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (type_s == NULL) {</td><td> </td><td class="right">  if (type_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Invalid signature packet");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Invalid signature packet");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    signature_free(sign);</td><td> </td><td class="right">    signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(tmpbuf);</td><td> </td><td class="right">    buffer_free(tmpbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l16" /><small>skipping to change at</small><em> line 928</em></th><th> </th><th><a name="part-r16" /><small>skipping to change at</small><em> line 936</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (rs == NULL || string_len(rs) != 40) {</td><td> </td><td class="right">      if (rs == NULL || string_len(rs) != 40) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(rs);</td><td> </td><td class="right">        string_free(rs);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        signature_free(sign);</td><td> </td><td class="right">        signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* we make use of strings (because we have all-made functions to conv
ert</td><td> </td><td class="right">      /* we make use of strings (because we have all-made functions to conv
ert</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       * them to bignums (ou pas ;) */</td><td> </td><td class="right">       * them to bignums (ou pas ;) */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (gcry_sexp_build(&amp;sig, NULL, "(sig-val(dsa(r %b)(s %b)))",</td><td> </td><td class="right">      if (gcry_sexp_build(&amp;sig, NULL, "(sig-val(dsa(r %b)(s %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">            20 ,<span class="delete">rs-&gt;string, 20, rs-&gt;string + 20))</span> {</td><td> </td><td class="rblock">            20 ,<span class="insert">string_data(rs), 20,(unsigned char *)string_data(rs) + 20))
</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(rs);</td><td> </td><td class="right">        string_free(rs);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        signature_free(sign);</td><td> </td><td class="right">        signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      r = string_new(20);</td><td> </td><td class="right">      r = string_new(20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      s = string_new(20);</td><td> </td><td class="right">      s = string_new(20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (r == NULL || s == NULL) {</td><td> </td><td class="right">      if (r == NULL || s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(r);</td><td> </td><td class="right">        string_free(r);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(s);</td><td> </td><td class="right">        string_free(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(rs);</td><td> </td><td class="right">        string_free(rs);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        signature_free(sign);</td><td> </td><td class="right">        signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_fill(r, <span class="delete">rs-&gt;string,</span> 20);</td><td> </td><td class="rblock">      string_fill(r, <span class="insert">string_data(rs),</span> 20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      string_fill(s, <span class="delete">rs-&gt;string</span> + 20, 20);</td><td> </td><td class="rblock">      string_fill(s, <span class="insert">(char *)string_data(rs)</span> + 20, 20);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sig = DSA_SIG_new();</td><td> </td><td class="right">      sig = DSA_SIG_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (sig == NULL) {</td><td> </td><td class="right">      if (sig == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(r);</td><td> </td><td class="right">        string_free(r);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(s);</td><td> </td><td class="right">        string_free(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(rs);</td><td> </td><td class="right">        string_free(rs);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        signature_free(sign);</td><td> </td><td class="right">        signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sig-&gt;r = make_string_bn(r); /* is that really portable ? Openssh's ha
ck isn't better */</td><td> </td><td class="right">      sig-&gt;r = make_string_bn(r); /* is that really portable ? Openssh's ha
ck isn't better */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l17" /><small>skipping to change at</small><em> line 1006</em></th><th> </th><th><a name="part-r17" /><small>skipping to change at</small><em> line 1014</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (len &lt; rsalen) {</td><td> </td><td class="right">      if (len &lt; rsalen) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_RARE, "RSA signature len %d &lt; %d",</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_RARE, "RSA signature len %d &lt; %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            len, rsalen);</td><td> </td><td class="right">            len, rsalen);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sign-&gt;type = TYPE_RSA;</td><td> </td><td class="right">      sign-&gt;type = TYPE_RSA;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (gcry_sexp_build(&amp;sig, NULL, "(sig-val(rsa(s %b)))",</td><td> </td><td class="right">      if (gcry_sexp_build(&amp;sig, NULL, "(sig-val(rsa(s %b)))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          string_len(e), <span class="delete">e-&gt;string</span>)) {</td><td> </td><td class="rblock">          string_len(e), <span class="insert">string_data(e)</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        signature_free(sign);</td><td> </td><td class="right">        signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(e);</td><td> </td><td class="right">        string_free(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sign-&gt;rsa_sign = sig;</td><td> </td><td class="right">      sign-&gt;rsa_sign = sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sign-&gt;rsa_sign = e;</td><td> </td><td class="right">      sign-&gt;rsa_sign = e;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l18" /><small>skipping to change at</small><em> line 1072</em></th><th> </th><th><a name="part-r18" /><small>skipping to change at</small><em> line 1080</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(sign);</td><td> </td><td class="right">  SAFE_FREE(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Maybe the missing function from libcrypto</td><td> </td><td class="right"> * Maybe the missing function from libcrypto</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * I think now, maybe it's a bad idea to name it has it should have be</td><td> </td><td class="right"> * I think now, maybe it's a bad idea to name it has it should have be</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * named in libcrypto</td><td> </td><td class="right"> * named in libcrypto</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">STRING *RSA_do_sign(const</span> unsigned char *payload, int len, RSA <span class="delete">*priv</span></td><td> </td><td class="rblock">static <span class="insert">ssh_string RSA_do_sign(const</span> unsigned char *payload, int len, RSA <span class="insert">*p</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">key)</span> {</td><td> </td><td class="rblock"><span class="insert">rivkey)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *sign</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string sign</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *buffer = NULL;</td><td> </td><td class="right">  unsigned char *buffer = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int size;</td><td> </td><td class="right">  unsigned int size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = malloc(RSA_size(privkey));</td><td> </td><td class="right">  buffer = malloc(RSA_size(privkey));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (RSA_sign(NID_sha1, payload, len, buffer, &amp;size, privkey) == 0) {</td><td> </td><td class="right">  if (RSA_sign(NID_sha1, payload, len, buffer, &amp;size, privkey) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(buffer);</td><td> </td><td class="right">    SAFE_FREE(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l19" /><small>skipping to change at</small><em> line 1101</em></th><th> </th><th><a name="part-r19" /><small>skipping to change at</small><em> line 1109</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_fill(sign, buffer, size);</td><td> </td><td class="right">  string_fill(sign, buffer, size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(buffer);</td><td> </td><td class="right">  SAFE_FREE(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sign;</td><td> </td><td class="right">  return sign;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *ssh_do_sign_with_agent(struct ssh_session *session,</span></td><td> </td><td class="rblock"><span class="insert">ssh_string ssh_do_sign_with_agent(ssh_session session,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    struct <span class="delete">buffer_struct</span> *buf, struct <span class="delete">public_key_struct</span> *publickey) {</td><td> </td><td class="rblock">    struct <span class="insert">ssh_buffer_struct</span> *buf, struct <span class="insert">ssh_public_key_struct</span> *publickey)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">buffer_struct</span> *sigbuf = NULL;</td><td> </td><td class="rblock"> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *signature = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_buffer_struct</span> *sigbuf = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *session_id = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *signature = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *session_id = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  struct ssh_crypto_struct *crypto = NULL;</td><td> </td><td class="right">  struct ssh_crypto_struct *crypto = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;current_crypto) {</td><td> </td><td class="right">  if (session-&gt;current_crypto) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    crypto = session-&gt;current_crypto;</td><td> </td><td class="right">    crypto = session-&gt;current_crypto;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    crypto = session-&gt;next_crypto;</td><td> </td><td class="right">    crypto = session-&gt;next_crypto;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* prepend session identifier */</td><td> </td><td class="right">  /* prepend session identifier */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session_id = string_new(SHA_DIGEST_LEN);</td><td> </td><td class="right">  session_id = string_new(SHA_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l20" /><small>skipping to change at</small><em> line 1150</em></th><th> </th><th><a name="part-r20" /><small>skipping to change at</small><em> line 1158</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* create signature */</td><td> </td><td class="right">  /* create signature */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  signature = agent_sign_data(session, sigbuf, publickey);</td><td> </td><td class="right">  signature = agent_sign_data(session, sigbuf, publickey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(sigbuf);</td><td> </td><td class="right">  buffer_free(sigbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return signature;</td><td> </td><td class="right">  return signature;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* _WIN32 */</td><td> </td><td class="right">#endif /* _WIN32 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"> <span class="insert">* This function concats in a buffer the values needed to do a signature</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * verification. */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ssh_buffer ssh_userauth_build_digest(ssh_session session, ssh_message msg, </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">char *service) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">/*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     The value of 'signature' is a signature by the corresponding private</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">   key over the following data, in the following order:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    session identifier</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      byte      SSH_MSG_USERAUTH_REQUEST</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    user name</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    service name</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    "publickey"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      boolean   TRUE</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    public key algorithm name</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string    public key to be used for authentication</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       struct ssh_crypto_struct *crypto = session-&gt;current_crypto ? session</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">-&gt;current_crypto :</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                                             session-&gt;next_crypto;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string session_id = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  uint8_t type = SSH2_MSG_USERAUTH_REQUEST;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string username = string_from_char(msg-&gt;auth_request.username);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string servicename = string_from_char(service);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string method = string_from_char("publickey");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  uint8_t has_sign = 1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string algo = string_from_char(msg-&gt;auth_request.public_key-&gt;type_c);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string publickey = publickey_to_string(msg-&gt;auth_request.public_key);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer = buffer_new();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (buffer == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    goto error;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  session_id = string_new(SHA_DIGEST_LEN);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (session_id == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    goto error;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  string_fill(session_id, crypto-&gt;session_id, SHA_DIGEST_LEN);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(buffer_add_ssh_string(buffer, session_id) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_u8(buffer, type) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_ssh_string(buffer, username) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_ssh_string(buffer, servicename) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_ssh_string(buffer, method) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_u8(buffer, has_sign) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_ssh_string(buffer, algo) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">     buffer_add_ssh_string(buffer, publickey) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    goto error;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">error:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(session_id) string_free(session_id);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(username) string_free(username);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(servicename) string_free(servicename);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(method) string_free(method);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(algo) string_free(algo);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(publickey) string_free(publickey);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">/*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This function signs the session id (known as H) as a string then</td><td> </td><td class="right"> * This function signs the session id (known as H) as a string then</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the content of sigbuf */</td><td> </td><td class="right"> * the content of sigbuf */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *ssh_do_sign(SSH_SESSION *session, BUFFER *sigbuf,</span></td><td> </td><td class="rblock"><span class="insert">ssh_string ssh_do_sign(ssh_session session, ssh_buffer sigbuf,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    PRIVATE_KEY *privatekey)</span> {</td><td> </td><td class="rblock"><span class="insert">    ssh_private_key privatekey)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">CRYPTO</span> *crypto = session-&gt;current_crypto ? <span class="delete">session-&gt;current_crypto</span> :</td><td> </td><td class="rblock">  <span class="insert">struct ssh_crypto_struct</span> *crypto = session-&gt;current_crypto ? <span class="insert">session-&gt;cur</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">rent_crypto</span> :</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    session-&gt;next_crypto;</td><td> </td><td class="right">    session-&gt;next_crypto;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td> </td><td class="right">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *session_str</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string session_str</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *signature</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string signature</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SIGNATURE *sign = NULL;</td><td> </td><td class="right">  SIGNATURE *sign = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SHACTX ctx = NULL;</td><td> </td><td class="right">  SHACTX ctx = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t gcryhash;</td><td> </td><td class="right">  gcry_sexp_t gcryhash;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session_str = string_new(SHA_DIGEST_LEN);</td><td> </td><td class="right">  session_str = string_new(SHA_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session_str == NULL) {</td><td> </td><td class="right">  if (session_str == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l21" /><small>skipping to change at</small><em> line 1251</em></th><th> </th><th><a name="part-r21" /><small>skipping to change at</small><em> line 1323</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sign-&gt;type = privatekey-&gt;type;</td><td> </td><td class="right">  sign-&gt;type = privatekey-&gt;type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  signature = signature_to_string(sign);</td><td> </td><td class="right">  signature = signature_to_string(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  signature_free(sign);</td><td> </td><td class="right">  signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return signature;</td><td> </td><td class="right">  return signature;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *ssh_encrypt_rsa1(SSH_SESSION *session, STRING *data, PUBLIC_KEY *ke</span></td><td> </td><td class="rblock"><span class="insert">ssh_string ssh_encrypt_rsa1(ssh_session session, ssh_string data, ssh_publi</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">y)</span> {</td><td> </td><td class="rblock"><span class="insert">c_key key)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *str</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string str</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t len = string_len(data);</td><td> </td><td class="right">  size_t len = string_len(data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t size = 0;</td><td> </td><td class="right">  size_t size = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *tmp = NULL;</td><td> </td><td class="right">  const char *tmp = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t ret_sexp;</td><td> </td><td class="right">  gcry_sexp_t ret_sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t data_sexp;</td><td> </td><td class="right">  gcry_sexp_t data_sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (gcry_sexp_build(&amp;data_sexp, NULL, "(data(flags pkcs1)(value %b))",</td><td> </td><td class="right">  if (gcry_sexp_build(&amp;data_sexp, NULL, "(data(flags pkcs1)(value %b))",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      len, <span class="delete">data-&gt;string</span>)) {</td><td> </td><td class="rblock">      len, <span class="insert">string_data(data)</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "RSA1 encrypt: libgcrypt error");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "RSA1 encrypt: libgcrypt error");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (gcry_pk_encrypt(&amp;ret_sexp, data_sexp, key-&gt;rsa_pub)) {</td><td> </td><td class="right">  if (gcry_pk_encrypt(&amp;ret_sexp, data_sexp, key-&gt;rsa_pub)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_release(data_sexp);</td><td> </td><td class="right">    gcry_sexp_release(data_sexp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "RSA1 encrypt: libgcrypt error");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "RSA1 encrypt: libgcrypt error");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_release(data_sexp);</td><td> </td><td class="right">  gcry_sexp_release(data_sexp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l22" /><small>skipping to change at</small><em> line 1305</em></th><th> </th><th><a name="part-r22" /><small>skipping to change at</small><em> line 1377</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_release(ret_sexp);</td><td> </td><td class="right">  gcry_sexp_release(ret_sexp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = RSA_size(key-&gt;rsa_pub);</td><td> </td><td class="right">  size = RSA_size(key-&gt;rsa_pub);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  str = string_new(size);</td><td> </td><td class="right">  str = string_new(size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (str == NULL) {</td><td> </td><td class="right">  if (str == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Not enough space");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (RSA_public_encrypt(len, <span class="delete">data-&gt;string, str-&gt;string, key-&gt;rsa</span>_pub,</td><td> </td><td class="rblock">  if (RSA_public_encrypt(len, <span class="insert">string_data(data), string_data(str), key-&gt;rsa
</span>_pub,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      RSA_PKCS1_PADDING) &lt; 0) {</td><td> </td><td class="right">      RSA_PKCS1_PADDING) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(str);</td><td> </td><td class="right">    string_free(str);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return str;</td><td> </td><td class="right">  return str;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* this function signs the session id */</td><td> </td><td class="right">/* this function signs the session id */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *ssh_sign_session_id(SSH_SESSION *session, PRIVATE_KEY *privatekey)</span> </td><td> </td><td class="rblock"><span class="insert">ssh_string ssh_sign_session_id(ssh_session session, ssh_private_key private</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">{</td><td> </td><td class="rblock"><span class="insert">key)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">CRYPTO</span> *crypto=session-&gt;current_crypto ? <span class="delete">session-&gt;current_crypto</span> :</td><td> </td><td class="rblock">       <span class="insert">struct ssh_crypto_struct</span> *crypto=session-&gt;current_crypto ? <span class="insert">session-&gt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">current_crypto</span> :</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    session-&gt;next_crypto;</td><td> </td><td class="right">    session-&gt;next_crypto;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td> </td><td class="right">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *</span>signature = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string </span>signature = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SIGNATURE *sign = NULL;</td><td> </td><td class="right">  SIGNATURE *sign = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SHACTX ctx = NULL;</td><td> </td><td class="right">  SHACTX ctx = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t data_sexp;</td><td> </td><td class="right">  gcry_sexp_t data_sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ctx = sha1_init();</td><td> </td><td class="right">  ctx = sha1_init();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 44 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>96 lines changed or deleted</i></th><th><i> </i></th><th><i>174 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
