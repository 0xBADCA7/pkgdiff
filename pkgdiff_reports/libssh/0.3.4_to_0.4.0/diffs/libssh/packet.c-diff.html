<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: packet.c - packet.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;packet.c&nbsp;</th><th> </th><th>&nbsp;packet.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 24</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 24</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILI
TY</td><td> </td><td class="right"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILI
TY</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</td><td> </td><td class="right"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * License for more details.</td><td> </td><td class="right"> * License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU Lesser General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU Lesser General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with the SSH Library; see the file COPYING.  If not, write to</td><td> </td><td class="right"> * along with the SSH Library; see the file COPYING.  If not, write to</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</td><td> </td><td class="right"> * the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MA 02111-1307, USA.</td><td> </td><td class="right"> * MA 02111-1307, USA.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "config.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdlib.h&gt;</td><td> </td><td class="right">#include &lt;stdlib.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdio.h&gt;</td><td> </td><td class="right">#include &lt;stdio.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#include &lt;unistd.h&gt;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;string.h&gt;</td><td> </td><td class="right">#include &lt;string.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;errno.h&gt;</td><td> </td><td class="right">#include &lt;errno.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;arpa/inet.h&gt;</td><td> </td><td class="right">#include &lt;arpa/inet.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#include "config.h"</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/ssh2.h"</td><td> </td><td class="right">#include "libssh/ssh2.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/ssh1.h"</td><td> </td><td class="right">#include "libssh/ssh1.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/crypto.h"</td><td> </td><td class="right">#include "libssh/crypto.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/packet.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/socket.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/channels.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/messages.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/pcap.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* XXX include selected mac size */</td><td> </td><td class="right">/* XXX include selected mac size */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int macsize=SHA_DIGEST_LEN;</td><td> </td><td class="right">static int macsize=SHA_DIGEST_LEN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* in nonblocking mode, socket_read will read as much as it can, and return
 */</td><td> </td><td class="right">/* in nonblocking mode, socket_read will read as much as it can, and return
 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* SSH_OK if it has read at least len bytes, otherwise, SSH_AGAIN. */</td><td> </td><td class="right">/* SSH_OK if it has read at least len bytes, otherwise, SSH_AGAIN. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* in blocking mode, it will read at least len bytes and will block until i
t's ok. */</td><td> </td><td class="right">/* in blocking mode, it will read at least len bytes and will block until i
t's ok. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define PACKET_STATE_INIT 0</td><td> </td><td class="right">#define PACKET_STATE_INIT 0</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define PACKET_STATE_SIZEREAD 1</td><td> </td><td class="right">#define PACKET_STATE_SIZEREAD 1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_read2(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">static int packet_read2(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td> </td><td class="right">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;current_crypto-&gt;in_cipher-&gt;blocksize : 8);</td><td> </td><td class="right">      session-&gt;current_crypto-&gt;in_cipher-&gt;blocksize : 8);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int current_macsize = session-&gt;current_crypto ? macsize : 0;</td><td> </td><td class="right">  int current_macsize = session-&gt;current_crypto ? macsize : 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char mac[30] = {0};</td><td> </td><td class="right">  unsigned char mac[30] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char buffer[16] = {0};</td><td> </td><td class="right">  char buffer[16] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  void *packet=NULL;</td><td> </td><td class="right">  void *packet=NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int to_be_read;</td><td> </td><td class="right">  int to_be_read;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> len;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u8</span> padding;</td><td> </td><td class="rblock">  <span class="insert">uint8_t</span> padding;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;alive == 0) {</td><td> </td><td class="right">  if (session-&gt;alive == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* The error message was already set into this session */</td><td> </td><td class="right">    /* The error message was already set into this session */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return SSH_ERROR;</td><td> </td><td class="right">    return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(session-&gt;packet_state) {</td><td> </td><td class="right">  switch(session-&gt;packet_state) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 105</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 112</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_add_data(session-&gt;in_buffer, buffer, blocksize) &lt; 0) {</td><td> </td><td class="right">      if (buffer_add_data(session-&gt;in_buffer, buffer, blocksize) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if(len &gt; MAX_PACKET_LEN) {</td><td> </td><td class="right">      if(len &gt; MAX_PACKET_LEN) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "read_packet(): Packet len too high(%u %.4x)", len, len);</td><td> </td><td class="right">            "read_packet(): Packet len too high(%u %.4x)", len, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      to_be_read = len - blocksize + sizeof(u<span class="delete">32</span>);</td><td> </td><td class="rblock">      to_be_read = len - blocksize + sizeof(u<span class="insert">int32_t</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (to_be_read &lt; 0) {</td><td> </td><td class="right">      if (to_be_read &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        /* remote sshd sends invalid sizes? */</td><td> </td><td class="right">        /* remote sshd sends invalid sizes? */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "given numbers of bytes left to be read &lt; 0 (%d)!", to_be_read)
;</td><td> </td><td class="right">            "given numbers of bytes left to be read &lt; 0 (%d)!", to_be_read)
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* saves the status of the current operations */</td><td> </td><td class="right">      /* saves the status of the current operations */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;in_packet.len = len;</td><td> </td><td class="right">      session-&gt;in_packet.len = len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;packet_state = PACKET_STATE_SIZEREAD;</td><td> </td><td class="right">      session-&gt;packet_state = PACKET_STATE_SIZEREAD;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case PACKET_STATE_SIZEREAD:</td><td> </td><td class="right">    case PACKET_STATE_SIZEREAD:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      len = session-&gt;in_packet.len;</td><td> </td><td class="right">      len = session-&gt;in_packet.len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      to_be_read = len - blocksize + sizeof(u<span class="delete">32</span>) + current_macsize;</td><td> </td><td class="rblock">      to_be_read = len - blocksize + sizeof(u<span class="insert">int32_t</span>) + current_macsize;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* if to_be_read is zero, the whole packet was blocksize bytes. */</td><td> </td><td class="right">      /* if to_be_read is zero, the whole packet was blocksize bytes. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (to_be_read != 0) {</td><td> </td><td class="right">      if (to_be_read != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        rc = ssh_socket_wait_for_data(session-&gt;socket,session,to_be_read);</td><td> </td><td class="right">        rc = ssh_socket_wait_for_data(session-&gt;socket,session,to_be_read);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (rc != SSH_OK) {</td><td> </td><td class="right">        if (rc != SSH_OK) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        rc = SSH_ERROR;</td><td> </td><td class="right">        rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        packet = malloc(to_be_read);</td><td> </td><td class="right">        packet = malloc(to_be_read);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (packet == NULL) {</td><td> </td><td class="right">        if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 150</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 157</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        SAFE_FREE(packet);</td><td> </td><td class="right">        SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (session-&gt;current_crypto) {</td><td> </td><td class="right">      if (session-&gt;current_crypto) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        /*</td><td> </td><td class="right">        /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         * decrypt the rest of the packet (blocksize bytes already</td><td> </td><td class="right">         * decrypt the rest of the packet (blocksize bytes already</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         * have been decrypted)</td><td> </td><td class="right">         * have been decrypted)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         */</td><td> </td><td class="right">         */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (packet_decrypt(session,</td><td> </td><td class="right">        if (packet_decrypt(session,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">              <span class="delete">buffer_get(session-&gt;in_buffer) + blocksize</span>,</td><td> </td><td class="rblock">              <span class="insert">((uint8_t*)buffer_get(session-&gt;in_buffer) + blocksize)</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              buffer_get_len(session-&gt;in_buffer) - blocksize) &lt; 0) {</td><td> </td><td class="right">              buffer_get_len(session-&gt;in_buffer) - blocksize) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          ssh_set_error(session, SSH_FATAL, "Decrypt error");</td><td> </td><td class="right">          ssh_set_error(session, SSH_FATAL, "Decrypt error");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef WITH_PCAP</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        if(session-&gt;pcap_ctx){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               ssh_pcap_context_write(session-&gt;pcap_ctx,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               SSH_PCAP_DIR_IN, buffer_get(session-&gt;in_buff</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">er),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               buffer_get_len(session-&gt;in_buffer),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               buffer_get_len(session-&gt;in_buffer));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_socket_read(session-&gt;socket, mac, macsize);</td><td> </td><td class="right">        ssh_socket_read(session-&gt;socket, mac, macsize);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (packet_hmac_verify(session, session-&gt;in_buffer, mac) &lt; 0) {</td><td> </td><td class="right">        if (packet_hmac_verify(session, session-&gt;in_buffer, mac) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          ssh_set_error(session, SSH_FATAL, "HMAC error");</td><td> </td><td class="right">          ssh_set_error(session, SSH_FATAL, "HMAC error");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef WITH_PCAP</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      else {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       /* No crypto */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        if(session-&gt;pcap_ctx){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               ssh_pcap_context_write(session-&gt;pcap_ctx,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               SSH_PCAP_DIR_IN, buffer_get(session-&gt;in_buff</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">er),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               buffer_get_len(session-&gt;in_buffer),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               buffer_get_len(session-&gt;in_buffer));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_pass_bytes(session-&gt;in_buffer, sizeof(u<span class="delete">32</span>));</td><td> </td><td class="rblock">      buffer_pass_bytes(session-&gt;in_buffer, sizeof(u<span class="insert">int32_t</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* pass the size which has been processed before */</td><td> </td><td class="right">      /* pass the size which has been processed before */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_get_u8(session-&gt;in_buffer, &amp;padding) == 0) {</td><td> </td><td class="right">      if (buffer_get_u8(session-&gt;in_buffer, &amp;padding) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL, "Packet too short to read padding
");</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL, "Packet too short to read padding
");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      ssh_log(session, SSH_LOG_<span class="delete">RARE</span>,</td><td> </td><td class="rblock">      ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "%hhd bytes padding, %d bytes left in buffer",</td><td> </td><td class="right">          "%hhd bytes padding, %d bytes left in buffer",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          padding, buffer_get_rest_len(session-&gt;in_buffer));</td><td> </td><td class="right">          padding, buffer_get_rest_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (padding &gt; buffer_get_rest_len(session-&gt;in_buffer)) {</td><td> </td><td class="right">      if (padding &gt; buffer_get_rest_len(session-&gt;in_buffer)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "Invalid padding: %d (%d resting)",</td><td> </td><td class="right">            "Invalid padding: %d (%d resting)",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            padding,</td><td> </td><td class="right">            padding,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            buffer_get_rest_len(session-&gt;in_buffer));</td><td> </td><td class="right">            buffer_get_rest_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_print_hexa("incrimined packet",</td><td> </td><td class="right">        ssh_print_hexa("incrimined packet",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            buffer_get(session-&gt;in_buffer),</td><td> </td><td class="right">            buffer_get(session-&gt;in_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            buffer_get_len(session-&gt;in_buffer));</td><td> </td><td class="right">            buffer_get_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_pass_bytes_end(session-&gt;in_buffer, padding);</td><td> </td><td class="right">      buffer_pass_bytes_end(session-&gt;in_buffer, padding);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      ssh_log(session, SSH_LOG_<span class="delete">RARE</span>,</td><td> </td><td class="rblock">      ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "After padding, %d bytes left in buffer",</td><td> </td><td class="right">          "After padding, %d bytes left in buffer",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          buffer_get_rest_len(session-&gt;in_buffer));</td><td> </td><td class="right">          buffer_get_rest_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td> </td><td class="right">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_i
n) {</td><td> </td><td class="right">      if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_i
n) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        ssh_log(session, <span class="delete">SSH_LOG_RARE,</span> "Decompressing in_buffer ...");</td><td> </td><td class="rblock">        ssh_log(session, <span class="insert">SSH_LOG_PACKET,</span> "Decompressing in_buffer ...");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        if (decompress_buffer(session, <span class="delete">session-&gt;in_buffer)</span> &lt; 0) {</td><td> </td><td class="rblock">        if (decompress_buffer(session, <span class="insert">session-&gt;in_buffer, MAX_PACKET_LEN)</span> </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">&lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;recv_seq++;</td><td> </td><td class="right">      session-&gt;recv_seq++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;packet_state = PACKET_STATE_INIT;</td><td> </td><td class="right">      session-&gt;packet_state = PACKET_STATE_INIT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return SSH_OK;</td><td> </td><td class="right">      return SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 218</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 244</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Invalid state into packet_read2(): %d",</td><td> </td><td class="right">      "Invalid state into packet_read2(): %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;packet_state);</td><td> </td><td class="right">      session-&gt;packet_state);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* a slighty modified packet_read2() for SSH-1 protocol */</td><td> </td><td class="right">/* a slighty modified packet_read2() for SSH-1 protocol */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_read1(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">static int packet_read1(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  void *packet = NULL;</td><td> </td><td class="right">  void *packet = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int to_be_read;</td><td> </td><td class="right">  int to_be_read;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> padding;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> padding;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> crc;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> crc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> len;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(!session-&gt;alive) {</td><td> </td><td class="right">  if(!session-&gt;alive) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch (session-&gt;packet_state){</td><td> </td><td class="right">  switch (session-&gt;packet_state){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case PACKET_STATE_INIT:</td><td> </td><td class="right">    case PACKET_STATE_INIT:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      memset(&amp;session-&gt;in_packet, 0, sizeof(PACKET));</td><td> </td><td class="right">      memset(&amp;session-&gt;in_packet, 0, sizeof(PACKET));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 247</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 273</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (buffer_reinit(session-&gt;in_buffer) &lt; 0) {</td><td> </td><td class="right">        if (buffer_reinit(session-&gt;in_buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      } else {</td><td> </td><td class="right">      } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        session-&gt;in_buffer = buffer_new();</td><td> </td><td class="right">        session-&gt;in_buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (session-&gt;in_buffer == NULL) {</td><td> </td><td class="right">        if (session-&gt;in_buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      rc = ssh_socket_read(session-&gt;socket, &amp;len, sizeof(u<span class="delete">32</span>));</td><td> </td><td class="rblock">      rc = ssh_socket_read(session-&gt;socket, &amp;len, sizeof(u<span class="insert">int32_t</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (rc != SSH_OK) {</td><td> </td><td class="right">      if (rc != SSH_OK) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      rc = SSH_ERROR;</td><td> </td><td class="right">      rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* len is not encrypted */</td><td> </td><td class="right">      /* len is not encrypted */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      len = ntohl(len);</td><td> </td><td class="right">      len = ntohl(len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (len &gt; MAX_PACKET_LEN) {</td><td> </td><td class="right">      if (len &gt; MAX_PACKET_LEN) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 314</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 340</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          ssh_set_error(session, SSH_FATAL, "Packet decrypt error");</td><td> </td><td class="right">          ssh_set_error(session, SSH_FATAL, "Packet decrypt error");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          goto error;</td><td> </td><td class="right">          goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_print_hexa("read packet decrypted:", buffer_get(session-&gt;in_buffe
r),</td><td> </td><td class="right">      ssh_print_hexa("read packet decrypted:", buffer_get(session-&gt;in_buffe
r),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          buffer_get_len(session-&gt;in_buffer));</td><td> </td><td class="right">          buffer_get_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(session, SSH_LOG_PACKET, "%d bytes padding", padding);</td><td> </td><td class="right">      ssh_log(session, SSH_LOG_PACKET, "%d bytes padding", padding);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if(((len + padding) != buffer_get_rest_len(session-&gt;in_buffer)) ||</td><td> </td><td class="right">      if(((len + padding) != buffer_get_rest_len(session-&gt;in_buffer)) ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          ((len + padding) &lt; sizeof(u<span class="delete">32</span>))) {</td><td> </td><td class="rblock">          ((len + padding) &lt; sizeof(u<span class="insert">int32_t</span>))) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_RARE, "no crc32 in packet");</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_RARE, "no crc32 in packet");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL, "no crc32 in packet");</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL, "no crc32 in packet");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      memcpy(&amp;crc,</td><td> </td><td class="right">      memcpy(&amp;crc,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          <span class="delete">buffer_get_rest(session-&gt;in_buffer)</span> + <span class="delete">(len+padding)</span> - <span class="delete">sizeof(u32)</span></td><td> </td><td class="rblock">          <span class="insert">(unsigned char *)buffer_get_rest(session-&gt;in_buffer)</span> + <span class="insert">(len+paddi</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">,</span></td><td> </td><td class="rblock"><span class="insert">ng)</span> - <span class="insert">sizeof(uint32_t),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          sizeof(u32));</span></td><td> </td><td class="rblock"><span class="insert">          sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_pass_bytes_end(session-&gt;in_buffer, <span class="delete">sizeof(u32));</span></td><td> </td><td class="rblock">      buffer_pass_bytes_end(session-&gt;in_buffer, <span class="insert">sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      crc = ntohl(crc);</td><td> </td><td class="right">      crc = ntohl(crc);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (ssh_crc32(buffer_get_rest(session-&gt;in_buffer),</td><td> </td><td class="right">      if (ssh_crc32(buffer_get_rest(session-&gt;in_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">            (len + padding) - sizeof(u<span class="delete">32</span>)) != crc) {</td><td> </td><td class="rblock">            (len + padding) - sizeof(u<span class="insert">int32_t</span>)) != crc) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_print_hexa("crc32 on",buffer_get_rest(session-&gt;in_buffer),</td><td> </td><td class="right">        ssh_print_hexa("crc32 on",buffer_get_rest(session-&gt;in_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">            len + padding - sizeof(u<span class="delete">32</span>));</td><td> </td><td class="rblock">            len + padding - sizeof(u<span class="insert">int32_t</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_RARE, "Invalid crc32");</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_RARE, "Invalid crc32");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "Invalid crc32: expected %.8x, got %.8x",</td><td> </td><td class="right">            "Invalid crc32: expected %.8x, got %.8x",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            crc,</td><td> </td><td class="right">            crc,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            ssh_crc32(buffer_get_rest(session-&gt;in_buffer),</td><td> </td><td class="right">            ssh_crc32(buffer_get_rest(session-&gt;in_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">              len + padding - sizeof(u<span class="delete">32</span>)));</td><td> </td><td class="rblock">              len + padding - sizeof(u<span class="insert">int32_t</span>)));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        goto error;</td><td> </td><td class="right">        goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* pass the padding */</td><td> </td><td class="right">      /* pass the padding */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_pass_bytes(session-&gt;in_buffer, padding);</td><td> </td><td class="right">      buffer_pass_bytes(session-&gt;in_buffer, padding);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(session, SSH_LOG_PACKET, "The packet is valid");</td><td> </td><td class="right">      ssh_log(session, SSH_LOG_PACKET, "The packet is valid");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* TODO FIXME</td><td> </td><td class="right">/* TODO FIXME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td> </td><td class="right">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if(session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_in){</td><td> </td><td class="right">    if(session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_in){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        decompress_buffer(session,session-&gt;in_buffer);</td><td> </td><td class="right">        decompress_buffer(session,session-&gt;in_buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 368</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 394</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Invalid state into packet_read1(): %d",</td><td> </td><td class="right">      "Invalid state into packet_read1(): %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;packet_state);</td><td> </td><td class="right">      session-&gt;packet_state);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* WITH_SSH1 */</td><td> </td><td class="right">#endif /* WITH_SSH1 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* that's where i'd like C to be object ... */</td><td> </td><td class="right">/* that's where i'd like C to be object ... */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int packet_read(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int packet_read(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;version == 1) {</td><td> </td><td class="right">  if (session-&gt;version == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return packet_read1(session);</td><td> </td><td class="right">    return packet_read1(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return packet_read2(session);</td><td> </td><td class="right">  return packet_read2(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int packet_translate(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int packet_translate(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  memset(&amp;session-&gt;in_packet, 0, sizeof(PACKET));</td><td> </td><td class="right">  memset(&amp;session-&gt;in_packet, 0, sizeof(PACKET));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(session-&gt;in_buffer == NULL) {</td><td> </td><td class="right">  if(session-&gt;in_buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return SSH_ERROR;</td><td> </td><td class="right">    return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_<span class="delete">RARE</span>, "Final size %d",</td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>, "Final size %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_rest_len(session-&gt;in_buffer));</td><td> </td><td class="right">      buffer_get_rest_len(session-&gt;in_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(buffer_get_u8(session-&gt;in_buffer, &amp;session-&gt;in_packet.type) == 0) {</td><td> </td><td class="right">  if(buffer_get_u8(session-&gt;in_buffer, &amp;session-&gt;in_packet.type) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Packet too short to read type");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Packet too short to read type");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return SSH_ERROR;</td><td> </td><td class="right">    return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_<span class="delete">RARE</span>, "Type %hhd", session-&gt;in_packet.type);</td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>, "Type %hhd", session-&gt;in_packet.type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;in_packet.valid = 1;</td><td> </td><td class="right">  session-&gt;in_packet.valid = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return SSH_OK;</td><td> </td><td class="right">  return SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Write the the bufferized output. If the session is blocking, or</td><td> </td><td class="right"> * Write the the bufferized output. If the session is blocking, or</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * enforce_blocking is set, the call may block. Otherwise, it won't block.</td><td> </td><td class="right"> * enforce_blocking is set, the call may block. Otherwise, it won't block.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Return SSH_OK if everything has been sent, SSH_AGAIN if there are still</td><td> </td><td class="right"> * Return SSH_OK if everything has been sent, SSH_AGAIN if there are still</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * things to send on buffer, SSH_ERROR if there is an error.</td><td> </td><td class="right"> * things to send on buffer, SSH_ERROR if there is an error.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int packet_flush(<span class="delete">SSH_SESSION *</span>session, int enforce_blocking) {</td><td> </td><td class="rblock">int packet_flush(<span class="insert">ssh_session </span>session, int enforce_blocking) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (enforce_blocking || session-&gt;blocking) {</td><td> </td><td class="right">  if (enforce_blocking || session-&gt;blocking) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return ssh_socket_blocking_flush(session-&gt;socket);</td><td> </td><td class="right">    return ssh_socket_blocking_flush(session-&gt;socket);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ssh_socket_nonblocking_flush(session-&gt;socket);</td><td> </td><td class="right">  return ssh_socket_nonblocking_flush(session-&gt;socket);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This function places the outgoing packet buffer into an outgoing</td><td> </td><td class="right"> * This function places the outgoing packet buffer into an outgoing</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * socket buffer</td><td> </td><td class="right"> * socket buffer</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_write(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">static int packet_write(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_socket_write(session-&gt;socket,</td><td> </td><td class="right">  ssh_socket_write(session-&gt;socket,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get(session-&gt;out_buffer),</td><td> </td><td class="right">      buffer_get(session-&gt;out_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(session-&gt;out_buffer));</td><td> </td><td class="right">      buffer_get_len(session-&gt;out_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  rc = packet_flush(session, 0);</td><td> </td><td class="right">  rc = packet_flush(session, 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_send2(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">static int packet_send2(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td> </td><td class="right">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;current_crypto-&gt;out_cipher-&gt;blocksize : 8);</td><td> </td><td class="right">      session-&gt;current_crypto-&gt;out_cipher-&gt;blocksize : 8);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32</span> currentlen = buffer_get_len(session-&gt;out_buffer);</td><td> </td><td class="rblock">  u<span class="insert">int32_t</span> currentlen = buffer_get_len(session-&gt;out_buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *hmac = NULL;</td><td> </td><td class="right">  unsigned char *hmac = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char padstring[32] = {0};</td><td> </td><td class="right">  char padstring[32] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> finallen;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> finallen;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u8</span> padding;</td><td> </td><td class="rblock">  <span class="insert">uint8_t</span> padding;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_<span class="delete">RARE</span>,</td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Writing on the wire a packet having %u bytes before", currentlen);</td><td> </td><td class="right">      "Writing on the wire a packet having %u bytes before", currentlen);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td> </td><td class="right">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_out) 
{</td><td> </td><td class="right">  if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_out) 
{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    ssh_log(session, SSH_LOG_<span class="delete">RARE</span>, "Compressing in_buffer ...");</td><td> </td><td class="rblock">    ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>, "Compressing in_buffer ...");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (compress_buffer(session,session-&gt;out_buffer) &lt; 0) {</td><td> </td><td class="right">    if (compress_buffer(session,session-&gt;out_buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      goto error;</td><td> </td><td class="right">      goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    currentlen = buffer_get_len(session-&gt;out_buffer);</td><td> </td><td class="right">    currentlen = buffer_get_len(session-&gt;out_buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  padding = (blocksize - ((currentlen +5) % blocksize));</td><td> </td><td class="right">  padding = (blocksize - ((currentlen +5) % blocksize));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(padding &lt; 4) {</td><td> </td><td class="right">  if(padding &lt; 4) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    padding += blocksize;</td><td> </td><td class="right">    padding += blocksize;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;current_crypto) {</td><td> </td><td class="right">  if (session-&gt;current_crypto) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_get_random(padstring, padding, 0);</td><td> </td><td class="right">    ssh_get_random(padstring, padding, 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    memset(padstring,0,padding);</td><td> </td><td class="right">    memset(padstring,0,padding);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  finallen = htonl(currentlen + padding + 1);</td><td> </td><td class="right">  finallen = htonl(currentlen + padding + 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_<span class="delete">RARE</span>,</td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_<span class="insert">PACKET</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "%d bytes after comp + %d padding bytes = %lu bytes packet",</td><td> </td><td class="right">      "%d bytes after comp + %d padding bytes = %lu bytes packet",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      currentlen, padding, (long unsigned int) ntohl(finallen));</td><td> </td><td class="right">      currentlen, padding, (long unsigned int) ntohl(finallen));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;padding, sizeof(u<span class="delete">8)) &lt;</span> 0) {</td><td> </td><td class="rblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;padding, sizeof(u<span class="insert">int8_t)) &lt;
</span> 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;finallen, sizeof(u<span class="delete">32)) &lt; 0)
</span> {</td><td> </td><td class="rblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;finallen, sizeof(u<span class="insert">int32_t))
 &lt; 0)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_data(session-&gt;out_buffer, padstring, padding) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_data(session-&gt;out_buffer, padstring, padding) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"><span class="insert">#ifdef WITH_PCAP</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(session-&gt;pcap_ctx){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       ssh_pcap_context_write(session-&gt;pcap_ctx,SSH_PCAP_DIR_OUT,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       buffer_get(session-&gt;out_buffer),buffer_get_len(sessi</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">on-&gt;out_buffer)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       ,buffer_get_len(session-&gt;out_buffer));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  hmac = packet_encrypt(session, buffer_get(session-&gt;out_buffer),</td><td> </td><td class="right">  hmac = packet_encrypt(session, buffer_get(session-&gt;out_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(session-&gt;out_buffer));</td><td> </td><td class="right">      buffer_get_len(session-&gt;out_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (hmac) {</td><td> </td><td class="right">  if (hmac) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_add_data(session-&gt;out_buffer, hmac, 20) &lt; 0) {</td><td> </td><td class="right">    if (buffer_add_data(session-&gt;out_buffer, hmac, 20) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      goto error;</td><td> </td><td class="right">      goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  rc = packet_write(session);</td><td> </td><td class="right">  rc = packet_write(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;send_seq++;</td><td> </td><td class="right">  session-&gt;send_seq++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_reinit(session-&gt;out_buffer) &lt; 0) {</td><td> </td><td class="right">  if (buffer_reinit(session-&gt;out_buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    rc = SSH_ERROR;</td><td> </td><td class="right">    rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc; /* SSH_OK, AGAIN or ERROR */</td><td> </td><td class="right">  return rc; /* SSH_OK, AGAIN or ERROR */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">#ifdef <span class="delete">HAVE_SSH1</span></td><td> </td><td class="rblock">#ifdef <span class="insert">WITH_SSH1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">packet_send1(SSH_SESSION *session)</span> {</td><td> </td><td class="rblock">static int <span class="insert">packet_send1(ssh_session session)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td> </td><td class="right">  unsigned int blocksize = (session-&gt;current_crypto ?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;current_crypto-&gt;out_cipher-&gt;blocksize : 8);</td><td> </td><td class="right">      session-&gt;current_crypto-&gt;out_cipher-&gt;blocksize : 8);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32 currentlen = buffer_get_len(session-&gt;out_buffer) + sizeof(u32</span>);</td><td> </td><td class="rblock">  u<span class="insert">int32_t currentlen = buffer_get_len(session-&gt;out_buffer) + sizeof(uint32
_t</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char padstring[32] = {0};</td><td> </td><td class="right">  char padstring[32] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> finallen;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> finallen;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> crc;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> crc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u8</span> padding;</td><td> </td><td class="rblock">  <span class="insert">uint8_t</span> padding;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session,SSH_LOG_PACKET,"Sending a %d bytes long packet",currentle
n);</td><td> </td><td class="right">  ssh_log(session,SSH_LOG_PACKET,"Sending a %d bytes long packet",currentle
n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* TODO FIXME</td><td> </td><td class="right">/* TODO FIXME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td> </td><td class="right">#if defined(HAVE_LIBZ) &amp;&amp; defined(WITH_LIBZ)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_out) 
{</td><td> </td><td class="right">  if (session-&gt;current_crypto &amp;&amp; session-&gt;current_crypto-&gt;do_compress_out) 
{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (compress_buffer(session, session-&gt;out_buffer) &lt; 0) {</td><td> </td><td class="right">    if (compress_buffer(session, session-&gt;out_buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      goto error;</td><td> </td><td class="right">      goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 543</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 575</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  finallen = htonl(currentlen);</td><td> </td><td class="right">  finallen = htonl(currentlen);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PACKET,</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "%d bytes after comp + %d padding bytes = %d bytes packet",</td><td> </td><td class="right">      "%d bytes after comp + %d padding bytes = %d bytes packet",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      currentlen, padding, ntohl(finallen));</td><td> </td><td class="right">      currentlen, padding, ntohl(finallen));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;padstring, padding) &lt; 0) {</td><td> </td><td class="right">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;padstring, padding) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;finallen, sizeof(u<span class="delete">32)) &lt; 0)
</span> {</td><td> </td><td class="rblock">  if (buffer_prepend_data(session-&gt;out_buffer, &amp;finallen, sizeof(u<span class="insert">int32_t))
 &lt; 0)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  crc = <span class="delete">ssh_crc32(buffer_get(session-&gt;out_buffer)</span> + <span class="delete">sizeof(u32),</span></td><td> </td><td class="rblock">  crc = <span class="insert">ssh_crc32((char *)buffer_get(session-&gt;out_buffer)</span> + <span class="insert">sizeof(uint32_t</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_get_len(session-&gt;out_buffer) - <span class="delete">sizeof(u32));</span></td><td> </td><td class="rblock"><span class="insert">),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      buffer_get_len(session-&gt;out_buffer) - <span class="insert">sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(session-&gt;out_buffer, ntohl(crc)) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u32(session-&gt;out_buffer, ntohl(crc)) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_hexa("Clear packet", buffer_get(session-&gt;out_buffer),</td><td> </td><td class="right">  ssh_print_hexa("Clear packet", buffer_get(session-&gt;out_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(session-&gt;out_buffer));</td><td> </td><td class="right">      buffer_get_len(session-&gt;out_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  packet_encrypt(session, <span class="delete">buffer_get(session-&gt;out_buffer)</span> + <span class="delete">sizeof(u32),</span></td><td> </td><td class="rblock">  packet_encrypt(session, <span class="insert">(unsigned char *)buffer_get(session-&gt;out_buffer)</span> </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_get_len(session-&gt;out_buffer) - <span class="delete">sizeof(u32));</span></td><td> </td><td class="rblock">+ <span class="insert">sizeof(uint32_t),</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      buffer_get_len(session-&gt;out_buffer) - <span class="insert">sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_hexa("encrypted packet",buffer_get(session-&gt;out_buffer),</td><td> </td><td class="right">  ssh_print_hexa("encrypted packet",buffer_get(session-&gt;out_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(session-&gt;out_buffer));</td><td> </td><td class="right">      buffer_get_len(session-&gt;out_buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ssh_socket_write(session-&gt;socket, buffer_get(session-&gt;out_buffer),</td><td> </td><td class="right">  if (ssh_socket_write(session-&gt;socket, buffer_get(session-&gt;out_buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(session-&gt;out_buffer)) == SSH_ERROR) {</td><td> </td><td class="right">      buffer_get_len(session-&gt;out_buffer)) == SSH_ERROR) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 584</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 616</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_reinit(session-&gt;out_buffer) &lt; 0) {</td><td> </td><td class="right">  if (buffer_reinit(session-&gt;out_buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    rc = SSH_ERROR;</td><td> </td><td class="right">    rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;     /* SSH_OK, AGAIN or ERROR */</td><td> </td><td class="right">  return rc;     /* SSH_OK, AGAIN or ERROR */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* WITH_SSH1 */</td><td> </td><td class="right">#endif /* WITH_SSH1 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">packet_send(SSH_SESSION *session)</span> {</td><td> </td><td class="rblock">int <span class="insert">packet_send(ssh_session session)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">#ifdef <span class="delete">HAVE_SSH1</span></td><td> </td><td class="rblock">#ifdef <span class="insert">WITH_SSH1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;version == 1) {</td><td> </td><td class="right">  if (session-&gt;version == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return packet_send1(session);</td><td> </td><td class="right">    return packet_send1(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return packet_send2(session);</td><td> </td><td class="right">  return packet_send2(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">packet_parse(SSH_SESSION *session)</span> {</td><td> </td><td class="rblock">void <span class="insert">packet_parse(ssh_session session)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *error_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string error_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *error = NULL;</td><td> </td><td class="right">  char *error = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">int</span> type = session-&gt;in_packet.type;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> type = session-&gt;in_packet.type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> tmp;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;version == 1) {</td><td> </td><td class="right">  if (session-&gt;version == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* SSH-1 */</td><td> </td><td class="right">    /* SSH-1 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    switch(type) {</td><td> </td><td class="right">    switch(type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH_MSG_DISCONNECT:</td><td> </td><td class="right">      case SSH_MSG_DISCONNECT:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_PACKET, "Received SSH_MSG_DISCONNECT");</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_PACKET, "Received SSH_MSG_DISCONNECT");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL, "Received SSH_MSG_DISCONNECT");</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL, "Received SSH_MSG_DISCONNECT");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_socket_close(session-&gt;socket);</td><td> </td><td class="right">        ssh_socket_close(session-&gt;socket);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l10" /><small>skipping to change at</small><em> line 654</em></th><th> </th><th><a name="part-r10" /><small>skipping to change at</small><em> line 686</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        session-&gt;alive = 0;</td><td> </td><td class="right">        session-&gt;alive = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return;</td><td> </td><td class="right">        return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_WINDOW_ADJUST:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_WINDOW_ADJUST:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_DATA:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_DATA:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_EXTENDED_DATA:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_EXTENDED_DATA:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_REQUEST:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_REQUEST:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_EOF:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_EOF:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_CLOSE:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_CLOSE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        channel_handle(session,type);</td><td> </td><td class="right">        channel_handle(session,type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_IGNORE:</td><td> </td><td class="right">      case SSH2_MSG_IGNORE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_DEBUG:</td><td> </td><td class="right">      case SSH2_MSG_DEBUG:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return;</td><td> </td><td class="right">        return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      <span class="insert">case SSH2_MSG_SERVICE_REQUEST:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      case SSH2_MSG_USERAUTH_REQUEST:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      case SSH2_MSG_CHANNEL_OPEN:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        message_handle(session,type);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      default:</td><td> </td><td class="right">      default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_RARE, "Received unhandled packet %d", type
);</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_RARE, "Received unhandled packet %d", type
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_wait1(<span class="delete">SSH_SESSION *</span>session, int type, int blocking) {</td><td> </td><td class="rblock">static int packet_wait1(<span class="insert">ssh_session </span>session, int type, int blocking) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PROTOCOL, "packet_wait1 waiting for %d", type);</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PROTOCOL, "packet_wait1 waiting for %d", type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if ((packet_read1(session) != SSH_OK) ||</td><td> </td><td class="right">    if ((packet_read1(session) != SSH_OK) ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        (packet_translate(session) != SSH_OK)) {</td><td> </td><td class="right">        (packet_translate(session) != SSH_OK)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return SSH_ERROR;</td><td> </td><td class="right">      return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l11" /><small>skipping to change at</small><em> line 723</em></th><th> </th><th><a name="part-r11" /><small>skipping to change at</small><em> line 761</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return SSH_OK;</td><td> </td><td class="right">      return SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } while(1);</td><td> </td><td class="right">  } while(1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return SSH_OK;</td><td> </td><td class="right">  return SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* WITH_SSH1 */</td><td> </td><td class="right">#endif /* WITH_SSH1 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int packet_wait2(<span class="delete">SSH_SESSION *</span>session, int type, int blocking) {</td><td> </td><td class="rblock">static int packet_wait2(<span class="insert">ssh_session </span>session, int type, int blocking) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    rc = packet_read2(session);</td><td> </td><td class="right">    rc = packet_read2(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (rc != SSH_OK) {</td><td> </td><td class="right">    if (rc != SSH_OK) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return rc;</td><td> </td><td class="right">      return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (packet_translate(session) != SSH_OK) {</td><td> </td><td class="right">    if (packet_translate(session) != SSH_OK) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l12" /><small>skipping to change at</small><em> line 749</em></th><th> </th><th><a name="part-r12" /><small>skipping to change at</small><em> line 787</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        packet_parse(session);</td><td> </td><td class="right">        packet_parse(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_log(session, SSH_LOG_PACKET, "received disconnect packet");</td><td> </td><td class="right">        ssh_log(session, SSH_LOG_PACKET, "received disconnect packet");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        leave_function();</td><td> </td><td class="right">        leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return SSH_ERROR;</td><td> </td><td class="right">        return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_WINDOW_ADJUST:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_WINDOW_ADJUST:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_DATA:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_DATA:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_EXTENDED_DATA:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_EXTENDED_DATA:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_REQUEST:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_REQUEST:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_EOF:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_EOF:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_CHANNEL_CLOSE:</td><td> </td><td class="right">      case SSH2_MSG_CHANNEL_CLOSE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      <span class="insert">case SSH2_MSG_SERVICE_REQUEST:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      case SSH2_MSG_USERAUTH_REQUEST:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      case SSH2_MSG_CHANNEL_OPEN:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        packet_parse(session);</td><td> </td><td class="right">        packet_parse(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      case SSH2_MSG_IGNORE:</td><td> </td><td class="right">      case SSH2_MSG_IGNORE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      case SSH2_MSG_DEBUG:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      default:</td><td> </td><td class="right">      default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (type &amp;&amp; (type != session-&gt;in_packet.type)) {</td><td> </td><td class="right">        if (type &amp;&amp; (type != session-&gt;in_packet.type)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">          ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              "packet_wait2(): Received a %d type packet, but expected a %d
\n",</td><td> </td><td class="right">              "packet_wait2(): Received a %d type packet, but expected a %d
\n",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              session-&gt;in_packet.type, type);</td><td> </td><td class="right">              session-&gt;in_packet.type, type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          leave_function();</td><td> </td><td class="right">          leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          return SSH_ERROR;</td><td> </td><td class="right">          return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        leave_function();</td><td> </td><td class="right">        leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l13" /><small>skipping to change at</small><em> line 774</em></th><th> </th><th><a name="part-r13" /><small>skipping to change at</small><em> line 816</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (blocking == 0) {</td><td> </td><td class="right">    if (blocking == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return SSH_OK; //shouldn't it return SSH_AGAIN here ?</td><td> </td><td class="right">      return SSH_OK; //shouldn't it return SSH_AGAIN here ?</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } while(1);</td><td> </td><td class="right">  } while(1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return SSH_OK;</td><td> </td><td class="right">  return SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int packet_wait(<span class="delete">SSH_SESSION *</span>session, int type, int block) {</td><td> </td><td class="rblock">int packet_wait(<span class="insert">ssh_session </span>session, int type, int block) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SSH1</td><td> </td><td class="right">#ifdef WITH_SSH1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;version == 1) {</td><td> </td><td class="right">  if (session-&gt;version == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return packet_wait1(session, type, block);</td><td> </td><td class="right">    return packet_wait1(session, type, block);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return packet_wait2(session, type, block);</td><td> </td><td class="right">  return packet_wait2(session, type, block);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* vim: set ts=2 sw=2 et cindent: */</td><td> </td><td class="right">/* vim: set ts=2 sw=2 et cindent: */</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 54 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>62 lines changed or deleted</i></th><th><i> </i></th><th><i>110 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
