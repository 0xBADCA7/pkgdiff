<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: sftp.c - sftp.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;sftp.c&nbsp;</th><th> </th><th>&nbsp;sftp.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 36</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 36</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;errno.h&gt;</td><td> </td><td class="right">#include &lt;errno.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;fcntl.h&gt;</td><td> </td><td class="right">#include &lt;fcntl.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdlib.h&gt;</td><td> </td><td class="right">#include &lt;stdlib.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;string.h&gt;</td><td> </td><td class="right">#include &lt;string.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/types.h&gt;</td><td> </td><td class="right">#include &lt;sys/types.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/stat.h&gt;</td><td> </td><td class="right">#include &lt;sys/stat.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;arpa/inet.h&gt;</td><td> </td><td class="right">#include &lt;arpa/inet.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#define S_IFSOCK 0140000</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#define S_IFLNK  0120000</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef _MSC_VER</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#define S_IFBLK  0060000</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#define S_IFIFO  0010000</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/ssh2.h"</td><td> </td><td class="right">#include "libssh/ssh2.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/sftp.h"</td><td> </td><td class="right">#include "libssh/sftp.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/channels.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/misc.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SFTP</td><td> </td><td class="right">#ifdef WITH_SFTP</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define sftp_enter_function() _enter_function(sftp-&gt;channel-&gt;session)</td><td> </td><td class="right">#define sftp_enter_function() _enter_function(sftp-&gt;channel-&gt;session)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define sftp_leave_function() _leave_function(sftp-&gt;channel-&gt;session)</td><td> </td><td class="right">#define sftp_leave_function() _leave_function(sftp-&gt;channel-&gt;session)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">struct sftp_ext_struct {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  unsigned int count;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  char **name;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  char **data;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">};</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* functions */</td><td> </td><td class="right">/* functions */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">sftp_enqueue(SFTP_SESSION *session, SFTP_MESSAGE *msg);</span></td><td> </td><td class="rblock">static int <span class="insert">sftp_enqueue(sftp_session session, sftp_message msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void <span class="delete">sftp_message_free(SFTP_MESSAGE *msg);</span></td><td> </td><td class="rblock">static void <span class="insert">sftp_message_free(sftp_message msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void <span class="delete">sftp_set_error(SFTP_SESSION *sftp,</span> int errnum);</td><td> </td><td class="rblock">static void <span class="insert">sftp_set_error(sftp_session sftp,</span> int errnum);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void <span class="delete">status_msg_free(STATUS_MESSAGE *status);</span></td><td> </td><td class="rblock">static void <span class="insert">status_msg_free(sftp_status_message status);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">static sftp_ext sftp_ext_new(void) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_ext ext;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ext = malloc(sizeof(struct sftp_ext_struct));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ZERO_STRUCTP(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_SESSION *sftp_new(SSH_SESSION *session){</span></td><td> </td><td class="rblock">  <span class="insert">return ext;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_SESSION *sftp;</span></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">static void sftp_ext_free(sftp_ext ext) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  unsigned int i;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (ext-&gt;count) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    for (i = 0; i &lt; ext-&gt;count; i++) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext-&gt;name[i]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext-&gt;data[i]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    SAFE_FREE(ext-&gt;name);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    SAFE_FREE(ext-&gt;data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  SAFE_FREE(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">sftp_session sftp_new(ssh_session session){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_session sftp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session == NULL) {</td><td> </td><td class="right">  if (session == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  sftp = malloc(sizeof(<span class="delete">SFTP_SESSION</span>));</td><td> </td><td class="rblock">  sftp = malloc(sizeof(<span class="insert">struct sftp_session_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp == NULL) {</td><td> </td><td class="right">  if (sftp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">memset(sftp,0,sizeof(SFTP_SESSION));</span></td><td> </td><td class="rblock">  <span class="insert">ZERO_STRUCTP(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp-&gt;ext = sftp_ext_new();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp-&gt;ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    SAFE_FREE(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_leave_function();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;session = session;</td><td> </td><td class="right">  sftp-&gt;session = session;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;channel = channel_new(session);</td><td> </td><td class="right">  sftp-&gt;channel = channel_new(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp-&gt;channel == NULL) {</td><td> </td><td class="right">  if (sftp-&gt;channel == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(sftp);</td><td> </td><td class="right">    SAFE_FREE(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (channel_open_session(sftp-&gt;channel)) {</td><td> </td><td class="right">  if (channel_open_session(sftp-&gt;channel)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 96</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 154</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_free(sftp);</td><td> </td><td class="right">    sftp_free(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp;</td><td> </td><td class="right">  return sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef WITH_SERVER</td><td> </td><td class="right">#ifdef WITH_SERVER</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_SESSION *sftp_server_new(SSH_SESSION *session, CHANNEL *chan){</span></td><td> </td><td class="rblock"><span class="insert">sftp_session sftp_server_new(ssh_session session, ssh_channel chan){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_SESSION *sftp</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">  sftp_session sftp</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  sftp = malloc(sizeof(<span class="delete">SFTP_SESSION</span>));</td><td> </td><td class="rblock">  sftp = malloc(sizeof(<span class="insert">struct sftp_session_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp == NULL) {</td><td> </td><td class="right">  if (sftp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(sftp);</td><td> </td><td class="right">  ZERO_STRUCTP(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;session = session;</td><td> </td><td class="right">  sftp-&gt;session = session;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;channel = chan;</td><td> </td><td class="right">  sftp-&gt;channel = chan;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp;</td><td> </td><td class="right">  return sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_server_init(SFTP_SESSION *sftp){</span></td><td> </td><td class="rblock">int <span class="insert">sftp_server_init(sftp_session sftp){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  struct</span> ssh_session <span class="delete">*session</span> = sftp-&gt;session;</td><td> </td><td class="rblock">  ssh_session <span class="insert">session</span> = sftp-&gt;session;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_PACKET *packet</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_packet packet</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *reply</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer reply</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> version;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> version;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packet = sftp_packet_read(sftp);</td><td> </td><td class="right">  packet = sftp_packet_read(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet == NULL) {</td><td> </td><td class="right">  if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet-&gt;type != SSH_FXP_INIT) {</td><td> </td><td class="right">  if (packet-&gt;type != SSH_FXP_INIT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 146</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 205</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_get_u32(packet-&gt;payload, &amp;version);</td><td> </td><td class="right">  buffer_get_u32(packet-&gt;payload, &amp;version);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  version = ntohl(version);</td><td> </td><td class="right">  version = ntohl(version);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PACKET, "Client version: %d", version);</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PACKET, "Client version: %d", version);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;client_version = version;</td><td> </td><td class="right">  sftp-&gt;client_version = version;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_packet_free(packet);</td><td> </td><td class="right">  sftp_packet_free(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  reply = buffer_new();</td><td> </td><td class="right">  reply = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (reply == NULL) {</td><td> </td><td class="right">  if (reply == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(reply, ntohl(LIBSFTP_VERSION)) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u32(reply, ntohl(LIBSFTP_VERSION)) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(reply);</td><td> </td><td class="right">    buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp_packet_write(sftp, SSH_FXP_VERSION, reply) &lt; 0) {</td><td> </td><td class="right">  if (sftp_packet_write(sftp, SSH_FXP_VERSION, reply) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(reply);</td><td> </td><td class="right">    buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 176</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 237</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp-&gt;version = LIBSFTP_VERSION;</td><td> </td><td class="right">    sftp-&gt;version = LIBSFTP_VERSION;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp-&gt;version=version;</td><td> </td><td class="right">    sftp-&gt;version=version;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* WITH_SERVER */</td><td> </td><td class="right">#endif /* WITH_SERVER */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">sftp_free(SFTP_SESSION *sftp){</span></td><td> </td><td class="rblock">void <span class="insert">sftp_free(sftp_session sftp){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  struct request_queue *ptr;</span></td><td> </td><td class="rblock"><span class="insert">  sftp_request_queue ptr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp == NULL) {</td><td> </td><td class="right">  if (sftp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  channel_send_eof(sftp-&gt;channel);</td><td> </td><td class="right">  channel_send_eof(sftp-&gt;channel);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ptr = sftp-&gt;queue;</td><td> </td><td class="right">  ptr = sftp-&gt;queue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while(ptr) {</td><td> </td><td class="right">  while(ptr) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    s<span class="delete">truct request_queue *</span>old;</td><td> </td><td class="rblock">    s<span class="insert">ftp_request_queue </span>old;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(ptr-&gt;message);</td><td> </td><td class="right">    sftp_message_free(ptr-&gt;message);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    old = ptr-&gt;next;</td><td> </td><td class="right">    old = ptr-&gt;next;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(ptr);</td><td> </td><td class="right">    SAFE_FREE(ptr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ptr = old;</td><td> </td><td class="right">    ptr = old;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  channel_free(sftp-&gt;channel);</td><td> </td><td class="right">  channel_free(sftp-&gt;channel);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">memset(sftp, 0, sizeof(*sftp));</span></td><td> </td><td class="rblock">  <span class="insert">sftp_ext_free(sftp-&gt;ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ZERO_STRUCTP(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(sftp);</td><td> </td><td class="right">  SAFE_FREE(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_packet_write(<span class="delete">SFTP_SESSION *sftp,u8 type, BUFFER *</span>payload){</td><td> </td><td class="rblock">int sftp_packet_write(<span class="insert">sftp_session sftp, uint8_t type, ssh_buffer </span>payload){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int size;</td><td> </td><td class="right">  int size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_prepend_data(payload, &amp;type, <span class="delete">sizeof(u8))</span> &lt; 0) {</td><td> </td><td class="rblock">  if (buffer_prepend_data(payload, &amp;type, <span class="insert">sizeof(uint8_t))</span> &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = htonl(buffer_get_len(payload));</td><td> </td><td class="right">  size = htonl(buffer_get_len(payload));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_prepend_data(payload, &amp;size, <span class="delete">sizeof(u32))</span> &lt; 0) {</td><td> </td><td class="rblock">  if (buffer_prepend_data(payload, &amp;size, <span class="insert">sizeof(uint32_t))</span> &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = channel_write(sftp-&gt;channel, buffer_get(payload),</td><td> </td><td class="right">  size = channel_write(sftp-&gt;channel, buffer_get(payload),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_get_len(payload));</td><td> </td><td class="right">      buffer_get_len(payload));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (size &lt; 0) {</td><td> </td><td class="right">  if (size &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  } else if((u<span class="delete">32</span>) size != buffer_get_len(payload)) {</td><td> </td><td class="rblock">  } else if((u<span class="insert">int32_t</span>) size != buffer_get_len(payload)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_log(sftp-&gt;session, SSH_LOG_PACKET,</td><td> </td><td class="right">    ssh_log(sftp-&gt;session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Had to write %d bytes, wrote only %d",</td><td> </td><td class="right">        "Had to write %d bytes, wrote only %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_get_len(payload),</td><td> </td><td class="right">        buffer_get_len(payload),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        size);</td><td> </td><td class="right">        size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return size;</td><td> </td><td class="right">  return size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_PACKET *sftp_packet_read(SFTP_SESSION *sftp)</span> {</td><td> </td><td class="rblock"><span class="insert">sftp_packet sftp_packet_read(sftp_session sftp)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_PACKET *packet</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_packet packet</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> size;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  packet = malloc(sizeof(<span class="delete">SFTP_PACKET</span>));</td><td> </td><td class="rblock">  packet = malloc(sizeof(<span class="insert">struct sftp_packet_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet == NULL) {</td><td> </td><td class="right">  if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packet-&gt;sftp = sftp;</td><td> </td><td class="right">  packet-&gt;sftp = sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packet-&gt;payload = buffer_new();</td><td> </td><td class="right">  packet-&gt;payload = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet-&gt;payload == NULL) {</td><td> </td><td class="right">  if (packet-&gt;payload == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(packet);</td><td> </td><td class="right">    SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, 4, 0) &lt;= 0) {</td><td> </td><td class="right">  if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, 4, 0) &lt;= 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(packet-&gt;payload);</td><td> </td><td class="right">    buffer_free(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(packet);</td><td> </td><td class="right">    SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_get_u32(packet-&gt;payload, &amp;size) <span class="delete">&lt; 0)</span> {</td><td> </td><td class="rblock">  if (buffer_get_u32(packet-&gt;payload, &amp;size) <span class="insert">!= sizeof(uint32_t))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">ssh_set_error(sftp-&gt;session, SSH_FATAL, "Short sftp packet!");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(packet-&gt;payload);</td><td> </td><td class="right">    buffer_free(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(packet);</td><td> </td><td class="right">    SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = ntohl(size);</td><td> </td><td class="right">  size = ntohl(size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, 1, 0) &lt;= 0) {</td><td> </td><td class="right">  if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, 1, 0) &lt;= 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* TODO: check if there are cases where an error needs to be set here *
/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(packet-&gt;payload);</td><td> </td><td class="right">    buffer_free(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(packet);</td><td> </td><td class="right">    SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_get_u8(packet-&gt;payload, &amp;packet-&gt;type);</td><td> </td><td class="right">  buffer_get_u8(packet-&gt;payload, &amp;packet-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (size &gt; 1) {</td><td> </td><td class="right">  if (size &gt; 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, size - 1, 0) &lt;=
 0) {</td><td> </td><td class="right">    if (channel_read_buffer(sftp-&gt;channel, packet-&gt;payload, size - 1, 0) &lt;=
 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      /* TODO: check if there are cases where an error needs to be set here
 */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(packet-&gt;payload);</td><td> </td><td class="right">      buffer_free(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      SAFE_FREE(packet);</td><td> </td><td class="right">      SAFE_FREE(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_leave_function();</td><td> </td><td class="right">      sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return packet;</td><td> </td><td class="right">  return packet;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void sftp_set_error(<span class="delete">SFTP_SESSION *</span>sftp, int errnum) {</td><td> </td><td class="rblock">static void sftp_set_error(<span class="insert">sftp_session </span>sftp, int errnum) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp != NULL) {</td><td> </td><td class="right">  if (sftp != NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp-&gt;errnum = errnum;</td><td> </td><td class="right">    sftp-&gt;errnum = errnum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Get the last sftp error */</td><td> </td><td class="right">/* Get the last sftp error */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_get_error(<span class="delete">SFTP_SESSION *</span>sftp) {</td><td> </td><td class="rblock">int sftp_get_error(<span class="insert">sftp_session </span>sftp) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp == NULL) {</td><td> </td><td class="right">  if (sftp == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp-&gt;errnum;</td><td> </td><td class="right">  return sftp-&gt;errnum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_MESSAGE *sftp_message_new(SFTP_SESSION *sftp){</span></td><td> </td><td class="rblock">static <span class="insert">sftp_message sftp_message_new(sftp_session sftp){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">  sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  msg = malloc(sizeof(<span class="delete">SFTP_MESSAGE</span>));</td><td> </td><td class="rblock">  msg = malloc(sizeof(<span class="insert">struct sftp_message_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg == NULL) {</td><td> </td><td class="right">  if (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(msg);</td><td> </td><td class="right">  ZERO_STRUCTP(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg-&gt;payload = buffer_new();</td><td> </td><td class="right">  msg-&gt;payload = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg-&gt;payload == NULL) {</td><td> </td><td class="right">  if (msg-&gt;payload == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(msg);</td><td> </td><td class="right">    SAFE_FREE(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg-&gt;sftp = sftp;</td><td> </td><td class="right">  msg-&gt;sftp = sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return msg;</td><td> </td><td class="right">  return msg;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void <span class="delete">sftp_message_free(SFTP_MESSAGE *msg)</span> {</td><td> </td><td class="rblock">static void <span class="insert">sftp_message_free(sftp_message msg)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_SESSION *sftp;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_session sftp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg == NULL) {</td><td> </td><td class="right">  if (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp = msg-&gt;sftp;</td><td> </td><td class="right">  sftp = msg-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(msg-&gt;payload);</td><td> </td><td class="right">  buffer_free(msg-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(msg);</td><td> </td><td class="right">  SAFE_FREE(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_MESSAGE *sftp_get_message(SFTP_PACKET *packet)</span> {</td><td> </td><td class="rblock">static <span class="insert">sftp_message sftp_get_message(sftp_packet packet)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_SESSION *sftp</span> = packet-&gt;sftp;</td><td> </td><td class="rblock">  <span class="insert">sftp_session sftp</span> = packet-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg = sftp_message_new(sftp);</td><td> </td><td class="right">  msg = sftp_message_new(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg == NULL) {</td><td> </td><td class="right">  if (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg-&gt;sftp = packet-&gt;sftp;</td><td> </td><td class="right">  msg-&gt;sftp = packet-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg-&gt;packet_type = packet-&gt;type;</td><td> </td><td class="right">  msg-&gt;packet_type = packet-&gt;type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if ((packet-&gt;type != SSH_FXP_STATUS) &amp;&amp; (packet-&gt;type!=SSH_FXP_HANDLE) &amp;&amp;</td><td> </td><td class="right">  if ((packet-&gt;type != SSH_FXP_STATUS) &amp;&amp; (packet-&gt;type!=SSH_FXP_HANDLE) &amp;&amp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      (packet-&gt;type != SSH_FXP_DATA) &amp;&amp; (packet-&gt;type != SSH_FXP_ATTRS) &amp;&amp;</td><td> </td><td class="right">      (packet-&gt;type != SSH_FXP_DATA) &amp;&amp; (packet-&gt;type != SSH_FXP_ATTRS) &amp;&amp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      (packet-&gt;type != SSH_FXP_NAME)) {</td><td> </td><td class="rblock">      (packet-&gt;type != SSH_FXP_NAME)<span class="insert"> &amp;&amp; (packet-&gt;type != SSH_FXP_EXTENDED_R
EPLY)</span>) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(packet-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(packet-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Unknown packet type %d", packet-&gt;type);</td><td> </td><td class="right">        "Unknown packet type %d", packet-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_get_u32(packet-&gt;payload, &amp;msg-&gt;id) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">  if (buffer_get_u32(packet-&gt;payload, &amp;msg-&gt;id) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(packet-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(packet-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Invalid packet %d: no ID", packet-&gt;type);</td><td> </td><td class="right">        "Invalid packet %d: no ID", packet-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(packet-&gt;sftp-&gt;session, SSH_LOG_PACKET,</td><td> </td><td class="right">  ssh_log(packet-&gt;sftp-&gt;session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Packet with id %d type %d",</td><td> </td><td class="right">      "Packet with id %d type %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      msg-&gt;id,</td><td> </td><td class="right">      msg-&gt;id,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      msg-&gt;packet_type);</td><td> </td><td class="right">      msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_data(msg-&gt;payload, buffer_get_rest(packet-&gt;payload),</td><td> </td><td class="right">  if (buffer_add_data(msg-&gt;payload, buffer_get_rest(packet-&gt;payload),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_get_rest_len(packet-&gt;payload)) &lt; 0) {</td><td> </td><td class="right">        buffer_get_rest_len(packet-&gt;payload)) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return msg;</td><td> </td><td class="right">  return msg;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">sftp_read_and_dispatch(SFTP_SESSION *sftp)</span> {</td><td> </td><td class="rblock">static int <span class="insert">sftp_read_and_dispatch(sftp_session sftp)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_PACKET *packet</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_packet packet</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packet = sftp_packet_read(sftp);</td><td> </td><td class="right">  packet = sftp_packet_read(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet == NULL) {</td><td> </td><td class="right">  if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1; /* something nasty happened reading the packet */</td><td> </td><td class="right">    return -1; /* something nasty happened reading the packet */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  msg = sftp_get_message(packet);</td><td> </td><td class="right">  msg = sftp_get_message(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 409</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 481</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp_enqueue(sftp, msg) &lt; 0) {</td><td> </td><td class="right">  if (sftp_enqueue(sftp, msg) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void sftp_packet_free(<span class="delete">SFTP_PACKET *</span>packet) {</td><td> </td><td class="rblock">void sftp_packet_free(<span class="insert">sftp_packet </span>packet) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet == NULL) {</td><td> </td><td class="right">  if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(packet-&gt;payload);</td><td> </td><td class="right">  buffer_free(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  free(packet);</td><td> </td><td class="right">  free(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Initialize the sftp session with the server. */</td><td> </td><td class="right">/* Initialize the sftp session with the server. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_init(SFTP_SESSION *sftp)</span> {</td><td> </td><td class="rblock">int <span class="insert">sftp_init(sftp_session sftp)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_PACKET *packet</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_packet packet</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *ext_name_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string ext_name_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *ext_data_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string ext_data_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *ext_name = NULL;</td><td> </td><td class="right">  char *ext_name = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *ext_data = NULL;</td><td> </td><td class="right">  char *ext_data = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32</span> version = htonl(LIBSFTP_VERSION);</td><td> </td><td class="rblock">  u<span class="insert">int32_t</span> version = htonl(LIBSFTP_VERSION);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if <span class="delete">((buffer_add_u32(buffer,</span> version) &lt; 0) <span class="delete">||</span></td><td> </td><td class="rblock">  if <span class="insert">(buffer_add_u32(buffer,</span> version) &lt; 0) <span class="insert">{</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_INIT, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_leave_function();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_INIT, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packet = sftp_packet_read(sftp);</td><td> </td><td class="right">  packet = sftp_packet_read(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet == NULL) {</td><td> </td><td class="right">  if (packet == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (packet-&gt;type != SSH_FXP_VERSION) {</td><td> </td><td class="right">  if (packet-&gt;type != SSH_FXP_VERSION) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received a %d messages instead of SSH_FXP_VERSION", packet-&gt;type);</td><td> </td><td class="right">        "Received a %d messages instead of SSH_FXP_VERSION", packet-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_packet_free(packet);</td><td> </td><td class="right">    sftp_packet_free(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">buffer_get_u32(packet-&gt;payload,&amp;version);</span></td><td> </td><td class="rblock">  <span class="insert">/* TODO: are we sure there are 4 bytes ready? */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer_get_u32(packet-&gt;payload, &amp;version);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  version = ntohl(version);</td><td> </td><td class="right">  version = ntohl(version);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">ssh_log(sftp-&gt;session, SSH_LOG_RARE,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      "SFTP server version %d",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      version);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ext_name_s = buffer_get_ssh_string(packet-&gt;payload);</td><td> </td><td class="right">  ext_name_s = buffer_get_ssh_string(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ext_data_s = buffer_get_ssh_string(packet-&gt;payload);</td><td> </td><td class="rblock">  <span class="insert">while (ext_name_s != NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if <span class="delete">(ext_name_s == NULL ||</span> (ext_data_s == <span class="delete">NULL))</span> {</td><td> </td><td class="rblock"><span class="insert">    int count = sftp-&gt;ext-&gt;count;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    string_free(ext_name_s);</td><td> </td><td class="rblock"><span class="insert">    char **tmp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">string_free(ext_data_s);</span></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    ssh_log(sftp-&gt;session, SSH_LOG_RARE,</span></td><td> </td><td class="rblock">    ext_data_s = buffer_get_ssh_string(packet-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">        "SFTP server version %d", version);</span></td><td> </td><td class="rblock">    if (ext_data_s == <span class="insert">NULL)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  } <span class="delete">else {</span></td><td> </td><td class="rblock">      string_free(ext_name_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      <span class="insert">break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ext_name = string_to_char(ext_name_s);</td><td> </td><td class="right">    ext_name = string_to_char(ext_name_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ext_data = string_to_char(ext_data_s);</td><td> </td><td class="right">    ext_data = string_to_char(ext_data_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">if (ext_name == NULL || ext_data == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_name);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_name_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_data_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_log(sftp-&gt;session, SSH_LOG_RARE,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "SFTP server extension: %s, version: %s",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        ext_name, ext_data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    if <span class="delete">(ext_name != NULL || ext_data !=</span> NULL) {</td><td> </td><td class="rblock">    <span class="insert">count++;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      <span class="delete">ssh_log(sftp-&gt;session, SSH_LOG_RARE,</span></td><td> </td><td class="rblock"><span class="insert">    tmp = realloc(sftp-&gt;ext-&gt;name, count * sizeof(char *));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          "SFTP server version %d (%s,%s)",</span></td><td> </td><td class="rblock">    if <span class="insert">(tmp ==</span> NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          version, ext_name, ext_data);</span></td><td> </td><td class="rblock">      <span class="insert">ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    } <span class="delete">else</span> {</td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_name);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      <span class="delete">ssh_log(sftp-&gt;session, SSH_LOG_RARE,</span></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          "SFTP server version %d", version);</span></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_name_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_data_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">tmp[count - 1] = ext_name;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp-&gt;ext-&gt;name = tmp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    tmp = realloc(sftp-&gt;ext-&gt;data, count * sizeof(char *));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (tmp == NULL)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      <span class="insert">ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_name);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(ext_data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_name_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(ext_data_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">SAFE_FREE(ext_name);</span></td><td> </td><td class="rblock">    <span class="insert">tmp[count - 1] = ext_data;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    SAFE_FREE(ext_data);</span></td><td> </td><td class="rblock"><span class="insert">    sftp-&gt;ext-&gt;data = tmp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp-&gt;ext-&gt;count = count;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext_name_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext_data_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ext_name_s = buffer_get_ssh_string(packet-&gt;payload);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">string_free(ext_name_s);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  string_free(ext_data_s);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_packet_free(packet);</td><td> </td><td class="right">  sftp_packet_free(packet);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp-&gt;version = sftp-&gt;server_version = version;</td><td> </td><td class="right">  sftp-&gt;version = sftp-&gt;server_version = version;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                                                                           </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">static REQUEST_QUEUE *request_queue_new(SFTP_MESSAGE *msg)</span> {</td><td> </td><td class="rblock"><span class="insert">unsigned int sftp_extensions_get_count(sftp_session sftp)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">REQUEST_QUEUE *queue = NULL;</span></td><td> </td><td class="rblock">  <span class="insert">if (sftp == NULL || sftp-&gt;ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return sftp-&gt;ext-&gt;count;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  queue = <span class="delete">malloc(sizeof(REQUEST_QUEUE));</span></td><td> </td><td class="rblock"><span class="insert">const char *sftp_extensions_get_name(sftp_session sftp, unsigned int idx) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp == NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp-&gt;ext == NULL || sftp-&gt;ext-&gt;name == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (idx &gt; sftp-&gt;ext-&gt;count) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return sftp-&gt;ext-&gt;name[idx];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">const char *sftp_extensions_get_data(sftp_session sftp, unsigned int idx) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp == NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp-&gt;ext == NULL || sftp-&gt;ext-&gt;name == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (idx &gt; sftp-&gt;ext-&gt;count) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return sftp-&gt;ext-&gt;data[idx];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">int sftp_extension_supported(sftp_session sftp, const char *name,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    const char *data) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  int i, n;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  n = sftp_extensions_get_count(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  for (i = 0; i &lt; n; i++) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (strcmp(sftp_extensions_get_name(sftp, i), name) == 0 &amp;&amp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        strcmp(sftp_extensions_get_data(sftp, i), data) == 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return 1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">static sftp_request_queue request_queue_new(sftp_message msg) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_request_queue queue = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  queue = <span class="insert">malloc(sizeof(struct sftp_request_queue_struct));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (queue == NULL) {</td><td> </td><td class="right">  if (queue == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(msg-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(queue);</td><td> </td><td class="right">  ZERO_STRUCTP(queue);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  queue-&gt;message = msg;</td><td> </td><td class="right">  queue-&gt;message = msg;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return queue;</td><td> </td><td class="right">  return queue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void request_queue_free(<span class="delete">REQUEST_QUEUE *</span>queue) {</td><td> </td><td class="rblock">static void request_queue_free(<span class="insert">sftp_request_queue </span>queue) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (queue == NULL) {</td><td> </td><td class="right">  if (queue == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(queue);</td><td> </td><td class="right">  ZERO_STRUCTP(queue);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(queue);</td><td> </td><td class="right">  SAFE_FREE(queue);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">sftp_enqueue(SFTP_SESSION *sftp, SFTP_MESSAGE *msg)</span> {</td><td> </td><td class="rblock">static int <span class="insert">sftp_enqueue(sftp_session sftp, sftp_message msg)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">REQUEST_QUEUE *queue</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_request_queue queue</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">REQUEST_QUEUE *ptr;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_request_queue ptr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  queue = request_queue_new(msg);</td><td> </td><td class="right">  queue = request_queue_new(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (queue == NULL) {</td><td> </td><td class="right">  if (queue == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(sftp-&gt;session, SSH_LOG_PACKET,</td><td> </td><td class="right">  ssh_log(sftp-&gt;session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Queued msg type %d id %d",</td><td> </td><td class="right">      "Queued msg type %d id %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      msg-&gt;id, msg-&gt;packet_type);</td><td> </td><td class="right">      msg-&gt;id, msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 547</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 719</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ptr-&gt;next = queue; /* add it on bottom */</td><td> </td><td class="right">    ptr-&gt;next = queue; /* add it on bottom */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Pulls of a message from the queue based on the ID.</td><td> </td><td class="right"> * Pulls of a message from the queue based on the ID.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Returns NULL if no message has been found.</td><td> </td><td class="right"> * Returns NULL if no message has been found.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_MESSAGE *sftp_dequeue(SFTP_SESSION *sftp, u32</span> id){</td><td> </td><td class="rblock">static <span class="insert">sftp_message sftp_dequeue(sftp_session sftp, uint32_t</span> id){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">REQUEST_QUEUE *prev</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_request_queue prev</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">REQUEST_QUEUE *queue;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_request_queue queue;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_MESSAGE *msg;</span></td><td> </td><td class="rblock"><span class="insert">  sftp_message msg;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(sftp-&gt;queue == NULL) {</td><td> </td><td class="right">  if(sftp-&gt;queue == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  queue = sftp-&gt;queue;</td><td> </td><td class="right">  queue = sftp-&gt;queue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (queue) {</td><td> </td><td class="right">  while (queue) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if(queue-&gt;message-&gt;id == id) {</td><td> </td><td class="right">    if(queue-&gt;message-&gt;id == id) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* remove from queue */</td><td> </td><td class="right">      /* remove from queue */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (prev == NULL) {</td><td> </td><td class="right">      if (prev == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 585</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 757</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Assigns a new SFTP ID for new requests and assures there is no collision</td><td> </td><td class="right"> * Assigns a new SFTP ID for new requests and assures there is no collision</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * between them.</td><td> </td><td class="right"> * between them.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Returns a new ID ready to use in a request</td><td> </td><td class="right"> * Returns a new ID ready to use in a request</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static inline u<span class="delete">32 sftp_get_new_id(SFTP_SESSION *</span>session) {</td><td> </td><td class="rblock">static inline u<span class="insert">int32_t sftp_get_new_id(sftp_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ++session-&gt;id_counter;</td><td> </td><td class="right">  return ++session-&gt;id_counter;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">STATUS_MESSAGE *parse_status_msg(SFTP_MESSAGE *msg){</span></td><td> </td><td class="rblock">static <span class="insert">sftp_status_message parse_status_msg(sftp_message msg){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock"><span class="insert">  sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg-&gt;packet_type != SSH_FXP_STATUS) {</td><td> </td><td class="right">  if (msg-&gt;packet_type != SSH_FXP_STATUS) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Not a ssh_fxp_status message passed in!");</td><td> </td><td class="right">        "Not a ssh_fxp_status message passed in!");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  status = malloc(sizeof(<span class="delete">STATUS_MESSAGE</span>));</td><td> </td><td class="rblock">  status = malloc(sizeof(<span class="insert">struct sftp_status_message_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (status == NULL) {</td><td> </td><td class="right">  if (status == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(msg-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(status);</td><td> </td><td class="right">  ZERO_STRUCTP(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  status-&gt;id = msg-&gt;id;</td><td> </td><td class="right">  status-&gt;id = msg-&gt;id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if <span class="delete">((buffer_get_u32(msg-&gt;payload,&amp;status-&gt;status)</span> != <span class="delete">4) ||</span></td><td> </td><td class="rblock">  if <span class="insert">(buffer_get_u32(msg-&gt;payload,&amp;status-&gt;status)</span> != <span class="insert">4){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      (status-&gt;error = buffer_get_ssh_string(msg-&gt;payload)) == NULL ||</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      (status-&gt;lang = buffer_get_ssh_string(msg-&gt;payload)) == NULL) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    string_free(status-&gt;error);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    /* status-&gt;lang never get allocated if something failed */</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(status);</td><td> </td><td class="right">    SAFE_FREE(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Invalid SSH_FXP_STATUS message");</td><td> </td><td class="right">        "Invalid SSH_FXP_STATUS message");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">status-&gt;error = buffer_get_ssh_string(msg-&gt;payload);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  status-&gt;lang = buffer_get_ssh_string(msg-&gt;payload);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(status-&gt;error == NULL || status-&gt;lang == NULL){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if(msg-&gt;sftp-&gt;version &gt;=3){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      /* These are mandatory from version 3 */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      string_free(status-&gt;error);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* status-&gt;lang never get allocated if something failed */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      SAFE_FREE(status);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "Invalid SSH_FXP_STATUS message");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  status-&gt;status = ntohl(status-&gt;status);</td><td> </td><td class="right">  status-&gt;status = ntohl(status-&gt;status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  status-&gt;errormsg = string_to_char(status-&gt;error);</td><td> </td><td class="rblock">  <span class="insert">if(status-&gt;error)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  status-&gt;langmsg = string_to_char(status-&gt;lang);</td><td> </td><td class="rblock">    status-&gt;errormsg = string_to_char(status-&gt;error);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status-&gt;errormsg = strdup("No error message in packet");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if(status-&gt;lang)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    status-&gt;langmsg = string_to_char(status-&gt;lang);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status-&gt;langmsg = strdup("");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (status-&gt;errormsg == NULL || status-&gt;langmsg == NULL) {</td><td> </td><td class="right">  if (status-&gt;errormsg == NULL || status-&gt;langmsg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(msg-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status_msg_free(status);</td><td> </td><td class="right">    status_msg_free(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return status;</td><td> </td><td class="right">  return status;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void status_msg_free(<span class="delete">STATUS_MESSAGE *</span>status){</td><td> </td><td class="rblock">static void status_msg_free(<span class="insert">sftp_status_message </span>status){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (status == NULL) {</td><td> </td><td class="right">  if (status == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(status-&gt;error);</td><td> </td><td class="right">  string_free(status-&gt;error);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(status-&gt;lang);</td><td> </td><td class="right">  string_free(status-&gt;lang);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(status-&gt;errormsg);</td><td> </td><td class="right">  SAFE_FREE(status-&gt;errormsg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(status-&gt;langmsg);</td><td> </td><td class="right">  SAFE_FREE(status-&gt;langmsg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(status);</td><td> </td><td class="right">  SAFE_FREE(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_FILE *parse_handle_msg(SFTP_MESSAGE *msg){</span></td><td> </td><td class="rblock">static <span class="insert">sftp_file parse_handle_msg(sftp_message msg){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_FILE *file;</span></td><td> </td><td class="rblock"><span class="insert">  sftp_file file;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(msg-&gt;packet_type != SSH_FXP_HANDLE) {</td><td> </td><td class="right">  if(msg-&gt;packet_type != SSH_FXP_HANDLE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Not a ssh_fxp_handle message passed in!");</td><td> </td><td class="right">        "Not a ssh_fxp_handle message passed in!");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0070" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  file = malloc(sizeof(<span class="delete">SFTP_FILE</span>));</td><td> </td><td class="rblock">  file = malloc(sizeof(<span class="insert">struct sftp_file_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0071" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(msg-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(file);</td><td> </td><td class="right">  ZERO_STRUCTP(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;handle = buffer_get_ssh_string(msg-&gt;payload);</td><td> </td><td class="right">  file-&gt;handle = buffer_get_ssh_string(msg-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file-&gt;handle == NULL) {</td><td> </td><td class="right">  if (file-&gt;handle == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(msg-&gt;sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Invalid SSH_FXP_HANDLE message");</td><td> </td><td class="right">        "Invalid SSH_FXP_HANDLE message");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(file);</td><td> </td><td class="right">    SAFE_FREE(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;sftp = msg-&gt;sftp;</td><td> </td><td class="right">  file-&gt;sftp = msg-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;offset = 0;</td><td> </td><td class="right">  file-&gt;offset = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;eof = 0;</td><td> </td><td class="right">  file-&gt;eof = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return file;</td><td> </td><td class="right">  return file;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Open a directory */</td><td> </td><td class="right">/* Open a directory */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0072" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_DIR *sftp_opendir(SFTP_SESSION *sftp,</span> const char *path){</td><td> </td><td class="rblock"><span class="insert">sftp_dir sftp_opendir(sftp_session sftp,</span> const char *path){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_FILE *file</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_file file</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_DIR *dir</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_dir dir</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *path_s;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string path_s;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *payload;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer payload;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  payload = buffer_new();</td><td> </td><td class="right">  payload = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (payload == NULL) {</td><td> </td><td class="right">  if (payload == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0073" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  path_s = string_from_char(path);</td><td> </td><td class="right">  path_s = string_from_char(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (path_s == NULL) {</td><td> </td><td class="right">  if (path_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0074" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(payload);</td><td> </td><td class="right">    buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(payload, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(payload, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(payload, path_s) &lt; 0) {</td><td> </td><td class="right">      buffer_add_ssh_string(payload, path_s) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0075" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(payload);</td><td> </td><td class="right">    buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(path_s);</td><td> </td><td class="right">    string_free(path_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(path_s);</td><td> </td><td class="right">  string_free(path_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp_packet_write(sftp, SSH_FXP_OPENDIR, payload) &lt; 0) {</td><td> </td><td class="right">  if (sftp_packet_write(sftp, SSH_FXP_OPENDIR, payload) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(payload);</td><td> </td><td class="right">    buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 729</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 922</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_set_error(sftp, status-&gt;status);</td><td> </td><td class="right">      sftp_set_error(sftp, status-&gt;status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "SFTP server: %s", status-&gt;errormsg);</td><td> </td><td class="right">          "SFTP server: %s", status-&gt;errormsg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      status_msg_free(status);</td><td> </td><td class="right">      status_msg_free(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case SSH_FXP_HANDLE:</td><td> </td><td class="right">    case SSH_FXP_HANDLE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      file = parse_handle_msg(msg);</td><td> </td><td class="right">      file = parse_handle_msg(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (file != NULL) {</td><td> </td><td class="right">      if (file != NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0076" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        dir = malloc(sizeof(<span class="delete">SFTP_DIR</span>));</td><td> </td><td class="rblock">        dir = malloc(sizeof(<span class="insert">struct sftp_dir_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (dir == NULL) {</td><td> </td><td class="right">        if (dir == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0077" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">          ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          return NULL;</td><td> </td><td class="right">          return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        }</td><td> </td><td class="right">        }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ZERO_STRUCTP(dir);</td><td> </td><td class="right">        ZERO_STRUCTP(dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        dir-&gt;sftp = sftp;</td><td> </td><td class="right">        dir-&gt;sftp = sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        dir-&gt;name = strdup(path);</td><td> </td><td class="right">        dir-&gt;name = strdup(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        if (dir-&gt;name == NULL) {</td><td> </td><td class="right">        if (dir-&gt;name == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          SAFE_FREE(dir);</td><td> </td><td class="right">          SAFE_FREE(dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          SAFE_FREE(file);</td><td> </td><td class="right">          SAFE_FREE(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          return NULL;</td><td> </td><td class="right">          return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 760</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 954</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Parse the attributes from a payload from some messages. It is coded on</td><td> </td><td class="right"> * Parse the attributes from a payload from some messages. It is coded on</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * baselines from the protocol version 4.</td><td> </td><td class="right"> * baselines from the protocol version 4.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This code is more or less dead but maybe we need it in future.</td><td> </td><td class="right"> * This code is more or less dead but maybe we need it in future.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0078" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_ATTRIBUTES *sftp_parse_attr_4(SFTP_SESSION *sftp, BUFFER *</span>buf,</td><td> </td><td class="rblock">static <span class="insert">sftp_attributes sftp_parse_attr_4(sftp_session sftp, ssh_buffer </span>buf,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int expectnames) {</td><td> </td><td class="right">    int expectnames) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0079" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES *attr;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_attributes attr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *owner</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">  ssh_string owner</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *group</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string group</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> flags = 0;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> flags = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int ok = 0;</td><td> </td><td class="right">  int ok = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* unused member variable */</td><td> </td><td class="right">  /* unused member variable */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  (void) expectnames;</td><td> </td><td class="right">  (void) expectnames;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0080" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  attr = malloc(sizeof(<span class="delete">SFTP_ATTRIBUTES</span>));</td><td> </td><td class="rblock">  attr = malloc(sizeof(<span class="insert">struct sftp_attributes_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (attr == NULL) {</td><td> </td><td class="right">  if (attr == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0081" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(attr);</td><td> </td><td class="right">  ZERO_STRUCTP(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* This isn't really a loop, but it is like a try..catch.. */</td><td> </td><td class="right">  /* This isn't really a loop, but it is like a try..catch.. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_get_u32(buf, &amp;flags) != 4) {</td><td> </td><td class="right">    if (buffer_get_u32(buf, &amp;flags) != 4) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l10" /><small>skipping to change at</small><em> line 810</em></th><th> </th><th><a name="part-r10" /><small>skipping to change at</small><em> line 1005</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_PERMISSIONS) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_PERMISSIONS) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_get_u32(buf, &amp;attr-&gt;permissions) != 4) {</td><td> </td><td class="right">      if (buffer_get_u32(buf, &amp;attr-&gt;permissions) != 4) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;permissions = ntohl(attr-&gt;permissions);</td><td> </td><td class="right">      attr-&gt;permissions = ntohl(attr-&gt;permissions);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0082" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#ifndef _WIN32</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* FIXME on windows! */</td><td> </td><td class="right">      /* FIXME on windows! */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      switch (attr-&gt;permissions &amp; S_IFMT) {</td><td> </td><td class="right">      switch (attr-&gt;permissions &amp; S_IFMT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFSOCK:</td><td> </td><td class="right">        case S_IFSOCK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFBLK:</td><td> </td><td class="right">        case S_IFBLK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFCHR:</td><td> </td><td class="right">        case S_IFCHR:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFIFO:</td><td> </td><td class="right">        case S_IFIFO:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_SPECIAL;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_SPECIAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFLNK:</td><td> </td><td class="right">        case S_IFLNK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_SYMLINK;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_SYMLINK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l11" /><small>skipping to change at</small><em> line 832</em></th><th> </th><th><a name="part-r11" /><small>skipping to change at</small><em> line 1026</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFREG:</td><td> </td><td class="right">        case S_IFREG:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_REGULAR;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_REGULAR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFDIR:</td><td> </td><td class="right">        case S_IFDIR:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_DIRECTORY;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_DIRECTORY;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        default:</td><td> </td><td class="right">        default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_UNKNOWN;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_UNKNOWN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0083" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#endif /* _WIN32 */</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_ACCESSTIME) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_ACCESSTIME) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_get_u64(buf, &amp;attr-&gt;atime64) != 8) {</td><td> </td><td class="right">      if (buffer_get_u64(buf, &amp;attr-&gt;atime64) != 8) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;atime64 = ntohll(attr-&gt;atime64);</td><td> </td><td class="right">      attr-&gt;atime64 = ntohll(attr-&gt;atime64);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_SUBSECOND_TIMES) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_SUBSECOND_TIMES) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l12" /><small>skipping to change at</small><em> line 921</em></th><th> </th><th><a name="part-r12" /><small>skipping to change at</small><em> line 1114</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(attr);</td><td> </td><td class="right">    SAFE_FREE(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL, "Invalid ATTR structure");</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL, "Invalid ATTR structure");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return attr;</td><td> </td><td class="right">  return attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0084" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">/* <span class="delete">Version 3 code. it is the only one really supported (the draft for the 4
 misses clarifications)</span> */</td><td> </td><td class="rblock">/* <span class="insert">sftp version 0-3 code. It is different from the v4</span> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* maybe a paste of the draft is better than the code */</td><td> </td><td class="right">/* maybe a paste of the draft is better than the code */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   flags</td><td> </td><td class="right">        uint32   flags</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint64   size           present only if flag SSH_FILEXFER_ATTR_SIZE</td><td> </td><td class="right">        uint64   size           present only if flag SSH_FILEXFER_ATTR_SIZE</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   uid            present only if flag SSH_FILEXFER_ATTR_UIDG
ID</td><td> </td><td class="right">        uint32   uid            present only if flag SSH_FILEXFER_ATTR_UIDG
ID</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   gid            present only if flag SSH_FILEXFER_ATTR_UIDG
ID</td><td> </td><td class="right">        uint32   gid            present only if flag SSH_FILEXFER_ATTR_UIDG
ID</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   permissions    present only if flag SSH_FILEXFER_ATTR_PERM
ISSIONS</td><td> </td><td class="right">        uint32   permissions    present only if flag SSH_FILEXFER_ATTR_PERM
ISSIONS</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   atime          present only if flag SSH_FILEXFER_ACMODTIME</td><td> </td><td class="right">        uint32   atime          present only if flag SSH_FILEXFER_ACMODTIME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   mtime          present only if flag SSH_FILEXFER_ACMODTIME</td><td> </td><td class="right">        uint32   mtime          present only if flag SSH_FILEXFER_ACMODTIME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        uint32   extended_count present only if flag SSH_FILEXFER_ATTR_EXTE
NDED</td><td> </td><td class="right">        uint32   extended_count present only if flag SSH_FILEXFER_ATTR_EXTE
NDED</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string   extended_type</td><td> </td><td class="right">        string   extended_type</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string   extended_data</td><td> </td><td class="right">        string   extended_data</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ...      more extended data (extended_type - extended_data pairs),</td><td> </td><td class="right">        ...      more extended data (extended_type - extended_data pairs),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   so that number of pairs equals extended_count           
   */</td><td> </td><td class="right">                   so that number of pairs equals extended_count           
   */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0085" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_ATTRIBUTES *sftp_parse_attr_3(SFTP_SESSION *sftp, BUFFER *</span>buf,</td><td> </td><td class="rblock">static <span class="insert">sftp_attributes sftp_parse_attr_3(sftp_session sftp, ssh_buffer </span>buf,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int expectname) {</td><td> </td><td class="right">    int expectname) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0086" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *longname</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string longname</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *name</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string name</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES *attr;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_attributes attr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> flags = 0;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> flags = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int ok = 0;</td><td> </td><td class="right">  int ok = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0087" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  attr = malloc(sizeof(<span class="delete">SFTP_ATTRIBUTES</span>));</td><td> </td><td class="rblock">  attr = malloc(sizeof(<span class="insert">struct sftp_attributes_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (attr == NULL) {</td><td> </td><td class="right">  if (attr == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0088" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(attr);</td><td> </td><td class="right">  ZERO_STRUCTP(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* This isn't really a loop, but it is like a try..catch.. */</td><td> </td><td class="right">  /* This isn't really a loop, but it is like a try..catch.. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (expectname) {</td><td> </td><td class="right">    if (expectname) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if ((name = buffer_get_ssh_string(buf)) == NULL ||</td><td> </td><td class="right">      if ((name = buffer_get_ssh_string(buf)) == NULL ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          (attr-&gt;name = string_to_char(name)) == NULL) {</td><td> </td><td class="right">          (attr-&gt;name = string_to_char(name)) == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l13" /><small>skipping to change at</small><em> line 968</em></th><th> </th><th><a name="part-r13" /><small>skipping to change at</small><em> line 1162</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(sftp-&gt;session, SSH_LOG_RARE, "Name: %s", attr-&gt;name);</td><td> </td><td class="right">      ssh_log(sftp-&gt;session, SSH_LOG_RARE, "Name: %s", attr-&gt;name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if ((longname=buffer_get_ssh_string(buf)) == NULL ||</td><td> </td><td class="right">      if ((longname=buffer_get_ssh_string(buf)) == NULL ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          (attr-&gt;longname=string_to_char(longname)) == NULL) {</td><td> </td><td class="right">          (attr-&gt;longname=string_to_char(longname)) == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(longname);</td><td> </td><td class="right">      string_free(longname);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0089" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    if (buffer_get_u32(buf, &amp;flags) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">    if (buffer_get_u32(buf, &amp;flags) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    flags = ntohl(flags);</td><td> </td><td class="right">    flags = ntohl(flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    attr-&gt;flags = flags;</td><td> </td><td class="right">    attr-&gt;flags = flags;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_log(sftp-&gt;session, SSH_LOG_RARE,</td><td> </td><td class="right">    ssh_log(sftp-&gt;session, SSH_LOG_RARE,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Flags: %.8lx\n", (long unsigned int) flags);</td><td> </td><td class="right">        "Flags: %.8lx\n", (long unsigned int) flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_SIZE) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_SIZE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0090" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if(buffer_get_u64(buf, &amp;attr-&gt;size) != sizeof(u<span class="delete">64</span>)) {</td><td> </td><td class="rblock">      if(buffer_get_u64(buf, &amp;attr-&gt;size) != sizeof(u<span class="insert">int64_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;size = ntohll(attr-&gt;size);</td><td> </td><td class="right">      attr-&gt;size = ntohll(attr-&gt;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(sftp-&gt;session, SSH_LOG_RARE,</td><td> </td><td class="right">      ssh_log(sftp-&gt;session, SSH_LOG_RARE,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Size: %llu\n",</td><td> </td><td class="right">          "Size: %llu\n",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          (long long unsigned int) attr-&gt;size);</td><td> </td><td class="right">          (long long unsigned int) attr-&gt;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_UIDGID) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_UIDGID) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0091" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;uid) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;uid) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0092" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;gid) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;gid) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;uid = ntohl(attr-&gt;uid);</td><td> </td><td class="right">      attr-&gt;uid = ntohl(attr-&gt;uid);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;gid = ntohl(attr-&gt;gid);</td><td> </td><td class="right">      attr-&gt;gid = ntohl(attr-&gt;gid);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_PERMISSIONS) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_PERMISSIONS) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0093" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;permissions) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;permissions) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;permissions = ntohl(attr-&gt;permissions);</td><td> </td><td class="right">      attr-&gt;permissions = ntohl(attr-&gt;permissions);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0094" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#ifndef _WIN32</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      /* FIXME on windows */</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      switch (attr-&gt;permissions &amp; S_IFMT) {</td><td> </td><td class="right">      switch (attr-&gt;permissions &amp; S_IFMT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFSOCK:</td><td> </td><td class="right">        case S_IFSOCK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFBLK:</td><td> </td><td class="right">        case S_IFBLK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFCHR:</td><td> </td><td class="right">        case S_IFCHR:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFIFO:</td><td> </td><td class="right">        case S_IFIFO:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_SPECIAL;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_SPECIAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFLNK:</td><td> </td><td class="right">        case S_IFLNK:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_SYMLINK;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_SYMLINK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFREG:</td><td> </td><td class="right">        case S_IFREG:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_REGULAR;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_REGULAR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        case S_IFDIR:</td><td> </td><td class="right">        case S_IFDIR:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_DIRECTORY;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_DIRECTORY;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        default:</td><td> </td><td class="right">        default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          attr-&gt;type = SSH_FILEXFER_TYPE_UNKNOWN;</td><td> </td><td class="right">          attr-&gt;type = SSH_FILEXFER_TYPE_UNKNOWN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          break;</td><td> </td><td class="right">          break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0095" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#endif /* _WIN32 */</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_ACMODTIME) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_ACMODTIME) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0096" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;atime) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;atime) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;atime = ntohl(attr-&gt;atime);</td><td> </td><td class="right">      attr-&gt;atime = ntohl(attr-&gt;atime);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0097" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;mtime) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;mtime) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;mtime = ntohl(attr-&gt;mtime);</td><td> </td><td class="right">      attr-&gt;mtime = ntohl(attr-&gt;mtime);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_EXTENDED) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_EXTENDED) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0098" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      if (buffer_get_u32(buf, &amp;attr-&gt;extended_count) != sizeof(u<span class="delete">32</span>)) {</td><td> </td><td class="rblock">      if (buffer_get_u32(buf, &amp;attr-&gt;extended_count) != sizeof(u<span class="insert">int32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        break;</td><td> </td><td class="right">        break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      attr-&gt;extended_count = ntohl(attr-&gt;extended_count);</td><td> </td><td class="right">      attr-&gt;extended_count = ntohl(attr-&gt;extended_count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      while (attr-&gt;extended_count &amp;&amp;</td><td> </td><td class="right">      while (attr-&gt;extended_count &amp;&amp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          (attr-&gt;extended_type = buffer_get_ssh_string(buf))</td><td> </td><td class="right">          (attr-&gt;extended_type = buffer_get_ssh_string(buf))</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          &amp;&amp; (attr-&gt;extended_data = buffer_get_ssh_string(buf))) {</td><td> </td><td class="right">          &amp;&amp; (attr-&gt;extended_data = buffer_get_ssh_string(buf))) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        attr-&gt;extended_count--;</td><td> </td><td class="right">        attr-&gt;extended_count--;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l14" /><small>skipping to change at</small><em> line 1078</em></th><th> </th><th><a name="part-r14" /><small>skipping to change at</small><em> line 1269</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL, "Invalid ATTR structure");</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL, "Invalid ATTR structure");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* everything went smoothly */</td><td> </td><td class="right">  /* everything went smoothly */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return attr;</td><td> </td><td class="right">  return attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* FIXME is this really needed as a public function? */</td><td> </td><td class="right">/* FIXME is this really needed as a public function? */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0099" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">buffer_add_attributes(BUFFER *buffer, SFTP_ATTRIBUTES *attr)</span> {</td><td> </td><td class="rblock">int <span class="insert">buffer_add_attributes(ssh_buffer buffer, sftp_attributes attr)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> flags = (attr ? attr-&gt;flags : 0);</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> flags = (attr ? attr-&gt;flags : 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  flags &amp;= (SSH_FILEXFER_ATTR_SIZE | SSH_FILEXFER_ATTR_UIDGID |</td><td> </td><td class="right">  flags &amp;= (SSH_FILEXFER_ATTR_SIZE | SSH_FILEXFER_ATTR_UIDGID |</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      SSH_FILEXFER_ATTR_PERMISSIONS | SSH_FILEXFER_ATTR_ACMODTIME);</td><td> </td><td class="right">      SSH_FILEXFER_ATTR_PERMISSIONS | SSH_FILEXFER_ATTR_ACMODTIME);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, htonl(flags)) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u32(buffer, htonl(flags)) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (attr) {</td><td> </td><td class="right">  if (attr) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (flags &amp; SSH_FILEXFER_ATTR_SIZE) {</td><td> </td><td class="right">    if (flags &amp; SSH_FILEXFER_ATTR_SIZE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l15" /><small>skipping to change at</small><em> line 1119</em></th><th> </th><th><a name="part-r15" /><small>skipping to change at</small><em> line 1310</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_add_u32(buffer, htonl(attr-&gt;atime)) &lt; 0 ||</td><td> </td><td class="right">      if (buffer_add_u32(buffer, htonl(attr-&gt;atime)) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          buffer_add_u32(buffer, htonl(attr-&gt;mtime)) &lt; 0) {</td><td> </td><td class="right">          buffer_add_u32(buffer, htonl(attr-&gt;mtime)) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return -1;</td><td> </td><td class="right">        return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0100" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_ATTRIBUTES *sftp_parse_attr(SFTP_SESSION *session, BUFFER *</span>buf,</td><td> </td><td class="rblock"><span class="insert">sftp_attributes sftp_parse_attr(sftp_session session, ssh_buffer </span>buf,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int expectname) {</td><td> </td><td class="right">    int expectname) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(session-&gt;version) {</td><td> </td><td class="right">  switch(session-&gt;version) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 4:</td><td> </td><td class="right">    case 4:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return sftp_parse_attr_4(session, buf, expectname);</td><td> </td><td class="right">      return sftp_parse_attr_4(session, buf, expectname);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 3:</td><td> </td><td class="right">    case 3:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0101" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">case 2:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    case 1:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    case 0:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return sftp_parse_attr_3(session, buf, expectname);</td><td> </td><td class="right">      return sftp_parse_attr_3(session, buf, expectname);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session-&gt;session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(session-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Version %d unsupported by client", session-&gt;server_version);</td><td> </td><td class="right">          "Version %d unsupported by client", session-&gt;server_version);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Get the version of the SFTP protocol supported by the server */</td><td> </td><td class="right">/* Get the version of the SFTP protocol supported by the server */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0102" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_server_version(<span class="delete">SFTP_SESSION *</span>sftp) {</td><td> </td><td class="rblock">int sftp_server_version(<span class="insert">sftp_session </span>sftp) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp-&gt;server_version;</td><td> </td><td class="right">  return sftp-&gt;server_version;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Get a single file attributes structure of a directory. */</td><td> </td><td class="right">/* Get a single file attributes structure of a directory. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0103" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_ATTRIBUTES *sftp_readdir(SFTP_SESSION *sftp, SFTP_DIR *dir)</span> {</td><td> </td><td class="rblock"><span class="insert">sftp_attributes sftp_readdir(sftp_session sftp, sftp_dir dir)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_ATTRIBUTES *attr;</span></td><td> </td><td class="rblock"><span class="insert">  sftp_attributes attr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *payload;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer payload;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (dir-&gt;buffer == NULL) {</td><td> </td><td class="right">  if (dir-&gt;buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    payload = buffer_new();</td><td> </td><td class="right">    payload = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (payload == NULL) {</td><td> </td><td class="right">    if (payload == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0104" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    id = sftp_get_new_id(sftp);</td><td> </td><td class="right">    id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_add_u32(payload, id) &lt; 0 ||</td><td> </td><td class="right">    if (buffer_add_u32(payload, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_add_ssh_string(payload, dir-&gt;handle) &lt; 0) {</td><td> </td><td class="right">        buffer_add_ssh_string(payload, dir-&gt;handle) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0105" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(payload);</td><td> </td><td class="right">      buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_packet_write(sftp, SSH_FXP_READDIR, payload) &lt; 0) {</td><td> </td><td class="right">    if (sftp_packet_write(sftp, SSH_FXP_READDIR, payload) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(payload);</td><td> </td><td class="right">      buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(payload);</td><td> </td><td class="right">    buffer_free(payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l16" /><small>skipping to change at</small><em> line 1243</em></th><th> </th><th><a name="part-r16" /><small>skipping to change at</small><em> line 1439</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  dir-&gt;count--;</td><td> </td><td class="right">  dir-&gt;count--;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (dir-&gt;count == 0) {</td><td> </td><td class="right">  if (dir-&gt;count == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(dir-&gt;buffer);</td><td> </td><td class="right">    buffer_free(dir-&gt;buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    dir-&gt;buffer = NULL;</td><td> </td><td class="right">    dir-&gt;buffer = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return attr;</td><td> </td><td class="right">  return attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Tell if the directory has reached EOF (End Of File). */</td><td> </td><td class="right">/* Tell if the directory has reached EOF (End Of File). */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0106" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_dir_eof(<span class="delete">SFTP_DIR *</span>dir) {</td><td> </td><td class="rblock">int sftp_dir_eof(<span class="insert">sftp_dir </span>dir) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return dir-&gt;eof;</td><td> </td><td class="right">  return dir-&gt;eof;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Free a SFTP_ATTRIBUTE handle */</td><td> </td><td class="right">/* Free a SFTP_ATTRIBUTE handle */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0107" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void sftp_attributes_free(<span class="delete">SFTP_ATTRIBUTES *</span>file){</td><td> </td><td class="rblock">void sftp_attributes_free(<span class="insert">sftp_attributes </span>file){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(file-&gt;acl);</td><td> </td><td class="right">  string_free(file-&gt;acl);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(file-&gt;extended_data);</td><td> </td><td class="right">  string_free(file-&gt;extended_data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(file-&gt;extended_type);</td><td> </td><td class="right">  string_free(file-&gt;extended_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file-&gt;name);</td><td> </td><td class="right">  SAFE_FREE(file-&gt;name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file-&gt;longname);</td><td> </td><td class="right">  SAFE_FREE(file-&gt;longname);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file-&gt;group);</td><td> </td><td class="right">  SAFE_FREE(file-&gt;group);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file-&gt;owner);</td><td> </td><td class="right">  SAFE_FREE(file-&gt;owner);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file);</td><td> </td><td class="right">  SAFE_FREE(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0108" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">sftp_handle_close(SFTP_SESSION *sftp, STRING *handle)</span> {</td><td> </td><td class="rblock">static int <span class="insert">sftp_handle_close(sftp_session sftp, ssh_string handle)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">  sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> id;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0109" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0110" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, handle) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, handle) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_CLOSE ,buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_CLOSE ,buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* something nasty has happened */</td><td> </td><td class="right">      /* something nasty has happened */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l17" /><small>skipping to change at</small><em> line 1322</em></th><th> </th><th><a name="part-r17" /><small>skipping to change at</small><em> line 1523</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Received message %d during sftp_handle_close!", msg-&gt;packet_type
);</td><td> </td><td class="right">          "Received message %d during sftp_handle_close!", msg-&gt;packet_type
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0111" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">int sftp_file_close(SFTP_FILE *file) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  return sftp_close(file);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Close an open file handle. */</td><td> </td><td class="right">/* Close an open file handle. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0112" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_close(<span class="delete">SFTP_FILE *</span>file){</td><td> </td><td class="rblock">int sftp_close(<span class="insert">sftp_file </span>file){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int err = SSH_NO_ERROR;</td><td> </td><td class="right">  int err = SSH_NO_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file-&gt;name);</td><td> </td><td class="right">  SAFE_FREE(file-&gt;name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file-&gt;handle){</td><td> </td><td class="right">  if (file-&gt;handle){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    err = sftp_handle_close(file-&gt;sftp,file-&gt;handle);</td><td> </td><td class="right">    err = sftp_handle_close(file-&gt;sftp,file-&gt;handle);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(file-&gt;handle);</td><td> </td><td class="right">    string_free(file-&gt;handle);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* FIXME: check server response and implement errno */</td><td> </td><td class="right">  /* FIXME: check server response and implement errno */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(file);</td><td> </td><td class="right">  SAFE_FREE(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return err;</td><td> </td><td class="right">  return err;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0113" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">int sftp_dir_close(SFTP_DIR *dir) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  return sftp_closedir(dir);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Close an open directory. */</td><td> </td><td class="right">/* Close an open directory. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0114" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_closedir(<span class="delete">SFTP_DIR *</span>dir){</td><td> </td><td class="rblock">int sftp_closedir(<span class="insert">sftp_dir </span>dir){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int err = SSH_NO_ERROR;</td><td> </td><td class="right">  int err = SSH_NO_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(dir-&gt;name);</td><td> </td><td class="right">  SAFE_FREE(dir-&gt;name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (dir-&gt;handle) {</td><td> </td><td class="right">  if (dir-&gt;handle) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    err = sftp_handle_close(dir-&gt;sftp, dir-&gt;handle);</td><td> </td><td class="right">    err = sftp_handle_close(dir-&gt;sftp, dir-&gt;handle);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(dir-&gt;handle);</td><td> </td><td class="right">    string_free(dir-&gt;handle);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* FIXME: check server response and implement errno */</td><td> </td><td class="right">  /* FIXME: check server response and implement errno */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(dir-&gt;buffer);</td><td> </td><td class="right">  buffer_free(dir-&gt;buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(dir);</td><td> </td><td class="right">  SAFE_FREE(dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return err;</td><td> </td><td class="right">  return err;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Open a file on the server. */</td><td> </td><td class="right">/* Open a file on the server. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0115" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_FILE *sftp_open(SFTP_SESSION *</span>sftp, const char *file, int flags,</td><td> </td><td class="rblock"><span class="insert">sftp_file sftp_open(sftp_session </span>sftp, const char *file, int flags,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    mode_t mode) {</td><td> </td><td class="right">    mode_t mode) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0116" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_ATTRIBUTES</span> attr;</td><td> </td><td class="rblock"><span class="insert">  struct sftp_attributes_struct</span> attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_FILE *handle;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_file handle;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *filename;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string filename;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> sftp_flags = 0;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> sftp_flags = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> id;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0117" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  filename = string_from_char(file);</td><td> </td><td class="right">  filename = string_from_char(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (filename == NULL) {</td><td> </td><td class="right">  if (filename == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0118" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCT(attr);</td><td> </td><td class="right">  ZERO_STRUCT(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.permissions = mode;</td><td> </td><td class="right">  attr.permissions = mode;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td> </td><td class="right">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags == O_RDONLY)</td><td> </td><td class="right">  if (flags == O_RDONLY)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= SSH_FXF_READ; /* if any of the other flag is set,</td><td> </td><td class="right">    sftp_flags |= SSH_FXF_READ; /* if any of the other flag is set,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l18" /><small>skipping to change at</small><em> line 1401</em></th><th> </th><th><a name="part-r18" /><small>skipping to change at</small><em> line 1596</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags &amp; O_WRONLY)</td><td> </td><td class="right">  if (flags &amp; O_WRONLY)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= SSH_FXF_WRITE;</td><td> </td><td class="right">    sftp_flags |= SSH_FXF_WRITE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags &amp; O_RDWR)</td><td> </td><td class="right">  if (flags &amp; O_RDWR)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= (SSH_FXF_WRITE | SSH_FXF_READ);</td><td> </td><td class="right">    sftp_flags |= (SSH_FXF_WRITE | SSH_FXF_READ);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags &amp; O_CREAT)</td><td> </td><td class="right">  if (flags &amp; O_CREAT)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= SSH_FXF_CREAT;</td><td> </td><td class="right">    sftp_flags |= SSH_FXF_CREAT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags &amp; O_TRUNC)</td><td> </td><td class="right">  if (flags &amp; O_TRUNC)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= SSH_FXF_TRUNC;</td><td> </td><td class="right">    sftp_flags |= SSH_FXF_TRUNC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (flags &amp; O_EXCL)</td><td> </td><td class="right">  if (flags &amp; O_EXCL)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_flags |= SSH_FXF_EXCL;</td><td> </td><td class="right">    sftp_flags |= SSH_FXF_EXCL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0119" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">                                                                         </span></td><td> </td><td class="rblock">  <span class="insert">ssh_log(sftp-&gt;session,SSH_LOG_PACKET,"Opening file %s with sftp flags %x"
,file,sftp_flags);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, filename) &lt; 0) {</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, filename) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0120" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(filename);</td><td> </td><td class="right">    string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(filename);</td><td> </td><td class="right">  string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, htonl(sftp_flags)) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, htonl(sftp_flags)) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0121" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_attributes(buffer, &amp;attr) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_attributes(buffer, &amp;attr) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_OPEN, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_OPEN, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* something nasty has happened */</td><td> </td><td class="right">      /* something nasty has happened */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l19" /><small>skipping to change at</small><em> line 1453</em></th><th> </th><th><a name="part-r19" /><small>skipping to change at</small><em> line 1653</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return handle;</td><td> </td><td class="right">      return handle;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Received message %d during open!", msg-&gt;packet_type);</td><td> </td><td class="right">          "Received message %d during open!", msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0122" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void sftp_file_set_nonblocking(<span class="delete">SFTP_FILE *</span>handle){</td><td> </td><td class="rblock">void sftp_file_set_nonblocking(<span class="insert">sftp_file </span>handle){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    handle-&gt;nonblocking=1;</td><td> </td><td class="right">    handle-&gt;nonblocking=1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0123" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void sftp_file_set_blocking(<span class="delete">SFTP_FILE *</span>handle){</td><td> </td><td class="rblock">void sftp_file_set_blocking(<span class="insert">sftp_file </span>handle){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    handle-&gt;nonblocking=0;</td><td> </td><td class="right">    handle-&gt;nonblocking=0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Read from a file using an opened sftp file handle. */</td><td> </td><td class="right">/* Read from a file using an opened sftp file handle. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0124" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t <span class="delete">sftp_read(SFTP_FILE *handle,</span> void *buf, size_t count) {</td><td> </td><td class="rblock">ssize_t <span class="insert">sftp_read(sftp_file handle,</span> void *buf, size_t count) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_SESSION *sftp</span> = handle-&gt;sftp;</td><td> </td><td class="rblock">  <span class="insert">sftp_session sftp</span> = handle-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *datastring;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string datastring;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int id;</td><td> </td><td class="right">  int id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (handle-&gt;eof) {</td><td> </td><td class="right">  if (handle-&gt;eof) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0125" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(handle-&gt;sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(handle-&gt;sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, handle-&gt;handle) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, handle-&gt;handle) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_u64(buffer, htonll(handle-&gt;offset)) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_u64(buffer, htonll(handle-&gt;offset)) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0126" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_u32(buffer,htonl(count)) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_u32(buffer,htonl(count)) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(handle-&gt;sftp,</span> SSH_FXP_READ, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(handle-&gt;sftp,</span> SSH_FXP_READ, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (handle-&gt;nonblocking) {</td><td> </td><td class="right">    if (handle-&gt;nonblocking) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (channel_poll(handle-&gt;sftp-&gt;channel, 0) == 0) {</td><td> </td><td class="right">      if (channel_poll(handle-&gt;sftp-&gt;channel, 0) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        /* we cannot block */</td><td> </td><td class="right">        /* we cannot block */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return 0;</td><td> </td><td class="right">        return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l20" /><small>skipping to change at</small><em> line 1541</em></th><th> </th><th><a name="part-r20" /><small>skipping to change at</small><em> line 1746</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (string_len(datastring) &gt; count) {</td><td> </td><td class="right">      if (string_len(datastring) &gt; count) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "Received a too big DATA packet from sftp server: "</td><td> </td><td class="right">            "Received a too big DATA packet from sftp server: "</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "%zu and asked for %zu",</td><td> </td><td class="right">            "%zu and asked for %zu",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            string_len(datastring), count);</td><td> </td><td class="right">            string_len(datastring), count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(datastring);</td><td> </td><td class="right">        string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return -1;</td><td> </td><td class="right">        return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      count = string_len(datastring);</td><td> </td><td class="right">      count = string_len(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      handle-&gt;offset += count;</td><td> </td><td class="right">      handle-&gt;offset += count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0127" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      memcpy(buf, <span class="delete">datastring-&gt;string</span>, count);</td><td> </td><td class="rblock">      memcpy(buf, <span class="insert">string_data(datastring)</span>, count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(datastring);</td><td> </td><td class="right">      string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return count;</td><td> </td><td class="right">      return count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Received message %d during read!", msg-&gt;packet_type);</td><td> </td><td class="right">          "Received message %d during read!", msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1; /* not reached */</td><td> </td><td class="right">  return -1; /* not reached */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Start an asynchronous read from a file using an opened sftp file handle.
 */</td><td> </td><td class="right">/* Start an asynchronous read from a file using an opened sftp file handle.
 */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0128" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_async_read_begin(SFTP_FILE *file, u32</span> len){</td><td> </td><td class="rblock">int <span class="insert">sftp_async_read_begin(sftp_file file, uint32_t</span> len){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_SESSION *sftp</span> = file-&gt;sftp;</td><td> </td><td class="rblock">  <span class="insert">sftp_session sftp</span> = file-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0129" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_u64(buffer, htonll(file-&gt;offset)) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_u64(buffer, htonll(file-&gt;offset)) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0130" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_u32(buffer, htonl(len)) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_u32(buffer, htonl(len)) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_READ, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_READ, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;offset += len; /* assume we'll read len bytes */</td><td> </td><td class="right">  file-&gt;offset += len; /* assume we'll read len bytes */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return id;</td><td> </td><td class="right">  return id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Wait for an asynchronous read to complete and save the data. */</td><td> </td><td class="right">/* Wait for an asynchronous read to complete and save the data. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0131" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_async_read(SFTP_FILE *file,</span> void *data, <span class="delete">u32</span> size, <span class="delete">u32 id){</span></td><td> </td><td class="rblock">int <span class="insert">sftp_async_read(sftp_file file,</span> void *data, <span class="insert">uint32_t</span> size, <span class="insert">uint32_t id)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  SFTP_SESSION *sftp</span> = file-&gt;sftp;</td><td> </td><td class="rblock"><span class="insert">{</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock"><span class="insert">  sftp_session sftp</span> = file-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *datastring;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string datastring;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int err = SSH_OK;</td><td> </td><td class="right">  int err = SSH_OK;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0132" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32</span> len;</td><td> </td><td class="rblock">  u<span class="insert">int32_t</span> len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_enter_function();</td><td> </td><td class="right">  sftp_enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file-&gt;eof) {</td><td> </td><td class="right">  if (file-&gt;eof) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_leave_function();</td><td> </td><td class="right">    sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* handle an existing request */</td><td> </td><td class="right">  /* handle an existing request */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l21" /><small>skipping to change at</small><em> line 1660</em></th><th> </th><th><a name="part-r21" /><small>skipping to change at</small><em> line 1870</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "%zu and asked for %u",</td><td> </td><td class="right">            "%zu and asked for %u",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            string_len(datastring), size);</td><td> </td><td class="right">            string_len(datastring), size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(datastring);</td><td> </td><td class="right">        string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        sftp_leave_function();</td><td> </td><td class="right">        sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return SSH_ERROR;</td><td> </td><td class="right">        return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      len = string_len(datastring);</td><td> </td><td class="right">      len = string_len(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      //handle-&gt;offset+=len;</td><td> </td><td class="right">      //handle-&gt;offset+=len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* We already have set the offset previously. All we can do is warn t
hat the expected len</td><td> </td><td class="right">      /* We already have set the offset previously. All we can do is warn t
hat the expected len</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       * and effective lengths are different */</td><td> </td><td class="right">       * and effective lengths are different */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0133" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      memcpy(data, <span class="delete">datastring-&gt;string</span>, len);</td><td> </td><td class="rblock">      memcpy(data, <span class="insert">string_data(datastring)</span>, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(datastring);</td><td> </td><td class="right">      string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_leave_function();</td><td> </td><td class="right">      sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return len;</td><td> </td><td class="right">      return len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session,SSH_FATAL,"Received message %d during rea
d!",msg-&gt;packet_type);</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session,SSH_FATAL,"Received message %d during rea
d!",msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_leave_function();</td><td> </td><td class="right">      sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return SSH_ERROR;</td><td> </td><td class="right">      return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_leave_function();</td><td> </td><td class="right">  sftp_leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return SSH_ERROR;</td><td> </td><td class="right">  return SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0134" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t <span class="delete">sftp_write(SFTP_FILE *file,</span> const void *buf, size_t count) {</td><td> </td><td class="rblock">ssize_t <span class="insert">sftp_write(sftp_file file,</span> const void *buf, size_t count) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_SESSION *sftp</span> = file-&gt;sftp;</td><td> </td><td class="rblock">  <span class="insert">sftp_session sftp</span> = file-&gt;sftp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status;</span></td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *datastring;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string datastring;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int len;</td><td> </td><td class="right">  int len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int packetlen;</td><td> </td><td class="right">  int packetlen;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0135" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  datastring = string_new(count);</td><td> </td><td class="right">  datastring = string_new(count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (datastring == NULL) {</td><td> </td><td class="right">  if (datastring == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0136" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_fill(datastring, buf, count);</td><td> </td><td class="right">  string_fill(datastring, buf, count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(file-&gt;sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(file-&gt;sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_u64(buffer, htonll(file-&gt;offset)) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_u64(buffer, htonll(file-&gt;offset)) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, datastring) &lt; 0) {</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, datastring) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0137" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(datastring);</td><td> </td><td class="right">    string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(datastring);</td><td> </td><td class="right">  string_free(datastring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  len = sftp_packet_write(file-&gt;sftp, SSH_FXP_WRITE, buffer);</td><td> </td><td class="right">  len = sftp_packet_write(file-&gt;sftp, SSH_FXP_WRITE, buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  packetlen=buffer_get_len(buffer);</td><td> </td><td class="right">  packetlen=buffer_get_len(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (len &lt; 0) {</td><td> </td><td class="right">  if (len &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l22" /><small>skipping to change at</small><em> line 1757</em></th><th> </th><th><a name="part-r22" /><small>skipping to change at</small><em> line 1970</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Received message %d during write!", msg-&gt;packet_type);</td><td> </td><td class="right">          "Received message %d during write!", msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      sftp_message_free(msg);</td><td> </td><td class="right">      sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1; /* not reached */</td><td> </td><td class="right">  return -1; /* not reached */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Seek to a specific location in a file. */</td><td> </td><td class="right">/* Seek to a specific location in a file. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0138" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_seek(<span class="delete">SFTP_FILE *file, u32</span> new_offset) {</td><td> </td><td class="rblock">int sftp_seek(<span class="insert">sftp_file file, uint32_t</span> new_offset) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;offset = new_offset;</td><td> </td><td class="right">  file-&gt;offset = new_offset;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0139" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_seek64(<span class="delete">SFTP_FILE *file, u64</span> new_offset) {</td><td> </td><td class="rblock">int sftp_seek64(<span class="insert">sftp_file file, uint64_t</span> new_offset) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;offset = new_offset;</td><td> </td><td class="right">  file-&gt;offset = new_offset;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Report current byte position in file. */</td><td> </td><td class="right">/* Report current byte position in file. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0140" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">unsigned long sftp_tell(<span class="delete">SFTP_FILE *</span>file) {</td><td> </td><td class="rblock">unsigned long sftp_tell(<span class="insert">sftp_file </span>file) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return (unsigned long)file-&gt;offset;</td><td> </td><td class="right">  return (unsigned long)file-&gt;offset;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Report current byte position in file. */</td><td> </td><td class="right">/* Report current byte position in file. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0141" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">u64 sftp_tell64(SFTP_FILE *file)</span> {</td><td> </td><td class="rblock"><span class="insert">uint64_t sftp_tell64(sftp_file file)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  return <span class="delete">(u64)file-&gt;offset;</span></td><td> </td><td class="rblock">  return <span class="insert">(uint64_t) file-&gt;offset;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Rewinds the position of the file pointer to the beginning of the file.*/</td><td> </td><td class="right">/* Rewinds the position of the file pointer to the beginning of the file.*/</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0142" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void sftp_rewind(<span class="delete">SFTP_FILE *</span>file) {</td><td> </td><td class="rblock">void sftp_rewind(<span class="insert">sftp_file </span>file) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file-&gt;offset = 0;</td><td> </td><td class="right">  file-&gt;offset = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0143" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">/* deprecated */</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">int sftp_rm(SFTP_SESSION *sftp, const char *file) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  return sftp_unlink(sftp, file);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* code written by Nick */</td><td> </td><td class="right">/* code written by Nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0144" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_unlink(SFTP_SESSION *sftp,</span> const char *file) {</td><td> </td><td class="rblock">int <span class="insert">sftp_unlink(sftp_session sftp,</span> const char *file) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *filename;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string filename;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0145" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  filename = string_from_char(file);</td><td> </td><td class="right">  filename = string_from_char(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (filename == NULL) {</td><td> </td><td class="right">  if (filename == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0146" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0147" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, filename) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, filename) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_REMOVE, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(filename);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_REMOVE, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(filename);</td><td> </td><td class="right">    string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(filename);</td><td> </td><td class="right">  string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp)) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l23" /><small>skipping to change at</small><em> line 1866</em></th><th> </th><th><a name="part-r23" /><small>skipping to change at</small><em> line 2080</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session,SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session,SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to remove file", msg-&gt;packet_t
ype);</td><td> </td><td class="right">        "Received message %d when attempting to remove file", msg-&gt;packet_t
ype);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* code written by Nick */</td><td> </td><td class="right">/* code written by Nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0148" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_rmdir(SFTP_SESSION *sftp,</span> const char *directory) {</td><td> </td><td class="rblock">int <span class="insert">sftp_rmdir(sftp_session sftp,</span> const char *directory) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *filename;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string filename;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0149" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  filename = string_from_char(directory);</td><td> </td><td class="right">  filename = string_from_char(directory);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (filename == NULL) {</td><td> </td><td class="right">  if (filename == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0150" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0151" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, filename) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, filename) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_RMDIR, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(filename);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_RMDIR, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(filename);</td><td> </td><td class="right">    string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(filename);</td><td> </td><td class="right">  string_free(filename);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l24" /><small>skipping to change at</small><em> line 1933</em></th><th> </th><th><a name="part-r24" /><small>skipping to change at</small><em> line 2154</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to remove directory",</td><td> </td><td class="right">        "Received message %d when attempting to remove directory",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        msg-&gt;packet_type);</td><td> </td><td class="right">        msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Code written by Nick */</td><td> </td><td class="right">/* Code written by Nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0152" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_mkdir(SFTP_SESSION *sftp,</span> const char *directory, mode_t mode) {</td><td> </td><td class="rblock">int <span class="insert">sftp_mkdir(sftp_session sftp,</span> const char *directory, mode_t mode) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES *errno_attr</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_attributes errno_attr</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES</span> attr;</td><td> </td><td class="rblock">  <span class="insert">struct sftp_attributes_struct</span> attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *path;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string path;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0153" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  path = string_from_char(directory);</td><td> </td><td class="right">  path = string_from_char(directory);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (path == NULL) {</td><td> </td><td class="right">  if (path == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0154" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCT(attr);</td><td> </td><td class="right">  ZERO_STRUCT(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.permissions = mode;</td><td> </td><td class="right">  attr.permissions = mode;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td> </td><td class="right">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l25" /><small>skipping to change at</small><em> line 2022</em></th><th> </th><th><a name="part-r25" /><small>skipping to change at</small><em> line 2245</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to make directory",</td><td> </td><td class="right">        "Received message %d when attempting to make directory",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        msg-&gt;packet_type);</td><td> </td><td class="right">        msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* code written by nick */</td><td> </td><td class="right">/* code written by nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0155" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_rename(SFTP_SESSION *sftp,</span> const char *original, const char <span class="delete">*newna</span></td><td> </td><td class="rblock">int <span class="insert">sftp_rename(sftp_session sftp,</span> const char *original, const char <span class="insert">*newnam</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">me)</span> {</td><td> </td><td class="rblock"><span class="insert">e)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *oldpath;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string oldpath;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *newpath;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string newpath;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0156" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  oldpath = string_from_char(original);</td><td> </td><td class="right">  oldpath = string_from_char(original);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (oldpath == NULL) {</td><td> </td><td class="right">  if (oldpath == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0157" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  newpath = string_from_char(newname);</td><td> </td><td class="right">  newpath = string_from_char(newname);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (newpath == NULL) {</td><td> </td><td class="right">  if (newpath == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0158" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(oldpath);</td><td> </td><td class="right">    string_free(oldpath);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, oldpath) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, oldpath) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, newpath) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, newpath) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* POSIX rename atomically replaces newpath, we should do the same */</td><td> </td><td class="right">      /* POSIX rename atomically replaces newpath, we should do the same */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0159" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_u32(buffer, SSH_FXF_RENAME_OVERWRITE) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_u32(buffer, SSH_FXF_RENAME_OVERWRITE) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_RENAME, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(oldpath);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(newpath);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_RENAME, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(oldpath);</td><td> </td><td class="right">    string_free(oldpath);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(newpath);</td><td> </td><td class="right">    string_free(newpath);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(oldpath);</td><td> </td><td class="right">  string_free(oldpath);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(newpath);</td><td> </td><td class="right">  string_free(newpath);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l26" /><small>skipping to change at</small><em> line 2106</em></th><th> </th><th><a name="part-r26" /><small>skipping to change at</small><em> line 2338</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to rename",</td><td> </td><td class="right">        "Received message %d when attempting to rename",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        msg-&gt;packet_type);</td><td> </td><td class="right">        msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Code written by Nick */</td><td> </td><td class="right">/* Code written by Nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Set file attributes on a file, directory or symbolic link. */</td><td> </td><td class="right">/* Set file attributes on a file, directory or symbolic link. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0160" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_setstat(SFTP_SESSION *sftp,</span> const char *file, <span class="delete">SFTP_ATTRIBUTES *att</span></td><td> </td><td class="rblock">int <span class="insert">sftp_setstat(sftp_session sftp,</span> const char *file, <span class="insert">sftp_attributes attr)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">r)</span> {</td><td> </td><td class="rblock"> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> id = sftp_get_new_id(sftp);</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = buffer_new();</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *path</span> = string_from_char(file);</td><td> </td><td class="rblock">  <span class="insert">ssh_string path</span> = string_from_char(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0161" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  path = string_from_char(file);</td><td> </td><td class="right">  path = string_from_char(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (path == NULL) {</td><td> </td><td class="right">  if (path == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0162" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, path) &lt; 0 ||</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, path) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0163" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_attributes(buffer, attr) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_attributes(buffer, attr) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_SETSTAT, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(path);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_SETSTAT, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(path);</td><td> </td><td class="right">    string_free(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(path);</td><td> </td><td class="right">  string_free(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l27" /><small>skipping to change at</small><em> line 2176</em></th><th> </th><th><a name="part-r27" /><small>skipping to change at</small><em> line 2415</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td> </td><td class="right">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Change the file owner and group */</td><td> </td><td class="right">/* Change the file owner and group */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0164" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_chown(SFTP_SESSION *sftp,</span> const char *file, uid_t owner, gid_t <span class="delete">gro</span></td><td> </td><td class="rblock">int <span class="insert">sftp_chown(sftp_session sftp,</span> const char *file, uid_t owner, gid_t <span class="insert">grou</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">up)</span> {</td><td> </td><td class="rblock"><span class="insert">p)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES</span> attr;</td><td> </td><td class="rblock">       <span class="insert">struct sftp_attributes_struct</span> attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCT(attr);</td><td> </td><td class="right">  ZERO_STRUCT(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.uid = owner;</td><td> </td><td class="right">  attr.uid = owner;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.gid = group;</td><td> </td><td class="right">  attr.gid = group;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.flags = SSH_FILEXFER_ATTR_OWNERGROUP;</td><td> </td><td class="right">  attr.flags = SSH_FILEXFER_ATTR_OWNERGROUP;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp_setstat(sftp, file, &amp;attr);</td><td> </td><td class="right">  return sftp_setstat(sftp, file, &amp;attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Change permissions of a file */</td><td> </td><td class="right">/* Change permissions of a file */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0165" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_chmod(SFTP_SESSION *sftp,</span> const char *file, mode_t mode) {</td><td> </td><td class="rblock">int <span class="insert">sftp_chmod(sftp_session sftp,</span> const char *file, mode_t mode) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES</span> attr;</td><td> </td><td class="rblock">       <span class="insert">struct sftp_attributes_struct</span> attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCT(attr);</td><td> </td><td class="right">  ZERO_STRUCT(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.permissions = mode;</td><td> </td><td class="right">  attr.permissions = mode;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td> </td><td class="right">  attr.flags = SSH_FILEXFER_ATTR_PERMISSIONS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp_setstat(sftp, file, &amp;attr);</td><td> </td><td class="right">  return sftp_setstat(sftp, file, &amp;attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* Change the last modification and access time of a file. */</td><td> </td><td class="right">/* Change the last modification and access time of a file. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0166" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int sftp_utimes(<span class="delete">SFTP_SESSION *</span>sftp, const char *file,</td><td> </td><td class="rblock">int sftp_utimes(<span class="insert">sftp_session </span>sftp, const char *file,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    const struct timeval *times) {</td><td> </td><td class="right">    const struct timeval *times) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0167" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_ATTRIBUTES</span> attr;</td><td> </td><td class="rblock">       <span class="insert">struct sftp_attributes_struct</span> attr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCT(attr);</td><td> </td><td class="right">  ZERO_STRUCT(attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.atime = times[0].tv_sec;</td><td> </td><td class="right">  attr.atime = times[0].tv_sec;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.atime_nseconds = times[0].tv_usec;</td><td> </td><td class="right">  attr.atime_nseconds = times[0].tv_usec;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.mtime = times[1].tv_sec;</td><td> </td><td class="right">  attr.mtime = times[1].tv_sec;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.mtime_nseconds = times[1].tv_usec;</td><td> </td><td class="right">  attr.mtime_nseconds = times[1].tv_usec;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  attr.flags |= SSH_FILEXFER_ATTR_ACCESSTIME | SSH_FILEXFER_ATTR_MODIFYTIME
 |</td><td> </td><td class="right">  attr.flags |= SSH_FILEXFER_ATTR_ACCESSTIME | SSH_FILEXFER_ATTR_MODIFYTIME
 |</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SSH_FILEXFER_ATTR_SUBSECOND_TIMES;</td><td> </td><td class="right">    SSH_FILEXFER_ATTR_SUBSECOND_TIMES;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp_setstat(sftp, file, &amp;attr);</td><td> </td><td class="right">  return sftp_setstat(sftp, file, &amp;attr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0168" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">sftp_symlink(SFTP_SESSION *sftp,</span> const char *target, const char *dest) </td><td> </td><td class="rblock">int <span class="insert">sftp_symlink(sftp_session sftp,</span> const char *target, const char *dest) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">{</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string target_s;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *target_s;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_string dest_s;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  STRING *dest_s;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0169" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (sftp == <span class="delete">NULL || target</span> == NULL || dest == NULL) {</td><td> </td><td class="rblock">  if (sftp == <span class="insert">NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (target</span> == NULL || dest == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0170" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  target_s = string_from_char(target);</td><td> </td><td class="right">  target_s = string_from_char(target);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (target_s == NULL) {</td><td> </td><td class="right">  if (target_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0171" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  dest_s = string_from_char(dest);</td><td> </td><td class="right">  dest_s = string_from_char(dest);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (dest_s == NULL) {</td><td> </td><td class="right">  if (dest_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0172" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(target_s);</td><td> </td><td class="right">    string_free(target_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0173" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(dest_s);</td><td> </td><td class="right">    string_free(dest_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(target_s);</td><td> </td><td class="right">    string_free(target_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ssh_get_openssh_version(sftp-&gt;session)) {</td><td> </td><td class="right">  if (ssh_get_openssh_version(sftp-&gt;session)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* TODO check for version number if they ever fix it. */</td><td> </td><td class="right">    /* TODO check for version number if they ever fix it. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_add_ssh_string(buffer, target_s) &lt; 0 ||</td><td> </td><td class="right">    if (buffer_add_ssh_string(buffer, target_s) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, dest_s) &lt; 0) {</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, dest_s) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0174" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(buffer);</td><td> </td><td class="right">      buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(dest_s);</td><td> </td><td class="right">      string_free(dest_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(target_s);</td><td> </td><td class="right">      string_free(target_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_add_ssh_string(buffer, dest_s) &lt; 0 ||</td><td> </td><td class="right">    if (buffer_add_ssh_string(buffer, dest_s) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_add_ssh_string(buffer, target_s) &lt; 0) {</td><td> </td><td class="right">      buffer_add_ssh_string(buffer, target_s) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0175" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(buffer);</td><td> </td><td class="right">      buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(dest_s);</td><td> </td><td class="right">      string_free(dest_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(target_s);</td><td> </td><td class="right">      string_free(target_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sftp_packet_write(sftp, SSH_FXP_SYMLINK, buffer) &lt; 0) {</td><td> </td><td class="right">  if (sftp_packet_write(sftp, SSH_FXP_SYMLINK, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(dest_s);</td><td> </td><td class="right">    string_free(dest_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l28" /><small>skipping to change at</small><em> line 2323</em></th><th> </th><th><a name="part-r28" /><small>skipping to change at</small><em> line 2568</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td> </td><td class="right">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0176" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">char <span class="delete">*sftp_readlink(SFTP_SESSION *sftp,</span> const char *path) {</td><td> </td><td class="rblock">char <span class="insert">*sftp_readlink(sftp_session sftp,</span> const char *path) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *path_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string path_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *link_s</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string link_s</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  char <span class="delete">*link;</span></td><td> </td><td class="rblock">  char <span class="insert">*lnk;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> ignored;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> ignored;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> id;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0177" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (sftp == <span class="delete">NULL || path</span> == NULL) {</td><td> </td><td class="rblock">  if (sftp == <span class="insert">NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (path</span> == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">ssh_set_error_invalid(sftp, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp-&gt;version &lt; 3){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp,SSH_REQUEST_DENIED,"sftp version %d does not support</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> sftp_readlink",sftp-&gt;version);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0178" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                                           </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0179" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  path_s = string_from_char(path);</td><td> </td><td class="right">  path_s = string_from_char(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (path_s == NULL) {</td><td> </td><td class="right">  if (path_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0180" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0181" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, path_s) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, path_s) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_READLINK, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(path_s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_READLINK, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(path_s);</td><td> </td><td class="right">    string_free(path_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(path_s);</td><td> </td><td class="right">  string_free(path_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l29" /><small>skipping to change at</small><em> line 2373</em></th><th> </th><th><a name="part-r29" /><small>skipping to change at</small><em> line 2631</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    msg = sftp_dequeue(sftp, id);</td><td> </td><td class="right">    msg = sftp_dequeue(sftp, id);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg-&gt;packet_type == SSH_FXP_NAME) {</td><td> </td><td class="right">  if (msg-&gt;packet_type == SSH_FXP_NAME) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* we don't care about "count" */</td><td> </td><td class="right">    /* we don't care about "count" */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_get_u32(msg-&gt;payload, &amp;ignored);</td><td> </td><td class="right">    buffer_get_u32(msg-&gt;payload, &amp;ignored);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* we only care about the file name string */</td><td> </td><td class="right">    /* we only care about the file name string */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    link_s = buffer_get_ssh_string(msg-&gt;payload);</td><td> </td><td class="right">    link_s = buffer_get_ssh_string(msg-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (link_s == NULL) {</td><td> </td><td class="right">    if (link_s == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0182" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      /* TODO: what error to set here? */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0183" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    l<span class="delete">i</span>nk = string_to_char(link_s);</td><td> </td><td class="rblock">    lnk = string_to_char(link_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(link_s);</td><td> </td><td class="right">    string_free(link_s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0184" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    return l<span class="delete">i</span>nk;</td><td> </td><td class="rblock">    return lnk;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) 
*/</td><td> </td><td class="right">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) 
*/</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status = parse_status_msg(msg);</td><td> </td><td class="right">    status = parse_status_msg(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (status == NULL) {</td><td> </td><td class="right">    if (status == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "SFTP server: %s", status-&gt;errormsg);</td><td> </td><td class="right">        "SFTP server: %s", status-&gt;errormsg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status_msg_free(status);</td><td> </td><td class="right">    status_msg_free(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else { /* this shouldn't happen */</td><td> </td><td class="right">  } else { /* this shouldn't happen */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td> </td><td class="right">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0185" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">static sftp_statvfs_t sftp_parse_statvfs(sftp_session sftp, ssh_buffer buf)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       sftp_statvfs_t  statvfs;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  uint64_t tmp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  int ok = 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  statvfs = malloc(sizeof(struct sftp_statvfs_struct));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (statvfs == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ZERO_STRUCTP(statvfs);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  /* try .. catch */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  do {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* file system block size */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_bsize = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* fundamental fs block size */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_frsize = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* number of blocks (unit f_frsize) */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_blocks = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* free blocks in file system */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_bfree = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* free blocks for non-root */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_bavail = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* total file inodes */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_files = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* free file inodes */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_ffree = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* free file inodes for to non-root */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_favail = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* file system id */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_fsid = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* bit mask of f_flag values */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_flag = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    /* maximum filename length */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buffer_get_u64(buf, &amp;tmp) != sizeof(uint64_t)) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      break;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    statvfs-&gt;f_namemax = ntohll(tmp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ok = 1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  } while(0);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (!ok) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    SAFE_FREE(statvfs);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp-&gt;session, SSH_FATAL, "Invalid statvfs structure");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return statvfs;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">sftp_statvfs_t sftp_statvfs(sftp_session sftp, const char *path) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_status_message status = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_message msg = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string pathstr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string ext;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  uint32_t id;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp == NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (path == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp-&gt;version &lt; 3){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp,SSH_REQUEST_DENIED,"sftp version %d does not support</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> sftp_statvfs",sftp-&gt;version);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer = buffer_new();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (buffer == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ext = string_from_char("statvfs@openssh.com");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  pathstr = string_from_char(path);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (pathstr == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  id = sftp_get_new_id(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (buffer_add_u32(buffer, id) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      buffer_add_ssh_string(buffer, ext) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      buffer_add_ssh_string(buffer, pathstr) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(pathstr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp, SSH_FXP_EXTENDED, buffer) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(pathstr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  string_free(pathstr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  while (msg == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    msg = sftp_dequeue(sftp, id);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (msg-&gt;packet_type == SSH_FXP_EXTENDED_REPLY) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       sftp_statvfs_t  buf = sftp_parse_statvfs(sftp, msg-&gt;payload);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buf == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return buf;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status = parse_status_msg(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (status == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "SFTP server: %s", status-&gt;errormsg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status_msg_free(status);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  } else { /* this shouldn't happen */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "Received message %d when attempting to get statvfs", msg-&gt;packet_t</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ype);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">sftp_statvfs_t sftp_fstatvfs(sftp_file file) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_status_message status = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_message msg = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp_session sftp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_string ext;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  uint32_t id;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (file == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  sftp = file-&gt;sftp;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer = buffer_new();</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (buffer == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ext = string_from_char("fstatvfs@openssh.com");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (ext == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  id = sftp_get_new_id(sftp);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (buffer_add_u32(buffer, id) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      buffer_add_ssh_string(buffer, ext) &lt; 0 ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp, SSH_FXP_EXTENDED, buffer) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  string_free(ext);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  while (msg == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    msg = sftp_dequeue(sftp, id);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (msg-&gt;packet_type == SSH_FXP_EXTENDED_REPLY) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       sftp_statvfs_t buf = sftp_parse_statvfs(sftp, msg-&gt;payload);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (buf == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return buf;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status = parse_status_msg(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (status == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "SFTP server: %s", status-&gt;errormsg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    status_msg_free(status);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  } else { /* this shouldn't happen */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        "Received message %d when attempting to set stats", msg-&gt;packet_typ</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">e);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    sftp_message_free(msg);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">void sftp_statvfs_free(sftp_statvfs_t statvfs) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (statvfs == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  SAFE_FREE(statvfs);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* another code written by Nick */</td><td> </td><td class="right">/* another code written by Nick */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0186" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">char <span class="delete">*sftp_canonicalize_path(SFTP_SESSION *sftp,</span> const char *path) {</td><td> </td><td class="rblock">char <span class="insert">*sftp_canonicalize_path(sftp_session sftp,</span> const char *path) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *name</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string name</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pathstr;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string pathstr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *cname;</td><td> </td><td class="right">  char *cname;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0187" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> ignored;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> ignored;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> id;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">if (sftp == NULL)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (path == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_invalid(sftp-&gt;session, __FUNCTION__);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0188" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pathstr = string_from_char(path);</td><td> </td><td class="right">  pathstr = string_from_char(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (pathstr == NULL) {</td><td> </td><td class="right">  if (pathstr == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0189" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0190" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, pathstr) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, pathstr) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> SSH_FXP_REALPATH, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(pathstr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> SSH_FXP_REALPATH, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(pathstr);</td><td> </td><td class="right">    string_free(pathstr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(pathstr);</td><td> </td><td class="right">  string_free(pathstr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l30" /><small>skipping to change at</small><em> line 2444</em></th><th> </th><th><a name="part-r30" /><small>skipping to change at</small><em> line 2986</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    msg = sftp_dequeue(sftp, id);</td><td> </td><td class="right">    msg = sftp_dequeue(sftp, id);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (msg-&gt;packet_type == SSH_FXP_NAME) {</td><td> </td><td class="right">  if (msg-&gt;packet_type == SSH_FXP_NAME) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* we don't care about "count" */</td><td> </td><td class="right">    /* we don't care about "count" */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_get_u32(msg-&gt;payload, &amp;ignored);</td><td> </td><td class="right">    buffer_get_u32(msg-&gt;payload, &amp;ignored);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* we only care about the file name string */</td><td> </td><td class="right">    /* we only care about the file name string */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    name = buffer_get_ssh_string(msg-&gt;payload);</td><td> </td><td class="right">    name = buffer_get_ssh_string(msg-&gt;payload);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (name == NULL) {</td><td> </td><td class="right">    if (name == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0191" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      /* TODO: error message? */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    cname = string_to_char(name);</td><td> </td><td class="right">    cname = string_to_char(name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(name);</td><td> </td><td class="right">    string_free(name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0192" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock">    <span class="insert">if (cname == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return cname;</td><td> </td><td class="right">    return cname;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) 
*/</td><td> </td><td class="right">  } else if (msg-&gt;packet_type == SSH_FXP_STATUS) { /* bad response (error) 
*/</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status = parse_status_msg(msg);</td><td> </td><td class="right">    status = parse_status_msg(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (status == NULL) {</td><td> </td><td class="right">    if (status == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_REQUEST_DENIED,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "SFTP server: %s", status-&gt;errormsg);</td><td> </td><td class="right">        "SFTP server: %s", status-&gt;errormsg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status_msg_free(status);</td><td> </td><td class="right">    status_msg_free(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else { /* this shouldn't happen */</td><td> </td><td class="right">  } else { /* this shouldn't happen */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td> </td><td class="right">        "Received message %d when attempting to set stats", msg-&gt;packet_typ
e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sftp_message_free(msg);</td><td> </td><td class="right">    sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0193" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">SFTP_ATTRIBUTES *sftp_xstat(SFTP_SESSION *</span>sftp, const char *path,</td><td> </td><td class="rblock">static <span class="insert">sftp_attributes sftp_xstat(sftp_session </span>sftp, const char *path,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int param) {</td><td> </td><td class="right">    int param) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0194" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pathstr;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string pathstr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *buffer;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0195" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pathstr = string_from_char(path);</td><td> </td><td class="right">  pathstr = string_from_char(path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (pathstr == NULL) {</td><td> </td><td class="right">  if (pathstr == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0196" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0197" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, pathstr) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, pathstr) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(sftp,</span> param, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    string_free(pathstr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(sftp,</span> param, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(pathstr);</td><td> </td><td class="right">    string_free(pathstr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(pathstr);</td><td> </td><td class="right">  string_free(pathstr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l31" /><small>skipping to change at</small><em> line 2526</em></th><th> </th><th><a name="part-r31" /><small>skipping to change at</small><em> line 3078</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    status_msg_free(status);</td><td> </td><td class="right">    status_msg_free(status);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td> </td><td class="right">  ssh_set_error(sftp-&gt;session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Received mesg %d during stat()", msg-&gt;packet_type);</td><td> </td><td class="right">      "Received mesg %d during stat()", msg-&gt;packet_type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sftp_message_free(msg);</td><td> </td><td class="right">  sftp_message_free(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0198" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_ATTRIBUTES *sftp_stat(SFTP_SESSION *</span>session, const char *path) {</td><td> </td><td class="rblock"><span class="insert">sftp_attributes sftp_stat(sftp_session </span>session, const char *path) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp_xstat(session, path, SSH_FXP_STAT);</td><td> </td><td class="right">  return sftp_xstat(session, path, SSH_FXP_STAT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0199" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_ATTRIBUTES *sftp_lstat(SFTP_SESSION *</span>session, const char *path) {</td><td> </td><td class="rblock"><span class="insert">sftp_attributes sftp_lstat(sftp_session </span>session, const char *path) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sftp_xstat(session, path, SSH_FXP_LSTAT);</td><td> </td><td class="right">  return sftp_xstat(session, path, SSH_FXP_LSTAT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0200" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SFTP_ATTRIBUTES *sftp_fstat(SFTP_FILE *file)</span> {</td><td> </td><td class="rblock"><span class="insert">sftp_attributes sftp_fstat(sftp_file file)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STATUS_MESSAGE *status</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_status_message status</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SFTP_MESSAGE *msg</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">sftp_message msg</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  u32</span> id;</td><td> </td><td class="rblock"><span class="insert">  uint32_t</span> id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = buffer_new();</td><td> </td><td class="right">  buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0201" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(file-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  id = sftp_get_new_id(file-&gt;sftp);</td><td> </td><td class="right">  id = sftp_get_new_id(file-&gt;sftp);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td> </td><td class="right">  if (buffer_add_u32(buffer, id) &lt; 0 ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0202" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; <span class="delete">0 ||</span></td><td> </td><td class="rblock">      buffer_add_ssh_string(buffer, file-&gt;handle) &lt; <span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      sftp_packet_write(file-&gt;sftp,</span> SSH_FXP_FSTAT, buffer) &lt; 0) {</td><td> </td><td class="rblock"><span class="insert">    ssh_set_error_oom(file-&gt;sftp-&gt;session);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    buffer_free(buffer);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (sftp_packet_write(file-&gt;sftp,</span> SSH_FXP_FSTAT, buffer) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (msg == NULL) {</td><td> </td><td class="right">  while (msg == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (sftp_read_and_dispatch(file-&gt;sftp) &lt; 0) {</td><td> </td><td class="right">    if (sftp_read_and_dispatch(file-&gt;sftp) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    msg = sftp_dequeue(file-&gt;sftp, id);</td><td> </td><td class="right">    msg = sftp_dequeue(file-&gt;sftp, id);</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 202 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>321 lines changed or deleted</i></th><th><i> </i></th><th><i>885 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
