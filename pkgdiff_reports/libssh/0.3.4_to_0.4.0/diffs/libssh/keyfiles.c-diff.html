<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: keyfiles.c - keyfiles.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;keyfiles.c&nbsp;</th><th> </th><th>&nbsp;keyfiles.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 25</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 25</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILI
TY</td><td> </td><td class="right"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILI
TY</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</td><td> </td><td class="right"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * License for more details.</td><td> </td><td class="right"> * License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU Lesser General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU Lesser General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with the SSH Library; see the file COPYING.  If not, write to</td><td> </td><td class="right"> * along with the SSH Library; see the file COPYING.  If not, write to</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</td><td> </td><td class="right"> * the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MA 02111-1307, USA.</td><td> </td><td class="right"> * MA 02111-1307, USA.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "config.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;ctype.h&gt;</td><td> </td><td class="right">#include &lt;ctype.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;errno.h&gt;</td><td> </td><td class="right">#include &lt;errno.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;fcntl.h&gt;</td><td> </td><td class="right">#include &lt;fcntl.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/stat.h&gt;</td><td> </td><td class="right">#include &lt;sys/stat.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/types.h&gt;</td><td> </td><td class="right">#include &lt;sys/types.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdio.h&gt;</td><td> </td><td class="right">#include &lt;stdio.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;string.h&gt;</td><td> </td><td class="right">#include &lt;string.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">#include &lt;unistd.h&gt;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdlib.h&gt;</td><td> </td><td class="right">#include &lt;stdlib.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;arpa/inet.h&gt;</td><td> </td><td class="right">#include &lt;arpa/inet.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/keyfiles.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/wrapper.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/misc.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/keys.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">/*todo: remove this include */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/string.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;gcrypt.h&gt;</td><td> </td><td class="right">#include &lt;gcrypt.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/pem.h&gt;</td><td> </td><td class="right">#include &lt;openssl/pem.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/dsa.h&gt;</td><td> </td><td class="right">#include &lt;openssl/dsa.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/err.h&gt;</td><td> </td><td class="right">#include &lt;openssl/err.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/rsa.h&gt;</td><td> </td><td class="right">#include &lt;openssl/rsa.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_LIBCRYPTO */</td><td> </td><td class="right">#endif /* HAVE_LIBCRYPTO */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 92</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 102</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      k = header[2*i+1] - 'A' + 10;</td><td> </td><td class="right">      k = header[2*i+1] - 'A' + 10;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    else if ((header[2*i+1] &gt;= 'a') &amp;&amp; (header[2*i+1] &lt;= 'f'))</td><td> </td><td class="right">    else if ((header[2*i+1] &gt;= 'a') &amp;&amp; (header[2*i+1] &lt;= 'f'))</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      k = header[2*i+1] - 'a' + 10;</td><td> </td><td class="right">      k = header[2*i+1] - 'a' + 10;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    else</td><td> </td><td class="right">    else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    iv[i] = (j &lt;&lt; 4) + k;</td><td> </td><td class="right">    iv[i] = (j &lt;&lt; 4) + k;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">u32</span> char_to_u32(unsigned char *data, <span class="delete">u32</span> size) {</td><td> </td><td class="rblock">static <span class="insert">uint32_t</span> char_to_u32(unsigned char *data, <span class="insert">uint32_t</span> size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> ret;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> ret;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> i;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  for (i = 0, ret = 0; i &lt; size; ret = ret &lt;&lt; 8, ret += data[i++])</td><td> </td><td class="right">  for (i = 0, ret = 0; i &lt; size; ret = ret &lt;&lt; 8, ret += data[i++])</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ;</td><td> </td><td class="right">    ;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ret;</td><td> </td><td class="right">  return ret;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">u32 asn1_get_len(BUFFER *buffer)</span> {</td><td> </td><td class="rblock">static <span class="insert">uint32_t asn1_get_len(ssh_buffer buffer)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> len;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char tmp[4];</td><td> </td><td class="right">  unsigned char tmp[4];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_get_data(buffer,tmp,1) == 0) {</td><td> </td><td class="right">  if (buffer_get_data(buffer,tmp,1) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (tmp[0] &gt; 127) {</td><td> </td><td class="right">  if (tmp[0] &gt; 127) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    len = tmp[0] &amp; 127;</td><td> </td><td class="right">    len = tmp[0] &amp; 127;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (len &gt; 4) {</td><td> </td><td class="right">    if (len &gt; 4) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0; /* Length doesn't fit in u32. Can this really happen? */</td><td> </td><td class="right">      return 0; /* Length doesn't fit in u32. Can this really happen? */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 125</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 135</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0;</td><td> </td><td class="right">      return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    len = char_to_u32(tmp, len);</td><td> </td><td class="right">    len = char_to_u32(tmp, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    len = char_to_u32(tmp, 1);</td><td> </td><td class="right">    len = char_to_u32(tmp, 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return len;</td><td> </td><td class="right">  return len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">STRING *asn1_get_int(BUFFER *buffer)</span> {</td><td> </td><td class="rblock">static <span class="insert">ssh_string asn1_get_int(ssh_buffer buffer)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *str;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string str;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char type;</td><td> </td><td class="right">  unsigned char type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32</span> size;</td><td> </td><td class="rblock">  u<span class="insert">int32_t</span> size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_get_data(buffer, &amp;type, 1) == 0 || type != ASN1_INTEGER) {</td><td> </td><td class="right">  if (buffer_get_data(buffer, &amp;type, 1) == 0 || type != ASN1_INTEGER) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = asn1_get_len(buffer);</td><td> </td><td class="right">  size = asn1_get_len(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (size == 0) {</td><td> </td><td class="right">  if (size == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  str = string_new(size);</td><td> </td><td class="right">  str = string_new(size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 151</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 161</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_get_data(buffer, str-&gt;string, size) == 0) {</td><td> </td><td class="right">  if (buffer_get_data(buffer, str-&gt;string, size) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(str);</td><td> </td><td class="right">    string_free(str);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return str;</td><td> </td><td class="right">  return str;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int asn1_check_sequence(<span class="delete">BUFFER *</span>buffer) {</td><td> </td><td class="rblock">static int asn1_check_sequence(<span class="insert">ssh_buffer </span>buffer) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *j = NULL;</td><td> </td><td class="right">  unsigned char *j = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char tmp;</td><td> </td><td class="right">  unsigned char tmp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int i;</td><td> </td><td class="right">  int i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> size;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> padding;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> padding;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_get_data(buffer, &amp;tmp, 1) == 0 || tmp != ASN1_SEQUENCE) {</td><td> </td><td class="right">  if (buffer_get_data(buffer, &amp;tmp, 1) == 0 || tmp != ASN1_SEQUENCE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size = asn1_get_len(buffer);</td><td> </td><td class="right">  size = asn1_get_len(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if ((padding = buffer_get_len(buffer) - buffer-&gt;pos - size) &gt; 0) {</td><td> </td><td class="right">  if ((padding = buffer_get_len(buffer) - buffer-&gt;pos - size) &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    for (i = buffer_get_len(buffer) - buffer-&gt;pos - size,</td><td> </td><td class="right">    for (i = buffer_get_len(buffer) - buffer-&gt;pos - size,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">         j = buffer_get(buffer) + size + buffer-&gt;pos;</td><td> </td><td class="rblock">         j = <span class="insert">(unsigned char*)</span>buffer_get(buffer) + size + buffer-&gt;pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         i;</td><td> </td><td class="right">         i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         i--, j++)</td><td> </td><td class="right">         i--, j++)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    {</td><td> </td><td class="right">    {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (*j != padding) {                   /* padding is allowed */</td><td> </td><td class="right">      if (*j != padding) {                   /* padding is allowed */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return 0;                            /* but nothing else */</td><td> </td><td class="right">        return 0;                            /* but nothing else */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 1;</td><td> </td><td class="right">  return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 233</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 243</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        key[j] = digest[i];</td><td> </td><td class="right">        key[j] = digest[i];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int privatekey_decrypt(int algo, int mode, unsigned int key_len,</td><td> </td><td class="right">static int privatekey_decrypt(int algo, int mode, unsigned int key_len,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       unsigned char *iv, unsigned int iv_len,</td><td> </td><td class="right">                       unsigned char *iv, unsigned int iv_len,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">BUFFER *</span>data, ssh_auth_callback cb,</td><td> </td><td class="rblock">                       <span class="insert">ssh_buffer </span>data, ssh_auth_callback cb,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       void *userdata,</td><td> </td><td class="right">                       void *userdata,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       const char *desc)</td><td> </td><td class="right">                       const char *desc)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char passphrase[MAX_PASSPHRASE_SIZE] = {0};</td><td> </td><td class="right">  char passphrase[MAX_PASSPHRASE_SIZE] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char key[MAX_KEY_SIZE] = {0};</td><td> </td><td class="right">  unsigned char key[MAX_KEY_SIZE] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *tmp = NULL;</td><td> </td><td class="right">  unsigned char *tmp = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_cipher_hd_t cipher;</td><td> </td><td class="right">  gcry_cipher_hd_t cipher;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = -1;</td><td> </td><td class="right">  int rc = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!algo) {</td><td> </td><td class="right">  if (!algo) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 334</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 344</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  *iv = malloc(*iv_len);</td><td> </td><td class="right">  *iv = malloc(*iv_len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (*iv == NULL) {</td><td> </td><td class="right">  if (*iv == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return load_iv(header + iv_pos, *iv, *iv_len);</td><td> </td><td class="right">  return load_iv(header + iv_pos, *iv, *iv_len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">BUFFER *</span>privatekey_file_to_buffer(FILE *fp, int type,</td><td> </td><td class="rblock">static <span class="insert">ssh_buffer </span>privatekey_file_to_buffer(FILE *fp, int type,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_auth_callback cb, void *userdata, const char *desc) {</td><td> </td><td class="right">    ssh_auth_callback cb, void *userdata, const char *desc) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *out</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer out</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char buf[MAXLINESIZE] = {0};</td><td> </td><td class="right">  char buf[MAXLINESIZE] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *iv = NULL;</td><td> </td><td class="right">  unsigned char *iv = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *header_begin;</td><td> </td><td class="right">  const char *header_begin;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *header_end;</td><td> </td><td class="right">  const char *header_end;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int header_begin_size;</td><td> </td><td class="right">  unsigned int header_begin_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int header_end_size;</td><td> </td><td class="right">  unsigned int header_end_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int key_len = 0;</td><td> </td><td class="right">  unsigned int key_len = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int iv_len = 0;</td><td> </td><td class="right">  unsigned int iv_len = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int algo = 0;</td><td> </td><td class="right">  int algo = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int mode = 0;</td><td> </td><td class="right">  int mode = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 448</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 458</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(iv);</td><td> </td><td class="right">  SAFE_FREE(iv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return out;</td><td> </td><td class="right">  return out;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int read_rsa_privatekey(FILE *fp, gcry_sexp_t *r,</td><td> </td><td class="right">static int read_rsa_privatekey(FILE *fp, gcry_sexp_t *r,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_auth_callback cb, void *userdata, const char *desc) {</td><td> </td><td class="right">    ssh_auth_callback cb, void *userdata, const char *desc) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *n</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string n</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *e</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string e</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *d</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string d</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *p</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string p</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *q</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string q</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *unused1</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string unused1</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *unused2</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string unused2</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *u</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string u</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *v</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string v</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = 1;</td><td> </td><td class="right">  int rc = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = privatekey_file_to_buffer(fp, TYPE_RSA, cb, userdata, desc);</td><td> </td><td class="right">  buffer = privatekey_file_to_buffer(fp, TYPE_RSA, cb, userdata, desc);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!asn1_check_sequence(buffer)) {</td><td> </td><td class="right">  if (!asn1_check_sequence(buffer)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 520</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 530</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(unused1);</td><td> </td><td class="right">  string_free(unused1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(unused2);</td><td> </td><td class="right">  string_free(unused2);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(u);</td><td> </td><td class="right">  string_free(u);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(v);</td><td> </td><td class="right">  string_free(v);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int read_dsa_privatekey(FILE *fp, gcry_sexp_t *r, ssh_auth_callback 
cb,</td><td> </td><td class="right">static int read_dsa_privatekey(FILE *fp, gcry_sexp_t *r, ssh_auth_callback 
cb,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    void *userdata, const char *desc) {</td><td> </td><td class="right">    void *userdata, const char *desc) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buffer</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buffer</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *p</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string p</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *q</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string q</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *g</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string g</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *y</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string y</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *x</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string x</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *v</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string v</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = 1;</td><td> </td><td class="right">  int rc = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer = privatekey_file_to_buffer(fp, TYPE_DSS, cb, userdata, desc);</td><td> </td><td class="right">  buffer = privatekey_file_to_buffer(fp, TYPE_DSS, cb, userdata, desc);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer == NULL) {</td><td> </td><td class="right">  if (buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!asn1_check_sequence(buffer)) {</td><td> </td><td class="right">  if (!asn1_check_sequence(buffer)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(buffer);</td><td> </td><td class="right">    buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 581</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 591</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(y);</td><td> </td><td class="right">  string_free(y);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(x);</td><td> </td><td class="right">  string_free(x);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(v);</td><td> </td><td class="right">  string_free(v);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_LIBGCRYPT */</td><td> </td><td class="right">#endif /* HAVE_LIBGCRYPT */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int pem_get_password(char *buf, int size, int rwflag, void *userdata
) {</td><td> </td><td class="right">static int pem_get_password(char *buf, int size, int rwflag, void *userdata
) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">SSH_SESSION *</span>session = userdata;</td><td> </td><td class="rblock">  <span class="insert">ssh_session </span>session = userdata;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* unused flag */</td><td> </td><td class="right">  /* unused flag */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  (void) rwflag;</td><td> </td><td class="right">  (void) rwflag;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(buf);</td><td> </td><td class="right">  ZERO_STRUCTP(buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">ssh_log(session, SSH_LOG_RARE,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      "Trying to call external authentication function");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (session &amp;&amp; <span class="delete">session-&gt;options-&gt;auth_function)</span> {</td><td> </td><td class="rblock">  if (session &amp;&amp; <span class="insert">session-&gt;callbacks-&gt;auth_function)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    if <span class="delete">((*session-&gt;options-&gt;auth_function)("Passphrase</span> for private key:", <span class="delete">b</span></td><td> </td><td class="rblock">    if <span class="insert">(session-&gt;callbacks-&gt;auth_function("Passphrase</span> for private key:", <span class="insert">bu</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">uf,</span> size, 0, 0,</td><td> </td><td class="rblock"><span class="insert">f,</span> size, 0, 0,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        <span class="delete">session-&gt;options-&gt;auth_userdata ? session-&gt;options-&gt;auth_userdata :</span></td><td> </td><td class="rblock">        <span class="insert">session-&gt;callbacks-&gt;userdata)</span> &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> NULL)</span> &lt; 0) {</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0;</td><td> </td><td class="right">      return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return strlen(buf);</td><td> </td><td class="right">    return strlen(buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_LIBCRYPTO */</td><td> </td><td class="right">#endif /* HAVE_LIBCRYPTO */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l10" /><small>skipping to change at</small><em> line 614</em></th><th> </th><th><a name="part-r10" /><small>skipping to change at</small><em> line 626</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* TODO : implement it to read both DSA and RSA at once */</td><td> </td><td class="right">/* TODO : implement it to read both DSA and RSA at once */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief Reads a SSH private key from a file</td><td> </td><td class="right">/** \brief Reads a SSH private key from a file</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param session SSH Session</td><td> </td><td class="right"> * \param session SSH Session</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param filename Filename containing the private key</td><td> </td><td class="right"> * \param filename Filename containing the private key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param type Type of the private key. One of TYPE_DSS or TYPE_RSA.</td><td> </td><td class="right"> * \param type Type of the private key. One of TYPE_DSS or TYPE_RSA.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param passphrase Passphrase to decrypt the private key. Set to null if 
none is needed or it is unknown.</td><td> </td><td class="right"> * \param passphrase Passphrase to decrypt the private key. Set to null if 
none is needed or it is unknown.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns a PRIVATE_KEY object containing the private key, or NULL if it 
failed.</td><td> </td><td class="right"> * \returns a PRIVATE_KEY object containing the private key, or NULL if it 
failed.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see privatekey_free()</td><td> </td><td class="right"> * \see privatekey_free()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see publickey_from_privatekey()</td><td> </td><td class="right"> * \see publickey_from_privatekey()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PRIVATE_KEY *privatekey_from_file(SSH_SESSION *session, const char *filenam
</span>e,</td><td> </td><td class="rblock"><span class="insert">ssh_private_key privatekey_from_file(ssh_session session, const char *filen
am</span>e,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int type, const char *passphrase) {</td><td> </td><td class="right">    int type, const char *passphrase) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_auth_callback auth_cb = NULL;</td><td> </td><td class="right">  ssh_auth_callback auth_cb = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PRIVATE_KEY *</span>privkey = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_private_key </span>privkey = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  void *auth_ud = NULL;</td><td> </td><td class="right">  void *auth_ud = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  FILE *file = NULL;</td><td> </td><td class="right">  FILE *file = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t dsa = NULL;</td><td> </td><td class="right">  gcry_sexp_t dsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t rsa = NULL;</td><td> </td><td class="right">  gcry_sexp_t rsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int valid;</td><td> </td><td class="right">  int valid;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  DSA *dsa = NULL;</td><td> </td><td class="right">  DSA *dsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  RSA *rsa = NULL;</td><td> </td><td class="right">  RSA *rsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  ssh_log(session, SSH_LOG_RARE, "Trying to open %s", filename);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  file = fopen(filename,"r");</td><td> </td><td class="right">  file = fopen(filename,"r");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_REQUEST_DENIED,</td><td> </td><td class="right">    ssh_set_error(session, SSH_REQUEST_DENIED,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Error opening %s: %s", filename, strerror(errno));</td><td> </td><td class="right">        "Error opening %s: %s", filename, strerror(errno));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">ssh_log(session, SSH_LOG_RARE, "Trying to read %s, passphase=%s, authcb=%</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">s",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      filename, passphrase ? "true" : "false",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      session-&gt;callbacks &amp;&amp; session-&gt;callbacks-&gt;auth_function ? "true" : "f</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">alse");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch (type) {</td><td> </td><td class="right">  switch (type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_DSS:</td><td> </td><td class="right">    case TYPE_DSS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (passphrase == NULL) {</td><td> </td><td class="right">      if (passphrase == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        if <span class="delete">(session-&gt;options-&gt;auth_function)</span> {</td><td> </td><td class="rblock">        if <span class="insert">(session-&gt;callbacks-&gt;auth_function)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          auth_cb = <span class="delete">session-&gt;options-&gt;auth_function;</span></td><td> </td><td class="rblock">          auth_cb = <span class="insert">session-&gt;callbacks-&gt;auth_function;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          if (session-&gt;options-&gt;auth_userdata) {</span></td><td> </td><td class="rblock">          auth_ud = <span class="insert">session-&gt;callbacks-&gt;userdata;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">            auth_ud = <span class="delete">session-&gt;options-&gt;auth_userdata;</span></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          valid = read_dsa_privatekey(file, &amp;dsa, auth_cb, auth_ud,</td><td> </td><td class="right">          valid = read_dsa_privatekey(file, &amp;dsa, auth_cb, auth_ud,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              "Passphrase for private key:");</td><td> </td><td class="right">              "Passphrase for private key:");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        } else { /* authcb */</td><td> </td><td class="right">        } else { /* authcb */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          valid = read_dsa_privatekey(file, &amp;dsa, NULL, NULL, NULL);</td><td> </td><td class="right">          valid = read_dsa_privatekey(file, &amp;dsa, NULL, NULL, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        } /* authcb */</td><td> </td><td class="right">        } /* authcb */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      } else { /* passphrase */</td><td> </td><td class="right">      } else { /* passphrase */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        valid = read_dsa_privatekey(file, &amp;dsa, NULL,</td><td> </td><td class="right">        valid = read_dsa_privatekey(file, &amp;dsa, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            (void *) passphrase, NULL);</td><td> </td><td class="right">            (void *) passphrase, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l11" /><small>skipping to change at</small><em> line 679</em></th><th> </th><th><a name="part-r11" /><small>skipping to change at</small><em> line 694</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (dsa == NULL) {</td><td> </td><td class="right">      if (dsa == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            "Parsing private key %s: %s",</td><td> </td><td class="right">            "Parsing private key %s: %s",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            filename, ERR_error_string(ERR_get_error(), NULL));</td><td> </td><td class="right">            filename, ERR_error_string(ERR_get_error(), NULL));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_RSA:</td><td> </td><td class="right">    case TYPE_RSA:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (passphrase == NULL) {</td><td> </td><td class="right">      if (passphrase == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        if <span class="delete">(session-&gt;options-&gt;auth_function)</span> {</td><td> </td><td class="rblock">       if <span class="insert">(session-&gt;callbacks &amp;&amp; session-&gt;callbacks-&gt;auth_function)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          auth_cb = <span class="delete">session-&gt;options-&gt;auth_function;</span></td><td> </td><td class="rblock">               auth_cb = <span class="insert">session-&gt;callbacks-&gt;auth_function;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          if (session-&gt;options-&gt;auth_userdata) {</span></td><td> </td><td class="rblock">               auth_ud = <span class="insert">session-&gt;callbacks-&gt;userdata;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">            auth_ud = <span class="delete">session-&gt;options-&gt;auth_userdata;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">          }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          valid = read_rsa_privatekey(file, &amp;rsa, auth_cb, auth_ud,</td><td> </td><td class="right">          valid = read_rsa_privatekey(file, &amp;rsa, auth_cb, auth_ud,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              "Passphrase for private key:");</td><td> </td><td class="right">              "Passphrase for private key:");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        } else { /* authcb */</td><td> </td><td class="right">        } else { /* authcb */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          valid = read_rsa_privatekey(file, &amp;rsa, NULL, NULL, NULL);</td><td> </td><td class="right">          valid = read_rsa_privatekey(file, &amp;rsa, NULL, NULL, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        } /* authcb */</td><td> </td><td class="right">        } /* authcb */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      } else { /* passphrase */</td><td> </td><td class="right">      } else { /* passphrase */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        valid = read_rsa_privatekey(file, &amp;rsa, NULL,</td><td> </td><td class="right">        valid = read_rsa_privatekey(file, &amp;rsa, NULL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            (void *) passphrase, NULL);</td><td> </td><td class="right">            (void *) passphrase, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l12" /><small>skipping to change at</small><em> line 724</em></th><th> </th><th><a name="part-r12" /><small>skipping to change at</small><em> line 737</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            filename, ERR_error_string(ERR_get_error(),NULL));</td><td> </td><td class="right">            filename, ERR_error_string(ERR_get_error(),NULL));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL, "Invalid private key type %d", type
);</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL, "Invalid private key type %d", type
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } /* switch */</td><td> </td><td class="right">  } /* switch */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  privkey = malloc(sizeof(<span class="delete">PRIVATE_KEY</span>));</td><td> </td><td class="rblock">  privkey = malloc(sizeof(<span class="insert">struct ssh_private_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (privkey == NULL) {</td><td> </td><td class="right">  if (privkey == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_release(dsa);</td><td> </td><td class="right">    gcry_sexp_release(dsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_release(rsa);</td><td> </td><td class="right">    gcry_sexp_release(rsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    DSA_free(dsa);</td><td> </td><td class="right">    DSA_free(dsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    RSA_free(rsa);</td><td> </td><td class="right">    RSA_free(rsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;type = type;</td><td> </td><td class="right">  privkey-&gt;type = type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;dsa_priv = dsa;</td><td> </td><td class="right">  privkey-&gt;dsa_priv = dsa;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;rsa_priv = rsa;</td><td> </td><td class="right">  privkey-&gt;rsa_priv = rsa;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return privkey;</td><td> </td><td class="right">  return privkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* same that privatekey_from_file() but without any passphrase things. */</td><td> </td><td class="right">/* same that privatekey_from_file() but without any passphrase things. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">PRIVATE_KEY *</span>_privatekey_from_file(void *session, const char *filename,</td><td> </td><td class="rblock"><span class="insert">ssh_private_key </span>_privatekey_from_file(void *session, const char *filename,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int type) {</td><td> </td><td class="right">    int type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PRIVATE_KEY *</span>privkey = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_private_key </span>privkey = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  FILE *file = NULL;</td><td> </td><td class="right">  FILE *file = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t dsa = NULL;</td><td> </td><td class="right">  gcry_sexp_t dsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t rsa = NULL;</td><td> </td><td class="right">  gcry_sexp_t rsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int valid;</td><td> </td><td class="right">  int valid;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  DSA *dsa = NULL;</td><td> </td><td class="right">  DSA *dsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  RSA *rsa = NULL;</td><td> </td><td class="right">  RSA *rsa = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l13" /><small>skipping to change at</small><em> line 812</em></th><th> </th><th><a name="part-r13" /><small>skipping to change at</small><em> line 825</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            filename, ERR_error_string(ERR_get_error(), NULL));</td><td> </td><td class="right">            filename, ERR_error_string(ERR_get_error(), NULL));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_set_error(session, SSH_FATAL, "Invalid private key type %d", ty
pe);</td><td> </td><td class="right">        ssh_set_error(session, SSH_FATAL, "Invalid private key type %d", ty
pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return NULL;</td><td> </td><td class="right">        return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  privkey = malloc(sizeof(<span class="delete">PRIVATE_KEY</span>));</td><td> </td><td class="rblock">  privkey = malloc(sizeof(<span class="insert">struct ssh_private_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (privkey == NULL) {</td><td> </td><td class="right">  if (privkey == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_release(dsa);</td><td> </td><td class="right">    gcry_sexp_release(dsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_release(rsa);</td><td> </td><td class="right">    gcry_sexp_release(rsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    DSA_free(dsa);</td><td> </td><td class="right">    DSA_free(dsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    RSA_free(rsa);</td><td> </td><td class="right">    RSA_free(rsa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l14" /><small>skipping to change at</small><em> line 834</em></th><th> </th><th><a name="part-r14" /><small>skipping to change at</small><em> line 847</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;type = type;</td><td> </td><td class="right">  privkey-&gt;type = type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;dsa_priv = dsa;</td><td> </td><td class="right">  privkey-&gt;dsa_priv = dsa;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  privkey-&gt;rsa_priv = rsa;</td><td> </td><td class="right">  privkey-&gt;rsa_priv = rsa;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return privkey;</td><td> </td><td class="right">  return privkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief deallocate a private key</td><td> </td><td class="right">/** \brief deallocate a private key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param prv a PRIVATE_KEY object</td><td> </td><td class="right"> * \param prv a PRIVATE_KEY object</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void privatekey_free(<span class="delete">PRIVATE_KEY *</span>prv) {</td><td> </td><td class="rblock">void privatekey_free(<span class="insert">ssh_private_key </span>prv) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (prv == NULL) {</td><td> </td><td class="right">  if (prv == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_release(prv-&gt;dsa_priv);</td><td> </td><td class="right">  gcry_sexp_release(prv-&gt;dsa_priv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_release(prv-&gt;rsa_priv);</td><td> </td><td class="right">  gcry_sexp_release(prv-&gt;rsa_priv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  DSA_free(prv-&gt;dsa_priv);</td><td> </td><td class="right">  DSA_free(prv-&gt;dsa_priv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  RSA_free(prv-&gt;rsa_priv);</td><td> </td><td class="right">  RSA_free(prv-&gt;rsa_priv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  memset(prv, 0, sizeof(<span class="delete">PRIVATE_KEY</span>));</td><td> </td><td class="rblock">  memset(prv, 0, sizeof(<span class="insert">struct ssh_private_key_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(prv);</td><td> </td><td class="right">  SAFE_FREE(prv);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief Retrieve a public key from a file</td><td> </td><td class="right">/** \brief Retrieve a public key from a file</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param session the SSH session</td><td> </td><td class="right"> * \param session the SSH session</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param filename Filename of the key</td><td> </td><td class="right"> * \param filename Filename of the key</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> * \param <span class="delete">_type Pointer to a integer. If it is not null, it contains the ty
p</span>e of the key after execution.</td><td> </td><td class="rblock"> * \param <span class="insert">type Pointer to a integer. If it is not null, it contains the typ
</span>e of the key after execution.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return a SSH String containing the public key, or NULL if it failed.</td><td> </td><td class="right"> * \return a SSH String containing the public key, or NULL if it failed.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see string_free()</td><td> </td><td class="right"> * \see string_free()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see publickey_from_privatekey()</td><td> </td><td class="right"> * \see publickey_from_privatekey()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *publickey_from_file(SSH_SESSION *</span>session, const char *filename,</td><td> </td><td class="rblock"><span class="insert">ssh_string publickey_from_file(ssh_session </span>session, const char *filename,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int *type) {</td><td> </td><td class="right">    int *type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *</span>buffer = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer </span>buffer = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char buf[4096] = {0};</td><td> </td><td class="right">  char buf[4096] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *</span>str = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string </span>str = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *ptr = NULL;</td><td> </td><td class="right">  char *ptr = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int key_type;</td><td> </td><td class="right">  int key_type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int fd = -1;</td><td> </td><td class="right">  int fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int r;</td><td> </td><td class="right">  int r;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  fd = open(filename, O_RDONLY);</td><td> </td><td class="right">  fd = open(filename, O_RDONLY);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (fd &lt; 0) {</td><td> </td><td class="right">  if (fd &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_REQUEST_DENIED, "Public key file doesn't exi
st");</td><td> </td><td class="right">    ssh_set_error(session, SSH_REQUEST_DENIED, "Public key file doesn't exi
st");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l15" /><small>skipping to change at</small><em> line 927</em></th><th> </th><th><a name="part-r15" /><small>skipping to change at</small><em> line 940</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_fill(str, buffer_get(buffer), buffer_get_len(buffer));</td><td> </td><td class="right">  string_fill(str, buffer_get(buffer), buffer_get_len(buffer));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(buffer);</td><td> </td><td class="right">  buffer_free(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (type) {</td><td> </td><td class="right">  if (type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    *type = key_type;</td><td> </td><td class="right">    *type = key_type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return str;</td><td> </td><td class="right">  return str;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *try_publickey_from_file(SSH_SESSION *session, struct keys_struct ke
</span>ytab,</td><td> </td><td class="rblock"><span class="insert">ssh_string try_publickey_from_file(ssh_session session, struct ssh_keys_str
uct ke</span>ytab,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char **privkeyfile, int *type) {</td><td> </td><td class="right">    char **privkeyfile, int *type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">static</span> char <span class="delete">*home = NULL;</span></td><td> </td><td class="rblock">  char <span class="insert">*public;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock">  char <span class="insert">*private;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  char <span class="delete">public[256] = {0};</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  char private[256] = {0};</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *priv;</td><td> </td><td class="right">  const char *priv;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *pub;</td><td> </td><td class="right">  const char *pub;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *new;</td><td> </td><td class="right">  char *new;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pubkey;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string pubkey=NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"></span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  if (home == NULL) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    home = ssh_get_user_home_dir();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    if (home == NULL) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      ssh_set_error(session,SSH_FATAL,"User home dir impossible to guess");</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">      return NULL;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pub = keytab.publickey;</td><td> </td><td class="right">  pub = keytab.publickey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (pub == NULL) {</td><td> </td><td class="right">  if (pub == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  priv = keytab.privatekey;</td><td> </td><td class="right">  priv = keytab.privatekey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (priv == NULL) {</td><td> </td><td class="right">  if (priv == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  <span class="insert">if (session-&gt;sshdir == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    if (ssh_options_set(session, SSH_OPTIONS_SSH_DIR, NULL) &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* are them readable ? */</td><td> </td><td class="right">  /* are them readable ? */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">snprintf(public,</span> sizeof(public), <span class="delete">pub, home);</span></td><td> </td><td class="rblock">  <span class="insert">public=dir_expand_dup(session,pub,1);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_PACKET, "Trying to open <span class="delete">public key</span> %s", public);</td><td> </td><td class="rblock"><span class="insert">  private=dir_expand_dup(session,priv,1);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  //snprintf(public,</span> sizeof(public), <span class="insert">"%s/%s", session-&gt;sshdir, pub);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  //snprintf(private, sizeof(private), "%s/%s", session-&gt;sshdir, priv);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_PACKET, "Trying to open <span class="insert">publickey</span> %s", public);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!ssh_file_readaccess_ok(public)) {</td><td> </td><td class="right">  if (!ssh_file_readaccess_ok(public)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    ssh_log(session, SSH_LOG_PACKET, <span class="delete">"Failed");</span></td><td> </td><td class="rblock">    ssh_log(session, SSH_LOG_PACKET, <span class="insert">"Failed to open publickey %s", public)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    return NULL;</span></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    goto error;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">snprintf(private, sizeof(private), priv, home);</span></td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_PACKET, "Trying to open <span class="insert">privatekey</span> %s", <span class="insert">private)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_PACKET, "Trying to open <span class="delete">private key</span> %s", <span class="delete">private</span></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!ssh_file_readaccess_ok(private)) {</td><td> </td><td class="right">  if (!ssh_file_readaccess_ok(private)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    ssh_log(session, SSH_LOG_PACKET, <span class="delete">"Failed");</span></td><td> </td><td class="rblock">    ssh_log(session, SSH_LOG_PACKET, <span class="insert">"Failed to open privatekey %s", privat</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    return NULL;</span></td><td> </td><td class="rblock"><span class="insert">e);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    goto error;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  ssh_log(session, SSH_LOG_PACKET, "Success <span class="delete">read</span>ing public and private key"
);</td><td> </td><td class="rblock">  ssh_log(session, SSH_LOG_PACKET, "Success <span class="insert">open</span>ing public and private key"
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /*</td><td> </td><td class="right">  /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * We are sure both the private and public key file is readable. We retur
n</td><td> </td><td class="right">   * We are sure both the private and public key file is readable. We retur
n</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * the public as a string, and the private filename as an argument</td><td> </td><td class="right">   * the public as a string, and the private filename as an argument</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   */</td><td> </td><td class="right">   */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pubkey = publickey_from_file(session, public, type);</td><td> </td><td class="right">  pubkey = publickey_from_file(session, public, type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (pubkey == NULL) {</td><td> </td><td class="right">  if (pubkey == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_log(session, SSH_LOG_PACKET,</td><td> </td><td class="right">    ssh_log(session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Wasn't able to open public key file %s: %s",</td><td> </td><td class="right">        "Wasn't able to open public key file %s: %s",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        public,</td><td> </td><td class="right">        public,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        ssh_get_error(session));</td><td> </td><td class="right">        ssh_get_error(session));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">return NULL</span>;</td><td> </td><td class="rblock">    <span class="insert">goto error</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  new = realloc(*privkeyfile, strlen(private) + 1);</td><td> </td><td class="right">  new = realloc(*privkeyfile, strlen(private) + 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (new == NULL) {</td><td> </td><td class="right">  if (new == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    string_free(pubkey);</td><td> </td><td class="right">    string_free(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">return NULL</span>;</td><td> </td><td class="rblock">    <span class="insert">goto error</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  strcpy(new, private);</td><td> </td><td class="right">  strcpy(new, private);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  *privkeyfile = new;</td><td> </td><td class="right">  *privkeyfile = new;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"><span class="insert">error:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  SAFE_FREE(public);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  SAFE_FREE(private);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return pubkey;</td><td> </td><td class="right">  return pubkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int alldigits(const char *s) {</td><td> </td><td class="right">static int alldigits(const char *s) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  while (*s) {</td><td> </td><td class="right">  while (*s) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (isdigit(*s)) {</td><td> </td><td class="right">    if (isdigit(*s)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      s++;</td><td> </td><td class="right">      s++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    } else {</td><td> </td><td class="right">    } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0;</td><td> </td><td class="right">      return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l16" /><small>skipping to change at</small><em> line 1022</em></th><th> </th><th><a name="part-r16" /><small>skipping to change at</small><em> line 1036</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \addtogroup ssh_session</td><td> </td><td class="right">/** \addtogroup ssh_session</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @{ */</td><td> </td><td class="right"> * @{ */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/**</td><td> </td><td class="right">/**</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \brief Lowercase a string.</td><td> </td><td class="right"> * \brief Lowercase a string.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param  str          String to lowercase.</td><td> </td><td class="right"> * \param  str          String to lowercase.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return              The malloced lowered string or NULL on error.</td><td> </td><td class="right"> * \return              The malloced lowered string or NULL on error.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \internal</td><td> </td><td class="right"> * \internal</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static char *lowercase(const char* str) {</td><td> </td><td class="right">static char *lowercase(const char* str) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  char <span class="delete">*p = 0;</span></td><td> </td><td class="rblock">  char <span class="insert">*new, *p;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  char *new = strdup(str);</span></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if (str == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">    return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">if((str == NULL) ||</span> (new == <span class="delete">NULL))</span> {</td><td> </td><td class="rblock">  <span class="insert">new = strdup(str);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  if</span> (new == <span class="insert">NULL)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  for (p = new; *p; p++) {</td><td> </td><td class="right">  for (p = new; *p; p++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    *p = tolower(*p);</td><td> </td><td class="right">    *p = tolower(*p);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return new;</td><td> </td><td class="right">  return new;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l17" /><small>skipping to change at</small><em> line 1060</em></th><th> </th><th><a name="part-r17" /><small>skipping to change at</small><em> line 1078</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** \brief returns one line of known host file</td><td> </td><td class="right">/** \brief returns one line of known host file</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * will return a token array containing (host|ip) keytype key</td><td> </td><td class="right"> * will return a token array containing (host|ip) keytype key</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param file pointer to the known host file. Could be pointing to NULL at
 start</td><td> </td><td class="right"> * \param file pointer to the known host file. Could be pointing to NULL at
 start</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param filename file name of the known host file</td><td> </td><td class="right"> * \param filename file name of the known host file</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param found_type pointer to a string to be set with the found key type</td><td> </td><td class="right"> * \param found_type pointer to a string to be set with the found key type</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \internal</td><td> </td><td class="right"> * \internal</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns NULL if no match was found or the file was not found</td><td> </td><td class="right"> * \returns NULL if no match was found or the file was not found</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns found_type type of key (ie "dsa","ssh-rsa1"). Don't free that v
alue.</td><td> </td><td class="right"> * \returns found_type type of key (ie "dsa","ssh-rsa1"). Don't free that v
alue.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static char **ssh_get_knownhost_line(<span class="delete">SSH_SESSION *</span>session, FILE **file,</td><td> </td><td class="rblock">static char **ssh_get_knownhost_line(<span class="insert">ssh_session </span>session, FILE **file,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    const char *filename, const char **found_type) {</td><td> </td><td class="right">    const char *filename, const char **found_type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char buffer[4096] = {0};</td><td> </td><td class="right">  char buffer[4096] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *ptr;</td><td> </td><td class="right">  char *ptr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char **tokens;</td><td> </td><td class="right">  char **tokens;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(*file == NULL){</td><td> </td><td class="right">  if(*file == NULL){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    *file = fopen(filename,"r");</td><td> </td><td class="right">    *file = fopen(filename,"r");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (*file == NULL) {</td><td> </td><td class="right">    if (*file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l18" /><small>skipping to change at</small><em> line 1142</em></th><th> </th><th><a name="part-r18" /><small>skipping to change at</small><em> line 1160</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/**</td><td> </td><td class="right">/**</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \brief Check the public key in the known host line matches the</td><td> </td><td class="right"> * \brief Check the public key in the known host line matches the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * public key of the currently connected server.</td><td> </td><td class="right"> * public key of the currently connected server.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param tokens list of tokens in the known_hosts line.</td><td> </td><td class="right"> * \param tokens list of tokens in the known_hosts line.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return 1 if the key matches</td><td> </td><td class="right"> * \return 1 if the key matches</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return 0 if the key doesn't match</td><td> </td><td class="right"> * \return 0 if the key doesn't match</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return -1 on error</td><td> </td><td class="right"> * \return -1 on error</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int <span class="delete">check_public_key(SSH_SESSION *session,</span> char **tokens) {</td><td> </td><td class="rblock">static int <span class="insert">check_public_key(ssh_session session,</span> char **tokens) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pubkey</span> = session-&gt;current_crypto-&gt;server_pubkey;</td><td> </td><td class="rblock">  <span class="insert">ssh_string pubkey</span> = session-&gt;current_crypto-&gt;server_pubkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *pubkey_buffer;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer pubkey_buffer;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *pubkey_64;</td><td> </td><td class="right">  char *pubkey_64;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* ok we found some public key in known hosts file. now un-base64it */</td><td> </td><td class="right">  /* ok we found some public key in known hosts file. now un-base64it */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (alldigits(tokens[1])) {</td><td> </td><td class="right">  if (alldigits(tokens[1])) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* openssh rsa1 format */</td><td> </td><td class="right">    /* openssh rsa1 format */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    bignum tmpbn;</td><td> </td><td class="right">    bignum tmpbn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">STRING *</span>tmpstring;</td><td> </td><td class="rblock">    <span class="insert">ssh_string </span>tmpstring;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    unsigned int len;</td><td> </td><td class="right">    unsigned int len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int i;</td><td> </td><td class="right">    int i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    pubkey_buffer = buffer_new();</td><td> </td><td class="right">    pubkey_buffer = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (pubkey_buffer == NULL) {</td><td> </td><td class="right">    if (pubkey_buffer == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    tmpstring = string_from_char("ssh-rsa1");</td><td> </td><td class="right">    tmpstring = string_from_char("ssh-rsa1");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (tmpstring == NULL) {</td><td> </td><td class="right">    if (tmpstring == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l19" /><small>skipping to change at</small><em> line 1191</em></th><th> </th><th><a name="part-r19" /><small>skipping to change at</small><em> line 1209</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">         because of the padding which it does --kv */</td><td> </td><td class="right">         because of the padding which it does --kv */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* tmpstring = make_bignum_string(tmpbn); */</td><td> </td><td class="right">      /* tmpstring = make_bignum_string(tmpbn); */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* do it manually instead */</td><td> </td><td class="right">      /* do it manually instead */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      len = bignum_num_bytes(tmpbn);</td><td> </td><td class="right">      len = bignum_num_bytes(tmpbn);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      tmpstring = malloc(4 + len);</td><td> </td><td class="right">      tmpstring = malloc(4 + len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (tmpstring == NULL) {</td><td> </td><td class="right">      if (tmpstring == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_free(pubkey_buffer);</td><td> </td><td class="right">        buffer_free(pubkey_buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        bignum_free(tmpbn);</td><td> </td><td class="right">        bignum_free(tmpbn);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return -1;</td><td> </td><td class="right">        return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">      /* TODO: fix the hardcoding */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      tmpstring-&gt;size = htonl(len);</td><td> </td><td class="right">      tmpstring-&gt;size = htonl(len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      bignum_bn2bin(tmpbn, len, tmpstring-&gt;string);</td><td> </td><td class="right">      bignum_bn2bin(tmpbn, len, tmpstring-&gt;string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      bignum_bn2bin(tmpbn, tmpstring-&gt;string);</td><td> </td><td class="right">      bignum_bn2bin(tmpbn, tmpstring-&gt;string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      bignum_free(tmpbn);</td><td> </td><td class="right">      bignum_free(tmpbn);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (buffer_add_ssh_string(pubkey_buffer, tmpstring) &lt; 0) {</td><td> </td><td class="right">      if (buffer_add_ssh_string(pubkey_buffer, tmpstring) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        buffer_free(pubkey_buffer);</td><td> </td><td class="right">        buffer_free(pubkey_buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        string_free(tmpstring);</td><td> </td><td class="right">        string_free(tmpstring);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l20" /><small>skipping to change at</small><em> line 1241</em></th><th> </th><th><a name="part-r20" /><small>skipping to change at</small><em> line 1260</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 1;</td><td> </td><td class="right">  return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/**</td><td> </td><td class="right">/**</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \brief checks if a hostname matches a openssh-style hashed known host</td><td> </td><td class="right"> * \brief checks if a hostname matches a openssh-style hashed known host</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param host host to check</td><td> </td><td class="right"> * \param host host to check</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param hashed hashed value</td><td> </td><td class="right"> * \param hashed hashed value</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns 1 if it matches</td><td> </td><td class="right"> * \returns 1 if it matches</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \returns 0 otherwise</td><td> </td><td class="right"> * \returns 0 otherwise</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int match_hashed_host(<span class="delete">SSH_SESSION *</span>session, const char *host,</td><td> </td><td class="rblock">static int match_hashed_host(<span class="insert">ssh_session </span>session, const char *host,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    const char *sourcehash) {</td><td> </td><td class="right">    const char *sourcehash) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* Openssh hash structure :</td><td> </td><td class="right">  /* Openssh hash structure :</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * |1|base64 encoded salt|base64 encoded hash</td><td> </td><td class="right">   * |1|base64 encoded salt|base64 encoded hash</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * hash is produced that way :</td><td> </td><td class="right">   * hash is produced that way :</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * hash := HMAC_SHA1(key=salt,data=host)</td><td> </td><td class="right">   * hash := HMAC_SHA1(key=salt,data=host)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   */</td><td> </td><td class="right">   */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char buffer[256] = {0};</td><td> </td><td class="right">  unsigned char buffer[256] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *salt;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_buffer salt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  BUFFER *hash;</span></td><td> </td><td class="rblock"><span class="insert">  ssh_buffer hash;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  HMACCTX mac;</td><td> </td><td class="right">  HMACCTX mac;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *source;</td><td> </td><td class="right">  char *source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *b64hash;</td><td> </td><td class="right">  char *b64hash;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int match;</td><td> </td><td class="right">  int match;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int size;</td><td> </td><td class="right">  unsigned int size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (strncmp(sourcehash, "|1|", 3) != 0) {</td><td> </td><td class="right">  if (strncmp(sourcehash, "|1|", 3) != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l21" /><small>skipping to change at</small><em> line 1353</em></th><th> </th><th><a name="part-r21" /><small>skipping to change at</small><em> line 1372</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *         SSH_SERVER_FOUND_OTHER:   The server gave use a key of a type wh
ile</td><td> </td><td class="right"> *         SSH_SERVER_FOUND_OTHER:   The server gave use a key of a type wh
ile</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *                                   we had an other type recorded. It is a</td><td> </td><td class="right"> *                                   we had an other type recorded. It is a</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *                                   possible attack \n</td><td> </td><td class="right"> *                                   possible attack \n</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *         SSH_SERVER_NOT_KNOWN:     The server is unknown. User should con
firm</td><td> </td><td class="right"> *         SSH_SERVER_NOT_KNOWN:     The server is unknown. User should con
firm</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *                                   the MD5 is correct\n</td><td> </td><td class="right"> *                                   the MD5 is correct\n</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *         SSH_SERVER_FILE_NOT_FOUND:The known host file does not exist. Th
e</td><td> </td><td class="right"> *         SSH_SERVER_FILE_NOT_FOUND:The known host file does not exist. Th
e</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *                                   host is thus unknown. File will be cre
ated</td><td> </td><td class="right"> *                                   host is thus unknown. File will be cre
ated</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *                                   if host key is accepted\n</td><td> </td><td class="right"> *                                   if host key is accepted\n</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *         SSH_SERVER_ERROR:         Some error happened</td><td> </td><td class="right"> *         SSH_SERVER_ERROR:         Some error happened</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> * \see ssh_options_set<span class="delete">_wanted_algo</span>()</td><td> </td><td class="rblock"> * \see ssh_options_set()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \see ssh_get_pubkey_hash()</td><td> </td><td class="right"> * \see ssh_get_pubkey_hash()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \bug There is no current way to remove or modify an entry into the known</td><td> </td><td class="right"> * \bug There is no current way to remove or modify an entry into the known</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * host table.</td><td> </td><td class="right"> * host table.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int ssh_is_server_known(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int ssh_is_server_known(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  FILE *file = NULL;</td><td> </td><td class="right">  FILE *file = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char **tokens;</td><td> </td><td class="right">  char **tokens;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *host;</td><td> </td><td class="right">  char *host;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *type;</td><td> </td><td class="right">  const char *type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int match;</td><td> </td><td class="right">  int match;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int ret = SSH_SERVER_NOT_KNOWN;</td><td> </td><td class="right">  int ret = SSH_SERVER_NOT_KNOWN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if <span class="delete">(ssh_options_default_known_hosts_file(session-&gt;options)</span> &lt; 0) {</td><td> </td><td class="rblock">  if <span class="insert">(session-&gt;knownhosts == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    ssh_set_error(session, SSH_REQUEST_DENIED,</td><td> </td><td class="rblock"><span class="insert">    if (ssh_options_set(session, SSH_OPTIONS_KNOWNHOSTS, NULL)</span> &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        "Can't find a known_hosts file");</td><td> </td><td class="rblock">      ssh_set_error(session, SSH_REQUEST_DENIED,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    leave_function();</td><td> </td><td class="rblock">          "Can't find a known_hosts file");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    return SSH_SERVER_FILE_NOT_FOUND;</td><td> </td><td class="rblock">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">      return SSH_SERVER_FILE_NOT_FOUND;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">    <span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (session-&gt;<span class="delete">options-&gt;</span>host == NULL) {</td><td> </td><td class="rblock">  if (session-&gt;host == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Can't verify host in known hosts if the hostname isn't known");</td><td> </td><td class="right">        "Can't verify host in known hosts if the hostname isn't known");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return SSH_SERVER_ERROR;</td><td> </td><td class="right">    return SSH_SERVER_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  host = lowercase(session-&gt;<span class="delete">options-&gt;</span>host);</td><td> </td><td class="rblock">  host = lowercase(session-&gt;host);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (host == NULL) {</td><td> </td><td class="right">  if (host == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Not enough space!");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Not enough space!");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return SSH_SERVER_ERROR;</td><td> </td><td class="right">    return SSH_SERVER_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    tokens = ssh_get_knownhost_line(session, &amp;file,</td><td> </td><td class="right">    tokens = ssh_get_knownhost_line(session, &amp;file,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        session-&gt;<span class="delete">options-&gt;known_hosts_file</span>, &amp;type);</td><td> </td><td class="rblock">        session-&gt;<span class="insert">knownhosts</span>, &amp;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* End of file, return the current state */</td><td> </td><td class="right">    /* End of file, return the current state */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (tokens == NULL) {</td><td> </td><td class="right">    if (tokens == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    match = match_hashed_host(session, host, tokens[0]);</td><td> </td><td class="right">    match = match_hashed_host(session, host, tokens[0]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (match == 0) {</td><td> </td><td class="right">    if (match == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      match = match_hostname(host, tokens[0], strlen(tokens[0]));</td><td> </td><td class="right">      match = match_hostname(host, tokens[0], strlen(tokens[0]));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l22" /><small>skipping to change at</small><em> line 1447</em></th><th> </th><th><a name="part-r22" /><small>skipping to change at</small><em> line 1468</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* Return the current state at end of file */</td><td> </td><td class="right">  /* Return the current state at end of file */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ret;</td><td> </td><td class="right">  return ret;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** You generaly use it when ssh_is_server_known() answered SSH_SERVER_NOT_
KNOWN</td><td> </td><td class="right">/** You generaly use it when ssh_is_server_known() answered SSH_SERVER_NOT_
KNOWN</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \brief write the current server as known in the known hosts file. This w
ill create the known hosts file if it does not exist.</td><td> </td><td class="right"> * \brief write the current server as known in the known hosts file. This w
ill create the known hosts file if it does not exist.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \param session ssh session</td><td> </td><td class="right"> * \param session ssh session</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * \return 0 on success, -1 on error</td><td> </td><td class="right"> * \return 0 on success, -1 on error</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">ssh_write_knownhost(SSH_SESSION *session)</span> {</td><td> </td><td class="rblock">int <span class="insert">ssh_write_knownhost(ssh_session session)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pubkey</span> = session-&gt;current_crypto-&gt;server_pubkey;</td><td> </td><td class="rblock">  <span class="insert">ssh_string pubkey</span> = session-&gt;current_crypto-&gt;server_pubkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *pubkey_64;</td><td> </td><td class="right">  unsigned char *pubkey_64;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char buffer[4096] = {0};</td><td> </td><td class="right">  char buffer[4096] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  FILE *file;</td><td> </td><td class="right">  FILE *file;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *dir;</td><td> </td><td class="right">  char *dir;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t len = 0;</td><td> </td><td class="right">  size_t len = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (ssh_options_<span class="delete">default_known_hosts_file(session-&gt;options</span>) &lt; 0) {</td><td> </td><td class="rblock">  if (ssh_options_<span class="insert">set(session, SSH_OPTIONS_KNOWNHOSTS, NULL</span>) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Cannot find known_hosts file.");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Cannot find known_hosts file.");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (session-&gt;<span class="delete">options-&gt;</span>host == NULL) {</td><td> </td><td class="rblock">  if (session-&gt;host == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Cannot write host in known hosts if the hostname is unknown");</td><td> </td><td class="right">        "Cannot write host in known hosts if the hostname is unknown");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* Check if ~/.ssh exists and create it if not */</td><td> </td><td class="right">  /* Check if ~/.ssh exists and create it if not */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  dir = ssh_dirname(session-&gt;<span class="delete">options-&gt;known_hosts_file</span>);</td><td> </td><td class="rblock">  dir = ssh_dirname(session-&gt;<span class="insert">knownhosts</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (dir == NULL) {</td><td> </td><td class="right">  if (dir == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "%s", strerror(errno));</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "%s", strerror(errno));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (! ssh_file_readaccess_ok(dir)) {</td><td> </td><td class="right">  if (! ssh_file_readaccess_ok(dir)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (ssh_mkdir(dir, 0700) &lt; 0) {</td><td> </td><td class="right">    if (ssh_mkdir(dir, 0700) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Cannot create %s directory.", dir);</td><td> </td><td class="right">          "Cannot create %s directory.", dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      SAFE_FREE(dir);</td><td> </td><td class="right">      SAFE_FREE(dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SAFE_FREE(dir);</td><td> </td><td class="right">  SAFE_FREE(dir);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  file = fopen(session-&gt;<span class="delete">options-&gt;known_hosts_file</span>, "a");</td><td> </td><td class="rblock">  file = fopen(session-&gt;<span class="insert">knownhosts</span>, "a");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (file == NULL) {</td><td> </td><td class="right">  if (file == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Couldn't open known_hosts file %s for appending: %s",</td><td> </td><td class="right">        "Couldn't open known_hosts file %s for appending: %s",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        session-&gt;<span class="delete">options-&gt;known_hosts_file</span>, strerror(errno));</td><td> </td><td class="rblock">        session-&gt;<span class="insert">knownhosts</span>, strerror(errno));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (strcmp(session-&gt;current_crypto-&gt;server_pubkey_type, "ssh-rsa1") == 0)
 {</td><td> </td><td class="right">  if (strcmp(session-&gt;current_crypto-&gt;server_pubkey_type, "ssh-rsa1") == 0)
 {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    /* openssh uses a different format for ssh-rsa1 keys.</td><td> </td><td class="right">    /* openssh uses a different format for ssh-rsa1 keys.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       Be compatible --kv */</td><td> </td><td class="right">       Be compatible --kv */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">PUBLIC_KEY *</span>key;</td><td> </td><td class="rblock">    <span class="insert">ssh_public_key </span>key;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char *e_string = NULL;</td><td> </td><td class="right">    char *e_string = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char *n_string = NULL;</td><td> </td><td class="right">    char *n_string = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    bignum e = NULL;</td><td> </td><td class="right">    bignum e = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    bignum n = NULL;</td><td> </td><td class="right">    bignum n = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    int rsa_size;</td><td> </td><td class="right">    int rsa_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    gcry_sexp_t sexp;</td><td> </td><td class="right">    gcry_sexp_t sexp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    key = publickey_from_string(session, pubkey);</td><td> </td><td class="right">    key = publickey_from_string(session, pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l23" /><small>skipping to change at</small><em> line 1566</em></th><th> </th><th><a name="part-r23" /><small>skipping to change at</small><em> line 1587</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      OPENSSL_free(e_string);</td><td> </td><td class="right">      OPENSSL_free(e_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      OPENSSL_free(n_string);</td><td> </td><td class="right">      OPENSSL_free(n_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      publickey_free(key);</td><td> </td><td class="right">      publickey_free(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      fclose(file);</td><td> </td><td class="right">      fclose(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    snprintf(buffer, sizeof(buffer),</td><td> </td><td class="right">    snprintf(buffer, sizeof(buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "%s %d %s %s\n",</td><td> </td><td class="right">        "%s %d %s %s\n",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        session-&gt;<span class="delete">options-&gt;</span>host,</td><td> </td><td class="rblock">        session-&gt;host,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        rsa_size &lt;&lt; 3,</td><td> </td><td class="right">        rsa_size &lt;&lt; 3,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        e_string,</td><td> </td><td class="right">        e_string,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        n_string);</td><td> </td><td class="right">        n_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    bignum_free(e);</td><td> </td><td class="right">    bignum_free(e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    bignum_free(n);</td><td> </td><td class="right">    bignum_free(n);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(e_string);</td><td> </td><td class="right">    SAFE_FREE(e_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(n_string);</td><td> </td><td class="right">    SAFE_FREE(n_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l24" /><small>skipping to change at</small><em> line 1591</em></th><th> </th><th><a name="part-r24" /><small>skipping to change at</small><em> line 1612</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    publickey_free(key);</td><td> </td><td class="right">    publickey_free(key);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    pubkey_64 = bin_to_base64(pubkey-&gt;string, string_len(pubkey));</td><td> </td><td class="right">    pubkey_64 = bin_to_base64(pubkey-&gt;string, string_len(pubkey));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (pubkey_64 == NULL) {</td><td> </td><td class="right">    if (pubkey_64 == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      fclose(file);</td><td> </td><td class="right">      fclose(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    snprintf(buffer, sizeof(buffer),</td><td> </td><td class="right">    snprintf(buffer, sizeof(buffer),</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "%s %s %s\n",</td><td> </td><td class="right">        "%s %s %s\n",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        session-&gt;<span class="delete">options-&gt;</span>host,</td><td> </td><td class="rblock">        session-&gt;host,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        session-&gt;current_crypto-&gt;server_pubkey_type,</td><td> </td><td class="right">        session-&gt;current_crypto-&gt;server_pubkey_type,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        pubkey_64);</td><td> </td><td class="right">        pubkey_64);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(pubkey_64);</td><td> </td><td class="right">    SAFE_FREE(pubkey_64);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  len = strlen(buffer);</td><td> </td><td class="right">  len = strlen(buffer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (fwrite(buffer, len, 1, file) != 1 || ferror(file)) {</td><td> </td><td class="right">  if (fwrite(buffer, len, 1, file) != 1 || ferror(file)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    fclose(file);</td><td> </td><td class="right">    fclose(file);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 69 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>120 lines changed or deleted</i></th><th><i> </i></th><th><i>144 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
