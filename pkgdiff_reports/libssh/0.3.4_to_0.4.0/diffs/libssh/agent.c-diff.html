<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: agent.c - agent.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;agent.c&nbsp;</th><th> </th><th>&nbsp;agent.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 53</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 53</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;poll.h&gt;</td><td> </td><td class="right">#include &lt;poll.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;unistd.h&gt;</td><td> </td><td class="right">#include &lt;unistd.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;arpa/inet.h&gt;</td><td> </td><td class="right">#include &lt;arpa/inet.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/agent.h"</td><td> </td><td class="right">#include "libssh/agent.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/socket.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/keys.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* macro to check for "agent failure" message */</td><td> </td><td class="right">/* macro to check for "agent failure" message */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define agent_failed(x) \</td><td> </td><td class="right">#define agent_failed(x) \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  (((x) == SSH_AGENT_FAILURE) || ((x) == SSH_COM_AGENT2_FAILURE) || \</td><td> </td><td class="right">  (((x) == SSH_AGENT_FAILURE) || ((x) == SSH_COM_AGENT2_FAILURE) || \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   ((x) == SSH2_AGENT_FAILURE))</td><td> </td><td class="right">   ((x) == SSH2_AGENT_FAILURE))</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static <span class="delete">u32</span> agent_get_u32(const void *vp) {</td><td> </td><td class="rblock">static <span class="insert">uint32_t</span> agent_get_u32(const void *vp) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  const <span class="delete">u8</span> *p = (const <span class="delete">u8</span> *)vp;</td><td> </td><td class="rblock">  const <span class="insert">uint8_t</span> *p = (const <span class="insert">uint8_t</span> *)vp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> v;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> v;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  v  = <span class="delete">(u32)p[0]</span> &lt;&lt; 24;</td><td> </td><td class="rblock">  v  = <span class="insert">(uint32_t)p[0]</span> &lt;&lt; 24;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  v |= <span class="delete">(u32)p[1]</span> &lt;&lt; 16;</td><td> </td><td class="rblock">  v |= <span class="insert">(uint32_t)p[1]</span> &lt;&lt; 16;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  v |= <span class="delete">(u32)p[2]</span> &lt;&lt; 8;</td><td> </td><td class="rblock">  v |= <span class="insert">(uint32_t)p[2]</span> &lt;&lt; 8;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  v |= <span class="delete">(u32)p[3];</span></td><td> </td><td class="rblock">  v |= <span class="insert">(uint32_t)p[3];</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return v;</td><td> </td><td class="right">  return v;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void agent_put_u32(void *vp, <span class="delete">u32</span> v) {</td><td> </td><td class="rblock">static void agent_put_u32(void *vp, <span class="insert">uint32_t</span> v) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u8</span> *p = <span class="delete">(u8</span> *)vp;</td><td> </td><td class="rblock">  <span class="insert">uint8_t</span> *p = <span class="insert">(uint8_t</span> *)vp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  p[0] = <span class="delete">(u8)(v</span> &gt;&gt; 24) &amp; 0xff;</td><td> </td><td class="rblock">  p[0] = <span class="insert">(uint8_t)(v</span> &gt;&gt; 24) &amp; 0xff;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  p[1] = <span class="delete">(u8)(v</span> &gt;&gt; 16) &amp; 0xff;</td><td> </td><td class="rblock">  p[1] = <span class="insert">(uint8_t)(v</span> &gt;&gt; 16) &amp; 0xff;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  p[2] = <span class="delete">(u8)(v</span> &gt;&gt; 8) &amp; 0xff;</td><td> </td><td class="rblock">  p[2] = <span class="insert">(uint8_t)(v</span> &gt;&gt; 8) &amp; 0xff;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  p[3] = <span class="delete">(u8)v</span> &amp; 0xff;</td><td> </td><td class="rblock">  p[3] = <span class="insert">(uint8_t)v</span> &amp; 0xff;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static size_t atomicio(struct socket *s, void *buf, size_t n, int do_read) 
{</td><td> </td><td class="right">static size_t atomicio(struct socket *s, void *buf, size_t n, int do_read) 
{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  char *b = buf;</td><td> </td><td class="right">  char *b = buf;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  size_t pos = 0;</td><td> </td><td class="right">  size_t pos = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssize_t res;</td><td> </td><td class="right">  ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  struct pollfd pfd;</td><td> </td><td class="right">  struct pollfd pfd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int fd = ssh_socket_get_fd(s);</td><td> </td><td class="right">  int fd = ssh_socket_get_fd(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pfd.fd = fd;</td><td> </td><td class="right">  pfd.fd = fd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 121</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 125</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      errno = EPIPE;</td><td> </td><td class="right">      errno = EPIPE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return pos;</td><td> </td><td class="right">      return pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      pos += (size_t) res;</td><td> </td><td class="right">      pos += (size_t) res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return pos;</td><td> </td><td class="right">  return pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">AGENT *agent_new(struct ssh_session</span> *session) {</td><td> </td><td class="rblock"><span class="insert">ssh_agent agent_new(struct ssh_session_struct</span> *session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">AGENT *agent</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_agent agent</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  agent = malloc(sizeof(<span class="delete">AGENT</span>));</td><td> </td><td class="rblock">  agent = malloc(sizeof(<span class="insert">struct ssh_agent_struct</span>));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent == NULL) {</td><td> </td><td class="right">  if (agent == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ZERO_STRUCTP(agent);</td><td> </td><td class="right">  ZERO_STRUCTP(agent);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  agent-&gt;count = 0;</td><td> </td><td class="right">  agent-&gt;count = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  agent-&gt;sock = ssh_socket_new(session);</td><td> </td><td class="right">  agent-&gt;sock = ssh_socket_new(session);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent-&gt;sock == NULL) {</td><td> </td><td class="right">  if (agent-&gt;sock == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(agent);</td><td> </td><td class="right">    SAFE_FREE(agent);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return agent;</td><td> </td><td class="right">  return agent;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void agent_close(struct agent_struct *agent) {</td><td> </td><td class="rblock">void agent_close(struct <span class="insert">ssh_</span>agent_struct *agent) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent == NULL) {</td><td> </td><td class="right">  if (agent == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return;</td><td> </td><td class="right">    return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (getenv("SSH_AUTH_SOCK")) {</td><td> </td><td class="right">  if (getenv("SSH_AUTH_SOCK")) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_socket_close(agent-&gt;sock);</td><td> </td><td class="right">    ssh_socket_close(agent-&gt;sock);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void agent_free(<span class="delete">AGENT *</span>agent) {</td><td> </td><td class="rblock">void agent_free(<span class="insert">ssh_agent </span>agent) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent) {</td><td> </td><td class="right">  if (agent) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (agent-&gt;ident) {</td><td> </td><td class="right">    if (agent-&gt;ident) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_free(agent-&gt;ident);</td><td> </td><td class="right">      buffer_free(agent-&gt;ident);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (agent-&gt;sock) {</td><td> </td><td class="right">    if (agent-&gt;sock) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      agent_close(agent);</td><td> </td><td class="right">      agent_close(agent);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_socket_free(agent-&gt;sock);</td><td> </td><td class="right">      ssh_socket_free(agent-&gt;sock);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    SAFE_FREE(agent);</td><td> </td><td class="right">    SAFE_FREE(agent);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int agent_connect(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">static int agent_connect(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *auth_sock = NULL;</td><td> </td><td class="right">  const char *auth_sock = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session == NULL || session-&gt;agent == NULL) {</td><td> </td><td class="right">  if (session == NULL || session-&gt;agent == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  auth_sock = getenv("SSH_AUTH_SOCK");</td><td> </td><td class="right">  auth_sock = getenv("SSH_AUTH_SOCK");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (auth_sock &amp;&amp; *auth_sock) {</td><td> </td><td class="right">  if (auth_sock &amp;&amp; *auth_sock) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (ssh_socket_unix(session-&gt;agent-&gt;sock, auth_sock) &lt; 0) {</td><td> </td><td class="right">    if (ssh_socket_unix(session-&gt;agent-&gt;sock, auth_sock) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if 0</td><td> </td><td class="right">#if 0</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int agent_decode_reply(struct ssh_session<span class="delete"> *session, int type)</span> {</td><td> </td><td class="rblock">static int agent_decode_reply(struct ssh_session<span class="insert">_struct *session, int type)
</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch (type) {</td><td> </td><td class="right">  switch (type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case SSH_AGENT_FAILURE:</td><td> </td><td class="right">    case SSH_AGENT_FAILURE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case SSH2_AGENT_FAILURE:</td><td> </td><td class="right">    case SSH2_AGENT_FAILURE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case SSH_COM_AGENT2_FAILURE:</td><td> </td><td class="right">    case SSH_COM_AGENT2_FAILURE:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(session, SSH_LOG_RARE, "SSH_AGENT_FAILURE");</td><td> </td><td class="right">      ssh_log(session, SSH_LOG_RARE, "SSH_AGENT_FAILURE");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0;</td><td> </td><td class="right">      return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case SSH_AGENT_SUCCESS:</td><td> </td><td class="right">    case SSH_AGENT_SUCCESS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 1;</td><td> </td><td class="right">      return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Bad response from authentication agent: %d", type);</td><td> </td><td class="right">          "Bad response from authentication agent: %d", type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int agent_talk(struct <span class="delete">ssh_session</span> *session,</td><td> </td><td class="rblock">static int agent_talk(struct <span class="insert">ssh_session_struct</span> *session,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    struct <span class="delete">buffer_struct</span> *request, struct <span class="delete">buffer_struct</span> *reply) {</td><td> </td><td class="rblock">    struct <span class="insert">ssh_buffer_struct</span> *request, struct <span class="insert">ssh_buffer_struct</span> *reply) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> len = 0;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> len = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u8</span> payload[1024] = {0};</td><td> </td><td class="rblock">  <span class="insert">uint8_t</span> payload[1024] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  len = buffer_get_len(request);</td><td> </td><td class="right">  len = buffer_get_len(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PACKET, "agent_talk - len of request: %u", len);</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PACKET, "agent_talk - len of request: %u", len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  agent_put_u32(payload, len);</td><td> </td><td class="right">  agent_put_u32(payload, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* send length and then the request packet */</td><td> </td><td class="right">  /* send length and then the request packet */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (atomicio(session-&gt;agent-&gt;sock, payload, 4, 0) == 4) {</td><td> </td><td class="right">  if (atomicio(session-&gt;agent-&gt;sock, payload, 4, 0) == 4) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (atomicio(session-&gt;agent-&gt;sock, buffer_get_rest(request), len, 0)</td><td> </td><td class="right">    if (atomicio(session-&gt;agent-&gt;sock, buffer_get_rest(request), len, 0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        != len) {</td><td> </td><td class="right">        != len) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(session, SSH_LOG_PACKET, "atomicio sending request failed: %s
",</td><td> </td><td class="right">      ssh_log(session, SSH_LOG_PACKET, "atomicio sending request failed: %s
",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 262</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 266</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_log(session, SSH_LOG_FUNCTIONS,</td><td> </td><td class="right">      ssh_log(session, SSH_LOG_FUNCTIONS,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Not enough space");</td><td> </td><td class="right">          "Not enough space");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    len -= n;</td><td> </td><td class="right">    len -= n;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int agent_get_ident_count(struct <span class="delete">ssh_session</span> *session) {</td><td> </td><td class="rblock">int agent_get_ident_count(struct <span class="insert">ssh_session_struct</span> *session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *request</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer request</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *reply</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer reply</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int type = 0;</td><td> </td><td class="right">  unsigned int type = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int c1 = 0, c2 = 0;</td><td> </td><td class="right">  unsigned int c1 = 0, c2 = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">8</span> buf[4] = {0};</td><td> </td><td class="rblock">  u<span class="insert">int8_t</span> buf[4] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch (session-&gt;version) {</td><td> </td><td class="right">  switch (session-&gt;version) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 1:</td><td> </td><td class="right">    case 1:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      c1 = SSH_AGENTC_REQUEST_RSA_IDENTITIES;</td><td> </td><td class="right">      c1 = SSH_AGENTC_REQUEST_RSA_IDENTITIES;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      c2 = SSH_AGENT_RSA_IDENTITIES_ANSWER;</td><td> </td><td class="right">      c2 = SSH_AGENT_RSA_IDENTITIES_ANSWER;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 2:</td><td> </td><td class="right">    case 2:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      c1 = SSH2_AGENTC_REQUEST_IDENTITIES;</td><td> </td><td class="right">      c1 = SSH2_AGENTC_REQUEST_IDENTITIES;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      c2 = SSH2_AGENT_IDENTITIES_ANSWER;</td><td> </td><td class="right">      c2 = SSH2_AGENT_IDENTITIES_ANSWER;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 302</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 306</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent_talk(session, request, reply) &lt; 0) {</td><td> </td><td class="right">  if (agent_talk(session, request, reply) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(request);</td><td> </td><td class="right">    buffer_free(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(request);</td><td> </td><td class="right">  buffer_free(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* get message type and verify the answer */</td><td> </td><td class="right">  /* get message type and verify the answer */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  buffer_get_u8(reply, (u<span class="delete">8</span> *) &amp;type);</td><td> </td><td class="rblock">  buffer_get_u8(reply, (u<span class="insert">int8_t</span> *) &amp;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PACKET,</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PACKET,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "agent_ident_count - answer type: %d, expected answer: %d",</td><td> </td><td class="right">      "agent_ident_count - answer type: %d, expected answer: %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      type, c2);</td><td> </td><td class="right">      type, c2);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent_failed(type)) {</td><td> </td><td class="right">  if (agent_failed(type)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (type != c2) {</td><td> </td><td class="right">  } else if (type != c2) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Bad authentication reply message type: %d", type);</td><td> </td><td class="right">        "Bad authentication reply message type: %d", type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  buffer_get_u32(reply, (u<span class="delete">32</span> *) buf);</td><td> </td><td class="rblock">  buffer_get_u32(reply, (u<span class="insert">int32_t</span> *) buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;agent-&gt;count = agent_get_u32(buf);</td><td> </td><td class="right">  session-&gt;agent-&gt;count = agent_get_u32(buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_PACKET, "agent_ident_count - count: %d",</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_PACKET, "agent_ident_count - count: %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      session-&gt;agent-&gt;count);</td><td> </td><td class="right">      session-&gt;agent-&gt;count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;agent-&gt;count &gt; 1024) {</td><td> </td><td class="right">  if (session-&gt;agent-&gt;count &gt; 1024) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        "Too many identities in authentication reply: %d",</td><td> </td><td class="right">        "Too many identities in authentication reply: %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        session-&gt;agent-&gt;count);</td><td> </td><td class="right">        session-&gt;agent-&gt;count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(reply);</td><td> </td><td class="right">    buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;agent-&gt;ident) {</td><td> </td><td class="right">  if (session-&gt;agent-&gt;ident) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_reinit(session-&gt;agent-&gt;ident);</td><td> </td><td class="right">    buffer_reinit(session-&gt;agent-&gt;ident);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;agent-&gt;ident = reply;</td><td> </td><td class="right">  session-&gt;agent-&gt;ident = reply;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return session-&gt;agent-&gt;count;</td><td> </td><td class="right">  return session-&gt;agent-&gt;count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* caller has to free commment */</td><td> </td><td class="right">/* caller has to free commment */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">struct <span class="delete">public_key_struct *agent_get_first_ident(struct ssh_session *session
</span>,</td><td> </td><td class="rblock">struct <span class="insert">ssh_public_key_struct *agent_get_first_ident(struct ssh_session_stru
ct *session</span>,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char **comment) {</td><td> </td><td class="right">    char **comment) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent_get_ident_count(session) &gt; 0) {</td><td> </td><td class="right">  if (agent_get_ident_count(session) &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return agent_get_next_ident(session, comment);</td><td> </td><td class="right">    return agent_get_next_ident(session, comment);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* caller has to free commment */</td><td> </td><td class="right">/* caller has to free commment */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">struct <span class="delete">public_key_struct *agent_get_next_ident(struct ssh_session</span> *session,</td><td> </td><td class="rblock">struct <span class="insert">ssh_public_key_struct *agent_get_next_ident(struct ssh_session_struc
t</span> *session,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char **comment) {</td><td> </td><td class="right">    char **comment) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">public_key_struct</span> *pubkey = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_public_key_struct</span> *pubkey = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *blob = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *blob = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *tmp = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *tmp = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;agent-&gt;count == 0) {</td><td> </td><td class="right">  if (session-&gt;agent-&gt;count == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(session-&gt;version) {</td><td> </td><td class="right">  switch(session-&gt;version) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 1:</td><td> </td><td class="right">    case 1:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case 2:</td><td> </td><td class="right">    case 2:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      /* get the blob */</td><td> </td><td class="right">      /* get the blob */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 394</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 398</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      pubkey = publickey_from_string(session, blob);</td><td> </td><td class="right">      pubkey = publickey_from_string(session, blob);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      string_free(blob);</td><td> </td><td class="right">      string_free(blob);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      break;</td><td> </td><td class="right">      break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return NULL;</td><td> </td><td class="right">      return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return pubkey;</td><td> </td><td class="right">  return pubkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *agent_sign_data(struct ssh_session</span> *session,</td><td> </td><td class="rblock"><span class="insert">ssh_string agent_sign_data(struct ssh_session_struct</span> *session,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    struct <span class="delete">buffer_struct</span> *data,</td><td> </td><td class="rblock">    struct <span class="insert">ssh_buffer_struct</span> *data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    struct <span class="delete">public_key_struct</span> *pubkey) {</td><td> </td><td class="rblock">    struct <span class="insert">ssh_public_key_struct</span> *pubkey) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *blob = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *blob = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">string_struct</span> *sig = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_string_struct</span> *sig = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">buffer_struct</span> *request = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_buffer_struct</span> *request = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  struct <span class="delete">buffer_struct</span> *reply = NULL;</td><td> </td><td class="rblock">  struct <span class="insert">ssh_buffer_struct</span> *reply = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int type = SSH2_AGENT_FAILURE;</td><td> </td><td class="right">  int type = SSH2_AGENT_FAILURE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int flags = 0;</td><td> </td><td class="right">  int flags = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  u<span class="delete">32</span> dlen = 0;</td><td> </td><td class="rblock">  u<span class="insert">int32_t</span> dlen = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* create blob from the pubkey */</td><td> </td><td class="right">  /* create blob from the pubkey */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  blob = publickey_to_string(pubkey);</td><td> </td><td class="right">  blob = publickey_to_string(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  request = buffer_new();</td><td> </td><td class="right">  request = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (request == NULL) {</td><td> </td><td class="right">  if (request == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* create request */</td><td> </td><td class="right">  /* create request */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 451</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 455</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* send the request */</td><td> </td><td class="right">  /* send the request */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent_talk(session, request, reply) &lt; 0) {</td><td> </td><td class="right">  if (agent_talk(session, request, reply) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(request);</td><td> </td><td class="right">    buffer_free(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(request);</td><td> </td><td class="right">  buffer_free(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* check if reply is valid */</td><td> </td><td class="right">  /* check if reply is valid */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if (buffer_get_u8(reply, (u<span class="delete">8 *) &amp;type) &lt; 0</span>) {</td><td> </td><td class="rblock">  if (buffer_get_u8(reply, (u<span class="insert">int8_t *) &amp;type) != sizeof(uint8_t)</span>) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (agent_failed(type)) {</td><td> </td><td class="right">  if (agent_failed(type)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_log(session, SSH_LOG_RARE, "Agent reports failure in signing the ke
y");</td><td> </td><td class="right">    ssh_log(session, SSH_LOG_RARE, "Agent reports failure in signing the ke
y");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(reply);</td><td> </td><td class="right">    buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else if (type != SSH2_AGENT_SIGN_RESPONSE) {</td><td> </td><td class="right">  } else if (type != SSH2_AGENT_SIGN_RESPONSE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Bad authentication response: %d", ty
pe);</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Bad authentication response: %d", ty
pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_free(reply);</td><td> </td><td class="right">    buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 478</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 482</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return sig;</td><td> </td><td class="right">  return sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">error:</td><td> </td><td class="right">error:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_set_error(session, SSH_FATAL, "Not enough memory");</td><td> </td><td class="right">  ssh_set_error(session, SSH_FATAL, "Not enough memory");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(blob);</td><td> </td><td class="right">  string_free(blob);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(request);</td><td> </td><td class="right">  buffer_free(request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buffer_free(reply);</td><td> </td><td class="right">  buffer_free(reply);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return NULL;</td><td> </td><td class="right">  return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int agent_is_running(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int agent_is_running(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session == NULL || session-&gt;agent == NULL) {</td><td> </td><td class="right">  if (session == NULL || session-&gt;agent == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 0;</td><td> </td><td class="right">    return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ssh_socket_is_open(session-&gt;agent-&gt;sock)) {</td><td> </td><td class="right">  if (ssh_socket_is_open(session-&gt;agent-&gt;sock)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return 1;</td><td> </td><td class="right">    return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } else {</td><td> </td><td class="right">  } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (agent_connect(session) &lt; 0) {</td><td> </td><td class="right">    if (agent_connect(session) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return 0;</td><td> </td><td class="right">      return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    } else {</td><td> </td><td class="right">    } else {</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 22 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>46 lines changed or deleted</i></th><th><i> </i></th><th><i>50 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
