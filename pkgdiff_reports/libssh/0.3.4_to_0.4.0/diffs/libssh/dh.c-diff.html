<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: dh.c - dh.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;dh.c&nbsp;</th><th> </th><th>&nbsp;dh.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 43</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 43</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the server computes his own public key, f</td><td> </td><td class="right"> * the server computes his own public key, f</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * f = g^y mod p</td><td> </td><td class="right"> * f = g^y mod p</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * it sents it to the client</td><td> </td><td class="right"> * it sents it to the client</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the common key K is calculated by the client by doing</td><td> </td><td class="right"> * the common key K is calculated by the client by doing</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * k = f^x mod p</td><td> </td><td class="right"> * k = f^x mod p</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the server does the same with the client public key e</td><td> </td><td class="right"> * the server does the same with the client public key e</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * k' = e^y mod p</td><td> </td><td class="right"> * k' = e^y mod p</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * if everything went correctly, k and k' are equal</td><td> </td><td class="right"> * if everything went correctly, k and k' are equal</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "config.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdio.h&gt;</td><td> </td><td class="right">#include &lt;stdio.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;stdlib.h&gt;</td><td> </td><td class="right">#include &lt;stdlib.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;string.h&gt;</td><td> </td><td class="right">#include &lt;string.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef _WIN32</td><td> </td><td class="right">#ifndef _WIN32</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;arpa/inet.h&gt;</td><td> </td><td class="right">#include &lt;arpa/inet.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/priv.h"</td><td> </td><td class="right">#include "libssh/priv.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "libssh/crypto.h"</td><td> </td><td class="right">#include "libssh/crypto.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/buffer.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/session.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/keys.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/dh.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">/* todo: remove it */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#include "libssh/string.h"</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/rand.h&gt;</td><td> </td><td class="right">#include &lt;openssl/rand.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/evp.h&gt;</td><td> </td><td class="right">#include &lt;openssl/evp.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;openssl/err.h&gt;</td><td> </td><td class="right">#include &lt;openssl/err.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static unsigned char p_value[] = {</td><td> </td><td class="right">static unsigned char p_value[] = {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC9, 0x0F, 0xDA, 0
xA2,</td><td> </td><td class="right">        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xC9, 0x0F, 0xDA, 0
xA2,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        0x21, 0x68, 0xC2, 0x34, 0xC4, 0xC6, 0x62, 0x8B, 0x80, 0xDC, 0x1C, 0
xD1,</td><td> </td><td class="right">        0x21, 0x68, 0xC2, 0x34, 0xC4, 0xC6, 0x62, 0x8B, 0x80, 0xDC, 0x1C, 0
xD1,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        0x29, 0x02, 0x4E, 0x08, 0x8A, 0x67, 0xCC, 0x74, 0x02, 0x0B, 0xBE, 0
xA6,</td><td> </td><td class="right">        0x29, 0x02, 0x4E, 0x08, 0x8A, 0x67, 0xCC, 0x74, 0x02, 0x0B, 0xBE, 0
xA6,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 219</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 226</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">void ssh_print_hexa(const char *descr, const unsigned char *what, size_t le
n) {</td><td> </td><td class="right">void ssh_print_hexa(const char *descr, const unsigned char *what, size_t le
n) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char *hexa = ssh_get_hexa(what, len);</td><td> </td><td class="right">    char *hexa = ssh_get_hexa(what, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (hexa == NULL) {</td><td> </td><td class="right">    if (hexa == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return;</td><td> </td><td class="right">      return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    printf("%s: %s\n", descr, hexa);</td><td> </td><td class="right">    printf("%s: %s\n", descr, hexa);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_generate_x(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int dh_generate_x(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;x = bignum_new();</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;x = bignum_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;x == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;x == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_rand(session-&gt;next_crypto-&gt;x, 128);</td><td> </td><td class="right">  bignum_rand(session-&gt;next_crypto-&gt;x, 128);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_rand(session-&gt;next_crypto-&gt;x, 128, 0, -1);</td><td> </td><td class="right">  bignum_rand(session-&gt;next_crypto-&gt;x, 128, 0, -1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* not harder than this */</td><td> </td><td class="right">  /* not harder than this */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_bignum("x", session-&gt;next_crypto-&gt;x);</td><td> </td><td class="right">  ssh_print_bignum("x", session-&gt;next_crypto-&gt;x);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* used by server */</td><td> </td><td class="right">/* used by server */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_generate_y(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int dh_generate_y(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    session-&gt;next_crypto-&gt;y = bignum_new();</td><td> </td><td class="right">    session-&gt;next_crypto-&gt;y = bignum_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;y == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;y == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_rand(session-&gt;next_crypto-&gt;y, 128);</td><td> </td><td class="right">  bignum_rand(session-&gt;next_crypto-&gt;y, 128);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_rand(session-&gt;next_crypto-&gt;y, 128, 0, -1);</td><td> </td><td class="right">  bignum_rand(session-&gt;next_crypto-&gt;y, 128, 0, -1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* not harder than this */</td><td> </td><td class="right">  /* not harder than this */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_bignum("y", session-&gt;next_crypto-&gt;y);</td><td> </td><td class="right">  ssh_print_bignum("y", session-&gt;next_crypto-&gt;y);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* used by server */</td><td> </td><td class="right">/* used by server */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_generate_e(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int dh_generate_e(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_CTX ctx = bignum_ctx_new();</td><td> </td><td class="right">  bignum_CTX ctx = bignum_ctx_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;e = bignum_new();</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;e = bignum_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;e == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;e == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 294</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 301</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_bignum("e", session-&gt;next_crypto-&gt;e);</td><td> </td><td class="right">  ssh_print_bignum("e", session-&gt;next_crypto-&gt;e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_ctx_free(ctx);</td><td> </td><td class="right">  bignum_ctx_free(ctx);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_generate_f(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int dh_generate_f(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_CTX ctx = bignum_ctx_new();</td><td> </td><td class="right">  bignum_CTX ctx = bignum_ctx_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;f = bignum_new();</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;f = bignum_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;f == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;f == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 327</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 334</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_bignum("f", session-&gt;next_crypto-&gt;f);</td><td> </td><td class="right">  ssh_print_bignum("f", session-&gt;next_crypto-&gt;f);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_ctx_free(ctx);</td><td> </td><td class="right">  bignum_ctx_free(ctx);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *make_bignum_string(bignum</span> num) {</td><td> </td><td class="rblock"><span class="insert">ssh_string make_bignum_string(bignum</span> num) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *ptr</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string ptr</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int pad = 0;</td><td> </td><td class="right">  int pad = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int len = bignum_num_bytes(num);</td><td> </td><td class="right">  unsigned int len = bignum_num_bytes(num);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int bits = bignum_num_bits(num);</td><td> </td><td class="right">  unsigned int bits = bignum_num_bits(num);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* Remember if the fist bit is set, it is considered as a</td><td> </td><td class="right">  /* Remember if the fist bit is set, it is considered as a</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">   * negative number. So 0's must be appended */</td><td> </td><td class="right">   * negative number. So 0's must be appended */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (!(bits % 8) &amp;&amp; bignum_is_bit_set(num, bits - 1)) {</td><td> </td><td class="right">  if (!(bits % 8) &amp;&amp; bignum_is_bit_set(num, bits - 1)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    pad++;</td><td> </td><td class="right">    pad++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  fprintf(stderr, "%d bits, %d bytes, %d padding\n", bits, len, pad);</td><td> </td><td class="right">  fprintf(stderr, "%d bits, %d bytes, %d padding\n", bits, len, pad);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* DEBUG_CRYPTO */</td><td> </td><td class="right">#endif /* DEBUG_CRYPTO */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                                           </span></td><td> </td><td class="rblock"><span class="insert">/* TODO: fix that crap !! */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ptr = malloc(4 + len + pad);</td><td> </td><td class="right">  ptr = malloc(4 + len + pad);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ptr == NULL) {</td><td> </td><td class="right">  if (ptr == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return NULL;</td><td> </td><td class="right">    return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ptr-&gt;size = htonl(len + pad);</td><td> </td><td class="right">  ptr-&gt;size = htonl(len + pad);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (pad) {</td><td> </td><td class="right">  if (pad) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ptr-&gt;string[0] = 0;</td><td> </td><td class="right">    ptr-&gt;string[0] = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_bn2bin(num, len, ptr-&gt;string + pad);</td><td> </td><td class="right">  bignum_bn2bin(num, len, ptr-&gt;string + pad);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_bn2bin(num, ptr-&gt;string + pad);</td><td> </td><td class="right">  bignum_bn2bin(num, ptr-&gt;string + pad);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return ptr;</td><td> </td><td class="right">  return ptr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">bignum make_string_bn(<span class="delete">STRING *</span>string){</td><td> </td><td class="rblock">bignum make_string_bn(<span class="insert">ssh_string </span>string){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum bn = NULL;</td><td> </td><td class="right">  bignum bn = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned int len = string_len(string);</td><td> </td><td class="right">  unsigned int len = string_len(string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  fprintf(stderr, "Importing a %d bits, %d bytes object ...\n",</td><td> </td><td class="right">  fprintf(stderr, "Importing a %d bits, %d bytes object ...\n",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      len * 8, len);</td><td> </td><td class="right">      len * 8, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* DEBUG_CRYPTO */</td><td> </td><td class="right">#endif /* DEBUG_CRYPTO */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_bin2bn(string-&gt;string, len, &amp;bn);</td><td> </td><td class="right">  bignum_bin2bn(string-&gt;string, len, &amp;bn);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bn = bignum_bin2bn(string-&gt;string, len, NULL);</td><td> </td><td class="right">  bn = bignum_bin2bn(string-&gt;string, len, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return bn;</td><td> </td><td class="right">  return bn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *dh_get_e(SSH_SESSION *</span>session) {</td><td> </td><td class="rblock"><span class="insert">ssh_string dh_get_e(ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return make_bignum_string(session-&gt;next_crypto-&gt;e);</td><td> </td><td class="right">  return make_bignum_string(session-&gt;next_crypto-&gt;e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* used by server */</td><td> </td><td class="right">/* used by server */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *dh_get_f(SSH_SESSION *</span>session) {</td><td> </td><td class="rblock"><span class="insert">ssh_string dh_get_f(ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return make_bignum_string(session-&gt;next_crypto-&gt;f);</td><td> </td><td class="right">  return make_bignum_string(session-&gt;next_crypto-&gt;f);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void dh_import_pubkey(<span class="delete">SSH_SESSION *session, STRING *</span>pubkey_string) {</td><td> </td><td class="rblock">void dh_import_pubkey(<span class="insert">ssh_session session, ssh_string </span>pubkey_string) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;server_pubkey = pubkey_string;</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;server_pubkey = pubkey_string;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_import_f(<span class="delete">SSH_SESSION *session, STRING *</span>f_string) {</td><td> </td><td class="rblock">int dh_import_f(<span class="insert">ssh_session session, ssh_string </span>f_string) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;f = make_string_bn(f_string);</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;f = make_string_bn(f_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;f == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;f == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_bignum("f",session-&gt;next_crypto-&gt;f);</td><td> </td><td class="right">  ssh_print_bignum("f",session-&gt;next_crypto-&gt;f);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* used by the server implementation */</td><td> </td><td class="right">/* used by the server implementation */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_import_e(<span class="delete">SSH_SESSION *session, STRING *</span>e_string) {</td><td> </td><td class="rblock">int dh_import_e(<span class="insert">ssh_session session, ssh_string </span>e_string) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;e = make_string_bn(e_string);</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;e = make_string_bn(e_string);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;e == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;e == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_print_bignum("e",session-&gt;next_crypto-&gt;e);</td><td> </td><td class="right">    ssh_print_bignum("e",session-&gt;next_crypto-&gt;e);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int dh_build_k(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int dh_build_k(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_CTX ctx = bignum_ctx_new();</td><td> </td><td class="right">  bignum_CTX ctx = bignum_ctx_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;k = bignum_new();</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;k = bignum_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;next_crypto-&gt;k == NULL) {</td><td> </td><td class="right">  if (session-&gt;next_crypto-&gt;k == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 468</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 475</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBCRYPTO</td><td> </td><td class="right">#ifdef HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  bignum_ctx_free(ctx);</td><td> </td><td class="right">  bignum_ctx_free(ctx);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void sha_add(<span class="delete">STRING *</span>str,SHACTX ctx){</td><td> </td><td class="rblock">static void sha_add(<span class="insert">ssh_string </span>str,SHACTX ctx){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    sha1_update(ctx,str,string_len(str)+4);</td><td> </td><td class="right">    sha1_update(ctx,str,string_len(str)+4);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_print_hexa("partial hashed sessionid",str,string_len(str)+4);</td><td> </td><td class="right">    ssh_print_hexa("partial hashed sessionid",str,string_len(str)+4);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">*/</td><td> </td><td class="right">*/</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int make_sessionid(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int make_sessionid(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SHACTX ctx;</td><td> </td><td class="right">  SHACTX ctx;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *num</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string num</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *str</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string str</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *server_hash</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer server_hash</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *client_hash</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer client_hash</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">BUFFER *buf</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_buffer buf</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">u32</span> len;</td><td> </td><td class="rblock">  <span class="insert">uint32_t</span> len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = SSH_ERROR;</td><td> </td><td class="right">  int rc = SSH_ERROR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ctx = sha1_init();</td><td> </td><td class="right">  ctx = sha1_init();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return rc;</td><td> </td><td class="right">    return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  buf = buffer_new();</td><td> </td><td class="right">  buf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 622</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 629</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;out_hashbuf = NULL;</td><td> </td><td class="right">  session-&gt;out_hashbuf = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(str);</td><td> </td><td class="right">  string_free(str);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  string_free(num);</td><td> </td><td class="right">  string_free(num);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return rc;</td><td> </td><td class="right">  return rc;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int hashbufout_add_cookie(<span class="delete">SSH_SESSION *</span>session) {</td><td> </td><td class="rblock">int hashbufout_add_cookie(<span class="insert">ssh_session </span>session) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;out_hashbuf = buffer_new();</td><td> </td><td class="right">  session-&gt;out_hashbuf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;out_hashbuf == NULL) {</td><td> </td><td class="right">  if (session-&gt;out_hashbuf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u8(session-&gt;out_hashbuf, 20) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u8(session-&gt;out_hashbuf, 20) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_reinit(session-&gt;out_hashbuf);</td><td> </td><td class="right">    buffer_reinit(session-&gt;out_hashbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 650</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 657</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    if (buffer_add_data(session-&gt;out_hashbuf,</td><td> </td><td class="right">    if (buffer_add_data(session-&gt;out_hashbuf,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          session-&gt;client_kex.cookie, 16) &lt; 0) {</td><td> </td><td class="right">          session-&gt;client_kex.cookie, 16) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      buffer_reinit(session-&gt;out_hashbuf);</td><td> </td><td class="right">      buffer_reinit(session-&gt;out_hashbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int hashbufin_add_cookie(<span class="delete">SSH_SESSION *</span>session, unsigned char *cookie) {</td><td> </td><td class="rblock">int hashbufin_add_cookie(<span class="insert">ssh_session </span>session, unsigned char *cookie) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;in_hashbuf = buffer_new();</td><td> </td><td class="right">  session-&gt;in_hashbuf = buffer_new();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session-&gt;in_hashbuf == NULL) {</td><td> </td><td class="right">  if (session-&gt;in_hashbuf == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_u8(session-&gt;in_hashbuf, 20) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_u8(session-&gt;in_hashbuf, 20) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_reinit(session-&gt;in_hashbuf);</td><td> </td><td class="right">    buffer_reinit(session-&gt;in_hashbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (buffer_add_data(session-&gt;in_hashbuf,cookie, 16) &lt; 0) {</td><td> </td><td class="right">  if (buffer_add_data(session-&gt;in_hashbuf,cookie, 16) &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    buffer_reinit(session-&gt;in_hashbuf);</td><td> </td><td class="right">    buffer_reinit(session-&gt;in_hashbuf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int generate_one_key(<span class="delete">STRING *</span>k,</td><td> </td><td class="rblock">static int generate_one_key(<span class="insert">ssh_string </span>k,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    unsigned char session_id[SHA_DIGEST_LEN],</td><td> </td><td class="right">    unsigned char session_id[SHA_DIGEST_LEN],</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    unsigned char output[SHA_DIGEST_LEN],</td><td> </td><td class="right">    unsigned char output[SHA_DIGEST_LEN],</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    char letter) {</td><td> </td><td class="right">    char letter) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SHACTX ctx = NULL;</td><td> </td><td class="right">  SHACTX ctx = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ctx = sha1_init();</td><td> </td><td class="right">  ctx = sha1_init();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (ctx == NULL) {</td><td> </td><td class="right">  if (ctx == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sha1_update(ctx, k, string_len(k) + 4);</td><td> </td><td class="right">  sha1_update(ctx, k, string_len(k) + 4);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sha1_update(ctx, session_id, SHA_DIGEST_LEN);</td><td> </td><td class="right">  sha1_update(ctx, session_id, SHA_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sha1_update(ctx, &amp;letter, 1);</td><td> </td><td class="right">  sha1_update(ctx, &amp;letter, 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sha1_update(ctx, session_id, SHA_DIGEST_LEN);</td><td> </td><td class="right">  sha1_update(ctx, session_id, SHA_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sha1_final(output, ctx);</td><td> </td><td class="right">  sha1_final(output, ctx);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">generate_session_keys(SSH_SESSION *session)</span> {</td><td> </td><td class="rblock">int <span class="insert">generate_session_keys(ssh_session session)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *k_string</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_string k_string</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SHACTX ctx = NULL;</td><td> </td><td class="right">  SHACTX ctx = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int rc = -1;</td><td> </td><td class="right">  int rc = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  k_string = make_bignum_string(session-&gt;next_crypto-&gt;k);</td><td> </td><td class="right">  k_string = make_bignum_string(session-&gt;next_crypto-&gt;k);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (k_string == NULL) {</td><td> </td><td class="right">  if (k_string == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    goto error;</td><td> </td><td class="right">    goto error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 818</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 825</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @return The bytes allocated or &lt; 0 on error.</td><td> </td><td class="right"> * @return The bytes allocated or &lt; 0 on error.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @warning It is very important that you verify at some moment that the ha
sh</td><td> </td><td class="right"> * @warning It is very important that you verify at some moment that the ha
sh</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *          matches a known server. If you don't do it, cryptography wont h
elp</td><td> </td><td class="right"> *          matches a known server. If you don't do it, cryptography wont h
elp</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *          you at making things secure</td><td> </td><td class="right"> *          you at making things secure</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @see ssh_is_server_known()</td><td> </td><td class="right"> * @see ssh_is_server_known()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @see ssh_get_hexa()</td><td> </td><td class="right"> * @see ssh_get_hexa()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * @see ssh_print_hexa()</td><td> </td><td class="right"> * @see ssh_print_hexa()</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">ssh_get_pubkey_hash(SSH_SESSION *session,</span> unsigned char **hash) {</td><td> </td><td class="rblock">int <span class="insert">ssh_get_pubkey_hash(ssh_session session,</span> unsigned char **hash) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">STRING *pubkey;</span></td><td> </td><td class="rblock">  <span class="insert">ssh_string pubkey;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  MD5CTX ctx;</td><td> </td><td class="right">  MD5CTX ctx;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char *h;</td><td> </td><td class="right">  unsigned char *h;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (session == NULL || hash == NULL) {</td><td> </td><td class="right">  if (session == NULL || hash == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  *hash = NULL;</td><td> </td><td class="right">  *hash = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  h = malloc(sizeof(unsigned char *) * MD5_DIGEST_LEN);</td><td> </td><td class="right">  h = malloc(sizeof(unsigned char *) * MD5_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 850</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 857</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pubkey = session-&gt;current_crypto-&gt;server_pubkey;</td><td> </td><td class="right">  pubkey = session-&gt;current_crypto-&gt;server_pubkey;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  md5_update(ctx, pubkey-&gt;string, string_len(pubkey));</td><td> </td><td class="right">  md5_update(ctx, pubkey-&gt;string, string_len(pubkey));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  md5_final(h, ctx);</td><td> </td><td class="right">  md5_final(h, ctx);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  *hash = h;</td><td> </td><td class="right">  *hash = h;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return MD5_DIGEST_LEN;</td><td> </td><td class="right">  return MD5_DIGEST_LEN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">STRING *ssh_get_pubkey(SSH_SESSION *session){</span></td><td> </td><td class="rblock"><span class="insert">/**</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * @brief Deallocate the hash obtained by ssh_get_pubkey_hash.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * This is required under Microsoft platform as this library might use a</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * different C library than your software, hence a different heap.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> *</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * @param  hash         The buffer to deallocate.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> *</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * @see ssh_get_pubkey_hash()</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">void ssh_clean_pubkey_hash(unsigned char **hash) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  SAFE_FREE(*hash);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">  *hash = NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ssh_string ssh_get_pubkey(ssh_session session){</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return string_copy(session-&gt;current_crypto-&gt;server_pubkey);</td><td> </td><td class="right">    return string_copy(session-&gt;current_crypto-&gt;server_pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static int match(const char *group, const char *object){</td><td> </td><td class="right">static int match(const char *group, const char *object){</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *a;</td><td> </td><td class="right">  const char *a;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  const char *z;</td><td> </td><td class="right">  const char *z;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  a = z = group;</td><td> </td><td class="right">  a = z = group;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  do {</td><td> </td><td class="right">  do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    a = strchr(z, ',');</td><td> </td><td class="right">    a = strchr(z, ',');</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l10" /><small>skipping to change at</small><em> line 878</em></th><th> </th><th><a name="part-r10" /><small>skipping to change at</small><em> line 899</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        return 1;</td><td> </td><td class="right">        return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      }</td><td> </td><td class="right">      }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    z = a + 1;</td><td> </td><td class="right">    z = a + 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  } while(1);</td><td> </td><td class="right">  } while(1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  /* not reached */</td><td> </td><td class="right">  /* not reached */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return 0;</td><td> </td><td class="right">  return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">static</span> int <span class="delete">sig_verify(SSH_SESSION *session, PUBLIC_KEY *pubkey,</span></td><td> </td><td class="rblock">int <span class="insert">sig_verify(ssh_session session, ssh_public_key pubkey,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    SIGNATURE *signature, unsigned char <span class="delete">*digest)</span> {</td><td> </td><td class="rblock">    SIGNATURE *signature, unsigned char <span class="insert">*digest, int size)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_error_t valid = 0;</td><td> </td><td class="right">  gcry_error_t valid = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  gcry_sexp_t gcryhash;</td><td> </td><td class="right">  gcry_sexp_t gcryhash;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#elif defined HAVE_LIBCRYPTO</td><td> </td><td class="right">#elif defined HAVE_LIBCRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int valid = 0;</td><td> </td><td class="right">  int valid = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td> </td><td class="right">  unsigned char hash[SHA_DIGEST_LEN + 1] = {0};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  sha1(digest,<span class="delete">SHA_DIGEST_LEN</span>, hash + 1);</td><td> </td><td class="rblock">  sha1(digest,<span class="insert"> size</span>, hash + 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_CRYPTO</td><td> </td><td class="right">#ifdef DEBUG_CRYPTO</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_print_hexa("Hash to be verified with dsa", hash + 1, SHA_DIGEST_LEN);</td><td> </td><td class="right">  ssh_print_hexa("Hash to be verified with dsa", hash + 1, SHA_DIGEST_LEN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  switch(pubkey-&gt;type) {</td><td> </td><td class="right">  switch(pubkey-&gt;type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    case TYPE_DSS:</td><td> </td><td class="right">    case TYPE_DSS:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_LIBGCRYPT</td><td> </td><td class="right">#ifdef HAVE_LIBGCRYPT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      valid = gcry_sexp_build(&amp;gcryhash, NULL, "%b", SHA_DIGEST_LEN + 1, ha
sh);</td><td> </td><td class="right">      valid = gcry_sexp_build(&amp;gcryhash, NULL, "%b", SHA_DIGEST_LEN + 1, ha
sh);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      if (valid != 0) {</td><td> </td><td class="right">      if (valid != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l11" /><small>skipping to change at</small><em> line 973</em></th><th> </th><th><a name="part-r11" /><small>skipping to change at</small><em> line 994</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL, "Invalid RSA signature");</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL, "Invalid RSA signature");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    default:</td><td> </td><td class="right">    default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL, "Unknown public key type");</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL, "Unknown public key type");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return -1;</td><td> </td><td class="right">  return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int <span class="delete">signature_verify(SSH_SESSION *session, STRING *signature)</span> {</td><td> </td><td class="rblock">int <span class="insert">signature_verify(ssh_session session, ssh_string signature)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">PUBLIC_KEY *pubkey</span> = NULL;</td><td> </td><td class="rblock">  <span class="insert">ssh_public_key pubkey</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  SIGNATURE *sign = NULL;</td><td> </td><td class="right">  SIGNATURE *sign = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  int err;</td><td> </td><td class="right">  int err;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  enter_function();</td><td> </td><td class="right">  enter_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  <span class="delete">if (session-&gt;options-&gt;dont_verify_hostkey) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    ssh_log(session, SSH_LOG_FUNCTIONS, "Host key wasn't verified");</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    leave_function();</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">    return 0;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">  }</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  pubkey = publickey_from_string(session,session-&gt;next_crypto-&gt;server_pubke
y);</td><td> </td><td class="right">  pubkey = publickey_from_string(session,session-&gt;next_crypto-&gt;server_pubke
y);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if(pubkey == NULL) {</td><td> </td><td class="right">  if(pubkey == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  if <span class="delete">(session-&gt;options-&gt;wanted_methods[SSH_HOSTKEYS])</span> {</td><td> </td><td class="rblock">  if <span class="insert">(session-&gt;wanted_methods[SSH_HOSTKEYS])</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">    <span class="delete">if(!match(session-&gt;options-&gt;wanted_methods[SSH_HOSTKEYS],pubkey-&gt;type_c</span></td><td> </td><td class="rblock">    <span class="insert">if(!match(session-&gt;wanted_methods[SSH_HOSTKEYS],pubkey-&gt;type_c))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">))</span> {</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      ssh_set_error(session, SSH_FATAL,</td><td> </td><td class="right">      ssh_set_error(session, SSH_FATAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">          "Public key from server (%s) doesn't match user preference (%s)",</td><td> </td><td class="right">          "Public key from server (%s) doesn't match user preference (%s)",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">          pubkey-&gt;type_c, session-&gt;<span class="delete">options-&gt;</span>wanted_methods[SSH_HOSTKEYS]);</td><td> </td><td class="rblock">          pubkey-&gt;type_c, session-&gt;wanted_methods[SSH_HOSTKEYS]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      publickey_free(pubkey);</td><td> </td><td class="right">      publickey_free(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      leave_function();</td><td> </td><td class="right">      leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      return -1;</td><td> </td><td class="right">      return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    }</td><td> </td><td class="right">    }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  sign = signature_from_string(session, signature, pubkey, pubkey-&gt;type);</td><td> </td><td class="right">  sign = signature_from_string(session, signature, pubkey, pubkey-&gt;type);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  if (sign == NULL) {</td><td> </td><td class="right">  if (sign == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    ssh_set_error(session, SSH_FATAL, "Invalid signature blob");</td><td> </td><td class="right">    ssh_set_error(session, SSH_FATAL, "Invalid signature blob");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    publickey_free(pubkey);</td><td> </td><td class="right">    publickey_free(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    leave_function();</td><td> </td><td class="right">    leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">    return -1;</td><td> </td><td class="right">    return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  }</td><td> </td><td class="right">  }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  ssh_log(session, SSH_LOG_FUNCTIONS,</td><td> </td><td class="right">  ssh_log(session, SSH_LOG_FUNCTIONS,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">      "Going to verify a %s type signature", pubkey-&gt;type_c);</td><td> </td><td class="right">      "Going to verify a %s type signature", pubkey-&gt;type_c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">  err = <span class="delete">sig_verify(session,pubkey,sign,session-&gt;next_crypto-&gt;session_id);</span></td><td> </td><td class="rblock">  err = <span class="insert">sig_verify(session,pubkey,sign,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                            session-&gt;next_crypto-&gt;session_id,SHA_DIGEST_LEN</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  signature_free(sign);</td><td> </td><td class="right">  signature_free(sign);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  session-&gt;next_crypto-&gt;server_pubkey_type = pubkey-&gt;type_c;</td><td> </td><td class="right">  session-&gt;next_crypto-&gt;server_pubkey_type = pubkey-&gt;type_c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  publickey_free(pubkey);</td><td> </td><td class="right">  publickey_free(pubkey);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  leave_function();</td><td> </td><td class="right">  leave_function();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">  return err;</td><td> </td><td class="right">  return err;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/** @} */</td><td> </td><td class="right">/** @} */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* vim: set ts=2 sw=2 et cindent: */</td><td> </td><td class="right">/* vim: set ts=2 sw=2 et cindent: */</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 32 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>46 lines changed or deleted</i></th><th><i> </i></th><th><i>62 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
