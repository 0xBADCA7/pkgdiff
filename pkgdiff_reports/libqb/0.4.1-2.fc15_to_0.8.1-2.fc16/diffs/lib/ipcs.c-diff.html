<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.0.0-16-generic #28-Ubuntu SMP Fri Jan 27 17:44:39 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.0 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: ipcs.c - ipcs.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;ipcs.c&nbsp;</th><th> </th><th>&nbsp;ipcs.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 34</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 34</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "ipc_int.h"</td><td> </td><td class="right">#include "ipc_int.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbdefs.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbdefs.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbatomic.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbatomic.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbipcs.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbipcs.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static void qb_ipcs_flowcontrol_set(struct qb_ipcs_connection *c,</td><td> </td><td class="right">static void qb_ipcs_flowcontrol_set(struct qb_ipcs_connection *c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   int32_t fc_enable);</td><td> </td><td class="right">                                   int32_t fc_enable);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static QB_LIST_DECLARE(qb_ipc_services);</td><td> </td><td class="right">static QB_LIST_DECLARE(qb_ipc_services);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">qb_ipcs_service_t*</span> qb_ipcs_create(const char *name,</td><td> </td><td class="rblock"><span class="insert">qb_ipcs_service_t *</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                 int32_t service_id,</td><td> </td><td class="rblock">qb_ipcs_create(const char *name,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                 enum qb_ipc_type type,</td><td> </td><td class="rblock">              int32_t service_id,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                 struct qb_ipcs_service_handlers <span class="delete">*handlers)</span></td><td> </td><td class="rblock">              enum qb_ipc_type type, struct qb_ipcs_service_handlers <span class="insert">*handl</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">ers)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_service *s;</td><td> </td><td class="right">       struct qb_ipcs_service *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s = calloc(1, sizeof(struct qb_ipcs_service));</td><td> </td><td class="right">       s = calloc(1, sizeof(struct qb_ipcs_service));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (s == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;pid = getpid();</td><td> </td><td class="right">       s-&gt;pid = getpid();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;type = type;</td><td> </td><td class="right">       s-&gt;type = type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;needs_sock_for_poll = QB_FALSE;</td><td> </td><td class="right">       s-&gt;needs_sock_for_poll = QB_FALSE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_priority = QB_LOOP_MED;</td><td> </td><td class="right">       s-&gt;poll_priority = QB_LOOP_MED;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;ref_count = 1;</td><td> </td><td class="right">       s-&gt;ref_count = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;service_id = service_id;</td><td> </td><td class="right">       s-&gt;service_id = service_id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       strncpy(s-&gt;name, name, NAME_MAX);</td><td> </td><td class="right">       strncpy(s-&gt;name, name, NAME_MAX);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 65</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 68</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;serv_fns.connection_closed = handlers-&gt;connection_closed;</td><td> </td><td class="right">       s-&gt;serv_fns.connection_closed = handlers-&gt;connection_closed;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;serv_fns.connection_destroyed = handlers-&gt;connection_destroyed;</td><td> </td><td class="right">       s-&gt;serv_fns.connection_destroyed = handlers-&gt;connection_destroyed;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_init(&amp;s-&gt;connections);</td><td> </td><td class="right">       qb_list_init(&amp;s-&gt;connections);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_init(&amp;s-&gt;list);</td><td> </td><td class="right">       qb_list_init(&amp;s-&gt;list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_add(&amp;s-&gt;list, &amp;qb_ipc_services);</td><td> </td><td class="right">       qb_list_add(&amp;s-&gt;list, &amp;qb_ipc_services);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return s;</td><td> </td><td class="right">       return s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_poll_handlers_set(struct <span class="delete">qb_ipcs_service* s,</span></td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                              struct qb_ipcs_poll_handlers *handlers)</td><td> </td><td class="rblock">qb_ipcs_poll_handlers_set(struct <span class="insert">qb_ipcs_service *s,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                         struct qb_ipcs_poll_handlers *handlers)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_fns.job_add = handlers-&gt;job_add;</td><td> </td><td class="right">       s-&gt;poll_fns.job_add = handlers-&gt;job_add;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_fns.dispatch_add = handlers-&gt;dispatch_add;</td><td> </td><td class="right">       s-&gt;poll_fns.dispatch_add = handlers-&gt;dispatch_add;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_fns.dispatch_mod = handlers-&gt;dispatch_mod;</td><td> </td><td class="right">       s-&gt;poll_fns.dispatch_mod = handlers-&gt;dispatch_mod;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_fns.dispatch_del = handlers-&gt;dispatch_del;</td><td> </td><td class="right">       s-&gt;poll_fns.dispatch_del = handlers-&gt;dispatch_del;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_run(struct <span class="delete">qb_ipcs_service* s)</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_run(struct <span class="insert">qb_ipcs_service *s)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       int32_t <span class="delete">res;</span></td><td> </td><td class="rblock">       int32_t <span class="insert">res = 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (s-&gt;poll_fns.dispatch_add == NULL ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">           s-&gt;poll_fns.dispatch_mod == NULL ||</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">           s-&gt;poll_fns.dispatch_del == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       switch (s-&gt;type) {</td><td> </td><td class="right">       switch (s-&gt;type) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPC_SOCKET:</td><td> </td><td class="right">       case QB_IPC_SOCKET:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_us_init((struct qb_ipcs_service *)s);</td><td> </td><td class="right">               qb_ipcs_us_init((struct qb_ipcs_service *)s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPC_SHM:</td><td> </td><td class="right">       case QB_IPC_SHM:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_shm_init((struct qb_ipcs_service *)s);</td><td> </td><td class="right">               qb_ipcs_shm_init((struct qb_ipcs_service *)s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPC_POSIX_MQ:</td><td> </td><td class="right">       case QB_IPC_POSIX_MQ:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_POSIX_MQ</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_pmq_init((struct qb_ipcs_service *)s);</td><td> </td><td class="right">               qb_ipcs_pmq_init((struct qb_ipcs_service *)s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               res = -ENOTSUP;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif /* HAVE_POSIX_MQ */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPC_SYSV_MQ:</td><td> </td><td class="right">       case QB_IPC_SYSV_MQ:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_SYSV_MQ</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_smq_init((struct qb_ipcs_service *)s);</td><td> </td><td class="right">               qb_ipcs_smq_init((struct qb_ipcs_service *)s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#else</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               res = -ENOTSUP;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif /* HAVE_SYSV_MQ */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       default:</td><td> </td><td class="right">       default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -EINVAL;</td><td> </td><td class="right">               res = -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       res = qb_ipcs_us_publish(s);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_unref(s);</td><td> </td><td class="right">               qb_ipcs_unref(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">                                                                    </span></td><td> </td><td class="rblock">       <span class="insert">res = qb_ipcs_us_publish(s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               (void)qb_ipcs_us_withdraw(s);</td><td> </td><td class="right">               (void)qb_ipcs_us_withdraw(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               <span class="insert">qb_ipcs_unref(s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return res;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _modify_dispatch_descriptor_(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_modify_dispatch_descriptor_(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">qb_ipcs_dispatch_mod_fn disp_mod = c-&gt;service-&gt;poll_fns.dispatch_mod</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;type == QB_IPC_POSIX_MQ</td><td> </td><td class="right">       if (c-&gt;service-&gt;type == QB_IPC_POSIX_MQ</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">           &amp;&amp; !c-&gt;service-&gt;needs_sock_for_poll) {</td><td> </td><td class="right">           &amp;&amp; !c-&gt;service-&gt;needs_sock_for_poll) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               return <span class="delete">c-&gt;service-&gt;poll_fns.dispatch_mod(c-&gt;service-&gt;</span></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_MQUEUE_H</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                        poll_priority,</span></td><td> </td><td class="rblock">               return <span class="insert">disp_mod(c-&gt;service-&gt;poll_priority,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        (int32_t) <span class="delete">c-&gt;reques</span></td><td> </td><td class="rblock">                               (int32_t) <span class="insert">c-&gt;request.u.pmq.q,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">t.u.</span></td><td> </td><td class="rblock"><span class="insert">                               c-&gt;poll_events,</span> c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                        pmq.q, c-&gt;poll_even</span></td><td> </td><td class="rblock">                               <span class="insert">qb_ipcs_dispatch_service_request);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ts,</span></td><td> </td><td class="rblock"><span class="insert">#endif /* HAVE_MQUEUE_H */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        c,</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        <span class="delete">qb_ipcs_dispatch_se</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">rvice_request);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (c-&gt;service-&gt;type == QB_IPC_SOCKET) {</td><td> </td><td class="right">       } else if (c-&gt;service-&gt;type == QB_IPC_SOCKET) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               return <span class="delete">c-&gt;service-&gt;poll_fns.dispatch_mod(c-&gt;service-&gt;</span></td><td> </td><td class="rblock">               return <span class="insert">disp_mod(c-&gt;service-&gt;poll_priority,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                        poll_priority,</span></td><td> </td><td class="rblock">                               c-&gt;event.u.us.sock,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        c-&gt;event.u.us.sock,</td><td> </td><td class="rblock">                               c-&gt;poll_events, c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        c-&gt;poll_events, c,</td><td> </td><td class="rblock">                               <span class="insert">qb_ipcs_dispatch_connection_request);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        <span class="delete">qb_ipcs_dispatch_co</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">nnection_request);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               return <span class="delete">c-&gt;service-&gt;poll_fns.dispatch_mod(c-&gt;service-&gt;</span></td><td> </td><td class="rblock">               return <span class="insert">disp_mod(c-&gt;service-&gt;poll_priority,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                        poll_priority,</span></td><td> </td><td class="rblock">                               c-&gt;setup.u.us.sock,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        c-&gt;setup.u.us.sock,</td><td> </td><td class="rblock">                               c-&gt;poll_events, c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        c-&gt;poll_events, c,</td><td> </td><td class="rblock">                               <span class="insert">qb_ipcs_dispatch_connection_request);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                        <span class="delete">qb_ipcs_dispatch_co</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">nnection_request);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return -EINVAL;</td><td> </td><td class="right">       return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_request_rate_limit(struct qb_ipcs_service *s,</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               enum qb_ipcs_rate_limit rl)</td><td> </td><td class="rblock">qb_ipcs_request_rate_limit(struct qb_ipcs_service *s,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                          enum qb_ipcs_rate_limit rl)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c;</td><td> </td><td class="right">       struct qb_ipcs_connection *c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       enum qb_loop_priority old_p = s-&gt;poll_priority;</td><td> </td><td class="right">       enum qb_loop_priority old_p = s-&gt;poll_priority;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">struct qb_list_head *pos;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       struct qb_list_head *n;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       switch (rl) {</td><td> </td><td class="right">       switch (rl) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPCS_RATE_FAST:</td><td> </td><td class="right">       case QB_IPCS_RATE_FAST:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;poll_priority = QB_LOOP_HIGH;</td><td> </td><td class="right">               s-&gt;poll_priority = QB_LOOP_HIGH;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPCS_RATE_SLOW:</td><td> </td><td class="right">       case QB_IPCS_RATE_SLOW:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPCS_RATE_OFF:</td><td> </td><td class="right">       case QB_IPCS_RATE_OFF:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       case QB_IPCS_RATE_OFF_2:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;poll_priority = QB_LOOP_LOW;</td><td> </td><td class="right">               s-&gt;poll_priority = QB_LOOP_LOW;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       default:</td><td> </td><td class="right">       default:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       case QB_IPCS_RATE_NORMAL:</td><td> </td><td class="right">       case QB_IPCS_RATE_NORMAL:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;poll_priority = QB_LOOP_MED;</td><td> </td><td class="right">               s-&gt;poll_priority = QB_LOOP_MED;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               break;</td><td> </td><td class="right">               break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">qb_list_for_each_entry(c, &amp;s-&gt;connections, list)</span> {</td><td> </td><td class="rblock">       <span class="insert">for (pos = s-&gt;connections.next, n = pos-&gt;next;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">            pos != &amp;s-&gt;connections; pos = n, n = pos-&gt;next)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               <span class="insert">c = qb_list_entry(pos, struct qb_ipcs_connection, list);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_connection_ref(c);</td><td> </td><td class="right">               qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_ipcs_flowcontrol_set(c, (rl == <span class="delete">QB_IPCS_RATE_OFF));</span></td><td> </td><td class="rblock">               <span class="insert">if (rl == QB_IPCS_RATE_OFF) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if (old_p <span class="delete">==</span> s-&gt;poll_priority) {</td><td> </td><td class="rblock">                       qb_ipcs_flowcontrol_set(c, <span class="insert">1);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_ipcs_connection_unref(c);</span></td><td> </td><td class="rblock"><span class="insert">               } else if</span> (rl == <span class="insert">QB_IPCS_RATE_OFF_2) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       continue;</span></td><td> </td><td class="rblock"><span class="insert">                       qb_ipcs_flowcontrol_set(c, 2);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               } else {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       qb_ipcs_flowcontrol_set(c, QB_FALSE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               if (old_p <span class="insert">!=</span> s-&gt;poll_priority) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                       <span class="insert">(void)_modify_dispatch_descriptor_(c);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                                           </td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">(void)_modify_dispatch_descriptor_(c);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_connection_unref(c);</td><td> </td><td class="right">               qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_ref(struct qb_ipcs_service *s)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_ref(struct qb_ipcs_service *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_atomic_int_inc(&amp;s-&gt;ref_count);</td><td> </td><td class="right">       qb_atomic_int_inc(&amp;s-&gt;ref_count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_unref(struct qb_ipcs_service *s)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_unref(struct qb_ipcs_service *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t free_it;</td><td> </td><td class="right">       int32_t free_it;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c = NULL;</td><td> </td><td class="right">       struct qb_ipcs_connection *c = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_list_head <span class="delete">*iter;</span></td><td> </td><td class="rblock">       struct qb_list_head <span class="insert">*pos;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_list_head <span class="delete">*iter_next;</span></td><td> </td><td class="rblock">       struct qb_list_head <span class="insert">*n;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       assert(s-&gt;ref_count &gt; 0);</td><td> </td><td class="right">       assert(s-&gt;ref_count &gt; 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free_it = qb_atomic_int_dec_and_test(&amp;s-&gt;ref_count);</td><td> </td><td class="right">       free_it = qb_atomic_int_dec_and_test(&amp;s-&gt;ref_count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (free_it) {</td><td> </td><td class="right">       if (free_it) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_log(LOG_DEBUG, "%s() - <span class="delete">destorying",</span> __func__);</td><td> </td><td class="rblock">               qb_util_log(LOG_DEBUG, "%s() - <span class="insert">destroying",</span> __func__);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_list_for_each_safe(iter, iter_next, &amp;s-&gt;connections)</span> {</td><td> </td><td class="rblock">               <span class="insert">for (pos = s-&gt;connections.next, n = pos-&gt;next;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       c = <span class="delete">qb_list_entry(iter,</span> struct qb_ipcs_connection, <span class="delete">l</span></td><td> </td><td class="rblock"><span class="insert">                    pos != &amp;s-&gt;connections; pos = n, n = pos-&gt;next)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ist);</span></td><td> </td><td class="rblock">                       c = <span class="insert">qb_list_entry(pos,</span> struct qb_ipcs_connection, <span class="insert">li</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">st);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (c == NULL) {</td><td> </td><td class="right">                       if (c == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               continue;</td><td> </td><td class="right">                               continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_ipcs_disconnect(c);</td><td> </td><td class="right">                       qb_ipcs_disconnect(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               (void)qb_ipcs_us_withdraw(s);</td><td> </td><td class="right">               (void)qb_ipcs_us_withdraw(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               free(s);</td><td> </td><td class="right">               free(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_destroy(struct <span class="delete">qb_ipcs_service* s)</span></td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_destroy(struct <span class="insert">qb_ipcs_service *s)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_unref(s);</td><td> </td><td class="right">       qb_ipcs_unref(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * connection API</td><td> </td><td class="right"> * connection API</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_ipcs_response_send(struct qb_ipcs_connection *c, const void <span class="delete">*dat</span></td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">a,</span></td><td> </td><td class="rblock">qb_ipcs_response_send(struct qb_ipcs_connection *c, const void <span class="insert">*data,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                             size_t size)</td><td> </td><td class="rblock">                     size_t size)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = c-&gt;service-&gt;funcs.send(&amp;c-&gt;response, data, size);</td><td> </td><td class="right">       res = c-&gt;service-&gt;funcs.send(&amp;c-&gt;response, data, size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == size) {</td><td> </td><td class="right">       if (res == size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.responses++;</td><td> </td><td class="right">               c-&gt;stats.responses++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (res == -EAGAIN || res == -ETIMEDOUT) {</td><td> </td><td class="right">       } else if (res == -EAGAIN || res == -ETIMEDOUT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.send_retries++;</td><td> </td><td class="right">               c-&gt;stats.send_retries++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_ipcs_response_sendv(struct qb_ipcs_connection <span class="delete">*c,</span> const struct <span class="delete">i</span></td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ovec</span> * iov, size_t iov_len)</td><td> </td><td class="rblock">qb_ipcs_response_sendv(struct qb_ipcs_connection <span class="insert">* c,</span> const struct <span class="insert">iovec</span> * </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">iov,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                      size_t iov_len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = c-&gt;service-&gt;funcs.sendv(&amp;c-&gt;response, iov, iov_len);</td><td> </td><td class="right">       res = c-&gt;service-&gt;funcs.sendv(&amp;c-&gt;response, iov, iov_len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &gt; 0) {</td><td> </td><td class="right">       if (res &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.responses++;</td><td> </td><td class="right">               c-&gt;stats.responses++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (res == -EAGAIN || res == -ETIMEDOUT) {</td><td> </td><td class="right">       } else if (res == -EAGAIN || res == -ETIMEDOUT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.send_retries++;</td><td> </td><td class="right">               c-&gt;stats.send_retries++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t send_event_notification(int32_t fd, int32_t revents, void <span class="delete">*d</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ata)</span></td><td> </td><td class="rblock">send_event_notification(int32_t fd, int32_t revents, void <span class="insert">*data)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res = 0;</td><td> </td><td class="right">       ssize_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c = data;</td><td> </td><td class="right">       struct qb_ipcs_connection *c = data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;outstanding_notifiers &gt; 0) {</td><td> </td><td class="right">       if (c-&gt;outstanding_notifiers &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = qb_ipc_us_send(&amp;c-&gt;setup, data, c-&gt;outstanding_notifie
rs);</td><td> </td><td class="right">               res = qb_ipc_us_send(&amp;c-&gt;setup, data, c-&gt;outstanding_notifie
rs);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &gt; 0) {</td><td> </td><td class="right">       if (res &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;outstanding_notifiers -= res;</td><td> </td><td class="right">               c-&gt;outstanding_notifiers -= res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;outstanding_notifiers &gt; 0) {</td><td> </td><td class="right">       if (c-&gt;outstanding_notifiers &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return 0;</td><td> </td><td class="right">               return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;outstanding_notifiers = 0;</td><td> </td><td class="right">               c-&gt;outstanding_notifiers = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;poll_events = POLLIN | POLLPRI | POLLNVAL,</td><td> </td><td class="right">               c-&gt;poll_events = POLLIN | POLLPRI | POLLNVAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               (void)_modify_dispatch_descriptor_(c);</td><td> </td><td class="rblock">               <span class="insert">    </span>(void)_modify_dispatch_descriptor_(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_ipcs_event_send(struct qb_ipcs_connection * c, const void *data,</td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          size_t size)</td><td> </td><td class="rblock">qb_ipcs_event_send(struct qb_ipcs_connection * c, const void *data, size_t </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">size)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res2 = 0;</td><td> </td><td class="right">       ssize_t res2 = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = c-&gt;service-&gt;funcs.send(&amp;c-&gt;event, data, size);</td><td> </td><td class="right">       res = c-&gt;service-&gt;funcs.send(&amp;c-&gt;event, data, size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != size) {</td><td> </td><td class="right">       if (res != size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto deref_and_return;</td><td> </td><td class="right">               goto deref_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;stats.events++;</td><td> </td><td class="right">       c-&gt;stats.events++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;needs_sock_for_poll) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;needs_sock_for_poll) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;outstanding_notifiers &gt; 0) {</td><td> </td><td class="right">               if (c-&gt;outstanding_notifiers &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;outstanding_notifiers++;</td><td> </td><td class="right">                       c-&gt;outstanding_notifiers++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res2 = qb_ipc_us_send(&amp;c-&gt;setup, data, 1);</td><td> </td><td class="right">                       res2 = qb_ipc_us_send(&amp;c-&gt;setup, data, 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (res2 == 1) {</td><td> </td><td class="right">                       if (res2 == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               goto deref_and_return;</td><td> </td><td class="right">                               goto deref_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * notify the client later, when we can.</td><td> </td><td class="right">                        * notify the client later, when we can.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;outstanding_notifiers++;</td><td> </td><td class="right">                       c-&gt;outstanding_notifiers++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;poll_events = POLLOUT | POLLIN | POLLPRI | POLLNV
AL,</td><td> </td><td class="right">                       c-&gt;poll_events = POLLOUT | POLLIN | POLLPRI | POLLNV
AL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       (void)_modify_dispatch_descriptor_(c);</td><td> </td><td class="rblock">                       <span class="insert">    </span>(void)_modify_dispatch_descriptor_(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">deref_and_return:</td><td> </td><td class="right">deref_and_return:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_ipcs_event_sendv(struct qb_ipcs_connection * c,</td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           const struct iovec * iov, size_t iov_len)</td><td> </td><td class="rblock">qb_ipcs_event_sendv(struct qb_ipcs_connection * c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                   const struct iovec * iov, size_t iov_len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res2;</td><td> </td><td class="right">       ssize_t res2;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = c-&gt;service-&gt;funcs.sendv(&amp;c-&gt;event, iov, iov_len);</td><td> </td><td class="right">       res = c-&gt;service-&gt;funcs.sendv(&amp;c-&gt;event, iov, iov_len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto deref_and_return;</td><td> </td><td class="right">               goto deref_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;stats.events++;</td><td> </td><td class="right">       c-&gt;stats.events++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;needs_sock_for_poll) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;needs_sock_for_poll) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;outstanding_notifiers &gt; 0) {</td><td> </td><td class="right">               if (c-&gt;outstanding_notifiers &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;outstanding_notifiers++;</td><td> </td><td class="right">                       c-&gt;outstanding_notifiers++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res2 = qb_ipc_us_send(&amp;c-&gt;setup, &amp;res, 1);</td><td> </td><td class="right">                       res2 = qb_ipc_us_send(&amp;c-&gt;setup, &amp;res, 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (res2 == 1) {</td><td> </td><td class="right">                       if (res2 == 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               goto deref_and_return;</td><td> </td><td class="right">                               goto deref_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * notify the client later, when we can.</td><td> </td><td class="right">                        * notify the client later, when we can.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;outstanding_notifiers++;</td><td> </td><td class="right">                       c-&gt;outstanding_notifiers++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;poll_events = POLLOUT | POLLIN | POLLPRI | POLLNV
AL,</td><td> </td><td class="right">                       c-&gt;poll_events = POLLOUT | POLLIN | POLLPRI | POLLNV
AL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       (void)_modify_dispatch_descriptor_(c);</td><td> </td><td class="rblock">                       <span class="insert">    </span>(void)_modify_dispatch_descriptor_(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">deref_and_return:</td><td> </td><td class="right">deref_and_return:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">qb_ipcs_connection_t <span class="delete">*qb_ipcs_connection_first_get(struct</span> qb_ipcs_service *</td><td> </td><td class="rblock">qb_ipcs_connection_t <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> s)</td><td> </td><td class="rblock"><span class="insert">qb_ipcs_connection_first_get(struct</span> qb_ipcs_service * s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c;</td><td> </td><td class="right">       struct qb_ipcs_connection *c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_list_head *iter;</td><td> </td><td class="right">       struct qb_list_head *iter;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (qb_list_empty(&amp;s-&gt;connections)) {</td><td> </td><td class="right">       if (qb_list_empty(&amp;s-&gt;connections)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return NULL;</td><td> </td><td class="right">               return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       iter = s-&gt;connections.next;</td><td> </td><td class="right">       iter = s-&gt;connections.next;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c = qb_list_entry(iter, struct qb_ipcs_connection, list);</td><td> </td><td class="right">       c = qb_list_entry(iter, struct qb_ipcs_connection, list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return c;</td><td> </td><td class="right">       return c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">qb_ipcs_connection_t * qb_ipcs_connection_next_get(struct <span class="delete">qb_ipcs_service*</span> </td><td> </td><td class="rblock">qb_ipcs_connection_t *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">s,</td><td> </td><td class="rblock">qb_ipcs_connection_next_get(struct <span class="insert">qb_ipcs_service *</span> s,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                  struct qb_ipcs_connection</td><td> </td><td class="rblock">                           struct qb_ipcs_connection <span class="insert">* current)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> <span class="delete">*current)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c;</td><td> </td><td class="right">       struct qb_ipcs_connection *c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_list_head *iter;</td><td> </td><td class="right">       struct qb_list_head *iter;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (current-&gt;list.next == &amp;s-&gt;connections) {</td><td> </td><td class="rblock">       if (current<span class="insert"> == NULL || current</span>-&gt;list.next == &amp;s-&gt;connections) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return NULL;</td><td> </td><td class="right">               return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       iter = current-&gt;list.next;</td><td> </td><td class="right">       iter = current-&gt;list.next;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c = qb_list_entry(iter, struct qb_ipcs_connection, list);</td><td> </td><td class="right">       c = qb_list_entry(iter, struct qb_ipcs_connection, list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return c;</td><td> </td><td class="right">       return c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_service_id_get(struct qb_ipcs_connection <span class="delete">*c)</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_service_id_get(struct qb_ipcs_connection <span class="insert">* c)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return c-&gt;service-&gt;service_id;</td><td> </td><td class="right">       return c-&gt;service-&gt;service_id;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">struct qb_ipcs_connection <span class="delete">*qb_ipcs_connection_alloc(struct</span> qb_ipcs_service </td><td> </td><td class="rblock">struct qb_ipcs_connection <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">*s)</td><td> </td><td class="rblock"><span class="insert">qb_ipcs_connection_alloc(struct</span> qb_ipcs_service *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_ipcs_connection *c = calloc(1, sizeof(struct <span class="delete">qb_ipcs_conne</span></td><td> </td><td class="rblock">       struct qb_ipcs_connection *c =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ction));</span></td><td> </td><td class="rblock">           calloc(1, sizeof(struct <span class="insert">qb_ipcs_connection));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;refcount = 1;</td><td> </td><td class="right">       c-&gt;refcount = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;service = s;</td><td> </td><td class="right">       c-&gt;service = s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;pid = 0;</td><td> </td><td class="right">       c-&gt;pid = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;euid = -1;</td><td> </td><td class="right">       c-&gt;euid = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;egid = -1;</td><td> </td><td class="right">       c-&gt;egid = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_init(&amp;c-&gt;list);</td><td> </td><td class="right">       qb_list_init(&amp;c-&gt;list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;receive_buf = NULL;</td><td> </td><td class="right">       c-&gt;receive_buf = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;context = NULL;</td><td> </td><td class="right">       c-&gt;context = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;fc_enabled = QB_FALSE;</td><td> </td><td class="right">       c-&gt;fc_enabled = QB_FALSE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;state = QB_IPCS_CONNECTION_INACTIVE;</td><td> </td><td class="right">       c-&gt;state = QB_IPCS_CONNECTION_INACTIVE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;poll_events = POLLIN | POLLPRI | POLLNVAL;</td><td> </td><td class="right">       c-&gt;poll_events = POLLIN | POLLPRI | POLLNVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return c;</td><td> </td><td class="right">       return c;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_connection_ref(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_connection_ref(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       qb_atomic_int_inc(&amp;c-&gt;refcount);</td><td> </td><td class="rblock">       <span class="insert">if (c) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               qb_atomic_int_inc(&amp;c-&gt;refcount);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_connection_unref(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_connection_unref(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t free_it;</td><td> </td><td class="right">       int32_t free_it;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;refcount &lt; 1) {</td><td> </td><td class="right">       if (c-&gt;refcount &lt; 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "%s() ref:%d state:%d fd:%d",</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "%s() ref:%d state:%d fd:%d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           __func__, c-&gt;refcount, c-&gt;state, <span class="delete">c-&gt;setup.u.us.s</span></td><td> </td><td class="rblock">                           __func__, c-&gt;refcount, c-&gt;state,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ock);</span></td><td> </td><td class="rblock">                           <span class="insert">c-&gt;setup.u.us.sock);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               assert(0);</td><td> </td><td class="right">               assert(0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free_it = qb_atomic_int_dec_and_test(&amp;c-&gt;refcount);</td><td> </td><td class="right">       free_it = qb_atomic_int_dec_and_test(&amp;c-&gt;refcount);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (free_it) {</td><td> </td><td class="right">       if (free_it) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_list_del(&amp;c-&gt;list);</td><td> </td><td class="right">               qb_list_del(&amp;c-&gt;list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;service-&gt;serv_fns.connection_destroyed) {</td><td> </td><td class="right">               if (c-&gt;service-&gt;serv_fns.connection_destroyed) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;service-&gt;serv_fns.connection_destroyed(c);</td><td> </td><td class="right">                       c-&gt;service-&gt;serv_fns.connection_destroyed(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;service-&gt;funcs.disconnect(c);</td><td> </td><td class="right">               c-&gt;service-&gt;funcs.disconnect(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">if (c-&gt;receive_buf) {</span></td><td> </td><td class="rblock">               free(c-&gt;receive_buf);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       free(c-&gt;receive_buf);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               free(c);</td><td> </td><td class="right">               free(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_disconnect(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_disconnect(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_job_dispatch_fn rerun_job;</td><td> </td><td class="right">       qb_loop_job_dispatch_fn rerun_job;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_util_log(LOG_DEBUG, "%s() state:%d", __func__, c-&gt;state);</td><td> </td><td class="right">       qb_util_log(LOG_DEBUG, "%s() state:%d", __func__, c-&gt;state);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;state == QB_IPCS_CONNECTION_ACTIVE) {</td><td> </td><td class="right">       if (c-&gt;state == QB_IPCS_CONNECTION_ACTIVE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if (c-&gt;service-&gt;needs_sock_for_poll &amp;&amp;</td><td> </td><td class="rblock">               <span class="insert">c-&gt;state = QB_IPCS_CONNECTION_INACTIVE;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                   c-&gt;setup.u.us.sock &gt; 0) {</td><td> </td><td class="rblock"><span class="insert">               c-&gt;service-&gt;stats.closed_connections++;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               if (c-&gt;service-&gt;needs_sock_for_poll &amp;&amp; c-&gt;setup.u.us.sock &gt; </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                       <span class="insert">(void)c-&gt;service-&gt;poll_fns.dispatch_del(c-&gt;setup.u.u</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">s.sock);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_ipcc_us_sock_close(c-&gt;setup.u.us.sock);</td><td> </td><td class="right">                       qb_ipcc_us_sock_close(c-&gt;setup.u.us.sock);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;setup.u.us.sock = -1;</td><td> </td><td class="right">                       c-&gt;setup.u.us.sock = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">                       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               c-&gt;state = <span class="delete">QB_IPCS_CONNECTION_DOWN;</span></td><td> </td><td class="rblock">               <span class="insert">/* return early as it's an incomplete connection.</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (c-&gt;state == QB_IPCS_CONNECTION_ESTABLISHED) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               c-&gt;state = <span class="insert">QB_IPCS_CONNECTION_SHUTTING_DOWN;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;service-&gt;stats.active_connections--;</td><td> </td><td class="right">               c-&gt;service-&gt;stats.active_connections--;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;service-&gt;stats.closed_connections++;</td><td> </td><td class="right">               c-&gt;service-&gt;stats.closed_connections++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               <span class="insert">if (c-&gt;service-&gt;needs_sock_for_poll &amp;&amp; c-&gt;setup.u.us.sock &gt; </span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       (void)c-&gt;service-&gt;poll_fns.dispatch_del(c-&gt;setup.u.u</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">s.sock);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       qb_ipcc_us_sock_close(c-&gt;setup.u.us.sock);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       c-&gt;setup.u.us.sock = -1;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       qb_ipcs_connection_unref(c);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (c-&gt;state == QB_IPCS_CONNECTION_DOWN) {</td><td> </td><td class="rblock">       if (c-&gt;state == QB_IPCS_CONNECTION_<span class="insert">SHUTTING_</span>DOWN) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = 0;</td><td> </td><td class="right">               res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;service-&gt;serv_fns.connection_closed) {</td><td> </td><td class="right">               if (c-&gt;service-&gt;serv_fns.connection_closed) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = c-&gt;service-&gt;serv_fns.connection_closed(c);</td><td> </td><td class="right">                       res = c-&gt;service-&gt;serv_fns.connection_closed(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == 0) {</td><td> </td><td class="right">               if (res == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">                       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       /* <span class="delete">ok, so they want the connection_closedd()</span></td><td> </td><td class="rblock">                       /* <span class="insert">OK, so they want the connection_closed</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * function re-run */</td><td> </td><td class="right">                        * function re-run */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       rerun_job = <span class="delete">(qb_loop_job_dispatch_fn)qb_ipcs_disconn</span></td><td> </td><td class="rblock">                       rerun_job =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ect;</span></td><td> </td><td class="rblock">                           <span class="insert">(qb_loop_job_dispatch_fn) qb_ipcs_disconnect;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       res = c-&gt;service-&gt;poll_fns.job_add(QB_LOOP_LOW, c,</td><td> </td><td class="rblock">                       res = c-&gt;service-&gt;poll_fns.job_add(QB_LOOP_LOW,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                          c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                                          rerun_job);</td><td> </td><td class="right">                                                          rerun_job);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (res != 0) {</td><td> </td><td class="right">                       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               /* last ditch attempt to cleanup */</td><td> </td><td class="right">                               /* last ditch attempt to cleanup */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               qb_ipcs_connection_unref(c);</td><td> </td><td class="right">                               qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void qb_ipcs_flowcontrol_set(struct qb_ipcs_connection *c, int32_t <span class="delete">f</span></td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">c_enable)</span></td><td> </td><td class="rblock">qb_ipcs_flowcontrol_set(struct qb_ipcs_connection *c, int32_t <span class="insert">fc_enable)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;fc_enabled != fc_enable) {</td><td> </td><td class="right">       if (c-&gt;fc_enabled != fc_enable) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;service-&gt;funcs.fc_set(&amp;c-&gt;request, fc_enable);</td><td> </td><td class="right">               c-&gt;service-&gt;funcs.fc_set(&amp;c-&gt;request, fc_enable);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;fc_enabled = fc_enable;</td><td> </td><td class="right">               c-&gt;fc_enabled = fc_enable;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.flow_control_state = fc_enable;</td><td> </td><td class="right">               c-&gt;stats.flow_control_state = fc_enable;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.flow_control_count++;</td><td> </td><td class="right">               c-&gt;stats.flow_control_count++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _process_request_(struct qb_ipcs_connection *c,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                int32_t ms_timeout)</td><td> </td><td class="rblock">_process_request_(struct qb_ipcs_connection *c, int32_t ms_timeout)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t size;</td><td> </td><td class="right">       ssize_t size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipc_request_header *hdr;</td><td> </td><td class="right">       struct qb_ipc_request_header *hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_ref(c);</td><td> </td><td class="right">       qb_ipcs_connection_ref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;funcs.peek &amp;&amp; c-&gt;service-&gt;funcs.reclaim) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;funcs.peek &amp;&amp; c-&gt;service-&gt;funcs.reclaim) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               size = c-&gt;service-&gt;funcs.peek(&amp;c-&gt;request, (void**)&amp;hdr,</td><td> </td><td class="rblock">               size = c-&gt;service-&gt;funcs.peek(&amp;c-&gt;request, (void<span class="insert"> </span>**)&amp;hdr,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                             ms_timeout);</td><td> </td><td class="right">                                             ms_timeout);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               hdr = <span class="delete">(struct qb_ipc_request_header *)c-&gt;receive_buf;</span></td><td> </td><td class="rblock">               hdr = <span class="insert">c-&gt;receive_buf;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               size = c-&gt;service-&gt;funcs.recv(&amp;c-&gt;request, hdr, <span class="delete">c-&gt;request.m</span></td><td> </td><td class="rblock">               size = c-&gt;service-&gt;funcs.recv(&amp;c-&gt;request,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ax_msg_size,</span></td><td> </td><td class="rblock">                                             hdr,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                             <span class="insert">c-&gt;request.max_msg_size,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                             ms_timeout);</td><td> </td><td class="right">                                             ms_timeout);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (size &lt; 0) {</td><td> </td><td class="right">       if (size &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (size != -EAGAIN &amp;&amp; size != -ETIMEDOUT) {</td><td> </td><td class="right">               if (size != -EAGAIN &amp;&amp; size != -ETIMEDOUT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR, "%s(): %s", __func__, strerror(</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_ERR,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">-res));</span></td><td> </td><td class="rblock"><span class="insert">                                      "recv from client connection failed")</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       c-&gt;stats.recv_retries++;</td><td> </td><td class="right">                       c-&gt;stats.recv_retries++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = size;</td><td> </td><td class="right">               res = size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup;</td><td> </td><td class="right">               goto cleanup;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;stats.requests++;</td><td> </td><td class="right">       c-&gt;stats.requests++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (hdr-&gt;id == QB_IPC_MSG_DISCONNECT) {</td><td> </td><td class="right">       if (hdr-&gt;id == QB_IPC_MSG_DISCONNECT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_log(LOG_DEBUG, "<span class="delete">%s() QB_IPC_MSG_DISCONNECT", __func_
_</span>);</td><td> </td><td class="rblock">               qb_util_log(LOG_DEBUG, "<span class="insert">client requesting a disconnect"</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_disconnect(c);</td><td> </td><td class="right">               qb_ipcs_disconnect(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -ESHUTDOWN;</td><td> </td><td class="right">               res = -ESHUTDOWN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = c-&gt;service-&gt;serv_fns.msg_process(c, hdr, hdr-&gt;size);</td><td> </td><td class="right">               res = c-&gt;service-&gt;serv_fns.msg_process(c, hdr, hdr-&gt;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               /* 0 == good, neg<span class="delete">i</span>tive == backoff */</td><td> </td><td class="rblock">               /* 0 == good, neg<span class="insert">a</span>tive == backoff */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res &lt; 0) {</td><td> </td><td class="right">               if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = -ENOBUFS;</td><td> </td><td class="right">                       res = -ENOBUFS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = size;</td><td> </td><td class="right">                       res = size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;funcs.peek &amp;&amp; c-&gt;service-&gt;funcs.reclaim) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;funcs.peek &amp;&amp; c-&gt;service-&gt;funcs.reclaim) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;service-&gt;funcs.reclaim(&amp;c-&gt;request);</td><td> </td><td class="right">               c-&gt;service-&gt;funcs.reclaim(&amp;c-&gt;request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup:</td><td> </td><td class="right">cleanup:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_ipcs_connection_unref(c);</td><td> </td><td class="right">       qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define IPC_REQUEST_TIMEOUT 10</td><td> </td><td class="right">#define IPC_REQUEST_TIMEOUT 10</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define MAX_RECV_MSGS 50</td><td> </td><td class="right">#define MAX_RECV_MSGS 50</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0070" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_dispatch_service_request(int32_t fd, int32_t revents,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                        void *data)</td><td> </td><td class="rblock">qb_ipcs_dispatch_service_request(int32_t fd, int32_t revents, void *data)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = _process_request_((struct qb_ipcs_connection *)data,</td><td> </td><td class="right">       int32_t res = _process_request_((struct qb_ipcs_connection *)data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                       IPC_REQUEST_TIMEOUT);</td><td> </td><td class="right">                                       IPC_REQUEST_TIMEOUT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &gt; 0) {</td><td> </td><td class="right">       if (res &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return 0;</td><td> </td><td class="right">               return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0071" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static ssize_t _request_q_len_get(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">static ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_request_q_len_get(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t q_len;</td><td> </td><td class="right">       ssize_t q_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;funcs.q_len_get) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;funcs.q_len_get) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               q_len = c-&gt;service-&gt;funcs.q_len_get(&amp;c-&gt;request);</td><td> </td><td class="right">               q_len = c-&gt;service-&gt;funcs.q_len_get(&amp;c-&gt;request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (q_len &lt; 0) {</td><td> </td><td class="right">               if (q_len &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return q_len;</td><td> </td><td class="right">                       return q_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               q_len = QB_MIN(q_len, MAX_RECV_MSGS);</td><td> </td><td class="right">               q_len = QB_MIN(q_len, MAX_RECV_MSGS);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;service-&gt;poll_priority == QB_LOOP_MED)</td><td> </td><td class="right">               if (c-&gt;service-&gt;poll_priority == QB_LOOP_MED)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       q_len = QB_MIN(q_len, 5);</td><td> </td><td class="right">                       q_len = QB_MIN(q_len, 5);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (c-&gt;service-&gt;poll_priority == QB_LOOP_LOW)</td><td> </td><td class="right">               if (c-&gt;service-&gt;poll_priority == QB_LOOP_LOW)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       q_len = 1;</td><td> </td><td class="right">                       q_len = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               q_len = 1;</td><td> </td><td class="right">               q_len = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return q_len;</td><td> </td><td class="right">       return q_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0072" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_dispatch_connection_request(int32_t fd, int32_t revents,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                           void <span class="delete">*data)</span></td><td> </td><td class="rblock">qb_ipcs_dispatch_connection_request(int32_t fd, int32_t revents, void <span class="insert">*data</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipcs_connection *c = (struct qb_ipcs_connection *)data;</td><td> </td><td class="right">       struct qb_ipcs_connection *c = (struct qb_ipcs_connection *)data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char bytes[MAX_RECV_MSGS];</td><td> </td><td class="right">       char bytes[MAX_RECV_MSGS];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t recvd = 0;</td><td> </td><td class="right">       int32_t recvd = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t avail;</td><td> </td><td class="right">       ssize_t avail;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (revents &amp; POLLHUP) {</td><td> </td><td class="right">       if (revents &amp; POLLHUP) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_DEBUG, "%s HUP conn:%p fd:%d", __func__, c, 
fd);</td><td> </td><td class="right">               qb_util_log(LOG_DEBUG, "%s HUP conn:%p fd:%d", __func__, c, 
fd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_disconnect(c);</td><td> </td><td class="right">               qb_ipcs_disconnect(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 602</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 700</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;service-&gt;needs_sock_for_poll &amp;&amp; recvd &gt; 0) {</td><td> </td><td class="right">       if (c-&gt;service-&gt;needs_sock_for_poll &amp;&amp; recvd &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               (void)qb_ipc_us_recv(&amp;c-&gt;setup, bytes, recvd, -1);</td><td> </td><td class="right">               (void)qb_ipc_us_recv(&amp;c-&gt;setup, bytes, recvd, -1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = QB_MIN(0, res);</td><td> </td><td class="right">       res = QB_MIN(0, res);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == -EAGAIN || res == -ETIMEDOUT || res == -ENOBUFS) {</td><td> </td><td class="right">       if (res == -EAGAIN || res == -ETIMEDOUT || res == -ENOBUFS) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = 0;</td><td> </td><td class="right">               res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0073" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_DEBUG, "%s returning %d : %s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_DEBUG, "request returned error");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           __func__, res, strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_ipcs_connection_unref(c);</td><td> </td><td class="right">               qb_ipcs_connection_unref(c);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0074" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_context_set(struct qb_ipcs_connection *c, void *context)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_context_set(struct qb_ipcs_connection *c, void *context)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0075" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;context = context;</td><td> </td><td class="right">       c-&gt;context = context;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0076" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">*qb_ipcs_context_get(struct</span> qb_ipcs_connection *c)</td><td> </td><td class="rblock">void <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qb_ipcs_context_get(struct</span> qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0077" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return c-&gt;context;</td><td> </td><td class="right">       return c-&gt;context;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0078" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_connection_stats_get(qb_ipcs_connection_t <span class="delete">*c,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                    struct <span class="delete">qb_ipcs_connection_stats*</span> stats,</td><td> </td><td class="rblock">qb_ipcs_connection_stats_get(qb_ipcs_connection_t <span class="insert">* c,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                    int32_t clear_after_read)</td><td> </td><td class="rblock">                            struct <span class="insert">qb_ipcs_connection_stats *</span> stats,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                            int32_t clear_after_read)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0079" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (c == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(stats, &amp;c-&gt;stats, sizeof(struct qb_ipcs_connection_stats));</td><td> </td><td class="right">       memcpy(stats, &amp;c-&gt;stats, sizeof(struct qb_ipcs_connection_stats));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (clear_after_read) {</td><td> </td><td class="right">       if (clear_after_read) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memset(&amp;c-&gt;stats, 0, sizeof(struct qb_ipcs_connection_stats)
);</td><td> </td><td class="right">               memset(&amp;c-&gt;stats, 0, sizeof(struct qb_ipcs_connection_stats)
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               c-&gt;stats.client_pid = c-&gt;pid;</td><td> </td><td class="right">               c-&gt;stats.client_pid = c-&gt;pid;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0080" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcs_stats_get(struct <span class="delete">qb_ipcs_service*</span> s,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         struct <span class="delete">qb_ipcs_stats*</span> stats,</td><td> </td><td class="rblock">qb_ipcs_stats_get(struct <span class="insert">qb_ipcs_service *</span> s,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         int32_t clear_after_read)</td><td> </td><td class="rblock">                 struct <span class="insert">qb_ipcs_stats *</span> stats, int32_t clear_after_read)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0081" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (s == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(stats, &amp;s-&gt;stats, sizeof(struct qb_ipcs_stats));</td><td> </td><td class="right">       memcpy(stats, &amp;s-&gt;stats, sizeof(struct qb_ipcs_stats));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (clear_after_read) {</td><td> </td><td class="right">       if (clear_after_read) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memset(&amp;s-&gt;stats, 0, sizeof(struct qb_ipcs_stats));</td><td> </td><td class="right">               memset(&amp;s-&gt;stats, 0, sizeof(struct qb_ipcs_stats));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 81 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>120 lines changed or deleted</i></th><th><i> </i></th><th><i>224 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
