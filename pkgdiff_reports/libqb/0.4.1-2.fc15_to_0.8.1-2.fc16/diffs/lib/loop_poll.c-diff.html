<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.0.0-16-generic #28-Ubuntu SMP Fri Jan 27 17:44:39 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.0 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: loop_poll.c - loop_poll.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;loop_poll.c&nbsp;</th><th> </th><th>&nbsp;loop_poll.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 23</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 23</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * libqb is distributed in the hope that it will be useful,</td><td> </td><td class="right"> * libqb is distributed in the hope that it will be useful,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td> </td><td class="right"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td> </td><td class="right"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * GNU Lesser General Public License for more details.</td><td> </td><td class="right"> * GNU Lesser General Public License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU Lesser General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU Lesser General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td> </td><td class="right"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "os_base.h"</td><td> </td><td class="right">#include "os_base.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_SYS_RESOURCE_H</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/resource.h&gt;</td><td> </td><td class="right">#include &lt;sys/resource.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_SYS_EPOLL_H</td><td> </td><td class="right">#ifdef HAVE_SYS_EPOLL_H</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/epoll.h&gt;</td><td> </td><td class="right">#include &lt;sys/epoll.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifndef epoll_create1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">int epoll_create1(int flags);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif /* workaround a set of sparc and alpha broken headers */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_SYS_EPOLL_H */</td><td> </td><td class="right">#endif /* HAVE_SYS_EPOLL_H */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_SYS_POLL_H</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/poll.h&gt;</td><td> </td><td class="right">#include &lt;sys/poll.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif /* HAVE_SYS_POLL_H */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef S_SPLINT_S</td><td> </td><td class="right">#ifndef S_SPLINT_S</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_SYS_TIMERFD_H</td><td> </td><td class="right">#ifdef HAVE_SYS_TIMERFD_H</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/timerfd.h&gt;</td><td> </td><td class="right">#include &lt;sys/timerfd.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_SYS_TIMERFD_H */</td><td> </td><td class="right">#endif /* HAVE_SYS_TIMERFD_H */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* S_SPLINT_S */</td><td> </td><td class="right">#endif /* S_SPLINT_S */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;signal.h&gt;</td><td> </td><td class="right">#include &lt;signal.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbdefs.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbdefs.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qblist.h&gt;</td><td> </td><td class="right">#include &lt;qb/qblist.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbarray.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbarray.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 61</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 69</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">enum qb_poll_type {</td><td> </td><td class="right">enum qb_poll_type {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QB_UNKNOWN,</td><td> </td><td class="right">       QB_UNKNOWN,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QB_JOB,</td><td> </td><td class="right">       QB_JOB,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QB_POLL,</td><td> </td><td class="right">       QB_POLL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QB_SIGNAL,</td><td> </td><td class="right">       QB_SIGNAL,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       QB_TIMER,</td><td> </td><td class="right">       QB_TIMER,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">};</td><td> </td><td class="right">};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct qb_poll_entry;</td><td> </td><td class="right">struct qb_poll_entry;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">typedef <span class="delete">int32_t (*qb_poll_add_to_jobs_fn)</span> (struct <span class="delete">qb_loop*</span> l, struct <span class="delete">qb_pol</span></td><td> </td><td class="rblock">typedef <span class="insert">int32_t(*qb_poll_add_to_jobs_fn)</span> (struct <span class="insert">qb_loop *</span> l,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">l_entry*</span> pe);</td><td> </td><td class="rblock">                                         struct <span class="insert">qb_poll_entry *</span> pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct qb_poll_entry {</td><td> </td><td class="right">struct qb_poll_entry {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_item item;</td><td> </td><td class="right">       struct qb_loop_item item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       enum qb_poll_type type;</td><td> </td><td class="right">       enum qb_poll_type type;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_poll_dispatch_fn poll_dispatch_fn;</td><td> </td><td class="right">       qb_loop_poll_dispatch_fn poll_dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_timer_dispatch_fn timer_dispatch_fn;</td><td> </td><td class="right">       qb_loop_timer_dispatch_fn timer_dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       enum qb_loop_priority p;</td><td> </td><td class="right">       enum qb_loop_priority p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t install_pos;</td><td> </td><td class="right">       uint32_t install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct pollfd ufd;</td><td> </td><td class="right">       struct pollfd ufd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_poll_add_to_jobs_fn add_to_jobs;</td><td> </td><td class="right">       qb_poll_add_to_jobs_fn add_to_jobs;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 90</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 99</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t epollfd;</td><td> </td><td class="right">       int32_t epollfd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct pollfd *ufds;</td><td> </td><td class="right">       struct pollfd *ufds;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t poll_entry_count;</td><td> </td><td class="right">       int32_t poll_entry_count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_array_t *poll_entries;</td><td> </td><td class="right">       qb_array_t *poll_entries;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_poll_low_fds_event_fn low_fds_event_fn;</td><td> </td><td class="right">       qb_loop_poll_low_fds_event_fn low_fds_event_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t not_enough_fds;</td><td> </td><td class="right">       int32_t not_enough_fds;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">};</td><td> </td><td class="right">};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _qb_signal_add_to_jobs_(struct <span class="delete">qb_loop* l,</span></td><td> </td><td class="rblock">static int32_t _qb_signal_add_to_jobs_(struct <span class="insert">qb_loop *l,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                      struct <span class="delete">qb_poll_entry* pe);</span></td><td> </td><td class="rblock">                                      struct <span class="insert">qb_poll_entry *pe);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _poll_to_epoll_event_(int32_t event)</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_poll_to_epoll_event_(int32_t event)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t out = 0;</td><td> </td><td class="right">       int32_t out = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLIN) out |= EPOLLIN;</td><td> </td><td class="rblock">       if (event &amp; POLLIN)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLOUT) out |= EPOLLOUT;</td><td> </td><td class="rblock">               out |= EPOLLIN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLPRI) out |= EPOLLPRI;</td><td> </td><td class="rblock">       if (event &amp; POLLOUT)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLERR) out |= EPOLLERR;</td><td> </td><td class="rblock">               out |= EPOLLOUT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLHUP) out |= EPOLLHUP;</td><td> </td><td class="rblock">       if (event &amp; POLLPRI)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; POLLNVAL) out |= EPOLLERR;</td><td> </td><td class="rblock">               out |= EPOLLPRI;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if (event &amp; POLLERR)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= EPOLLERR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if (event &amp; POLLHUP)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= EPOLLHUP;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if (event &amp; POLLNVAL)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= EPOLLERR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return out;</td><td> </td><td class="right">       return out;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _epoll_to_poll_event_(int32_t event)</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_epoll_to_poll_event_(int32_t event)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t out = 0;</td><td> </td><td class="right">       int32_t out = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; EPOLLIN)   out |= POLLIN;</td><td> </td><td class="rblock">       if (event &amp; EPOLLIN)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; EPOLLOUT)  out |= POLLOUT;</td><td> </td><td class="rblock">               out |= POLLIN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; EPOLLPRI)  out |= POLLPRI;</td><td> </td><td class="rblock">       if (event &amp; EPOLLOUT)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; EPOLLERR)  out |= POLLERR;</td><td> </td><td class="rblock">               out |= POLLOUT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (event &amp; EPOLLHUP)  out |= POLLHUP;</td><td> </td><td class="rblock">       if (event &amp; EPOLLPRI)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= POLLPRI;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if (event &amp; EPOLLERR)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= POLLERR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if (event &amp; EPOLLHUP)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               out |= POLLHUP;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return out;</td><td> </td><td class="right">       return out;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _poll_entry_check_generate_(struct qb_poll_entry *pe)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_poll_entry_check_generate_(struct qb_poll_entry *pe)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; 200; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; 200; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;check = random();</td><td> </td><td class="right">               pe-&gt;check = random();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;check != 0 &amp;&amp; pe-&gt;check != 0xffffffff) {</td><td> </td><td class="right">               if (pe-&gt;check != 0 &amp;&amp; pe-&gt;check != 0xffffffff) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       break;</td><td> </td><td class="right">                       break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#if defined(HAVE_TIMERFD) || defined(HAVE_EPOLL)</td><td> </td><td class="right">#if defined(HAVE_TIMERFD) || defined(HAVE_EPOLL)</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _poll_entry_from_handle_(struct qb_poll_source *s,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                       uint64_t handle_in,</td><td> </td><td class="rblock">_poll_entry_from_handle_(struct qb_poll_source *s,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                       struct qb_poll_entry **pe_pt)</td><td> </td><td class="rblock">                        uint64_t handle_in, struct qb_poll_entry **pe_pt)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t check = ((uint32_t) (((uint64_t) handle_in) &gt;&gt; 32));</td><td> </td><td class="right">       uint32_t check = ((uint32_t) (((uint64_t) handle_in) &gt;&gt; 32));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t handle = handle_in &amp; 0xffffffff;</td><td> </td><td class="right">       uint32_t handle = handle_in &amp; 0xffffffff;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       res = qb_array_index(s-&gt;poll_entries, handle, (void**)&amp;pe);</td><td> </td><td class="rblock">       res = qb_array_index(s-&gt;poll_entries, handle, (void<span class="insert"> </span>**)&amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;check != check) {</td><td> </td><td class="right">       if (pe-&gt;check != check) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       *pe_pt = pe;</td><td> </td><td class="right">       *pe_pt = pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_TIMERFD or HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_TIMERFD or HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _poll_entry_mark_deleted_(struct qb_poll_entry *pe)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_poll_entry_mark_deleted_(struct qb_poll_entry *pe)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.fd = -1;</td><td> </td><td class="right">       pe-&gt;ufd.fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;state = QB_POLL_ENTRY_DELETED;</td><td> </td><td class="right">       pe-&gt;state = QB_POLL_ENTRY_DELETED;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;check = 0;</td><td> </td><td class="right">       pe-&gt;check = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _poll_entry_empty_(struct qb_poll_entry *pe)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_poll_entry_empty_(struct qb_poll_entry *pe)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memset(pe, 0, sizeof(struct qb_poll_entry));</td><td> </td><td class="right">       memset(pe, 0, sizeof(struct qb_poll_entry));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.fd = -1;</td><td> </td><td class="right">       pe-&gt;ufd.fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _poll_dispatch_and_take_back_(struct qb_loop_item <span class="delete">* item,</span></td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                         enum qb_loop_priority p)</td><td> </td><td class="rblock">_poll_dispatch_and_take_back_(struct qb_loop_item <span class="insert">*item,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                             enum qb_loop_priority p)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe = (struct qb_poll_entry *)item;</td><td> </td><td class="right">       struct qb_poll_entry *pe = (struct qb_poll_entry *)item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_DISPATCH_TIME</td><td> </td><td class="right">#ifdef DEBUG_DISPATCH_TIME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint64_t start;</td><td> </td><td class="right">       uint64_t start;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint64_t stop;</td><td> </td><td class="right">       uint64_t stop;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t log_warn = QB_FALSE;</td><td> </td><td class="right">       int32_t log_warn = QB_FALSE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       start = qb_util_nano_current_get();</td><td> </td><td class="right">       start = qb_util_nano_current_get();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* DEBUG_DISPATCH_TIME */</td><td> </td><td class="right">#endif /* DEBUG_DISPATCH_TIME */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       assert(pe-&gt;state == QB_POLL_ENTRY_JOBLIST);</td><td> </td><td class="right">       assert(pe-&gt;state == QB_POLL_ENTRY_JOBLIST);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;type == QB_POLL) {</td><td> </td><td class="right">       if (pe-&gt;type == QB_POLL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               res = pe-&gt;poll_dispatch_fn(pe-&gt;ufd.fd, pe-&gt;ufd.revents, <span class="delete">pe-&gt;</span></td><td> </td><td class="rblock">               res = pe-&gt;poll_dispatch_fn(pe-&gt;ufd.fd,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">item.user_data);</span></td><td> </td><td class="rblock">                                          pe-&gt;ufd.revents,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                          <span class="insert">pe-&gt;item.user_data);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res &lt; 0) {</td><td> </td><td class="right">               if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       _poll_entry_mark_deleted_(pe);</td><td> </td><td class="right">                       _poll_entry_mark_deleted_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;state = QB_POLL_ENTRY_ACTIVE;</td><td> </td><td class="right">                       pe-&gt;state = QB_POLL_ENTRY_ACTIVE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;ufd.revents = 0;</td><td> </td><td class="right">                       pe-&gt;ufd.revents = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (pe-&gt;type == QB_TIMER) {</td><td> </td><td class="right">       } else if (pe-&gt;type == QB_TIMER) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               _poll_entry_mark_deleted_(pe);</td><td> </td><td class="right">               _poll_entry_mark_deleted_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;timer_dispatch_fn(pe-&gt;item.user_data);</td><td> </td><td class="right">               pe-&gt;timer_dispatch_fn(pe-&gt;item.user_data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_log(LOG_WARNING, "poll entry of unknown type:%d <span class="delete">stat</span></td><td> </td><td class="rblock">               qb_util_log(LOG_WARNING,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">e:%d",</span></td><td> </td><td class="rblock">                           "poll entry of unknown type:%d <span class="insert">state:%d", pe-&gt;ty</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           pe-&gt;type,</span> pe-&gt;state);</td><td> </td><td class="rblock"><span class="insert">pe,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                           pe-&gt;state);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;state == QB_POLL_ENTRY_ACTIVE) {</td><td> </td><td class="right">       if (pe-&gt;state == QB_POLL_ENTRY_ACTIVE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef DEBUG_DISPATCH_TIME</td><td> </td><td class="right">#ifdef DEBUG_DISPATCH_TIME</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;runs++;</td><td> </td><td class="right">               pe-&gt;runs++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if ((pe-&gt;runs % 50) == 0) {</td><td> </td><td class="right">               if ((pe-&gt;runs % 50) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       log_warn = QB_TRUE;</td><td> </td><td class="right">                       log_warn = QB_TRUE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               stop = qb_util_nano_current_get();</td><td> </td><td class="right">               stop = qb_util_nano_current_get();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if ((stop - start) &gt; (10 * QB_TIME_NS_IN_MSEC)) {</td><td> </td><td class="right">               if ((stop - start) &gt; (10 * QB_TIME_NS_IN_MSEC)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       log_warn = QB_TRUE;</td><td> </td><td class="right">                       log_warn = QB_TRUE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (log_warn &amp;&amp; pe-&gt;type == QB_POLL) {</td><td> </td><td class="right">               if (log_warn &amp;&amp; pe-&gt;type == QB_POLL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_util_log(LOG_INFO,</td><td> </td><td class="right">                       qb_util_log(LOG_INFO,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   "[fd:%d] dispatch:%p runs:%d duration:%d
 ms",</td><td> </td><td class="right">                                   "[fd:%d] dispatch:%p runs:%d duration:%d
 ms",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   pe-&gt;ufd.fd, pe-&gt;poll_dispatch_fn,</td><td> </td><td class="right">                                   pe-&gt;ufd.fd, pe-&gt;poll_dispatch_fn,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   pe-&gt;runs,</td><td> </td><td class="right">                                   pe-&gt;runs,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   <span class="delete">(int32_t)((stop</span> - <span class="delete">start)/QB_TIME_NS_IN_M</span></td><td> </td><td class="rblock">                                   <span class="insert">(int32_t) ((stop</span> -</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SEC));</span></td><td> </td><td class="rblock">                                               <span class="insert">start) / QB_TIME_NS_IN_MSEC)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else if (log_warn &amp;&amp; pe-&gt;type == QB_TIMER) {</td><td> </td><td class="right">               } else if (log_warn &amp;&amp; pe-&gt;type == QB_TIMER) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_util_log(LOG_INFO,</td><td> </td><td class="right">                       qb_util_log(LOG_INFO,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   "[timer] dispatch:%p runs:%d duration:%d
 ms",</td><td> </td><td class="right">                                   "[timer] dispatch:%p runs:%d duration:%d
 ms",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   pe-&gt;timer_dispatch_fn,</td><td> </td><td class="right">                                   pe-&gt;timer_dispatch_fn,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   pe-&gt;runs,</td><td> </td><td class="right">                                   pe-&gt;runs,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   <span class="delete">(int32_t)((stop</span> - <span class="delete">start)/QB_TIME_NS_IN_M</span></td><td> </td><td class="rblock">                                   <span class="insert">(int32_t) ((stop</span> -</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">SEC));</span></td><td> </td><td class="rblock">                                               <span class="insert">start) / QB_TIME_NS_IN_MSEC)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* DEBUG_DISPATCH_TIME */</td><td> </td><td class="right">#endif /* DEBUG_DISPATCH_TIME */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _poll_fds_usage_check_(struct qb_poll_source *s)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_poll_fds_usage_check_(struct qb_poll_source *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct rlimit lim;</td><td> </td><td class="right">       struct rlimit lim;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       static int32_t socks_limit = 0;</td><td> </td><td class="right">       static int32_t socks_limit = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t send_event = 0;</td><td> </td><td class="right">       int32_t send_event = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t socks_used = 0;</td><td> </td><td class="right">       int32_t socks_used = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t socks_avail = 0;</td><td> </td><td class="right">       int32_t socks_avail = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_entry *<span class="delete"> </span>pe;</td><td> </td><td class="rblock">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (socks_limit == 0) {</td><td> </td><td class="right">       if (socks_limit == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (getrlimit(RLIMIT_NOFILE, &amp;lim) == -1) {</td><td> </td><td class="right">               if (getrlimit(RLIMIT_NOFILE, &amp;lim) == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">char error_str[100];</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_WARNING, "getrlimit");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       strerror_r(errno, error_str, 100);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                       printf("getrlimit: %s\n", error_str);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return;</td><td> </td><td class="right">                       return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               socks_limit = lim.rlim_cur;</td><td> </td><td class="right">               socks_limit = lim.rlim_cur;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               socks_limit -= POLL_FDS_USED_MISC;</td><td> </td><td class="right">               socks_limit -= POLL_FDS_USED_MISC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (socks_limit &lt; 0) {</td><td> </td><td class="right">               if (socks_limit &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       socks_limit = 0;</td><td> </td><td class="right">                       socks_limit = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="delete">**)&amp;pe) == 0)
</span>;</td><td> </td><td class="rblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="insert"> **)&amp;pe) == 0
)</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if ((pe-&gt;state == QB_POLL_ENTRY_ACTIVE ||</td><td> </td><td class="right">               if ((pe-&gt;state == QB_POLL_ENTRY_ACTIVE ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                    pe-&gt;state == QB_POLL_ENTRY_JOBLIST) &amp;&amp;</td><td> </td><td class="rblock">                    pe-&gt;state == QB_POLL_ENTRY_JOBLIST) &amp;&amp; pe-&gt;ufd.fd != <span class="insert">-1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                   pe-&gt;ufd.fd != <span class="delete">-1)</span> {</td><td> </td><td class="rblock"><span class="insert">)</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       socks_used++;</td><td> </td><td class="right">                       socks_used++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED) {</td><td> </td><td class="right">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       _poll_entry_empty_(pe);</td><td> </td><td class="right">                       _poll_entry_empty_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       socks_avail = socks_limit - socks_used;</td><td> </td><td class="right">       socks_avail = socks_limit - socks_used;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (socks_avail &lt; 0) {</td><td> </td><td class="right">       if (socks_avail &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               socks_avail = 0;</td><td> </td><td class="right">               socks_avail = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 278</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 307</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       s-&gt;not_enough_fds = 0;</td><td> </td><td class="right">                       s-&gt;not_enough_fds = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       send_event = 1;</td><td> </td><td class="right">                       send_event = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (socks_avail &lt;= 1) {</td><td> </td><td class="right">               if (socks_avail &lt;= 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       s-&gt;not_enough_fds = 1;</td><td> </td><td class="right">                       s-&gt;not_enough_fds = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       send_event = 1;</td><td> </td><td class="right">                       send_event = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (send_event &amp;&amp; s-&gt;low_fds_event_fn) {</td><td> </td><td class="right">       if (send_event &amp;&amp; s-&gt;low_fds_event_fn) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               s-&gt;low_fds_event_fn(s-&gt;not_enough_fds,</td><td> </td><td class="rblock">               s-&gt;low_fds_event_fn(s-&gt;not_enough_fds, socks_avail);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   socks_avail);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define MAX_EVENTS 12</td><td> </td><td class="right">#define MAX_EVENTS 12</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _poll_and_add_to_jobs_(struct <span class="delete">qb_loop_source* src,</span> int32_t <span class="delete">m</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">s_timeout)</span></td><td> </td><td class="rblock">_poll_and_add_to_jobs_(struct <span class="insert">qb_loop_source *src,</span> int32_t <span class="insert">ms_timeout)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t event_count;</td><td> </td><td class="right">       int32_t event_count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t new_jobs = 0;</td><td> </td><td class="right">       int32_t new_jobs = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_entry <span class="delete">* pe</span> = NULL;</td><td> </td><td class="rblock">       struct qb_poll_entry <span class="insert">*pe</span> = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source <span class="delete">* s</span> = (struct qb_poll_source *)src;</td><td> </td><td class="rblock">       struct qb_poll_source <span class="insert">*s</span> = (struct qb_poll_source *)src;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct epoll_event events[MAX_EVENTS];</td><td> </td><td class="right">       struct epoll_event events[MAX_EVENTS];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       _poll_fds_usage_check_(s);</td><td> </td><td class="right">       _poll_fds_usage_check_(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> </span>retry_poll:</td><td> </td><td class="rblock">retry_poll:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       event_count = epoll_wait(s-&gt;epollfd, events, MAX_EVENTS, ms_timeout)
;</td><td> </td><td class="right">       event_count = epoll_wait(s-&gt;epollfd, events, MAX_EVENTS, ms_timeout)
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (errno == EINTR &amp;&amp; event_count == -1) {</td><td> </td><td class="right">       if (errno == EINTR &amp;&amp; event_count == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto retry_poll;</td><td> </td><td class="right">               goto retry_poll;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (event_count == -1) {</td><td> </td><td class="right">       } else if (event_count == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; event_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; event_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = _poll_entry_from_handle_(s, events[i].data.u64, &amp;pe);</td><td> </td><td class="right">               res = _poll_entry_from_handle_(s, events[i].data.u64, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res != 0) {</td><td> </td><td class="right">               if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       qb_util_log(LOG_WARNING, "can't find poll entry for </td><td> </td><td class="rblock">                       qb_util_log(LOG_WARNING,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">new event.");</td><td> </td><td class="rblock">                                   "can't find poll entry for new event.");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;ufd.fd == -1 || pe-&gt;state == QB_POLL_ENTRY_DELETED) 
{</td><td> </td><td class="right">               if (pe-&gt;ufd.fd == -1 || pe-&gt;state == QB_POLL_ENTRY_DELETED) 
{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       qb_util_log(LOG_WARNING, "can't post new event to a </td><td> </td><td class="rblock">                       qb_util_log(LOG_WARNING,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">deleted <span class="delete">entry.");</span></td><td> </td><td class="rblock">                                   "can't post new event to a deleted <span class="insert">entry</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">.");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * empty/deleted</td><td> </td><td class="right">                        * empty/deleted</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (events[i].events == pe-&gt;ufd.revents ||</td><td> </td><td class="right">               if (events[i].events == pe-&gt;ufd.revents ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   pe-&gt;state == QB_POLL_ENTRY_JOBLIST) {</td><td> </td><td class="right">                   pe-&gt;state == QB_POLL_ENTRY_JOBLIST) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * entry already in the job queue.</td><td> </td><td class="right">                        * entry already in the job queue.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;ufd.revents = _epoll_to_poll_event_(events[i].events);</td><td> </td><td class="right">               pe-&gt;ufd.revents = _epoll_to_poll_event_(events[i].events);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               new_jobs += pe-&gt;add_to_jobs(src-&gt;l, pe);</td><td> </td><td class="right">               new_jobs += pe-&gt;add_to_jobs(src-&gt;l, pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return new_jobs;</td><td> </td><td class="right">       return new_jobs;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _poll_and_add_to_jobs_(struct <span class="delete">qb_loop_source* src,</span> int32_t <span class="delete">m</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">s_timeout)</span></td><td> </td><td class="rblock">_poll_and_add_to_jobs_(struct <span class="insert">qb_loop_source *src,</span> int32_t <span class="insert">ms_timeout)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t new_jobs = 0;</td><td> </td><td class="right">       int32_t new_jobs = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_entry <span class="delete">* pe;</span></td><td> </td><td class="rblock">       struct qb_poll_entry <span class="insert">*pe;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source <span class="delete">* s</span> = (struct qb_poll_source *)src;</td><td> </td><td class="rblock">       struct qb_poll_source <span class="insert">*s</span> = (struct qb_poll_source *)src;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       _poll_fds_usage_check_(s);</td><td> </td><td class="right">       _poll_fds_usage_check_(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="delete">**)&amp;pe) == 0)
</span>;</td><td> </td><td class="rblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="insert"> **)&amp;pe) == 0
)</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memcpy(&amp;s-&gt;ufds[i], &amp;pe-&gt;ufd, sizeof(struct pollfd));</td><td> </td><td class="right">               memcpy(&amp;s-&gt;ufds[i], &amp;pe-&gt;ufd, sizeof(struct pollfd));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> </span>retry_poll:</td><td> </td><td class="rblock">retry_poll:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = poll(s-&gt;ufds, s-&gt;poll_entry_count, ms_timeout);</td><td> </td><td class="right">       res = poll(s-&gt;ufds, s-&gt;poll_entry_count, ms_timeout);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (errno == EINTR &amp;&amp; res == -1) {</td><td> </td><td class="right">       if (errno == EINTR &amp;&amp; res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto retry_poll;</td><td> </td><td class="right">               goto retry_poll;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (res == -1) {</td><td> </td><td class="right">       } else if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (s-&gt;ufds[i].fd == -1 || s-&gt;ufds[i].revents == 0) {</td><td> </td><td class="right">               if (s-&gt;ufds[i].fd == -1 || s-&gt;ufds[i].revents == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * empty entry</td><td> </td><td class="right">                        * empty entry</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="delete">**)&amp;pe) == 0)
</span>;</td><td> </td><td class="rblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="insert"> **)&amp;pe) == 0
)</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state != QB_POLL_ENTRY_ACTIVE ||</td><td> </td><td class="right">               if (pe-&gt;state != QB_POLL_ENTRY_ACTIVE ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   s-&gt;ufds[i].revents == pe-&gt;ufd.revents) {</td><td> </td><td class="right">                   s-&gt;ufds[i].revents == pe-&gt;ufd.revents) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       /*</td><td> </td><td class="right">                       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        * Wrong state to accept an event.</td><td> </td><td class="right">                        * Wrong state to accept an event.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                        */</td><td> </td><td class="right">                        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;ufd.revents = s-&gt;ufds[i].revents;</td><td> </td><td class="right">               pe-&gt;ufd.revents = s-&gt;ufds[i].revents;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               new_jobs += pe-&gt;add_to_jobs(src-&gt;l, pe);</td><td> </td><td class="right">               new_jobs += pe-&gt;add_to_jobs(src-&gt;l, pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return new_jobs;</td><td> </td><td class="right">       return new_jobs;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">struct qb_loop_source*</td><td> </td><td class="rblock">struct qb_loop_source<span class="insert"> </span>*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">qb_loop_poll_create(struct qb_loop *l)</td><td> </td><td class="right">qb_loop_poll_create(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_source *s = malloc(sizeof(struct qb_poll_source));</td><td> </td><td class="right">       struct qb_poll_source *s = malloc(sizeof(struct qb_poll_source));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (s == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.l = l;</td><td> </td><td class="right">       s-&gt;s.l = l;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.dispatch_and_take_back = _poll_dispatch_and_take_back_;</td><td> </td><td class="right">       s-&gt;s.dispatch_and_take_back = _poll_dispatch_and_take_back_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.poll = _poll_and_add_to_jobs_;</td><td> </td><td class="right">       s-&gt;s.poll = _poll_and_add_to_jobs_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_entries = qb_array_create(128, sizeof(struct qb_poll_entry))
;</td><td> </td><td class="right">       s-&gt;poll_entries = qb_array_create(128, sizeof(struct qb_poll_entry))
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;poll_entry_count = 0;</td><td> </td><td class="right">       s-&gt;poll_entry_count = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;low_fds_event_fn = NULL;</td><td> </td><td class="right">       s-&gt;low_fds_event_fn = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;not_enough_fds = 0;</td><td> </td><td class="right">       s-&gt;not_enough_fds = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;epollfd = epoll_create1(EPOLL_CLOEXEC);</td><td> </td><td class="right">       s-&gt;epollfd = epoll_create1(EPOLL_CLOEXEC);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;ufds = 0;</td><td> </td><td class="right">       s-&gt;ufds = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       return (struct qb_loop_source*)s;</td><td> </td><td class="rblock">       return (struct qb_loop_source<span class="insert"> </span>*)s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_loop_poll_destroy(struct qb_loop *l)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_loop_poll_destroy(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source *<span class="delete"> </span>s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="rblock">       struct qb_poll_source *s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_array_free(s-&gt;poll_entries);</td><td> </td><td class="right">       qb_array_free(s-&gt;poll_entries);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (s-&gt;epollfd != -1) {</td><td> </td><td class="right">       if (s-&gt;epollfd != -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               close(s-&gt;epollfd);</td><td> </td><td class="right">               close(s-&gt;epollfd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;epollfd = -1;</td><td> </td><td class="right">               s-&gt;epollfd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(s);</td><td> </td><td class="right">       free(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_poll_low_fds_event_set(struct qb_loop *l,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                      qb_loop_poll_low_fds_event_fn fn)</td><td> </td><td class="rblock">qb_loop_poll_low_fds_event_set(struct qb_loop *l,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                              qb_loop_poll_low_fds_event_fn fn)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source *<span class="delete"> </span>s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="rblock">       struct qb_poll_source *s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;low_fds_event_fn = fn;</td><td> </td><td class="right">       s-&gt;low_fds_event_fn = fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _get_empty_array_position_(struct qb_poll_source <span class="delete">* s)</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_get_empty_array_position_(struct qb_poll_source <span class="insert">*s)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t found = 0;</td><td> </td><td class="right">       int32_t found = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t install_pos;</td><td> </td><td class="right">       uint32_t install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef HAVE_EPOLL</td><td> </td><td class="right">#ifndef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct pollfd *ufds;</td><td> </td><td class="right">       struct pollfd *ufds;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t new_size = 0;</td><td> </td><td class="right">       int32_t new_size = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (found = 0, install_pos = 0;</td><td> </td><td class="right">       for (found = 0, install_pos = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">            install_pos &lt; s-&gt;poll_entry_count; install_pos++) {</td><td> </td><td class="right">            install_pos &lt; s-&gt;poll_entry_count; install_pos++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">assert(qb_array_index(s-&gt;poll_entries,</span> install_pos, <span class="delete">(void**)</span></td><td> </td><td class="rblock">               <span class="insert">assert(qb_array_index</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">&amp;pe)</span> == 0);</td><td> </td><td class="rblock"><span class="insert">                      (s-&gt;poll_entries,</span> install_pos, <span class="insert">(void **)&amp;pe)</span> == 0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state == QB_POLL_ENTRY_EMPTY) {</td><td> </td><td class="right">               if (pe-&gt;state == QB_POLL_ENTRY_EMPTY) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       found = 1;</td><td> </td><td class="right">                       found = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       break;</td><td> </td><td class="right">                       break;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (found == 0) {</td><td> </td><td class="right">       if (found == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               /*</td><td> </td><td class="right">               /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                * Grow pollfd list</td><td> </td><td class="right">                * Grow pollfd list</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                */</td><td> </td><td class="right">                */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               res = qb_array_grow(s-&gt;poll_entries,</td><td> </td><td class="rblock">               res = qb_array_grow(s-&gt;poll_entries, s-&gt;poll_entry_count + <span class="insert">1</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   s-&gt;poll_entry_count + <span class="delete">1);</span></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res != 0) {</td><td> </td><td class="right">               if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return res;</td><td> </td><td class="right">                       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                                                           </span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef HAVE_EPOLL</td><td> </td><td class="right">#ifndef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               new_size = (s-&gt;poll_entry_count<span class="delete">+ 1) * sizeof(struct pollfd)</span>;</td><td> </td><td class="rblock">               new_size = (s-&gt;poll_entry_count<span class="insert"> + 1) * sizeof(struct pollfd)
</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               ufds = realloc(s-&gt;ufds, new_size);</td><td> </td><td class="right">               ufds = realloc(s-&gt;ufds, new_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (ufds == NULL) {</td><td> </td><td class="right">               if (ufds == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return -ENOMEM;</td><td> </td><td class="right">                       return -ENOMEM;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds = ufds;</td><td> </td><td class="right">               s-&gt;ufds = ufds;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;poll_entry_count += 1;</td><td> </td><td class="right">               s-&gt;poll_entry_count += 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               install_pos = s-&gt;poll_entry_count - 1;</td><td> </td><td class="right">               install_pos = s-&gt;poll_entry_count - 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return install_pos;</td><td> </td><td class="right">       return install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _poll_add_(struct qb_loop *l,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         enum qb_loop_priority p,</td><td> </td><td class="rblock">_poll_add_(struct qb_loop *l,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         int32_t fd,</td><td> </td><td class="rblock">          enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         int32_t events,</td><td> </td><td class="rblock">          int32_t fd, int32_t events, void *data, struct qb_poll_entry <span class="insert">**pe</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         void *data,</td><td> </td><td class="rblock"><span class="insert">_pt)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         struct qb_poll_entry <span class="delete">**pe_pt)</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t install_pos;</td><td> </td><td class="right">       uint32_t install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source *<span class="delete"> </span>s;</td><td> </td><td class="rblock">       struct qb_poll_source *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct epoll_event ev;</td><td> </td><td class="right">       struct epoll_event ev;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL) {</td><td> </td><td class="right">       if (l == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="right">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       install_pos = _get_empty_array_position_(s);</td><td> </td><td class="right">       install_pos = _get_empty_array_position_(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       assert(qb_array_index(s-&gt;poll_entries, install_pos, (void<span class="delete">**)&amp;pe) == 
</span>0);</td><td> </td><td class="rblock">       assert(qb_array_index(s-&gt;poll_entries, install_pos, (void<span class="insert"> **)&amp;pe) ==
 </span>0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;state = QB_POLL_ENTRY_ACTIVE;</td><td> </td><td class="right">       pe-&gt;state = QB_POLL_ENTRY_ACTIVE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;install_pos = install_pos;</td><td> </td><td class="right">       pe-&gt;install_pos = install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       _poll_entry_check_generate_(pe);</td><td> </td><td class="right">       _poll_entry_check_generate_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.fd = fd;</td><td> </td><td class="right">       pe-&gt;ufd.fd = fd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.events = events;</td><td> </td><td class="right">       pe-&gt;ufd.events = events;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.revents = 0;</td><td> </td><td class="right">       pe-&gt;ufd.revents = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;item.user_data = data;</td><td> </td><td class="right">       pe-&gt;item.user_data = data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       pe-&gt;item.source = (struct qb_loop_source*)l-&gt;fd_source;</td><td> </td><td class="rblock">       pe-&gt;item.source = (struct qb_loop_source<span class="insert"> </span>*)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;p = p;</td><td> </td><td class="right">       pe-&gt;p = p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;runs = 0;</td><td> </td><td class="right">       pe-&gt;runs = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ev.events = _poll_to_epoll_event_(events);</td><td> </td><td class="right">       ev.events = _poll_to_epoll_event_(events);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ev.data.u64 = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | pe-&gt;install_pos;</td><td> </td><td class="right">       ev.data.u64 = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | pe-&gt;install_pos;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_ADD, fd, &amp;ev) == -1) {</td><td> </td><td class="right">       if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_ADD, fd, &amp;ev) == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_<span class="delete">log(LOG_ERR, "epoll_ctl(add) : %s", strerror(-res)</span>);</td><td> </td><td class="rblock">               qb_util_<span class="insert">perror(LOG_ERR, "epoll_ctl(add)"</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       *pe_pt = pe;</td><td> </td><td class="right">       *pe_pt = pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (res);</td><td> </td><td class="right">       return (res);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _qb_poll_add_to_jobs_(struct <span class="delete">qb_loop* l,</span> struct <span class="delete">qb_poll_entr</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">y* pe)</span></td><td> </td><td class="rblock">_qb_poll_add_to_jobs_(struct <span class="insert">qb_loop *l,</span> struct <span class="insert">qb_poll_entry *pe)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       assert(pe-&gt;type == QB_POLL);</td><td> </td><td class="right">       assert(pe-&gt;type == QB_POLL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td> </td><td class="right">       qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;state = QB_POLL_ENTRY_JOBLIST;</td><td> </td><td class="right">       pe-&gt;state = QB_POLL_ENTRY_JOBLIST;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 1;</td><td> </td><td class="right">       return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_poll_add(struct qb_loop <span class="delete">*l,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        enum qb_loop_priority p,</td><td> </td><td class="rblock">qb_loop_poll_add(struct qb_loop <span class="insert">* l,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        int32_t fd,</td><td> </td><td class="rblock">                enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        int32_t events,</td><td> </td><td class="rblock">                int32_t fd,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        void *data,</td><td> </td><td class="rblock">                int32_t events,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        qb_loop_poll_dispatch_fn dispatch_fn)</td><td> </td><td class="rblock">                void *data, qb_loop_poll_dispatch_fn dispatch_fn)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe = NULL;</td><td> </td><td class="right">       struct qb_poll_entry *pe = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t size;</td><td> </td><td class="right">       int32_t size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t new_size;</td><td> </td><td class="right">       int32_t new_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count;</td><td> </td><td class="right">       size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = _poll_add_(l, p, fd, events, data, &amp;pe);</td><td> </td><td class="right">       res = _poll_add_(l, p, fd, events, data, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       new_size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count
;</td><td> </td><td class="right">       new_size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;poll_dispatch_fn = dispatch_fn;</td><td> </td><td class="right">       pe-&gt;poll_dispatch_fn = dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;type = QB_POLL;</td><td> </td><td class="right">       pe-&gt;type = QB_POLL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;add_to_jobs = _qb_poll_add_to_jobs_;</td><td> </td><td class="right">       pe-&gt;add_to_jobs = _qb_poll_add_to_jobs_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (new_size &gt; size) {</td><td> </td><td class="right">       if (new_size &gt; size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_DEBUG,</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_log(LOG_TRACE,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           "grown poll array to %d for FD %d",</td><td> </td><td class="rblock">                           "grown poll array to %d for FD %d", new_size, <span class="insert">fd</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           new_size, <span class="delete">fd);</span></td><td> </td><td class="rblock"><span class="insert">);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_poll_mod(struct qb_loop <span class="delete">*l,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        enum qb_loop_priority p,</td><td> </td><td class="rblock">qb_loop_poll_mod(struct qb_loop <span class="insert">* l,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        int32_t fd,</td><td> </td><td class="rblock">                enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        int32_t events,</td><td> </td><td class="rblock">                int32_t fd,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        void *data,</td><td> </td><td class="rblock">                int32_t events,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                        qb_loop_poll_dispatch_fn dispatch_fn)</td><td> </td><td class="rblock">                void *data, qb_loop_poll_dispatch_fn dispatch_fn)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t i;</td><td> </td><td class="right">       uint32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source *<span class="delete"> </span>s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="rblock">       struct qb_poll_source *s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct epoll_event ev;</td><td> </td><td class="right">       struct epoll_event ev;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * Find file descriptor to modify events and dispatch function</td><td> </td><td class="right">        * Find file descriptor to modify events and dispatch function</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="delete">**)&amp;pe) == 0)
</span>;</td><td> </td><td class="rblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="insert"> **)&amp;pe) == 0
)</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;ufd.fd != fd) {</td><td> </td><td class="right">               if (pe-&gt;ufd.fd != fd) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED || pe-&gt;check == 0) {</td><td> </td><td class="right">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED || pe-&gt;check == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_util_log(LOG_ERR,</td><td> </td><td class="right">                       qb_util_log(LOG_ERR,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                                   "poll_mod : can't modify entry already d
eleted");</td><td> </td><td class="right">                                   "poll_mod : can't modify entry already d
eleted");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return -EBADF;</td><td> </td><td class="right">                       return -EBADF;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;poll_dispatch_fn = dispatch_fn;</td><td> </td><td class="right">               pe-&gt;poll_dispatch_fn = dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;item.user_data = data;</td><td> </td><td class="right">               pe-&gt;item.user_data = data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pe-&gt;p = p;</td><td> </td><td class="right">               pe-&gt;p = p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;ufd.events != events) {</td><td> </td><td class="right">               if (pe-&gt;ufd.events != events) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       ev.events = _poll_to_epoll_event_(events);</td><td> </td><td class="right">                       ev.events = _poll_to_epoll_event_(events);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       ev.data.u64 = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | i;</td><td> </td><td class="right">                       ev.data.u64 = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_MOD, fd, &amp;ev) ==
 -1) {</td><td> </td><td class="right">                       if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_MOD, fd, &amp;ev) ==
 -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               res = -errno;</td><td> </td><td class="right">                               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               qb_util_<span class="delete">log(LOG_ERR, "epoll_ctl(mod) : %s", 
strerror(-res)</span>);</td><td> </td><td class="rblock">                               qb_util_<span class="insert">perror(LOG_ERR, "epoll_ctl(mod)"</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;ufd.events = events;</td><td> </td><td class="right">                       pe-&gt;ufd.events = events;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return -EBADF;</td><td> </td><td class="right">       return -EBADF;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_poll_del(struct qb_loop <span class="delete">*l,</span> int32_t fd)</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_loop_poll_del(struct qb_loop <span class="insert">* l,</span> int32_t fd)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_poll_source *<span class="delete"> </span>s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="rblock">       struct qb_poll_source *s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; s-&gt;poll_entry_count; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="delete">**)&amp;pe) == 0)
</span>;</td><td> </td><td class="rblock">               assert(qb_array_index(s-&gt;poll_entries, i, (void<span class="insert"> **)&amp;pe) == 0
)</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;ufd.fd != fd || pe-&gt;type != QB_POLL) {</td><td> </td><td class="right">               if (pe-&gt;ufd.fd != fd || pe-&gt;type != QB_POLL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       continue;</td><td> </td><td class="right">                       continue;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED ||</td><td> </td><td class="right">               if (pe-&gt;state == QB_POLL_ENTRY_DELETED ||</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   pe-&gt;state == QB_POLL_ENTRY_EMPTY) {</td><td> </td><td class="right">                   pe-&gt;state == QB_POLL_ENTRY_EMPTY) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return 0;</td><td> </td><td class="right">                       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (pe-&gt;state == QB_POLL_ENTRY_JOBLIST) {</td><td> </td><td class="right">               if (pe-&gt;state == QB_POLL_ENTRY_JOBLIST) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_loop_level_item_del(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td> </td><td class="right">                       qb_loop_level_item_del(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_DEL, fd, NULL) == -1) {</td><td> </td><td class="right">               if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_DEL, fd, NULL) == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = -errno;</td><td> </td><td class="right">                       res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR, "epoll_ctl(del) : %s",</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_WARNING, "epoll_ctl(del)");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                   strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[i].fd = -1;</td><td> </td><td class="right">               s-&gt;ufds[i].fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[i].events = 0;</td><td> </td><td class="right">               s-&gt;ufds[i].events = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[i].revents = 0;</td><td> </td><td class="right">               s-&gt;ufds[i].revents = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               _poll_entry_mark_deleted_(pe);</td><td> </td><td class="right">               _poll_entry_mark_deleted_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return -EBADF;</td><td> </td><td class="right">       return -EBADF;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_TIMERFD</td><td> </td><td class="right">#ifdef HAVE_TIMERFD</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _qb_timer_add_to_jobs_(struct <span class="delete">qb_loop* l,</span> struct <span class="delete">qb_poll_ent</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ry* pe)</span></td><td> </td><td class="rblock">_qb_timer_add_to_jobs_(struct <span class="insert">qb_loop *l,</span> struct <span class="insert">qb_poll_entry *pe)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint64_t expired = 0;</td><td> </td><td class="right">       uint64_t expired = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t bytes = 0;</td><td> </td><td class="right">       ssize_t bytes = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       assert(pe-&gt;type == QB_TIMER);</td><td> </td><td class="right">       assert(pe-&gt;type == QB_TIMER);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;ufd.revents == POLLIN) {</td><td> </td><td class="right">       if (pe-&gt;ufd.revents == POLLIN) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               bytes = read(pe-&gt;ufd.fd, &amp;expired, sizeof(expired));</td><td> </td><td class="right">               bytes = read(pe-&gt;ufd.fd, &amp;expired, sizeof(expired));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (bytes != sizeof(expired)) {</td><td> </td><td class="right">               if (bytes != sizeof(expired)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_WARNING,</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_WARNING,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               "couldn't read from timer fd <span class="delete">%zd %s",</span></td><td> </td><td class="rblock">                                      "couldn't read from timer fd <span class="insert">%zd",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                               bytes, strerror(errno));</span></td><td> </td><td class="rblock"><span class="insert">                                      bytes);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td> </td><td class="right">               qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p], &amp;pe-&gt;item);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "timer revents: %d expected %d",</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "timer revents: %d expected %d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           pe-&gt;ufd.revents, POLLIN);</td><td> </td><td class="right">                           pe-&gt;ufd.revents, POLLIN);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(pe-&gt;ufd.fd);</td><td> </td><td class="right">       close(pe-&gt;ufd.fd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.fd = -1;</td><td> </td><td class="right">       pe-&gt;ufd.fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;state = QB_POLL_ENTRY_JOBLIST;</td><td> </td><td class="right">       pe-&gt;state = QB_POLL_ENTRY_JOBLIST;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 1;</td><td> </td><td class="right">       return 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_timer_msec_duration_to_expire(struct qb_loop_source <span class="delete">*timer_</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">source)</span></td><td> </td><td class="rblock">qb_loop_timer_msec_duration_to_expire(struct qb_loop_source <span class="insert">* timer_source)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return -1;</td><td> </td><td class="right">       return -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">struct qb_loop_source*</td><td> </td><td class="rblock">struct qb_loop_source<span class="insert"> </span>*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">qb_loop_timer_create(struct qb_loop *l)</td><td> </td><td class="right">qb_loop_timer_create(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return NULL;</td><td> </td><td class="right">       return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0070" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_loop_timer_destroy(struct qb_loop *l)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_loop_timer_destroy(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0071" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_timer_add(struct qb_loop *l,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         enum qb_loop_priority p,</td><td> </td><td class="rblock">qb_loop_timer_add(struct qb_loop *l,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         uint64_t nsec_duration,</td><td> </td><td class="rblock">                 enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         void *data,</td><td> </td><td class="rblock">                 uint64_t nsec_duration,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         qb_loop_timer_dispatch_fn timer_fn,</td><td> </td><td class="rblock">                 void *data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                         qb_loop_timer_handle * timer_handle_out)</td><td> </td><td class="rblock">                 qb_loop_timer_dispatch_fn timer_fn,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                 qb_loop_timer_handle * timer_handle_out)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t fd;</td><td> </td><td class="right">       int32_t fd;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t size, new_size;</td><td> </td><td class="right">       int32_t size, new_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct itimerspec its;</td><td> </td><td class="right">       struct itimerspec its;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL || timer_fn == NULL) {</td><td> </td><td class="right">       if (l == NULL || timer_fn == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR,</td><td> </td><td class="right">               qb_util_log(LOG_ERR,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           "can't add a timer with either (l == NULL || tim
er_fn == NULL)");</td><td> </td><td class="right">                           "can't add a timer with either (l == NULL || tim
er_fn == NULL)");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (timer_handle_out == NULL) {</td><td> </td><td class="right">       if (timer_handle_out == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0072" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_log(LOG_ERR, "can't add a timer with <span class="delete">(timer_handle_o</span></td><td> </td><td class="rblock">               qb_util_log(LOG_ERR,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ut</span> == <span class="delete">NULL)");</span></td><td> </td><td class="rblock">                           "can't add a timer with <span class="insert">(timer_handle_out</span> == <span class="insert">NUL</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">L)");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -ENOENT;</td><td> </td><td class="right">               return -ENOENT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0073" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       fd = timerfd_create(CLOCK_MONOTONIC, TFD_CLOEXEC<span class="delete">|</span>TFD_NONBLOCK);</td><td> </td><td class="rblock">       fd = timerfd_create(CLOCK_MONOTONIC, TFD_CLOEXEC<span class="insert"> | </span>TFD_NONBLOCK);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (fd == -1) {</td><td> </td><td class="right">       if (fd == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0074" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "failed to create <span class="delete">timer: %s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "failed to create <span class="insert">timer");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       its.it_interval.tv_sec = 0;</td><td> </td><td class="right">       its.it_interval.tv_sec = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       its.it_interval.tv_nsec = 0;</td><td> </td><td class="right">       its.it_interval.tv_nsec = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       its.it_value.tv_sec = nsec_duration / QB_TIME_NS_IN_SEC;</td><td> </td><td class="right">       its.it_value.tv_sec = nsec_duration / QB_TIME_NS_IN_SEC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       its.it_value.tv_nsec = nsec_duration % QB_TIME_NS_IN_SEC;</td><td> </td><td class="right">       its.it_value.tv_nsec = nsec_duration % QB_TIME_NS_IN_SEC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = timerfd_settime(fd, 0, &amp;its, NULL);</td><td> </td><td class="right">       res = timerfd_settime(fd, 0, &amp;its, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == -1) {</td><td> </td><td class="right">       if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0075" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "failed to set time on <span class="delete">timer: %s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "failed to set time on <span class="insert">timer");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto close_and_return;</td><td> </td><td class="right">               goto close_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count;</td><td> </td><td class="right">       size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = _poll_add_(l, p, fd, POLLIN, data, &amp;pe);</td><td> </td><td class="right">       res = _poll_add_(l, p, fd, POLLIN, data, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto close_and_return;</td><td> </td><td class="right">               goto close_and_return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       new_size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count
;</td><td> </td><td class="right">       new_size = ((struct qb_poll_source *)l-&gt;fd_source)-&gt;poll_entry_count
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (new_size &gt; size) {</td><td> </td><td class="right">       if (new_size &gt; size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0076" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_log(LOG_<span class="delete">DEBUG</span>, "grown poll array to %d for timer %d"
,</td><td> </td><td class="rblock">               qb_util_log(LOG_<span class="insert">TRACE</span>, "grown poll array to %d for timer %d"
,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           new_size, fd);</td><td> </td><td class="right">                           new_size, fd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;timer_dispatch_fn = timer_fn;</td><td> </td><td class="right">       pe-&gt;timer_dispatch_fn = timer_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;type = QB_TIMER;</td><td> </td><td class="right">       pe-&gt;type = QB_TIMER;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;add_to_jobs = _qb_timer_add_to_jobs_;</td><td> </td><td class="right">       pe-&gt;add_to_jobs = _qb_timer_add_to_jobs_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       *timer_handle_out = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | pe-&gt;install_p
os;</td><td> </td><td class="right">       *timer_handle_out = (((uint64_t) (pe-&gt;check)) &lt;&lt; 32) | pe-&gt;install_p
os;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0077" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> </span>close_and_return:</td><td> </td><td class="rblock">close_and_return:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(fd);</td><td> </td><td class="right">       close(fd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0078" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_timer_del(struct qb_loop <span class="delete">*l,</span> qb_loop_timer_handle th)</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_loop_timer_del(struct qb_loop <span class="insert">* l,</span> qb_loop_timer_handle th)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_source *s;</td><td> </td><td class="right">       struct qb_poll_source *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL || th == 0) {</td><td> </td><td class="right">       if (l == NULL || th == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="right">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = _poll_entry_from_handle_(s, th, &amp;pe);</td><td> </td><td class="right">       res = _poll_entry_from_handle_(s, th, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 781</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 820</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_DEBUG, "trying to delete timer in JOBLIST");</td><td> </td><td class="right">               qb_util_log(LOG_DEBUG, "trying to delete timer in JOBLIST");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;state != QB_POLL_ENTRY_ACTIVE &amp;&amp;</td><td> </td><td class="right">       if (pe-&gt;state != QB_POLL_ENTRY_ACTIVE &amp;&amp;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">           pe-&gt;state != QB_POLL_ENTRY_JOBLIST) {</td><td> </td><td class="right">           pe-&gt;state != QB_POLL_ENTRY_JOBLIST) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_WARNING, "trying to delete timer with state:
%d",</td><td> </td><td class="right">               qb_util_log(LOG_WARNING, "trying to delete timer with state:
%d",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           pe-&gt;state);</td><td> </td><td class="right">                           pe-&gt;state);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pe-&gt;ufd.fd != -1) {</td><td> </td><td class="right">       if (pe-&gt;ufd.fd != -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef HAVE_EPOLL</td><td> </td><td class="right">#ifdef HAVE_EPOLL</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0079" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_DEL, pe-&gt;ufd.fd, NULL) =</td><td> </td><td class="rblock">               if (epoll_ctl(s-&gt;epollfd, EPOLL_CTL_DEL, pe-&gt;ufd.fd, NULL) =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">= -1) {</td><td> </td><td class="rblock">=</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                   -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = -errno;</td><td> </td><td class="right">                       res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0080" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR, "epoll_ctl(del:%d) : %s",</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_WARNING, "epoll_ctl(del:%d)",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                   pe-&gt;ufd.fd, strerror(-res));</span></td><td> </td><td class="rblock"><span class="insert">                                      pe-&gt;ufd.fd);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[pe-&gt;install_pos].fd = -1;</td><td> </td><td class="right">               s-&gt;ufds[pe-&gt;install_pos].fd = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[pe-&gt;install_pos].events = 0;</td><td> </td><td class="right">               s-&gt;ufds[pe-&gt;install_pos].events = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               s-&gt;ufds[pe-&gt;install_pos].revents = 0;</td><td> </td><td class="right">               s-&gt;ufds[pe-&gt;install_pos].revents = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_EPOLL */</td><td> </td><td class="right">#endif /* HAVE_EPOLL */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               close(pe-&gt;ufd.fd);</td><td> </td><td class="right">               close(pe-&gt;ufd.fd);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       _poll_entry_mark_deleted_(pe);</td><td> </td><td class="right">       _poll_entry_mark_deleted_(pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0081" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">uint64_t qb_loop_timer_expire_time_get(struct qb_loop <span class="delete">*l, qb_loop_timer_han</span></td><td> </td><td class="rblock">uint64_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">dle</span> th)</td><td> </td><td class="rblock">qb_loop_timer_expire_time_get(struct qb_loop <span class="insert">* l, qb_loop_timer_handle</span> th)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_source *s;</td><td> </td><td class="right">       struct qb_poll_source *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct itimerspec its;</td><td> </td><td class="right">       struct itimerspec its;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL || th == 0) {</td><td> </td><td class="right">       if (l == NULL || th == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return 0;</td><td> </td><td class="right">               return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td> </td><td class="right">       s = (struct qb_poll_source *)l-&gt;fd_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = _poll_entry_from_handle_(s, th, &amp;pe);</td><td> </td><td class="right">       res = _poll_entry_from_handle_(s, th, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0082" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               return <span class="delete">res</span>;</td><td> </td><td class="rblock">               return <span class="insert">0</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (timerfd_gettime(pe-&gt;ufd.fd, &amp;its) == -1) {</td><td> </td><td class="right">       if (timerfd_gettime(pe-&gt;ufd.fd, &amp;its) == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return 0;</td><td> </td><td class="right">               return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (its.it_value.tv_sec * QB_TIME_NS_IN_SEC) + its.it_value.tv_n
sec;</td><td> </td><td class="right">       return (its.it_value.tv_sec * QB_TIME_NS_IN_SEC) + its.it_value.tv_n
sec;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* HAVE_TIMERFD */</td><td> </td><td class="right">#endif /* HAVE_TIMERFD */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0083" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t pipe_fds[2] = {<span class="delete">-1, -1</span>};</td><td> </td><td class="rblock">static int32_t pipe_fds[2] = {<span class="insert"> -1, -1 </span>};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct qb_signal_source {</td><td> </td><td class="right">struct qb_signal_source {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_source s;</td><td> </td><td class="right">       struct qb_loop_source s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_list_head sig_head;</td><td> </td><td class="right">       struct qb_list_head sig_head;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sigset_t signal_superset;</td><td> </td><td class="right">       sigset_t signal_superset;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">};</td><td> </td><td class="right">};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct qb_loop_sig {</td><td> </td><td class="right">struct qb_loop_sig {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_item item;</td><td> </td><td class="right">       struct qb_loop_item item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t signal;</td><td> </td><td class="right">       int32_t signal;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       enum qb_loop_priority p;</td><td> </td><td class="right">       enum qb_loop_priority p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_loop_signal_dispatch_fn dispatch_fn;</td><td> </td><td class="right">       qb_loop_signal_dispatch_fn dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *cloned_from;</td><td> </td><td class="right">       struct qb_loop_sig *cloned_from;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">};</td><td> </td><td class="right">};</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0084" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _handle_real_signal_(int signal_num, siginfo_t * si, void <span class="delete">*cont</span></td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ext)</span></td><td> </td><td class="rblock">_handle_real_signal_(int signal_num, siginfo_t * si, void <span class="insert">*context)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t sig = signal_num;</td><td> </td><td class="right">       int32_t sig = signal_num;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pipe_fds[1] &gt; 0) {</td><td> </td><td class="right">       if (pipe_fds[1] &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0085" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete"> </span>try_again:</td><td> </td><td class="rblock">try_again:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = write(pipe_fds[1], &amp;sig, sizeof(int32_t));</td><td> </td><td class="right">               res = write(pipe_fds[1], &amp;sig, sizeof(int32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == -1 &amp;&amp; errno == EAGAIN) {</td><td> </td><td class="right">               if (res == -1 &amp;&amp; errno == EAGAIN) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       goto try_again;</td><td> </td><td class="right">                       goto try_again;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else if (res != sizeof(int32_t)) {</td><td> </td><td class="right">               } else if (res != sizeof(int32_t)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0086" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       qb_util_log(LOG_ERR, "failed to write signal to pipe</td><td> </td><td class="rblock">                       qb_util_log(LOG_ERR,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> [%d]",</td><td> </td><td class="rblock">                                   "failed to write signal to pipe [%d]", <span class="insert">r</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   <span class="delete">res);</span></td><td> </td><td class="rblock"><span class="insert">es);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0087" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _signal_dispatch_and_take_back_(struct qb_loop_item <span class="delete">* item,</span></td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                           enum qb_loop_priority p)</td><td> </td><td class="rblock">_signal_dispatch_and_take_back_(struct qb_loop_item <span class="insert">*item,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                               enum qb_loop_priority p)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig = (struct qb_loop_sig *)item;</td><td> </td><td class="right">       struct qb_loop_sig *sig = (struct qb_loop_sig *)item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = sig-&gt;dispatch_fn(sig-&gt;signal, sig-&gt;item.user_data);</td><td> </td><td class="right">       res = sig-&gt;dispatch_fn(sig-&gt;signal, sig-&gt;item.user_data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_list_del(&amp;sig-&gt;cloned_from-&gt;item.list);</td><td> </td><td class="right">               qb_list_del(&amp;sig-&gt;cloned_from-&gt;item.list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               free(sig-&gt;cloned_from);</td><td> </td><td class="right">               free(sig-&gt;cloned_from);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(sig);</td><td> </td><td class="right">       free(sig);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct qb_loop_source *</td><td> </td><td class="right">struct qb_loop_source *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">qb_loop_signals_create(struct qb_loop *l)</td><td> </td><td class="right">qb_loop_signals_create(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_poll_entry *pe;</td><td> </td><td class="right">       struct qb_poll_entry *pe;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_signal_source *s = calloc(1, sizeof(struct qb_signal_sourc
e));</td><td> </td><td class="right">       struct qb_signal_source *s = calloc(1, sizeof(struct qb_signal_sourc
e));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0088" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (s == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.l = l;</td><td> </td><td class="right">       s-&gt;s.l = l;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.dispatch_and_take_back = _signal_dispatch_and_take_back_;</td><td> </td><td class="right">       s-&gt;s.dispatch_and_take_back = _signal_dispatch_and_take_back_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;s.poll = NULL;</td><td> </td><td class="right">       s-&gt;s.poll = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_init(&amp;s-&gt;sig_head);</td><td> </td><td class="right">       qb_list_init(&amp;s-&gt;sig_head);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sigemptyset(&amp;s-&gt;signal_superset);</td><td> </td><td class="right">       sigemptyset(&amp;s-&gt;signal_superset);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (pipe_fds[0] &lt; 0) {</td><td> </td><td class="right">       if (pipe_fds[0] &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = pipe(pipe_fds);</td><td> </td><td class="right">               res = pipe(pipe_fds);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == -1) {</td><td> </td><td class="right">               if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       res = -errno;</td><td> </td><td class="right">                       res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0089" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR,</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_ERR,</span> "Can't light <span class="insert">pipe");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   "Can't light <span class="delete">pipe: %s",</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                   strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       goto error_exit;</td><td> </td><td class="right">                       goto error_exit;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0090" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">(void)qb_util_fd_nonblock_cloexec_set(pipe_fds[0]);</span></td><td> </td><td class="rblock">               <span class="insert">(void)qb_sys_fd_nonblock_cloexec_set(pipe_fds[0]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               (void)qb_util_fd_nonblock_cloexec_set(pipe_fds[1]);</span></td><td> </td><td class="rblock"><span class="insert">               (void)qb_sys_fd_nonblock_cloexec_set(pipe_fds[1]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = _poll_add_(l, QB_LOOP_HIGH,</td><td> </td><td class="right">               res = _poll_add_(l, QB_LOOP_HIGH,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0091" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                pipe_fds[0], POLLIN,</td><td> </td><td class="rblock">                                pipe_fds[0], POLLIN, NULL, &amp;pe);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                NULL, &amp;pe);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == 0) {</td><td> </td><td class="right">               if (res == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;poll_dispatch_fn = NULL;</td><td> </td><td class="right">                       pe-&gt;poll_dispatch_fn = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;type = QB_SIGNAL;</td><td> </td><td class="right">                       pe-&gt;type = QB_SIGNAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       pe-&gt;add_to_jobs = _qb_signal_add_to_jobs_;</td><td> </td><td class="right">                       pe-&gt;add_to_jobs = _qb_signal_add_to_jobs_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0092" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR,</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_ERR,</span> "Can't smoke <span class="insert">pipe");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                   "Can't smoke <span class="delete">pipe: %s",</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                   strerror(-res));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       goto error_exit;</td><td> </td><td class="right">                       goto error_exit;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (struct qb_loop_source *)s;</td><td> </td><td class="right">       return (struct qb_loop_source *)s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0093" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> error_exit:</td><td> </td><td class="rblock">error_exit:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">free(s);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       errno = -res;</td><td> </td><td class="right">       errno = -res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0094" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">free(s);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (pipe_fds[0] &gt;= 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               close(pipe_fds[0]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (pipe_fds[1] &gt;= 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               close(pipe_fds[1]);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return NULL;</td><td> </td><td class="right">       return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0095" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_loop_signals_destroy(struct qb_loop *l)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_loop_signals_destroy(struct qb_loop *l)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0096" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">struct qb_signal_source *s =</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">           (struct qb_signal_source *)l-&gt;signal_source;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       struct qb_list_head *list;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       struct qb_list_head *n;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       struct qb_loop_item *item;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(pipe_fds[0]);</td><td> </td><td class="right">       close(pipe_fds[0]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pipe_fds[0] = -1;</td><td> </td><td class="right">       pipe_fds[0] = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(pipe_fds[1]);</td><td> </td><td class="right">       close(pipe_fds[1]);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pipe_fds[1] = -1;</td><td> </td><td class="right">       pipe_fds[1] = -1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0097" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">qb_list_for_each_safe(list, n, &amp;s-&gt;sig_head) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               item = qb_list_entry(list, struct qb_loop_item, list);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               qb_list_del(&amp;item-&gt;list);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               free(item);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(l-&gt;signal_source);</td><td> </td><td class="right">       free(l-&gt;signal_source);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0098" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t _qb_signal_add_to_jobs_(struct <span class="delete">qb_loop* l,</span></td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                      struct <span class="delete">qb_poll_entry* pe)</span></td><td> </td><td class="rblock">_qb_signal_add_to_jobs_(struct <span class="insert">qb_loop *l,</span> struct <span class="insert">qb_poll_entry *pe)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0099" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_signal_source *s = (struct qb_signal_source <span class="delete">*)l-&gt;signal_so</span></td><td> </td><td class="rblock">       struct qb_signal_source *s =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">urce;</span></td><td> </td><td class="rblock">           (struct qb_signal_source <span class="insert">*)l-&gt;signal_source;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_list_head *list;</td><td> </td><td class="right">       struct qb_list_head *list;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig;</td><td> </td><td class="right">       struct qb_loop_sig *sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_item *item;</td><td> </td><td class="right">       struct qb_loop_item *item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *new_sig_job;</td><td> </td><td class="right">       struct qb_loop_sig *new_sig_job;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t the_signal;</td><td> </td><td class="right">       int32_t the_signal;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t jobs_added = 0;</td><td> </td><td class="right">       int32_t jobs_added = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = read(pipe_fds[0], &amp;the_signal, sizeof(int32_t));</td><td> </td><td class="right">       res = read(pipe_fds[0], &amp;the_signal, sizeof(int32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != sizeof(int32_t)) {</td><td> </td><td class="right">       if (res != sizeof(int32_t)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0100" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               qb_util_<span class="delete">log(LOG_ERR, "failed to read pipe: %s", strerror(err
no)</span>);</td><td> </td><td class="rblock">               qb_util_<span class="insert">perror(LOG_ERR, "failed to read pipe"</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return 0;</td><td> </td><td class="right">               return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pe-&gt;ufd.revents = 0;</td><td> </td><td class="right">       pe-&gt;ufd.revents = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_for_each(list, &amp;s-&gt;sig_head) {</td><td> </td><td class="right">       qb_list_for_each(list, &amp;s-&gt;sig_head) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               item = qb_list_entry(list, struct qb_loop_item, list);</td><td> </td><td class="right">               item = qb_list_entry(list, struct qb_loop_item, list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               sig = (struct qb_loop_sig *)item;</td><td> </td><td class="right">               sig = (struct qb_loop_sig *)item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (sig-&gt;signal == the_signal) {</td><td> </td><td class="right">               if (sig-&gt;signal == the_signal) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       new_sig_job = calloc(1, sizeof(struct qb_loop_sig));</td><td> </td><td class="right">                       new_sig_job = calloc(1, sizeof(struct qb_loop_sig));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0101" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                       <span class="insert">if (new_sig_job == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                               return jobs_added;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       memcpy(new_sig_job, sig, sizeof(struct qb_loop_sig))
;</td><td> </td><td class="right">                       memcpy(new_sig_job, sig, sizeof(struct qb_loop_sig))
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       new_sig_job-&gt;cloned_from = sig;</td><td> </td><td class="right">                       new_sig_job-&gt;cloned_from = sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0102" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p], <span class="delete">&amp;new_sig_jo</span></td><td> </td><td class="rblock">                       qb_loop_level_item_add(&amp;l-&gt;level[pe-&gt;p],</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">b-&gt;item);</span></td><td> </td><td class="rblock">                                              <span class="insert">&amp;new_sig_job-&gt;item);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       jobs_added++;</td><td> </td><td class="right">                       jobs_added++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return jobs_added;</td><td> </td><td class="right">       return jobs_added;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0103" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void _adjust_sigactions_(struct qb_signal_source *s)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">_adjust_sigactions_(struct qb_signal_source *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig;</td><td> </td><td class="right">       struct qb_loop_sig *sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_item *item;</td><td> </td><td class="right">       struct qb_loop_item *item;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct sigaction sa;</td><td> </td><td class="right">       struct sigaction sa;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t needed;</td><td> </td><td class="right">       int32_t needed;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sa.sa_flags = SA_SIGINFO;</td><td> </td><td class="right">       sa.sa_flags = SA_SIGINFO;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sa.sa_sigaction = _handle_real_signal_;</td><td> </td><td class="right">       sa.sa_sigaction = _handle_real_signal_;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sigemptyset(&amp;s-&gt;signal_superset);</td><td> </td><td class="right">       sigemptyset(&amp;s-&gt;signal_superset);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 993</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 1060</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (needed) {</td><td> </td><td class="right">               if (needed) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       sigaddset(&amp;s-&gt;signal_superset, i);</td><td> </td><td class="right">                       sigaddset(&amp;s-&gt;signal_superset, i);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       sigaction(i, &amp;sa, NULL);</td><td> </td><td class="right">                       sigaction(i, &amp;sa, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       (void)signal(i, SIG_DFL);</td><td> </td><td class="right">                       (void)signal(i, SIG_DFL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0104" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_signal_add(qb_loop_t <span class="delete">*l,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          enum qb_loop_priority p,</td><td> </td><td class="rblock">qb_loop_signal_add(qb_loop_t <span class="insert">* l,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          int32_t the_sig,</td><td> </td><td class="rblock">                  enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          void *data,</td><td> </td><td class="rblock">                  int32_t the_sig,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          qb_loop_signal_dispatch_fn dispatch_fn,</td><td> </td><td class="rblock">                  void *data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          qb_loop_signal_handle <span class="delete">*handle)</span></td><td> </td><td class="rblock">                  qb_loop_signal_dispatch_fn dispatch_fn,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                  qb_loop_signal_handle <span class="insert">* handle)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig;</td><td> </td><td class="right">       struct qb_loop_sig *sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_signal_source *s;</td><td> </td><td class="right">       struct qb_signal_source *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL || dispatch_fn == NULL) {</td><td> </td><td class="right">       if (l == NULL || dispatch_fn == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (p &lt; QB_LOOP_LOW || p &gt; QB_LOOP_HIGH) {</td><td> </td><td class="right">       if (p &lt; QB_LOOP_LOW || p &gt; QB_LOOP_HIGH) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s = (struct qb_signal_source *)l-&gt;signal_source;</td><td> </td><td class="right">       s = (struct qb_signal_source *)l-&gt;signal_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig = calloc(1, sizeof(struct qb_loop_sig));</td><td> </td><td class="right">       sig = calloc(1, sizeof(struct qb_loop_sig));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0105" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (sig == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -errno;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;dispatch_fn = dispatch_fn;</td><td> </td><td class="right">       sig-&gt;dispatch_fn = dispatch_fn;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;p = p;</td><td> </td><td class="right">       sig-&gt;p = p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;signal = the_sig;</td><td> </td><td class="right">       sig-&gt;signal = the_sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;item.user_data = data;</td><td> </td><td class="right">       sig-&gt;item.user_data = data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;item.source = l-&gt;signal_source;</td><td> </td><td class="right">       sig-&gt;item.source = l-&gt;signal_source;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_init(&amp;sig-&gt;item.list);</td><td> </td><td class="right">       qb_list_init(&amp;sig-&gt;item.list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_add_tail(&amp;sig-&gt;item.list, &amp;s-&gt;sig_head);</td><td> </td><td class="right">       qb_list_add_tail(&amp;sig-&gt;item.list, &amp;s-&gt;sig_head);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (sigismember(&amp;s-&gt;signal_superset, the_sig) != 1) {</td><td> </td><td class="right">       if (sigismember(&amp;s-&gt;signal_superset, the_sig) != 1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               _adjust_sigactions_(s);</td><td> </td><td class="right">               _adjust_sigactions_(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (handle) {</td><td> </td><td class="right">       if (handle) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               *handle = sig;</td><td> </td><td class="right">               *handle = sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0106" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_signal_mod(qb_loop_t <span class="delete">*l,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          enum qb_loop_priority p,</td><td> </td><td class="rblock">qb_loop_signal_mod(qb_loop_t <span class="insert">* l,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          int32_t the_sig,</td><td> </td><td class="rblock">                  enum qb_loop_priority p,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          void *data,</td><td> </td><td class="rblock">                  int32_t the_sig,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          qb_loop_signal_dispatch_fn dispatch_fn,</td><td> </td><td class="rblock">                  void *data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          qb_loop_signal_handle handle)</td><td> </td><td class="rblock">                  qb_loop_signal_dispatch_fn dispatch_fn,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                  qb_loop_signal_handle handle)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_signal_source *s;</td><td> </td><td class="right">       struct qb_signal_source *s;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig = (struct qb_loop_sig *)handle;</td><td> </td><td class="right">       struct qb_loop_sig *sig = (struct qb_loop_sig *)handle;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (l == NULL || dispatch_fn == NULL || handle == NULL) {</td><td> </td><td class="right">       if (l == NULL || dispatch_fn == NULL || handle == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (p &lt; QB_LOOP_LOW || p &gt; QB_LOOP_HIGH) {</td><td> </td><td class="right">       if (p &lt; QB_LOOP_LOW || p &gt; QB_LOOP_HIGH) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EINVAL;</td><td> </td><td class="right">               return -EINVAL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 1061</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 1133</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       sig-&gt;p = p;</td><td> </td><td class="right">       sig-&gt;p = p;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (sig-&gt;signal != the_sig) {</td><td> </td><td class="right">       if (sig-&gt;signal != the_sig) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               sig-&gt;signal = the_sig;</td><td> </td><td class="right">               sig-&gt;signal = the_sig;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               _adjust_sigactions_(s);</td><td> </td><td class="right">               _adjust_sigactions_(s);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0107" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_loop_signal_del(qb_loop_t <span class="delete">*l,</span></td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                          qb_loop_signal_handle handle)</td><td> </td><td class="rblock">qb_loop_signal_del(qb_loop_t <span class="insert">* l,</span> qb_loop_signal_handle handle)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_loop_sig *sig = (struct qb_loop_sig *)handle;</td><td> </td><td class="right">       struct qb_loop_sig *sig = (struct qb_loop_sig *)handle;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_list_del(&amp;sig-&gt;item.list);</td><td> </td><td class="right">       qb_list_del(&amp;sig-&gt;item.list);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(sig);</td><td> </td><td class="right">       free(sig);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 107 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>186 lines changed or deleted</i></th><th><i> </i></th><th><i>249 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
