<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.2.0-29-generic #46-Ubuntu SMP Fri Jul 27 17:03:23 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.2 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: ringbuffer.c - ringbuffer.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;ringbuffer.c&nbsp;</th><th> </th><th>&nbsp;ringbuffer.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> * Copyright (C) 2010 Red Hat, Inc.</td><td> </td><td class="rblock"> * Copyright (C) 2010<span class="insert">-2011</span> Red Hat, Inc.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * Author: Angus Salkeld &lt;asalkeld@redhat.com&gt;</td><td> </td><td class="right"> * Author: Angus Salkeld &lt;asalkeld@redhat.com&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * This file is part of libqb.</td><td> </td><td class="right"> * This file is part of libqb.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * libqb is free software: you can redistribute it and/or modify</td><td> </td><td class="right"> * libqb is free software: you can redistribute it and/or modify</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * it under the terms of the GNU Lesser General Public License as published
 by</td><td> </td><td class="right"> * it under the terms of the GNU Lesser General Public License as published
 by</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * the Free Software Foundation, either version 2.1 of the License, or</td><td> </td><td class="right"> * the Free Software Foundation, either version 2.1 of the License, or</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * (at your option) any later version.</td><td> </td><td class="right"> * (at your option) any later version.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 25</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 25</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td> </td><td class="right"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * GNU Lesser General Public License for more details.</td><td> </td><td class="right"> * GNU Lesser General Public License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU Lesser General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU Lesser General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td> </td><td class="right"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "ringbuffer_int.h"</td><td> </td><td class="right">#include "ringbuffer_int.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbdefs.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbdefs.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbatomic.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbatomic.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//#define</span> CRAZY_DEBUG_PRINTFS 1</td><td> </td><td class="rblock"><span class="insert">/*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * #define</span> CRAZY_DEBUG_PRINTFS 1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"> <span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef CRAZY_DEBUG_PRINTFS</td><td> </td><td class="right">#ifdef CRAZY_DEBUG_PRINTFS</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define DEBUG_PRINTF(format, args...)  \</td><td> </td><td class="right">#define DEBUG_PRINTF(format, args...)  \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">do {                           \</td><td> </td><td class="right">do {                           \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(format, ##args); \</td><td> </td><td class="right">       printf(format, ##args); \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">} while(0)</td><td> </td><td class="right">} while(0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define DEBUG_PRINTF(format, args...)</td><td> </td><td class="right">#define DEBUG_PRINTF(format, args...)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* CRAZY_DEBUG_PRINTFS */</td><td> </td><td class="right">#endif /* CRAZY_DEBUG_PRINTFS */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/* the chunk header is two words</td><td> </td><td class="right">/* the chunk header is two words</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 58</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 60</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define QB_RB_READ_PT_INDEX (rb-&gt;shared_hdr-&gt;size + 1)</td><td> </td><td class="right">#define QB_RB_READ_PT_INDEX (rb-&gt;shared_hdr-&gt;size + 1)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define idx_step(idx)                                  \</td><td> </td><td class="right">#define idx_step(idx)                                  \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">do {                                                   \</td><td> </td><td class="right">do {                                                   \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td> </td><td class="right">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td> </td><td class="right">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }                                               \</td><td> </td><td class="right">       }                                               \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">} while (0)</td><td> </td><td class="right">} while (0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> * move the write pointer to the next 32 byte boundry</td><td> </td><td class="rblock"> * move the write pointer to the next 32 byte bound<span class="insert">a</span>ry</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * write_pt goes in 4 bytes (sizeof(uint32_t))</td><td> </td><td class="right"> * write_pt goes in 4 bytes (sizeof(uint32_t))</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">//#define</span> USE_CACHE_LINE_ALIGNMENT 1</td><td> </td><td class="rblock"><span class="insert">/*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"> * #define</span> USE_CACHE_LINE_ALIGNMENT 1</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"> <span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef USE_CACHE_LINE_ALIGNMENT</td><td> </td><td class="right">#ifdef USE_CACHE_LINE_ALIGNMENT</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define idx_cache_line_step(idx)       \</td><td> </td><td class="right">#define idx_cache_line_step(idx)       \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">do {                                   \</td><td> </td><td class="right">do {                                   \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (idx % 8) {                  \</td><td> </td><td class="right">       if (idx % 8) {                  \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               idx += (8 - (idx % 8)); \</td><td> </td><td class="right">               idx += (8 - (idx % 8)); \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }                               \</td><td> </td><td class="right">       }                               \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td> </td><td class="right">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td> </td><td class="right">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }                                               \</td><td> </td><td class="right">       }                                               \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">} while (0)</td><td> </td><td class="right">} while (0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 83</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 87</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define idx_cache_line_step(idx)                       \</td><td> </td><td class="right">#define idx_cache_line_step(idx)                       \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">do {                                                   \</td><td> </td><td class="right">do {                                                   \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td> </td><td class="right">       if (idx &gt; (rb-&gt;shared_hdr-&gt;size - 1)) {         \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td> </td><td class="right">               idx = ((idx) % (rb-&gt;shared_hdr-&gt;size)); \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }                                               \</td><td> </td><td class="right">       }                                               \</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">} while (0)</td><td> </td><td class="right">} while (0)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">static void qb_rb_chunk_check(qb_ringbuffer_t * rb, uint32_t pointer);</td><td> </td><td class="right">static void qb_rb_chunk_check(qb_ringbuffer_t * rb, uint32_t pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">qb_ringbuffer_t <span class="delete">*qb_rb_open(const</span> char *name, size_t size, uint32_t flags,</td><td> </td><td class="rblock">qb_ringbuffer_t <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           size_t shared_user_data_size)</td><td> </td><td class="rblock"><span class="insert">qb_rb_open(const</span> char *name, size_t size, uint32_t flags,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">{</td><td> </td><td class="rblock">          size_t shared_user_data_size)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       struct qb_ringbuffer_s <span class="delete">*rb = malloc(sizeof(struct qb_ringbuffer_s));</span></td><td> </td><td class="rblock">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       size_t <span class="delete">real_size = QB_ROUNDUP(size, sysconf(_SC_PAGESIZE));</span></td><td> </td><td class="rblock">       struct qb_ringbuffer_s <span class="insert">*rb;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       size_t <span class="insert">real_size;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       size_t shared_size;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char path[PATH_MAX];</td><td> </td><td class="right">       char path[PATH_MAX];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t fd_hdr;</td><td> </td><td class="right">       int32_t fd_hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t fd_data;</td><td> </td><td class="right">       int32_t fd_data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t file_flags = O_RDWR;</td><td> </td><td class="right">       uint32_t file_flags = O_RDWR;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       size_t shared_size = sizeof(struct qb_ringbuffer_shared_s);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char filename[PATH_MAX];</td><td> </td><td class="right">       char filename[PATH_MAX];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t error = 0;</td><td> </td><td class="right">       int32_t error = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">void *shm_addr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       long page_size = sysconf(_SC_PAGESIZE);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       shared_size <span class="delete">+=</span> shared_user_data_size;</td><td> </td><td class="rblock"><span class="insert">#ifdef QB_FORCE_SHM_ALIGN</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       page_size = QB_MAX(page_size, 16 * 1024);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif /* QB_FORCE_SHM_ALIGN */</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       real_size = QB_ROUNDUP(size, page_size);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       shared_size <span class="insert">=</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">           sizeof(struct qb_ringbuffer_shared_s) +</span> shared_user_data_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td> </td><td class="right">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               file_flags |= O_CREAT | O_TRUNC;</td><td> </td><td class="right">               file_flags |= O_CREAT | O_TRUNC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">rb = calloc(1, sizeof(struct qb_ringbuffer_s));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * Create a shared_hdr memory segment for the header.</td><td> </td><td class="right">        * Create a shared_hdr memory segment for the header.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       snprintf(filename, PATH_MAX, <span class="delete">"%s-header",</span> name);</td><td> </td><td class="rblock">       snprintf(filename, PATH_MAX, <span class="insert">"qb-%s-header",</span> name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       fd_hdr = <span class="delete">qb_util_mmap_file_open(path,</span> filename,</td><td> </td><td class="rblock">       fd_hdr = <span class="insert">qb_sys_mmap_file_open(path,</span> filename,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                       shared_size,</td><td> </td><td class="rblock">                                      shared_size, file_flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                       file_flags);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (fd_hdr &lt; 0) {</td><td> </td><td class="right">       if (fd_hdr &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               error = fd_hdr;</td><td> </td><td class="right">               error = fd_hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "couldn't create file for mmap");</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "couldn't create file for mmap");</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">return NULL</span>;</td><td> </td><td class="rblock">               <span class="insert">goto cleanup_hdr</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_hdr = mmap(0,</td><td> </td><td class="right">       rb-&gt;shared_hdr = mmap(0,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                             shared_size,</td><td> </td><td class="right">                             shared_size,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                             PROT_READ | PROT_WRITE, MAP_SHARED, fd_hdr, 0)
;</td><td> </td><td class="right">                             PROT_READ | PROT_WRITE, MAP_SHARED, fd_hdr, 0)
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (rb-&gt;shared_hdr == MAP_FAILED) {</td><td> </td><td class="right">       if (rb-&gt;shared_hdr == MAP_FAILED) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               error = -errno;</td><td> </td><td class="right">               error = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "couldn't create mmap for header");</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "couldn't create mmap for header");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup_hdr;</td><td> </td><td class="right">               goto cleanup_hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l5" /><small>skipping to change at</small><em> line 139</em></th><th> </th><th><a name="part-r5" /><small>skipping to change at</small><em> line 156</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td> </td><td class="right">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_data = NULL;</td><td> </td><td class="right">               rb-&gt;shared_data = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               /* rb-&gt;shared_hdr-&gt;size tracks data by ints and not bytes/ch
ars. */</td><td> </td><td class="right">               /* rb-&gt;shared_hdr-&gt;size tracks data by ints and not bytes/ch
ars. */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_hdr-&gt;size = real_size / sizeof(uint32_t);</td><td> </td><td class="right">               rb-&gt;shared_hdr-&gt;size = real_size / sizeof(uint32_t);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_hdr-&gt;write_pt = 0;</td><td> </td><td class="right">               rb-&gt;shared_hdr-&gt;write_pt = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_hdr-&gt;read_pt = 0;</td><td> </td><td class="right">               rb-&gt;shared_hdr-&gt;read_pt = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               strncpy(rb-&gt;shared_hdr-&gt;hdr_path, path, PATH_MAX);</td><td> </td><td class="right">               strncpy(rb-&gt;shared_hdr-&gt;hdr_path, path, PATH_MAX);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       error = qb_rb_sem_create(rb, flags);</td><td> </td><td class="right">       error = qb_rb_sem_create(rb, flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (error &lt; 0) {</td><td> </td><td class="right">       if (error &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "couldn't get a <span class="delete">semaphore %s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "couldn't get a <span class="insert">semaphore");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(-error));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup_hdr;</td><td> </td><td class="right">               goto cleanup_hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /* Create the shared_data memory segment for the actual ringbuffer.</td><td> </td><td class="right">       /* Create the shared_data memory segment for the actual ringbuffer.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        * They have to be sep<span class="delete">e</span>rate.</td><td> </td><td class="rblock">        * They have to be sep<span class="insert">a</span>rate.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td> </td><td class="right">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               snprintf(filename, PATH_MAX, <span class="delete">"%s-data",</span> name);</td><td> </td><td class="rblock">               snprintf(filename, PATH_MAX, <span class="insert">"qb-%s-data",</span> name);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               fd_data = <span class="delete">qb_util_mmap_file_open(path,</span></td><td> </td><td class="rblock">               fd_data = <span class="insert">qb_sys_mmap_file_open(path,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                filename,</td><td> </td><td class="rblock">                                               filename,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                real_size, file_flags);</td><td> </td><td class="rblock">                                               real_size, file_flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               strncpy(rb-&gt;shared_hdr-&gt;data_path, path, PATH_MAX);</td><td> </td><td class="right">               strncpy(rb-&gt;shared_hdr-&gt;data_path, path, PATH_MAX);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               fd_data = <span class="delete">qb_util_mmap_file_open(path,</span></td><td> </td><td class="rblock">               fd_data = <span class="insert">qb_sys_mmap_file_open(path,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                rb-&gt;shared_hdr-&gt;data_path,</td><td> </td><td class="rblock">                                               rb-&gt;shared_hdr-&gt;data_path,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                real_size, file_flags);</td><td> </td><td class="rblock">                                               real_size, file_flags);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (fd_data &lt; 0) {</td><td> </td><td class="right">       if (fd_data &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               error = fd_data;</td><td> </td><td class="right">               error = fd_data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "couldn't create file for mmap");</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "couldn't create file for mmap");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup_hdr;</td><td> </td><td class="right">               goto cleanup_hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_util_log(LOG_DEBUG,</td><td> </td><td class="right">       qb_util_log(LOG_DEBUG,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   "shm size:%zd; real_size:%zd; rb-&gt;size:%d", size,</td><td> </td><td class="right">                   "shm size:%zd; real_size:%zd; rb-&gt;size:%d", size,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   real_size, rb-&gt;shared_hdr-&gt;size);</td><td> </td><td class="right">                   real_size, rb-&gt;shared_hdr-&gt;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       error = <span class="delete">qb_util_circular_mmap(fd_data,</span></td><td> </td><td class="rblock">       error = <span class="insert">qb_sys_circular_mmap(fd_data, &amp;shm_addr,</span> real_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                 (void **)&amp;rb-&gt;shared_data,</span> real_size);</td><td> </td><td class="rblock">       <span class="insert">rb-&gt;shared_data = shm_addr;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (error != 0) {</td><td> </td><td class="right">       if (error != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_ERR, "couldn't create circular mmap on %s",</td><td> </td><td class="right">               qb_util_log(LOG_ERR, "couldn't create circular mmap on %s",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           rb-&gt;shared_hdr-&gt;data_path);</td><td> </td><td class="right">                           rb-&gt;shared_hdr-&gt;data_path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup_data;</td><td> </td><td class="right">               goto cleanup_data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td> </td><td class="right">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memset(rb-&gt;shared_data, 0, real_size);</td><td> </td><td class="right">               memset(rb-&gt;shared_data, 0, real_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_data[rb-&gt;shared_hdr-&gt;size] = 5;</td><td> </td><td class="right">               rb-&gt;shared_data[rb-&gt;shared_hdr-&gt;size] = 5;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               rb-&gt;shared_hdr-&gt;ref_count = 1;</td><td> </td><td class="right">               rb-&gt;shared_hdr-&gt;ref_count = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l6" /><small>skipping to change at</small><em> line 195</em></th><th> </th><th><a name="part-r6" /><small>skipping to change at</small><em> line 211</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(fd_data);</td><td> </td><td class="right">       close(fd_data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb;</td><td> </td><td class="right">       return rb;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup_data:</td><td> </td><td class="right">cleanup_data:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       close(fd_data);</td><td> </td><td class="right">       close(fd_data);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td> </td><td class="right">       if (flags &amp; QB_RB_FLAG_CREATE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               unlink(rb-&gt;shared_hdr-&gt;data_path);</td><td> </td><td class="right">               unlink(rb-&gt;shared_hdr-&gt;data_path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup_hdr:</td><td> </td><td class="right">cleanup_hdr:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       close(fd_hdr);</td><td> </td><td class="rblock">       <span class="insert">if (fd_hdr &gt;= 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (flags &amp; <span class="delete">QB_RB_FLAG_CREATE)</span> {</td><td> </td><td class="rblock">               close(fd_hdr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       if <span class="insert">(rb &amp;&amp;</span> (flags &amp; <span class="insert">QB_RB_FLAG_CREATE))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               unlink(rb-&gt;shared_hdr-&gt;hdr_path);</td><td> </td><td class="right">               unlink(rb-&gt;shared_hdr-&gt;hdr_path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               (void)rb-&gt;sem_destroy_fn(rb);</td><td> </td><td class="right">               (void)rb-&gt;sem_destroy_fn(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (rb &amp;&amp; (rb-&gt;shared_hdr != MAP_FAILED &amp;&amp; rb-&gt;shared_hdr != NULL)) 
{</td><td> </td><td class="right">       if (rb &amp;&amp; (rb-&gt;shared_hdr != MAP_FAILED &amp;&amp; rb-&gt;shared_hdr != NULL)) 
{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               munmap(rb-&gt;shared_hdr, sizeof(struct qb_ringbuffer_shared_s)
);</td><td> </td><td class="right">               munmap(rb-&gt;shared_hdr, sizeof(struct qb_ringbuffer_shared_s)
);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(rb);</td><td> </td><td class="right">       free(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       errno = -error;</td><td> </td><td class="right">       errno = -error;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return NULL;</td><td> </td><td class="right">       return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_rb_close(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_close(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (rb == NULL) {</td><td> </td><td class="right">       if (rb == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">qb_util_log(LOG_DEBUG,</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                   "Destroying ringbuffer: %s",</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                   rb-&gt;shared_hdr-&gt;hdr_path);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       (void)qb_atomic_int_dec_and_test(&amp;rb-&gt;shared_hdr-&gt;ref_count);</td><td> </td><td class="right">       (void)qb_atomic_int_dec_and_test(&amp;rb-&gt;shared_hdr-&gt;ref_count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       (void)rb-&gt;sem_destroy_fn(rb);</td><td> </td><td class="rblock">       <span class="insert">if (rb-&gt;flags &amp; QB_RB_FLAG_CREATE) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       unlink(rb-&gt;shared_hdr-&gt;data_path);</td><td> </td><td class="rblock">               (void)rb-&gt;sem_destroy_fn(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       unlink(rb-&gt;shared_hdr-&gt;hdr_path);</td><td> </td><td class="rblock">               unlink(rb-&gt;shared_hdr-&gt;data_path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               unlink(rb-&gt;shared_hdr-&gt;hdr_path);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               <span class="insert">qb_util_log(LOG_DEBUG,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                           "Free'ing ringbuffer: %s",</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                           rb-&gt;shared_hdr-&gt;hdr_path);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       } else {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               qb_util_log(LOG_DEBUG,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">                           "Closing ringbuffer: %s", rb-&gt;shared_hdr-&gt;hdr_pa</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">th);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       munmap(rb-&gt;shared_data, (rb-&gt;shared_hdr-&gt;size * sizeof(uint32_t)) &lt;&lt;
 1);</td><td> </td><td class="right">       munmap(rb-&gt;shared_data, (rb-&gt;shared_hdr-&gt;size * sizeof(uint32_t)) &lt;&lt;
 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       munmap(rb-&gt;shared_hdr, sizeof(struct qb_ringbuffer_shared_s));</td><td> </td><td class="right">       munmap(rb-&gt;shared_hdr, sizeof(struct qb_ringbuffer_shared_s));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       free(rb);</td><td> </td><td class="right">       free(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">char <span class="delete">*qb_rb_name_get(qb_ringbuffer_t</span> * rb)</td><td> </td><td class="rblock">char <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qb_rb_name_get(qb_ringbuffer_t</span> * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb-&gt;shared_hdr-&gt;hdr_path;</td><td> </td><td class="right">       return rb-&gt;shared_hdr-&gt;hdr_path;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">*qb_rb_shared_user_data_get(qb_ringbuffer_t</span> * rb)</td><td> </td><td class="rblock">void <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qb_rb_shared_user_data_get(qb_ringbuffer_t</span> * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb-&gt;shared_hdr-&gt;user_data;</td><td> </td><td class="right">       return rb-&gt;shared_hdr-&gt;user_data;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_rb_refcount_get(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_refcount_get(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return qb_atomic_int_get(&amp;rb-&gt;shared_hdr-&gt;ref_count);</td><td> </td><td class="right">       return qb_atomic_int_get(&amp;rb-&gt;shared_hdr-&gt;ref_count);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_space_free(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_space_free(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t write_size;</td><td> </td><td class="right">       uint32_t write_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t read_size;</td><td> </td><td class="right">       uint32_t read_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size_t space_free = 0;</td><td> </td><td class="right">       size_t space_free = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       write_size = rb-&gt;shared_hdr-&gt;write_pt;</td><td> </td><td class="right">       write_size = rb-&gt;shared_hdr-&gt;write_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">//</span> TODO idx_cache_line_step (write_size);</td><td> </td><td class="rblock">       <span class="insert">/*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">        *</span> TODO idx_cache_line_step (write_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">        <span class="insert">*/</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       read_size = rb-&gt;shared_hdr-&gt;read_pt;</td><td> </td><td class="right">       read_size = rb-&gt;shared_hdr-&gt;read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (write_size &gt; read_size) {</td><td> </td><td class="right">       if (write_size &gt; read_size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_free =</td><td> </td><td class="right">               space_free =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   (read_size - write_size + rb-&gt;shared_hdr-&gt;size) - 1;</td><td> </td><td class="right">                   (read_size - write_size + rb-&gt;shared_hdr-&gt;size) - 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (write_size &lt; read_size) {</td><td> </td><td class="right">       } else if (write_size &lt; read_size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_free = (read_size - write_size) - 1;</td><td> </td><td class="right">               space_free = (read_size - write_size) - 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_free = rb-&gt;shared_hdr-&gt;size;</td><td> </td><td class="right">               space_free = rb-&gt;shared_hdr-&gt;size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /* word -&gt; bytes */</td><td> </td><td class="right">       /* word -&gt; bytes */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (space_free * sizeof(uint32_t));</td><td> </td><td class="right">       return (space_free * sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_space_used(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_space_used(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t write_size;</td><td> </td><td class="right">       uint32_t write_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t read_size;</td><td> </td><td class="right">       uint32_t read_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size_t space_used;</td><td> </td><td class="right">       size_t space_used;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       write_size = rb-&gt;shared_hdr-&gt;write_pt;</td><td> </td><td class="right">       write_size = rb-&gt;shared_hdr-&gt;write_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       read_size = rb-&gt;shared_hdr-&gt;read_pt;</td><td> </td><td class="right">       read_size = rb-&gt;shared_hdr-&gt;read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (write_size &gt; read_size) {</td><td> </td><td class="right">       if (write_size &gt; read_size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_used = write_size - read_size;</td><td> </td><td class="right">               space_used = write_size - read_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (write_size &lt; read_size) {</td><td> </td><td class="right">       } else if (write_size &lt; read_size) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_used =</td><td> </td><td class="right">               space_used =</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                   (write_size - read_size + rb-&gt;shared_hdr-&gt;size) - 1;</td><td> </td><td class="right">                   (write_size - read_size + rb-&gt;shared_hdr-&gt;size) - 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               space_used = 0;</td><td> </td><td class="right">               space_used = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /* word -&gt; bytes */</td><td> </td><td class="right">       /* word -&gt; bytes */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (space_used * sizeof(uint32_t));</td><td> </td><td class="right">       return (space_used * sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0032" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_chunks_used(struct qb_ringbuffer_s <span class="delete">* rb)</span></td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chunks_used(struct qb_ringbuffer_s <span class="insert">*rb)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0033" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb-&gt;sem_getvalue_fn(rb);</td><td> </td><td class="right">       return rb-&gt;sem_getvalue_fn(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0034" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void <span class="delete">*qb_rb_chunk_alloc(qb_ringbuffer_t</span> * rb, size_t len)</td><td> </td><td class="rblock">void <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qb_rb_chunk_alloc(qb_ringbuffer_t</span> * rb, size_t len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t write_pt;</td><td> </td><td class="right">       uint32_t write_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0035" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * Reclaim data if we are over writing and we need space</td><td> </td><td class="right">        * Reclaim data if we are over writing and we need space</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (rb-&gt;flags &amp; QB_RB_FLAG_OVERWRITE) {</td><td> </td><td class="right">       if (rb-&gt;flags &amp; QB_RB_FLAG_OVERWRITE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               while (qb_rb_space_free(rb) &lt;</td><td> </td><td class="right">               while (qb_rb_space_free(rb) &lt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                      (len + QB_RB_CHUNK_HEADER_SIZE + 4)) {</td><td> </td><td class="right">                      (len + QB_RB_CHUNK_HEADER_SIZE + 4)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       qb_rb_chunk_reclaim(rb);</td><td> </td><td class="right">                       qb_rb_chunk_reclaim(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0036" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               if (qb_rb_space_free(rb) &lt;</td><td> </td><td class="rblock">               if (qb_rb_space_free(rb) &lt; (len + QB_RB_CHUNK_HEADER_SIZE + </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                   (len + QB_RB_CHUNK_HEADER_SIZE + 4)) {</td><td> </td><td class="rblock">4)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       errno = EAGAIN;</td><td> </td><td class="right">                       errno = EAGAIN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return NULL;</td><td> </td><td class="right">                       return NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       write_pt = rb-&gt;shared_hdr-&gt;write_pt;</td><td> </td><td class="right">       write_pt = rb-&gt;shared_hdr-&gt;write_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * insert the chunk header</td><td> </td><td class="right">        * insert the chunk header</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[write_pt++] = 0;</td><td> </td><td class="right">       rb-&gt;shared_data[write_pt++] = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       idx_step(write_pt);</td><td> </td><td class="right">       idx_step(write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[write_pt++] = QB_RB_CHUNK_MAGIC;</td><td> </td><td class="right">       rb-&gt;shared_data[write_pt++] = QB_RB_CHUNK_MAGIC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       idx_step(write_pt);</td><td> </td><td class="right">       idx_step(write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0037" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">        * return a pointer to the begining of the chunk data</td><td> </td><td class="rblock">        * return a pointer to the begin<span class="insert">n</span>ing of the chunk data</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return (void *)&amp;rb-&gt;shared_data[write_pt];</td><td> </td><td class="right">       return (void *)&amp;rb-&gt;shared_data[write_pt];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0038" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static uint32_t qb_rb_chunk_step(qb_ringbuffer_t * rb, uint32_t pointer)</td><td> </td><td class="rblock">static uint32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chunk_step(qb_ringbuffer_t * rb, uint32_t pointer)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_size = QB_RB_CHUNK_SIZE_GET(rb, pointer);</td><td> </td><td class="right">       uint32_t chunk_size = QB_RB_CHUNK_SIZE_GET(rb, pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * skip over the chunk header</td><td> </td><td class="right">        * skip over the chunk header</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pointer += QB_RB_CHUNK_HEADER_WORDS;</td><td> </td><td class="right">       pointer += QB_RB_CHUNK_HEADER_WORDS;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       idx_step(pointer);</td><td> </td><td class="right">       idx_step(pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * skip over the user's data.</td><td> </td><td class="right">        * skip over the user's data.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l7" /><small>skipping to change at</small><em> line 348</em></th><th> </th><th><a name="part-r7" /><small>skipping to change at</small><em> line 402</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       pointer += (chunk_size / sizeof(uint32_t));</td><td> </td><td class="right">       pointer += (chunk_size / sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /* make allowance for non-word sizes */</td><td> </td><td class="right">       /* make allowance for non-word sizes */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if ((chunk_size % sizeof(uint32_t)) != 0) {</td><td> </td><td class="right">       if ((chunk_size % sizeof(uint32_t)) != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               pointer++;</td><td> </td><td class="right">               pointer++;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       idx_cache_line_step(pointer);</td><td> </td><td class="right">       idx_cache_line_step(pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return pointer;</td><td> </td><td class="right">       return pointer;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0039" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_rb_chunk_commit(qb_ringbuffer_t * rb, size_t len)</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chunk_commit(qb_ringbuffer_t * rb, size_t len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0040" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       uint32_t old_write_pt<span class="delete"> = rb-&gt;shared_hdr-&gt;write_pt</span>;</td><td> </td><td class="rblock">       uint32_t old_write_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0041" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * commit the magic &amp; chunk_size</td><td> </td><td class="right">        * commit the magic &amp; chunk_size</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0042" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       old_write_pt = rb-&gt;shared_hdr-&gt;write_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[old_write_pt] = len;</td><td> </td><td class="right">       rb-&gt;shared_data[old_write_pt] = len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[old_write_pt + 1] = QB_RB_CHUNK_MAGIC;</td><td> </td><td class="right">       rb-&gt;shared_data[old_write_pt + 1] = QB_RB_CHUNK_MAGIC;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * commit the new write pointer</td><td> </td><td class="right">        * commit the new write pointer</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_hdr-&gt;write_pt = qb_rb_chunk_step(rb, old_write_pt);</td><td> </td><td class="right">       rb-&gt;shared_hdr-&gt;write_pt = qb_rb_chunk_step(rb, old_write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       DEBUG_PRINTF("%s: read: %u, write: %u (was:%u)\n", __func__,</td><td> </td><td class="right">       DEBUG_PRINTF("%s: read: %u, write: %u (was:%u)\n", __func__,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                    rb-&gt;shared_hdr-&gt;read_pt, rb-&gt;shared_hdr-&gt;write_pt,</td><td> </td><td class="right">                    rb-&gt;shared_hdr-&gt;read_pt, rb-&gt;shared_hdr-&gt;write_pt,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                    old_write_pt);</td><td> </td><td class="right">                    old_write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * post the notification to the reader</td><td> </td><td class="right">        * post the notification to the reader</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb-&gt;sem_post_fn(rb);</td><td> </td><td class="right">       return rb-&gt;sem_post_fn(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0043" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_chunk_write(qb_ringbuffer_t * rb, const void *data, size_t <span class="delete">le</span></td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">n)</span></td><td> </td><td class="rblock">qb_rb_chunk_write(qb_ringbuffer_t * rb, const void *data, size_t <span class="insert">len)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char *dest = qb_rb_chunk_alloc(rb, len);</td><td> </td><td class="right">       char *dest = qb_rb_chunk_alloc(rb, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0044" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (dest == NULL) {</td><td> </td><td class="right">       if (dest == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(dest, data, len);</td><td> </td><td class="right">       memcpy(dest, data, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = qb_rb_chunk_commit(rb, len);</td><td> </td><td class="right">       res = qb_rb_chunk_commit(rb, len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return len;</td><td> </td><td class="right">       return len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0045" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_rb_chunk_reclaim(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chunk_reclaim(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0046" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       uint32_t old_read_pt<span class="delete"> = rb-&gt;shared_hdr-&gt;read_pt</span>;</td><td> </td><td class="rblock">       uint32_t old_read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0047" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (qb_rb_space_used(rb) == 0) {</td><td> </td><td class="rblock">       if (<span class="insert">rb == NULL || </span>qb_rb_space_used(rb) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return;</td><td> </td><td class="right">               return;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0048" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">                                                                    </span></td><td> </td><td class="rblock">       <span class="insert">old_read_pt = rb-&gt;shared_hdr-&gt;read_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_rb_chunk_check(rb, old_read_pt);</td><td> </td><td class="right">       qb_rb_chunk_check(rb, old_read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_hdr-&gt;read_pt = qb_rb_chunk_step(rb, old_read_pt);</td><td> </td><td class="right">       rb-&gt;shared_hdr-&gt;read_pt = qb_rb_chunk_step(rb, old_read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * clear the header</td><td> </td><td class="right">        * clear the header</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[old_read_pt] = 0;</td><td> </td><td class="right">       rb-&gt;shared_data[old_read_pt] = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;shared_data[old_read_pt + 1] = 0;</td><td> </td><td class="right">       rb-&gt;shared_data[old_read_pt + 1] = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       DEBUG_PRINTF("%s: read: %u (was:%u), write: %u\n", __func__,</td><td> </td><td class="right">       DEBUG_PRINTF("%s: read: %u (was:%u), write: %u\n", __func__,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                    rb-&gt;shared_hdr-&gt;read_pt, old_read_pt,</td><td> </td><td class="right">                    rb-&gt;shared_hdr-&gt;read_pt, old_read_pt,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                    rb-&gt;shared_hdr-&gt;write_pt);</td><td> </td><td class="right">                    rb-&gt;shared_hdr-&gt;write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0049" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_chunk_peek(qb_ringbuffer_t * rb, void **data_out, int32_t <span class="delete">tim</span></td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">eout)</span></td><td> </td><td class="rblock">qb_rb_chunk_peek(qb_ringbuffer_t * rb, void **data_out, int32_t <span class="insert">timeout)</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t read_pt;</td><td> </td><td class="right">       uint32_t read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_size;</td><td> </td><td class="right">       uint32_t chunk_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_magic;</td><td> </td><td class="right">       uint32_t chunk_magic;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0050" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = rb-&gt;sem_timedwait_fn(rb, timeout);</td><td> </td><td class="right">       res = rb-&gt;sem_timedwait_fn(rb, timeout);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0 &amp;&amp; res != -EIDRM) {</td><td> </td><td class="right">       if (res &lt; 0 &amp;&amp; res != -EIDRM) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res != -ETIMEDOUT) {</td><td> </td><td class="right">               if (res != -ETIMEDOUT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0051" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       qb_util_<span class="delete">log(LOG_ERR, "sem_timedwait %s", strerror(-r
es)</span>);</td><td> </td><td class="rblock">                       qb_util_<span class="insert">perror(LOG_ERR, "sem_timedwait"</span>);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       read_pt = rb-&gt;shared_hdr-&gt;read_pt;</td><td> </td><td class="right">       read_pt = rb-&gt;shared_hdr-&gt;read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       chunk_size = QB_RB_CHUNK_SIZE_GET(rb, read_pt);</td><td> </td><td class="right">       chunk_size = QB_RB_CHUNK_SIZE_GET(rb, read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       chunk_magic = QB_RB_CHUNK_MAGIC_GET(rb, read_pt);</td><td> </td><td class="right">       chunk_magic = QB_RB_CHUNK_MAGIC_GET(rb, read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       *data_out = &amp;rb-&gt;shared_data[read_pt + QB_RB_CHUNK_HEADER_WORDS];</td><td> </td><td class="right">       *data_out = &amp;rb-&gt;shared_data[read_pt + QB_RB_CHUNK_HEADER_WORDS];</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (chunk_magic != QB_RB_CHUNK_MAGIC) {</td><td> </td><td class="right">       if (chunk_magic != QB_RB_CHUNK_MAGIC) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               errno = ENOMSG;</td><td> </td><td class="right">               errno = ENOMSG;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l8" /><small>skipping to change at</small><em> line 448</em></th><th> </th><th><a name="part-r8" /><small>skipping to change at</small><em> line 517</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return chunk_size;</td><td> </td><td class="right">               return chunk_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">ssize_t</td><td> </td><td class="right">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">qb_rb_chunk_read(qb_ringbuffer_t * rb, void *data_out, size_t len,</td><td> </td><td class="right">qb_rb_chunk_read(qb_ringbuffer_t * rb, void *data_out, size_t len,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                int32_t timeout)</td><td> </td><td class="right">                int32_t timeout)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t read_pt;</td><td> </td><td class="right">       uint32_t read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_size;</td><td> </td><td class="right">       uint32_t chunk_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0052" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       int32_t res;</td><td> </td><td class="rblock">       int32_t res<span class="insert"> = 0</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0053" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       res = rb-&gt;sem_timedwait_fn(rb, timeout);</td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (rb-&gt;sem_timedwait_fn) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               res = rb-&gt;sem_timedwait_fn(rb, timeout);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">}</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0 &amp;&amp; res != -EIDRM) {</td><td> </td><td class="right">       if (res &lt; 0 &amp;&amp; res != -EIDRM) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res != -ETIMEDOUT) {</td><td> </td><td class="right">               if (res != -ETIMEDOUT) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0054" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       <span class="delete">qb_util_log(LOG_ERR,</span></td><td> </td><td class="rblock">                       <span class="insert">qb_util_perror(LOG_ERR, "sem_timedwait");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                                   "sem_timedwait %s", strerror(errno));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (qb_rb_space_used(rb) == 0) {</td><td> </td><td class="right">       if (qb_rb_space_used(rb) == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -ENOMSG;</td><td> </td><td class="right">               return -ENOMSG;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       read_pt = rb-&gt;shared_hdr-&gt;read_pt;</td><td> </td><td class="right">       read_pt = rb-&gt;shared_hdr-&gt;read_pt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_rb_chunk_check(rb, read_pt);</td><td> </td><td class="right">       qb_rb_chunk_check(rb, read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l9" /><small>skipping to change at</small><em> line 480</em></th><th> </th><th><a name="part-r9" /><small>skipping to change at</small><em> line 553</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(data_out,</td><td> </td><td class="right">       memcpy(data_out,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              &amp;rb-&gt;shared_data[read_pt + QB_RB_CHUNK_HEADER_WORDS],</td><td> </td><td class="right">              &amp;rb-&gt;shared_data[read_pt + QB_RB_CHUNK_HEADER_WORDS],</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">              chunk_size);</td><td> </td><td class="right">              chunk_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       qb_rb_chunk_reclaim(rb);</td><td> </td><td class="right">       qb_rb_chunk_reclaim(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return chunk_size;</td><td> </td><td class="right">       return chunk_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0055" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void print_header(qb_ringbuffer_t * rb)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">print_header(qb_ringbuffer_t * rb)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf("Ringbuffer: \n");</td><td> </td><td class="right">       printf("Ringbuffer: \n");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (rb-&gt;flags &amp; QB_RB_FLAG_OVERWRITE) {</td><td> </td><td class="right">       if (rb-&gt;flags &amp; QB_RB_FLAG_OVERWRITE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               printf(" -&gt;OVERWRITE\n");</td><td> </td><td class="right">               printf(" -&gt;OVERWRITE\n");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               printf(" -&gt;NORMAL\n");</td><td> </td><td class="right">               printf(" -&gt;NORMAL\n");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(" -&gt;write_pt [%d]\n", rb-&gt;shared_hdr-&gt;write_pt);</td><td> </td><td class="right">       printf(" -&gt;write_pt [%d]\n", rb-&gt;shared_hdr-&gt;write_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(" -&gt;read_pt [%d]\n", rb-&gt;shared_hdr-&gt;read_pt);</td><td> </td><td class="right">       printf(" -&gt;read_pt [%d]\n", rb-&gt;shared_hdr-&gt;read_pt);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(" -&gt;size [%d words]\n", rb-&gt;shared_hdr-&gt;size);</td><td> </td><td class="right">       printf(" -&gt;size [%d words]\n", rb-&gt;shared_hdr-&gt;size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef S_SPLINT_S</td><td> </td><td class="right">#ifndef S_SPLINT_S</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(" =&gt;free [%zu bytes]\n", qb_rb_space_free(rb));</td><td> </td><td class="right">       printf(" =&gt;free [%zu bytes]\n", qb_rb_space_free(rb));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       printf(" =&gt;used [%zu bytes]\n", qb_rb_space_used(rb));</td><td> </td><td class="right">       printf(" =&gt;used [%zu bytes]\n", qb_rb_space_used(rb));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif /* S_SPLINT_S */</td><td> </td><td class="right">#endif /* S_SPLINT_S */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0056" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void qb_rb_chunk_check(qb_ringbuffer_t * rb, uint32_t pointer)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chunk_check(qb_ringbuffer_t * rb, uint32_t pointer)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_size;</td><td> </td><td class="right">       uint32_t chunk_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       uint32_t chunk_magic = QB_RB_CHUNK_MAGIC_GET(rb, pointer);</td><td> </td><td class="right">       uint32_t chunk_magic = QB_RB_CHUNK_MAGIC_GET(rb, pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (chunk_magic != QB_RB_CHUNK_MAGIC) {</td><td> </td><td class="right">       if (chunk_magic != QB_RB_CHUNK_MAGIC) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               chunk_size = QB_RB_CHUNK_SIZE_GET(rb, pointer);</td><td> </td><td class="right">               chunk_size = QB_RB_CHUNK_SIZE_GET(rb, pointer);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               printf("size: %x\n", chunk_size);</td><td> </td><td class="right">               printf("size: %x\n", chunk_size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               printf("magic: %x\n", chunk_magic);</td><td> </td><td class="right">               printf("magic: %x\n", chunk_magic);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               print_header(rb);</td><td> </td><td class="right">               print_header(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               assert(0);</td><td> </td><td class="right">               assert(0);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0057" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">ssize_t qb_rb_write_to_file(qb_ringbuffer_t * rb, int32_t fd)</td><td> </td><td class="rblock">ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_write_to_file(qb_ringbuffer_t * rb, int32_t fd)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0058" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       ssize_t result<span class="delete"> = 0</span>;</td><td> </td><td class="rblock">       ssize_t result;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t written_size = 0;</td><td> </td><td class="right">       ssize_t written_size = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0059" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       print_header(rb);</td><td> </td><td class="right">       print_header(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       result = write(fd, &amp;rb-&gt;shared_hdr-&gt;size, sizeof(uint32_t));</td><td> </td><td class="right">       result = write(fd, &amp;rb-&gt;shared_hdr-&gt;size, sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0060" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if (<span class="delete">(result &lt; 0) || (result != sizeof(uint32_t)</span>)) {</td><td> </td><td class="rblock">       if (<span class="insert">result != sizeof(uint32_t</span>)) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       written_size += result;</td><td> </td><td class="right">       written_size += result;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       result = write(fd, rb-&gt;shared_data,</td><td> </td><td class="right">       result = write(fd, rb-&gt;shared_data,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                      rb-&gt;shared_hdr-&gt;size * sizeof(uint32_t));</td><td> </td><td class="right">                      rb-&gt;shared_hdr-&gt;size * sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0061" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">((result &lt; 0)</span></td><td> </td><td class="rblock">       if (result != rb-&gt;shared_hdr-&gt;size * <span class="insert">sizeof(uint32_t))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">           ||</span> (result != rb-&gt;shared_hdr-&gt;size * <span class="delete">sizeof(uint32_t)))</span> {</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       written_size += result;</td><td> </td><td class="right">       written_size += result;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * store the read &amp; write pointers</td><td> </td><td class="right">        * store the read &amp; write pointers</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0062" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       result <span class="delete">+=</span></td><td> </td><td class="rblock">       result <span class="insert">=</span> write(fd, (void *)&amp;rb-&gt;shared_hdr-&gt;write_pt, <span class="insert">sizeof(uint32_</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">           write(fd, (void *)&amp;rb-&gt;shared_hdr-&gt;write_pt, <span class="delete">sizeof(uint32_t));</span></td><td> </td><td class="rblock"><span class="insert">t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">((result &lt; 0) ||</span> (result != <span class="delete">sizeof(uint32_t)))</span> {</td><td> </td><td class="rblock">       if (result != <span class="insert">sizeof(uint32_t))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       written_size += result;</td><td> </td><td class="right">       written_size += result;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0063" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       result <span class="delete">+=</span> write(fd, (void *)&amp;rb-&gt;shared_hdr-&gt;read_pt, <span class="delete">sizeof(uint32_</span></td><td> </td><td class="rblock">       result <span class="insert">=</span> write(fd, (void *)&amp;rb-&gt;shared_hdr-&gt;read_pt, <span class="insert">sizeof(uint32_t</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">t));</span></td><td> </td><td class="rblock"><span class="insert">));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       if <span class="delete">((result &lt; 0) ||</span> (result != <span class="delete">sizeof(uint32_t)))</span> {</td><td> </td><td class="rblock">       if (result != <span class="insert">sizeof(uint32_t))</span> {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       written_size += result;</td><td> </td><td class="right">       written_size += result;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0064" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">qb_util_log(LOG_DEBUG, " writing total of: %zd\n", written_size);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return written_size;</td><td> </td><td class="right">       return written_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0065" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">qb_ringbuffer_t <span class="delete">*qb_rb_create_from_file(int32_t</span> fd, uint32_t flags)</td><td> </td><td class="rblock">qb_ringbuffer_t <span class="insert">*</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">qb_rb_create_from_file(int32_t</span> fd, uint32_t flags)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t n_read;</td><td> </td><td class="right">       ssize_t n_read;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size_t n_required;</td><td> </td><td class="right">       size_t n_required;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0066" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       qb_ringbuffer_t *rb = <span class="delete">malloc(sizeof(qb_ringbuffer_t));</span></td><td> </td><td class="rblock">       <span class="insert">size_t total_read = 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       rb-&gt;shared_hdr = <span class="delete">malloc(sizeof(struct</span> qb_ringbuffer_shared_s));</td><td> </td><td class="rblock"><span class="insert">       uint32_t read_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       uint32_t write_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       qb_ringbuffer_t *rb = <span class="insert">calloc(1, sizeof(qb_ringbuffer_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (rb == NULL || fd &lt; 0) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       rb-&gt;shared_hdr = <span class="insert">calloc(1, sizeof(struct</span> qb_ringbuffer_shared_s));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       <span class="insert">if (rb-&gt;shared_hdr == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               goto cleanup_fail2;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       rb-&gt;flags = flags;</td><td> </td><td class="right">       rb-&gt;flags = flags;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       n_required = sizeof(uint32_t);</td><td> </td><td class="right">       n_required = sizeof(uint32_t);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       n_read = read(fd, &amp;rb-&gt;shared_hdr-&gt;size, n_required);</td><td> </td><td class="right">       n_read = read(fd, &amp;rb-&gt;shared_hdr-&gt;size, n_required);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (n_read != n_required) {</td><td> </td><td class="right">       if (n_read != n_required) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0067" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "Unable to read <span class="delete">fdata</span> header <span class="delete">%s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "Unable to read <span class="insert">blackbox file</span> header</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(errno));</span></td><td> </td><td class="rblock"><span class="insert">");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               return NULL;</span></td><td> </td><td class="rblock"><span class="insert">               goto cleanup_fail;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0068" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       total_read += n_read;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0069" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       n_required = (<span class="delete">(rb-&gt;shared_hdr-&gt;size + 2)</span> * sizeof(uint32_t));</td><td> </td><td class="rblock">       n_required = (<span class="insert">rb-&gt;shared_hdr-&gt;size</span> * sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if ((rb-&gt;shared_data = malloc(n_required)) == NULL) {</td><td> </td><td class="right">       if ((rb-&gt;shared_data = malloc(n_required)) == NULL) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0070" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "exhausted virtual memory");</td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "exhausted virtual memory");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">return NULL;</span></td><td> </td><td class="rblock">               <span class="insert">goto cleanup_fail;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       n_read = read(fd, rb-&gt;shared_data, n_required);</td><td> </td><td class="right">       n_read = read(fd, rb-&gt;shared_data, n_required);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (n_read &lt; 0) {</td><td> </td><td class="right">       if (n_read &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0071" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR, "file</span> read <span class="delete">failed: %s", strerror(errno)</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR, "Unable to</span> read <span class="insert">blackbox file data")</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">);</span></td><td> </td><td class="rblock"><span class="insert">;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">               return NULL;</span></td><td> </td><td class="rblock"><span class="insert">               goto cleanup_fail;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0072" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       total_read += n_read;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (n_read != n_required) {</td><td> </td><td class="right">       if (n_read != n_required) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_WARNING, "read %zd bytes, but expected %zu",</td><td> </td><td class="right">               qb_util_log(LOG_WARNING, "read %zd bytes, but expected %zu",</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           n_read, n_required);</td><td> </td><td class="right">                           n_read, n_required);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0073" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               goto cleanup_fail;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0074" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       rb-&gt;shared_hdr-&gt;write_pt = <span class="delete">rb-&gt;shared_data[QB_RB_WRITE_PT_INDEX];</span></td><td> </td><td class="rblock">       <span class="insert">n_read = read(fd, &amp;write_pt, sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       rb-&gt;shared_hdr-&gt;read_pt = <span class="delete">rb-&gt;shared_data[QB_RB_READ_PT_INDEX];</span></td><td> </td><td class="rblock"><span class="insert">       assert(n_read == sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       rb-&gt;shared_hdr-&gt;write_pt = <span class="insert">write_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       total_read += n_read;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       n_read = read(fd, &amp;read_pt, sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       assert(n_read == sizeof(uint32_t));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       rb-&gt;shared_hdr-&gt;read_pt = <span class="insert">read_pt;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       total_read += n_read;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0075" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       qb_util_log(LOG_DEBUG, "read total of: %zd", total_read);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       print_header(rb);</td><td> </td><td class="right">       print_header(rb);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return rb;</td><td> </td><td class="right">       return rb;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0076" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                                                           </td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">cleanup_fail:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       free(rb-&gt;shared_hdr);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">cleanup_fail2:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       free(rb);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       return NULL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0077" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_rb_chown(qb_ringbuffer_t * rb, uid_t owner, gid_t group)</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_rb_chown(qb_ringbuffer_t * rb, uid_t owner, gid_t group)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0078" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       int32_t res = chown(rb-&gt;shared_hdr-&gt;data_path, owner, group);</td><td> </td><td class="rblock">       int32_t <span class="insert">res;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert"></span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       if (rb == NULL) {</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">               return -EINVAL;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       }</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">       res = chown(rb-&gt;shared_hdr-&gt;data_path, owner, group);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = chown(rb-&gt;shared_hdr-&gt;hdr_path, owner, group);</td><td> </td><td class="right">       res = chown(rb-&gt;shared_hdr-&gt;hdr_path, owner, group);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 78 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>93 lines changed or deleted</i></th><th><i> </i></th><th><i>207 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
