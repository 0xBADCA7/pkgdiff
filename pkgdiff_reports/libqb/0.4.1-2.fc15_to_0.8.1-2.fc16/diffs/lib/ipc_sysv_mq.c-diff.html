<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<!-- Generated by rfcdiff 1.41: rfcdiff  --> 
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional" > -->
<!-- System: Linux aponomarenko 3.0.0-16-generic #28-Ubuntu SMP Fri Jan 27 17:44:39 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux --> 
<!-- Using awk: /usr/bin/gawk: GNU Awk 3.1.8 --> 
<!-- Using diff: /usr/bin/diff: diff (GNU diffutils) 3.0 --> 
<!-- Using wdiff: /usr/bin/wdiff: wdiff (GNU wdiff) 0.6.5 --> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /> 
  <meta http-equiv="Content-Style-Type" content="text/css" /> 
  <title>Diff: ipc_sysv_mq.c - ipc_sysv_mq.c</title> 
  <style type="text/css"> 
    body    { font-size:16px; margin: 0.4ex; margin-right: auto; } 
    tr      { } 
    td      { white-space: pre; font-family: Consolas, "DejaVu Sans Mono", "Droid Sans Mono", Monaco, Monospace; vertical-align: top; font-size: 0.86em;} 
    th      { font-size: 0.86em; } 
    .small  { font-size: 0.6em; font-style: italic; font-family: Verdana, Helvetica, sans-serif; } 
    .left   { background-color: #EEE; } 
    .right  { background-color: #FFF; } 
    .diff   { background-color: #CCF; } 
    .lblock { background-color: #BFB; } 
    .rblock { background-color: #FF8; } 
    .insert { background-color: #8FF; } 
    .delete { background-color: #ACF; } 
    .void   { background-color: #FFB; } 
    .cont   { background-color: #EEE; } 
    .linebr { background-color: #AAA; } 
    .lineno { color: red; background-color: #FFF; font-size: 0.7em; text-align: right; padding: 0 2px; } 
    .elipsis{ background-color: #AAA; } 
    .left .cont { background-color: #DDD; } 
    .right .cont { background-color: #EEE; } 
    .lblock .cont { background-color: #9D9; } 
    .rblock .cont { background-color: #DD6; } 
    .insert .cont { background-color: #0DD; } 
    .delete .cont { background-color: #8AD; } 
    .stats, .stats td, .stats th { background-color: #EEE; padding: 2px 0; } 
  </style> 
</head> 
<body > 
  <table border="0" cellpadding="0" cellspacing="0"> 
  <tr bgcolor="orange"><th></th><th>&nbsp;ipc_sysv_mq.c&nbsp;</th><th> </th><th>&nbsp;ipc_sysv_mq.c&nbsp;</th><th></th></tr> 
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l1" /><small>skipping to change at</small><em> line 23</em></th><th> </th><th><a name="part-r1" /><small>skipping to change at</small><em> line 23</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * libqb is distributed in the hope that it will be useful,</td><td> </td><td class="right"> * libqb is distributed in the hope that it will be useful,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td> </td><td class="right"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td> </td><td class="right"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * GNU Lesser General Public License for more details.</td><td> </td><td class="right"> * GNU Lesser General Public License for more details.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> *</td><td> </td><td class="right"> *</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * You should have received a copy of the GNU Lesser General Public License</td><td> </td><td class="right"> * You should have received a copy of the GNU Lesser General Public License</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td> </td><td class="right"> * along with libqb.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "os_base.h"</td><td> </td><td class="right">#include "os_base.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0001" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_SYS_IPC_H</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/ipc.h&gt;</td><td> </td><td class="right">#include &lt;sys/ipc.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0002" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#ifdef HAVE_SYS_MSG_H</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;sys/msg.h&gt;</td><td> </td><td class="right">#include &lt;sys/msg.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0003" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">#endif</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbdefs.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbdefs.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include &lt;qb/qbloop.h&gt;</td><td> </td><td class="right">#include &lt;qb/qbloop.h&gt;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "ipc_int.h"</td><td> </td><td class="right">#include "ipc_int.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#include "util_int.h"</td><td> </td><td class="right">#include "util_int.h"</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifndef MSGMAX</td><td> </td><td class="right">#ifndef MSGMAX</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define MSGMAX  8192</td><td> </td><td class="right">#define MSGMAX  8192</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#define MY_DATA_SIZE 8000</td><td> </td><td class="right">#define MY_DATA_SIZE 8000</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">struct my_msgbuf {</td><td> </td><td class="right">struct my_msgbuf {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t id __attribute__ ((aligned(8)));</td><td> </td><td class="right">       int32_t id __attribute__ ((aligned(8)));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char data[MY_DATA_SIZE] __attribute__ ((aligned(8)));</td><td> </td><td class="right">       char data[MY_DATA_SIZE] __attribute__ ((aligned(8)));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">} __attribute__ ((aligned(8)));</td><td> </td><td class="right">} __attribute__ ((aligned(8)));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * utility functions</td><td> </td><td class="right"> * utility functions</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * --------------------------------------------------------</td><td> </td><td class="right"> * --------------------------------------------------------</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0004" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t sysv_mq_unnamed_create(struct qb_ipcs_connection *c,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                     struct qb_ipc_one_way *queue)</td><td> </td><td class="rblock">sysv_mq_unnamed_create(struct qb_ipcs_connection *c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                      struct qb_ipc_one_way *queue)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct msqid_ds info;</td><td> </td><td class="right">       struct msqid_ds info;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">retry_creating_the_q:</td><td> </td><td class="right">retry_creating_the_q:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       queue-&gt;u.smq.key = random();</td><td> </td><td class="right">       queue-&gt;u.smq.key = random();</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       queue-&gt;u.smq.q =</td><td> </td><td class="right">       queue-&gt;u.smq.q =</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0005" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               msgget(queue-&gt;u.smq.key,</td><td> </td><td class="rblock">           msgget(queue-&gt;u.smq.key,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                      IPC_CREAT | IPC_EXCL | IPC_NOWAIT | S_IWUSR | <span class="delete">S_IRUSR</span></td><td> </td><td class="rblock">                  IPC_CREAT | IPC_EXCL | IPC_NOWAIT | S_IWUSR | <span class="insert">S_IRUSR);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (queue-&gt;u.smq.q == -1 &amp;&amp; errno == EEXIST) {</td><td> </td><td class="right">       if (queue-&gt;u.smq.q == -1 &amp;&amp; errno == EEXIST) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto retry_creating_the_q;</td><td> </td><td class="right">               goto retry_creating_the_q;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else if (queue-&gt;u.smq.q == -1) {</td><td> </td><td class="right">       } else if (queue-&gt;u.smq.q == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       /*</td><td> </td><td class="right">       /*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * change the queue size and change the ownership to that of</td><td> </td><td class="right">        * change the queue size and change the ownership to that of</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        * the client so they can access it.</td><td> </td><td class="right">        * the client so they can access it.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">        */</td><td> </td><td class="right">        */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = msgctl(queue-&gt;u.smq.q, IPC_STAT, &amp;info);</td><td> </td><td class="right">       res = msgctl(queue-&gt;u.smq.q, IPC_STAT, &amp;info);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0006" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span> "error getting sysv-mq <span class="delete">info : %s",</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span> "error getting sysv-mq <span class="insert">info");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(errno));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (info.msg_perm.uid != 0) {</td><td> </td><td class="right">       if (info.msg_perm.uid != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               qb_util_log(LOG_WARNING,</td><td> </td><td class="right">               qb_util_log(LOG_WARNING,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                           "not enough privileges to increase msg_qbytes");</td><td> </td><td class="right">                           "not enough privileges to increase msg_qbytes");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       info.msg_qbytes = 2 * queue-&gt;max_msg_size;</td><td> </td><td class="right">       info.msg_qbytes = 2 * queue-&gt;max_msg_size;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       info.msg_perm.uid = c-&gt;euid;</td><td> </td><td class="right">       info.msg_perm.uid = c-&gt;euid;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       info.msg_perm.gid = c-&gt;egid;</td><td> </td><td class="right">       info.msg_perm.gid = c-&gt;egid;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = msgctl(queue-&gt;u.smq.q, IPC_SET, &amp;info);</td><td> </td><td class="right">       res = msgctl(queue-&gt;u.smq.q, IPC_SET, &amp;info);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res != 0) {</td><td> </td><td class="right">       if (res != 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0007" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               <span class="delete">qb_util_log(LOG_ERR,</span></td><td> </td><td class="rblock">               <span class="insert">qb_util_perror(LOG_ERR,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           "error <span class="delete">modifing</span> the SYSV message <span class="delete">queue : %s",</span></td><td> </td><td class="rblock">                              "error <span class="insert">modifying</span> the SYSV message <span class="insert">queue");</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">                           strerror(errno));</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return res;</td><td> </td><td class="right">               return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0008" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t sysv_split_and_send(int32_t q, const void *msg_ptr,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                  size_t msg_len, int32_t last_chunk)</td><td> </td><td class="rblock">sysv_split_and_send(int32_t q, const void *msg_ptr,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                   size_t msg_len, int32_t last_chunk)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t sent = 0;</td><td> </td><td class="right">       int32_t sent = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef PACK_MESSAGES</td><td> </td><td class="right">#ifdef PACK_MESSAGES</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char *progress = (char *)msg_ptr;</td><td> </td><td class="right">       char *progress = (char *)msg_ptr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct my_msgbuf buf;</td><td> </td><td class="right">       struct my_msgbuf buf;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size_t to_send_now;     /* to send in this message */</td><td> </td><td class="right">       size_t to_send_now;     /* to send in this message */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       size_t to_send_next;    /* to send in next message */</td><td> </td><td class="right">       size_t to_send_next;    /* to send in next message */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       do {</td><td> </td><td class="right">       do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               to_send_now = QB_MIN(msg_len - sent, MY_DATA_SIZE);</td><td> </td><td class="right">               to_send_now = QB_MIN(msg_len - sent, MY_DATA_SIZE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               to_send_next = msg_len - (sent + to_send_now);</td><td> </td><td class="right">               to_send_next = msg_len - (sent + to_send_now);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               /* receiver used the ID to check to see if there</td><td> </td><td class="right">               /* receiver used the ID to check to see if there</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0009" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                * is more to rec<span class="delete">ie</span>ve for this message.</td><td> </td><td class="rblock">                * is more to rec<span class="insert">ei</span>ve for this message.</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                */</td><td> </td><td class="right">                */</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (last_chunk) {</td><td> </td><td class="right">               if (last_chunk) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       buf.id = to_send_next + 1;</td><td> </td><td class="right">                       buf.id = to_send_next + 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       buf.id = to_send_next + 1 + msg_len;</td><td> </td><td class="right">                       buf.id = to_send_next + 1 + msg_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memcpy(buf.data, progress, to_send_now);</td><td> </td><td class="right">               memcpy(buf.data, progress, to_send_now);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = msgsnd(q, &amp;buf, to_send_now, IPC_NOWAIT);</td><td> </td><td class="right">               res = msgsnd(q, &amp;buf, to_send_now, IPC_NOWAIT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == 0) {</td><td> </td><td class="right">               if (res == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       sent += to_send_now;</td><td> </td><td class="right">                       sent += to_send_now;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l2" /><small>skipping to change at</small><em> line 143</em></th><th> </th><th><a name="part-r2" /><small>skipping to change at</small><em> line 147</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == -1) {</td><td> </td><td class="right">       if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return sent;</td><td> </td><td class="right">       return sent;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * client functions</td><td> </td><td class="right"> * client functions</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * --------------------------------------------------------</td><td> </td><td class="right"> * --------------------------------------------------------</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0010" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static ssize_t qb_ipc_smq_send(struct qb_ipc_one_way *one_way,</td><td> </td><td class="rblock">static ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                              const void *msg_ptr, size_t msg_len)</td><td> </td><td class="rblock">qb_ipc_smq_send(struct qb_ipc_one_way *one_way,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">               const void *msg_ptr, size_t msg_len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return sysv_split_and_send(one_way-&gt;u.smq.q, msg_ptr, msg_len, QB_TR
UE);</td><td> </td><td class="right">       return sysv_split_and_send(one_way-&gt;u.smq.q, msg_ptr, msg_len, QB_TR
UE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0011" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static ssize_t qb_ipc_smq_sendv(struct qb_ipc_one_way *one_way,</td><td> </td><td class="rblock">static ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                               const struct iovec *iov, size_t iov_len)</td><td> </td><td class="rblock">qb_ipc_smq_sendv(struct qb_ipc_one_way *one_way,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                const struct iovec *iov, size_t iov_len)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res;</td><td> </td><td class="right">       int32_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t sent = 0;</td><td> </td><td class="right">       int32_t sent = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct my_msgbuf buf;</td><td> </td><td class="right">       struct my_msgbuf buf;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t i;</td><td> </td><td class="right">       int32_t i;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       for (i = 0; i &lt; iov_len; i++) {</td><td> </td><td class="right">       for (i = 0; i &lt; iov_len; i++) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (iov[i].iov_len &lt;= MY_DATA_SIZE) {</td><td> </td><td class="right">               if (iov[i].iov_len &lt;= MY_DATA_SIZE) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0012" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       if (i == iov_len<span class="delete">-</span>1) {</td><td> </td><td class="rblock">                       if (i == iov_len<span class="insert"> - </span>1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               buf.id = 1;</td><td> </td><td class="right">                               buf.id = 1;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       } else {</td><td> </td><td class="right">                       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               buf.id = i + iov[i].iov_len;</td><td> </td><td class="right">                               buf.id = i + iov[i].iov_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       memcpy(buf.data, iov[i].iov_base, iov[i].iov_len);</td><td> </td><td class="right">                       memcpy(buf.data, iov[i].iov_base, iov[i].iov_len);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0013" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       res = msgsnd(one_way-&gt;u.smq.q, &amp;buf, iov[i].iov_len,</td><td> </td><td class="rblock">                       res = msgsnd(one_way-&gt;u.smq.q,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"> IPC_NOWAIT);</td><td> </td><td class="rblock">                                    &amp;buf, iov[i].iov_len,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                                    IPC_NOWAIT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       if (res == 0) {</td><td> </td><td class="right">                       if (res == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               res = iov[i].iov_len;</td><td> </td><td class="right">                               res = iov[i].iov_len;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       } else {</td><td> </td><td class="right">                       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                               res = -errno;</td><td> </td><td class="right">                               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       }</td><td> </td><td class="right">                       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0014" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                       res = sysv_split_and_send(one_way-&gt;u.smq.q, <span class="delete">iov[i].i</span></td><td> </td><td class="rblock">                       res = sysv_split_and_send(one_way-&gt;u.smq.q,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">ov_base,</span></td><td> </td><td class="rblock">                                                 <span class="insert">iov[i].iov_base,</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                                 iov[i].iov_len, (i == <span class="delete">iov_</span></td><td> </td><td class="rblock">                                                 iov[i].iov_len,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">len-1));</span></td><td> </td><td class="rblock">                                                 (i == <span class="insert">iov_len - 1));</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res &gt; 0) {</td><td> </td><td class="right">               if (res &gt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       sent += res;</td><td> </td><td class="right">                       sent += res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               } else {</td><td> </td><td class="right">               } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       return res;</td><td> </td><td class="right">                       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return sent;</td><td> </td><td class="right">       return sent;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0015" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static ssize_t qb_ipc_smq_recv(struct qb_ipc_one_way *one_way,</td><td> </td><td class="rblock">static ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                              void *msg_ptr,</td><td> </td><td class="rblock">qb_ipc_smq_recv(struct qb_ipc_one_way *one_way,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                              size_t msg_len,</td><td> </td><td class="rblock">               void *msg_ptr, size_t msg_len, int32_t ms_timeout)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                              int32_t ms_timeout)</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t res;</td><td> </td><td class="right">       ssize_t res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       ssize_t received = 0;</td><td> </td><td class="right">       ssize_t received = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#ifdef PACK_MESSAGES</td><td> </td><td class="right">#ifdef PACK_MESSAGES</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       char *progress = (char *)msg_ptr;</td><td> </td><td class="right">       char *progress = (char *)msg_ptr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct my_msgbuf buf;</td><td> </td><td class="right">       struct my_msgbuf buf;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       do {</td><td> </td><td class="right">       do {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">try_again:</td><td> </td><td class="right">try_again:</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0016" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               res = msgrcv(one_way-&gt;u.smq.q, &amp;buf, MY_DATA_SIZE, 0, <span class="delete">IPC_NO</span></td><td> </td><td class="rblock">               res = msgrcv(one_way-&gt;u.smq.q, &amp;buf,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">WAIT);</span></td><td> </td><td class="rblock">                            MY_DATA_SIZE, 0, <span class="insert">IPC_NOWAIT);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == -1 &amp;&amp; errno == ENOMSG) {</td><td> </td><td class="right">               if (res == -1 &amp;&amp; errno == ENOMSG) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       goto try_again;</td><td> </td><td class="right">                       goto try_again;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               //printf("res:%zd, ID:%d\n", res, buf.id);</td><td> </td><td class="right">               //printf("res:%zd, ID:%d\n", res, buf.id);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               if (res == -1) {</td><td> </td><td class="right">               if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">                       goto return_status;</td><td> </td><td class="right">                       goto return_status;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               }</td><td> </td><td class="right">               }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               memcpy(progress, buf.data, res);</td><td> </td><td class="right">               memcpy(progress, buf.data, res);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               received += res;</td><td> </td><td class="right">               received += res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               progress += res;</td><td> </td><td class="right">               progress += res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } while (buf.id &gt; 1);</td><td> </td><td class="right">       } while (buf.id &gt; 1);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">return_status:</td><td> </td><td class="right">return_status:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#else</td><td> </td><td class="right">#else</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = msgrcv(one_way-&gt;u.smq.q, msg_ptr, msg_len, 0, IPC_NOWAIT);</td><td> </td><td class="right">       res = msgrcv(one_way-&gt;u.smq.q, msg_ptr, msg_len, 0, IPC_NOWAIT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       received = res;</td><td> </td><td class="right">       received = res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">#endif</td><td> </td><td class="right">#endif</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == -1 &amp;&amp; errno == ENOMSG) {</td><td> </td><td class="right">       if (res == -1 &amp;&amp; errno == ENOMSG) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               /* just to be consistent with other IPC types.</td><td> </td><td class="right">               /* just to be consistent with other IPC types.</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0017" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               */</td><td> </td><td class="rblock">               <span class="insert"> </span>*/</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -EAGAIN;</td><td> </td><td class="right">               return -EAGAIN;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == -1) {</td><td> </td><td class="right">       if (res == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               perror(__func__);</td><td> </td><td class="right">               perror(__func__);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return -errno;</td><td> </td><td class="right">               return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return received;</td><td> </td><td class="right">       return received;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0018" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void qb_ipcc_smq_disconnect(struct qb_ipcc_connection *c)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcc_smq_disconnect(struct qb_ipcc_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipc_request_header hdr;</td><td> </td><td class="right">       struct qb_ipc_request_header hdr;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0019" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">qb_util_log(LOG_DEBUG,</span> "%s()", __func__);</td><td> </td><td class="rblock">       <span class="insert">qb_util_log(LOG_TRACE,</span> "%s()", __func__);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">       <span class="delete">//if (c-&gt;needs_sock_for_poll) {</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       //      return;</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       //}</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       hdr.id = QB_IPC_MSG_DISCONNECT;</td><td> </td><td class="right">       hdr.id = QB_IPC_MSG_DISCONNECT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       hdr.size = sizeof(hdr);</td><td> </td><td class="right">       hdr.size = sizeof(hdr);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       (void)sysv_split_and_send(c-&gt;request.u.smq.q,</td><td> </td><td class="right">       (void)sysv_split_and_send(c-&gt;request.u.smq.q,</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0020" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                 (const char *)&amp;hdr, hdr.size,</td><td> </td><td class="rblock">                                 (const char *)&amp;hdr, hdr.size, QB_TRUE);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                 QB_TRUE);</td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       msgctl(c-&gt;event.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">       msgctl(c-&gt;event.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">       msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">       msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0021" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">int32_t qb_ipcc_smq_connect(struct qb_ipcc_connection *c,</td><td> </td><td class="rblock">int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                           struct qb_ipc_connection_response *response)</td><td> </td><td class="rblock">qb_ipcc_smq_connect(struct qb_ipcc_connection *c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                   struct qb_ipc_connection_response *response)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;funcs.send = qb_ipc_smq_send;</td><td> </td><td class="right">       c-&gt;funcs.send = qb_ipc_smq_send;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;funcs.sendv = qb_ipc_smq_sendv;</td><td> </td><td class="right">       c-&gt;funcs.sendv = qb_ipc_smq_sendv;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;funcs.recv = qb_ipc_smq_recv;</td><td> </td><td class="right">       c-&gt;funcs.recv = qb_ipc_smq_recv;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;funcs.fc_get = NULL;</td><td> </td><td class="right">       c-&gt;funcs.fc_get = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;funcs.disconnect = qb_ipcc_smq_disconnect;</td><td> </td><td class="right">       c-&gt;funcs.disconnect = qb_ipcc_smq_disconnect;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;type = QB_IPC_SYSV_MQ;</td><td> </td><td class="right">       c-&gt;type = QB_IPC_SYSV_MQ;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;needs_sock_for_poll = QB_TRUE;</td><td> </td><td class="right">       c-&gt;needs_sock_for_poll = QB_TRUE;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l3" /><small>skipping to change at</small><em> line 277</em></th><th> </th><th><a name="part-r3" /><small>skipping to change at</small><em> line 285</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               perror("msgget:REQUEST");</td><td> </td><td class="right">               perror("msgget:REQUEST");</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup;</td><td> </td><td class="right">               goto cleanup;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(&amp;c-&gt;response.u.smq.key, response-&gt;response, sizeof(uint32_t))
;</td><td> </td><td class="right">       memcpy(&amp;c-&gt;response.u.smq.key, response-&gt;response, sizeof(uint32_t))
;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;response.u.smq.q = msgget(c-&gt;response.u.smq.key, IPC_NOWAIT);</td><td> </td><td class="right">       c-&gt;response.u.smq.q = msgget(c-&gt;response.u.smq.key, IPC_NOWAIT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;response.u.smq.q == -1) {</td><td> </td><td class="right">       if (c-&gt;response.u.smq.q == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               perror("msgget:RESPONSE");</td><td> </td><td class="right">               perror("msgget:RESPONSE");</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0022" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               goto cleanup;</td><td> </td><td class="rblock">               goto cleanup<span class="insert">_request</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(&amp;c-&gt;event.u.smq.key, response-&gt;event, sizeof(uint32_t));</td><td> </td><td class="right">       memcpy(&amp;c-&gt;event.u.smq.key, response-&gt;event, sizeof(uint32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       c-&gt;event.u.smq.q = msgget(c-&gt;event.u.smq.key, IPC_NOWAIT);</td><td> </td><td class="right">       c-&gt;event.u.smq.q = msgget(c-&gt;event.u.smq.key, IPC_NOWAIT);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;event.u.smq.q == -1) {</td><td> </td><td class="right">       if (c-&gt;event.u.smq.q == -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               perror("msgget:EVENT");</td><td> </td><td class="right">               perror("msgget:EVENT");</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0023" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">               goto cleanup;</td><td> </td><td class="rblock">               goto cleanup<span class="insert">_request_response</span>;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0024" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       return 0;</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0025" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">cleanup_request_response:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">cleanup_request:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup:</td><td> </td><td class="right">cleanup:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">/*</td><td> </td><td class="right">/*</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * service functions</td><td> </td><td class="right"> * service functions</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> * --------------------------------------------------------</td><td> </td><td class="right"> * --------------------------------------------------------</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"> */</td><td> </td><td class="right"> */</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0026" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static void qb_ipcs_smq_disconnect(struct qb_ipcs_connection *c)</td><td> </td><td class="rblock">static void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_smq_disconnect(struct qb_ipcs_connection *c)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct qb_ipc_response_header msg;</td><td> </td><td class="right">       struct qb_ipc_response_header msg;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (c-&gt;setup.u.us.sock != -1) {</td><td> </td><td class="right">       if (c-&gt;setup.u.us.sock != -1) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msg.id = QB_IPC_MSG_DISCONNECT;</td><td> </td><td class="right">               msg.id = QB_IPC_MSG_DISCONNECT;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msg.size = sizeof(msg);</td><td> </td><td class="right">               msg.size = sizeof(msg);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msg.error = 0;</td><td> </td><td class="right">               msg.error = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               (void)qb_ipc_smq_send(&amp;c-&gt;event, &amp;msg, msg.size);</td><td> </td><td class="right">               (void)qb_ipc_smq_send(&amp;c-&gt;event, &amp;msg, msg.size);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       } else {</td><td> </td><td class="right">       } else {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msgctl(c-&gt;event.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">               msgctl(c-&gt;event.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">               msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">               msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0027" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static int32_t qb_ipcs_smq_connect(struct qb_ipcs_service *s,</td><td> </td><td class="rblock">static int32_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                  struct qb_ipcs_connection *c,</td><td> </td><td class="rblock">qb_ipcs_smq_connect(struct qb_ipcs_service *s,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">                                  struct qb_ipc_connection_response *r)</td><td> </td><td class="rblock">                   struct qb_ipcs_connection *c,</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">                   struct qb_ipc_connection_response *r)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = 0;</td><td> </td><td class="right">       int32_t res = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = sysv_mq_unnamed_create(c, &amp;c-&gt;request);</td><td> </td><td class="right">       res = sysv_mq_unnamed_create(c, &amp;c-&gt;request);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup;</td><td> </td><td class="right">               goto cleanup;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(r-&gt;request, &amp;c-&gt;request.u.smq.key, sizeof(int32_t));</td><td> </td><td class="right">       memcpy(r-&gt;request, &amp;c-&gt;request.u.smq.key, sizeof(int32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno"></td></tr>
      <tr bgcolor="gray" ><td></td><th><a name="part-l4" /><small>skipping to change at</small><em> line 343</em></th><th> </th><th><a name="part-r4" /><small>skipping to change at</small><em> line 358</em></th><td></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       res = sysv_mq_unnamed_create(c, &amp;c-&gt;event);</td><td> </td><td class="right">       res = sysv_mq_unnamed_create(c, &amp;c-&gt;event);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res &lt; 0) {</td><td> </td><td class="right">       if (res &lt; 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               res = -errno;</td><td> </td><td class="right">               res = -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               goto cleanup_request_response;</td><td> </td><td class="right">               goto cleanup_request_response;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       memcpy(r-&gt;event, &amp;c-&gt;event.u.smq.key, sizeof(int32_t));</td><td> </td><td class="right">       memcpy(r-&gt;event, &amp;c-&gt;event.u.smq.key, sizeof(int32_t));</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       r-&gt;hdr.error = 0;</td><td> </td><td class="right">       r-&gt;hdr.error = 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return 0;</td><td> </td><td class="right">       return 0;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0028" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">cleanup_request:</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"><span class="delete">       msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</span></td><td> </td><td class="rblock"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup_request_response:</td><td> </td><td class="right">cleanup_request_response:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td> </td><td class="right">       msgctl(c-&gt;response.u.smq.q, IPC_RMID, NULL);</td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0029" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">cleanup_request:</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock"><span class="insert">       msgctl(c-&gt;request.u.smq.q, IPC_RMID, NULL);</span></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">cleanup:</td><td> </td><td class="right">cleanup:</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       r-&gt;hdr.error = res;</td><td> </td><td class="right">       r-&gt;hdr.error = res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return res;</td><td> </td><td class="right">       return res;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0030" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">static ssize_t qb_ipc_smq_q_len_get(struct qb_ipc_one_way *one_way)</td><td> </td><td class="rblock">static ssize_t</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipc_smq_q_len_get(struct qb_ipc_one_way *one_way)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       struct msqid_ds info;</td><td> </td><td class="right">       struct msqid_ds info;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       int32_t res = msgctl(one_way-&gt;u.smq.q, IPC_STAT, &amp;info);</td><td> </td><td class="right">       int32_t res = msgctl(one_way-&gt;u.smq.q, IPC_STAT, &amp;info);</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       if (res == 0) {</td><td> </td><td class="right">       if (res == 0) {</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">               return info.msg_qnum;</td><td> </td><td class="right">               return info.msg_qnum;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       }</td><td> </td><td class="right">       }</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       return -errno;</td><td> </td><td class="right">       return -errno;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">}</td><td> </td><td class="right">}</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td><a name="diff0031" /></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock">void qb_ipcs_smq_init(struct qb_ipcs_service *s)</td><td> </td><td class="rblock">void</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="lblock"></td><td> </td><td class="rblock">qb_ipcs_smq_init(struct qb_ipcs_service *s)</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">{</td><td> </td><td class="right">{</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.connect = qb_ipcs_smq_connect;</td><td> </td><td class="right">       s-&gt;funcs.connect = qb_ipcs_smq_connect;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.disconnect = qb_ipcs_smq_disconnect;</td><td> </td><td class="right">       s-&gt;funcs.disconnect = qb_ipcs_smq_disconnect;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.send = qb_ipc_smq_send;</td><td> </td><td class="right">       s-&gt;funcs.send = qb_ipc_smq_send;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.sendv = qb_ipc_smq_sendv;</td><td> </td><td class="right">       s-&gt;funcs.sendv = qb_ipc_smq_sendv;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.recv = qb_ipc_smq_recv;</td><td> </td><td class="right">       s-&gt;funcs.recv = qb_ipc_smq_recv;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.peek = NULL;</td><td> </td><td class="right">       s-&gt;funcs.peek = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left">       s-&gt;funcs.reclaim = NULL;</td><td> </td><td class="right">       s-&gt;funcs.reclaim = NULL;</td><td class="lineno" valign="top"></td></tr>
      <tr><td class="lineno" valign="top"></td><td class="left"></td><td> </td><td class="right"></td><td class="lineno" valign="top"></td></tr>

     <tr><td></td><td class="left"></td><td> </td><td class="right"></td><td></td></tr>
     <tr bgcolor="gray"><th colspan="5" align="center"><a name="end">&nbsp;End of changes. 31 change blocks.&nbsp;</a></th></tr>
     <tr class="stats"><td></td><th><i>50 lines changed or deleted</i></th><th><i> </i></th><th><i>62 lines changed or added</i></th><td></td></tr>
     <tr><td colspan="5" align="center" class="small"><br/>This html diff was produced by rfcdiff 1.41. The latest version is available from <a href="http://www.tools.ietf.org/tools/rfcdiff/" >http://tools.ietf.org/tools/rfcdiff/</a> </td></tr>
   </table>
   </body>
   </html>
